<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üê∫ Loup-Garou</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">



<style>
:root {
  --blood: #7a1212;
  --blood2: #b02020;
  --ember: #c87941;
  --ember2: #e8a060;
  --moon: #e8d5a3;
  --moon2: #c4aa70;
  --smoke: #8a8070;
  --dark: #080810;
  --dark2: #100f18;
  --dark3: #181828;
  --dark4: #201f32;
  --wolf-clr: #c04040;
  --village-clr: #3a8a5a;
  --neutral-clr: #7a50b0;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--dark);color:var(--moon);font-family:'EB Garamond',Georgia,serif;font-size:16px;overflow-x:hidden;min-height:100vh;}

/* Stars */
.bg-stars{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(1px 1px at 8% 12%,rgba(232,213,163,.7) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 22% 5%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 38% 18%,rgba(232,213,163,.8) 0%,transparent 100%),
  radial-gradient(1px 1px at 55% 8%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 72% 15%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 88% 4%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 15% 35%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 45% 42%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 65% 30%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 92% 28%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 30% 60%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 78% 55%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 5% 75%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 50% 72%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 95% 68%,rgba(232,213,163,.4) 0%,transparent 100%);}
.bg-fog{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(ellipse at 15% 90%,rgba(200,121,65,.06) 0%,transparent 50%),
  radial-gradient(ellipse at 85% 85%,rgba(122,18,18,.08) 0%,transparent 50%),
  radial-gradient(ellipse at 50% 100%,rgba(30,25,15,.4) 0%,transparent 40%);}

/* SCREENS */
#app{position:relative;z-index:1;}
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* WELCOME */
#welcome-screen{align-items:center;justify-content:center;padding:40px 20px;text-align:center;}
.welcome-moon{font-size:5rem;margin-bottom:16px;animation:moonFloat 4s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(232,213,163,.4));}
@keyframes moonFloat{0%,100%{transform:translateY(0) rotate(-5deg);}50%{transform:translateY(-12px) rotate(5deg);}}
.welcome-title{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,8vw,4rem);text-shadow:0 0 40px rgba(232,213,163,.3),0 0 80px rgba(122,18,18,.4);letter-spacing:.05em;margin-bottom:8px;}
.welcome-sub{font-style:italic;color:var(--moon2);font-size:1.1rem;margin-bottom:40px;opacity:.8;}
.welcome-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:680px;}
.w-card{flex:1;min-width:250px;background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:16px;padding:28px 22px;cursor:pointer;transition:all .3s;}
.w-card:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.4);}
.w-card.red:hover{border-color:var(--blood2);box-shadow:0 16px 40px rgba(122,18,18,.25);}
.w-card.green:hover{border-color:#3a8a5a;box-shadow:0 16px 40px rgba(45,122,74,.2);}
.w-card-icon{font-size:2.5rem;margin-bottom:12px;}
.w-card-title{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:8px;}
.w-card-desc{font-size:.88rem;color:var(--smoke);font-style:italic;line-height:1.5;}

/* FORMS */
.form-screen{align-items:center;justify-content:center;padding:40px 20px;}
.form-box{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.15);border-radius:20px;padding:32px 28px;width:100%;max-width:420px;position:relative;}
.form-title{font-family:'Cinzel Decorative',serif;font-size:1.2rem;text-align:center;margin-bottom:22px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:.88rem;color:var(--moon2);margin-bottom:5px;}
.field input{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:8px;color:var(--moon);font-family:'EB Garamond',serif;font-size:1.05rem;padding:10px 14px;outline:none;transition:border-color .2s;}
.field input:focus{border-color:rgba(232,213,163,.45);}
.code-input{text-align:center!important;letter-spacing:.2em!important;font-size:1.5rem!important;font-family:'Cinzel Decorative',serif!important;}
.back-btn{position:absolute;top:14px;left:14px;background:none;border:none;color:var(--smoke);cursor:pointer;font-size:1.1rem;transition:color .2s;}
.back-btn:hover{color:var(--moon);}
.btn-primary{display:block;width:100%;background:linear-gradient(135deg,var(--blood),#500a0a);border:1px solid rgba(176,32,32,.5);color:var(--moon);font-family:'Cinzel Decorative',serif;font-size:.95rem;letter-spacing:.06em;padding:13px;border-radius:10px;cursor:pointer;transition:all .3s;margin-top:8px;box-shadow:0 4px 20px rgba(122,18,18,.3);}
.btn-primary:hover{background:linear-gradient(135deg,var(--blood2),var(--blood));box-shadow:0 6px 30px rgba(122,18,18,.5);transform:translateY(-1px);}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-sec{display:block;width:100%;background:transparent;border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:1rem;padding:10px;border-radius:8px;cursor:pointer;transition:all .2s;margin-top:8px;}
.btn-sec:hover{border-color:rgba(232,213,163,.4);color:var(--moon);}
.err-msg{color:#e07070;font-size:.85rem;text-align:center;padding:6px 0;min-height:24px;}
.ok-msg{color:#70d090;font-size:.85rem;text-align:center;padding:6px 0;}

/* AVATAR PICKER */
.avatar-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:4px;}
.av-btn{background:none;border:2px solid rgba(232,213,163,.1);border-radius:8px;padding:4px 6px;font-size:1.3rem;cursor:pointer;transition:all .2s;}
.av-btn.selected{border-color:rgba(232,213,163,.55);background:rgba(232,213,163,.08);}

/* LOBBY */
#lobby-screen{padding:20px;max-width:700px;margin:0 auto;width:100%;}
.lobby-head{text-align:center;padding:20px 0 24px;}
.lobby-code{font-family:'Cinzel Decorative',serif;font-size:2.4rem;letter-spacing:.18em;color:var(--ember2);text-shadow:0 0 30px rgba(200,121,65,.4);margin-bottom:8px;}
.lobby-lbl{font-size:.84rem;color:var(--smoke);font-style:italic;}
.copy-btn{background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.18);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.84rem;padding:5px 14px;border-radius:20px;cursor:pointer;transition:all .2s;margin-top:8px;}
.copy-btn:hover{background:rgba(232,213,163,.16);color:var(--moon);}
.lobby-players{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin:16px 0;}
.lp-tile{background:var(--dark3);border:1px solid rgba(232,213,163,.1);border-radius:10px;padding:14px 10px;text-align:center;animation:tileIn .4s ease;}
@keyframes tileIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
.lp-tile.host{border-color:rgba(200,121,65,.4);}
.lp-av{font-size:2rem;margin-bottom:5px;}
.lp-name{font-size:.84rem;}
.lp-badge{font-size:.7rem;color:var(--ember);font-style:italic;margin-top:2px;}
.lobby-waiting{font-style:italic;color:var(--smoke);text-align:center;padding:20px;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.5}50%{opacity:1}}
.panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:14px;padding:18px;position:relative;overflow:hidden;margin-bottom:14px;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(232,213,163,.2),transparent);}
.p-title{font-family:'Cinzel Decorative',serif;font-size:.72rem;letter-spacing:.14em;color:var(--moon2);margin-bottom:12px;text-transform:uppercase;}
.roles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:7px;max-height:260px;overflow-y:auto;}
.role-tog{background:rgba(255,255,255,.03);border:1px solid rgba(232,213,163,.1);border-radius:8px;padding:7px 5px;cursor:pointer;transition:all .2s;text-align:center;font-size:.77rem;}
.role-tog:hover{border-color:rgba(232,213,163,.3);}
.role-tog.on{border-color:rgba(232,213,163,.45);background:rgba(232,213,163,.07);}
.role-tog.on.loup{border-color:var(--blood2);background:rgba(122,18,18,.15);}
.role-tog.on.village{border-color:#4a9a5a;background:rgba(45,122,74,.12);}
.role-tog.on.neutre{border-color:#8a60c0;background:rgba(106,64,160,.15);}
.r-em{font-size:1.25rem;display:block;margin-bottom:3px;}
.dur-row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;}
.dur-field{display:flex;flex-direction:column;gap:4px;}
.dur-field label{font-size:.78rem;color:var(--smoke);}
.dur-field input{width:80px;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:6px;color:var(--moon);font-family:inherit;font-size:.95rem;padding:7px 10px;outline:none;}

/* GAME */
#game-screen{padding:14px;max-width:980px;margin:0 auto;width:100%;}

/* Phase Bar ‚Äî dynamic night/day atmosphere */
.phase-bar{display:flex;align-items:center;justify-content:space-between;border-radius:16px;padding:16px 22px;margin-bottom:14px;position:relative;overflow:hidden;transition:all .8s ease;}
.phase-bar.is-night{background:linear-gradient(135deg,#0d0b1a,#12102a);border:1px solid rgba(120,100,200,.25);box-shadow:0 4px 30px rgba(80,60,160,.2);}
.phase-bar.is-day{background:linear-gradient(135deg,#1a1208,#221a0a);border:1px solid rgba(220,160,60,.25);box-shadow:0 4px 30px rgba(200,140,40,.15);}
.phase-bar::before{content:'';position:absolute;inset:0;opacity:.04;pointer-events:none;transition:opacity .8s;}
.phase-bar.is-night::before{background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ccircle cx='5' cy='5' r='1' fill='white'/%3E%3Ccircle cx='25' cy='12' r='.7' fill='white'/%3E%3Ccircle cx='45' cy='3' r='1.2' fill='white'/%3E%3Ccircle cx='15' cy='35' r='.8' fill='white'/%3E%3Ccircle cx='55' cy='28' r='.6' fill='white'/%3E%3Ccircle cx='38' cy='50' r='1' fill='white'/%3E%3C/svg%3E");}
.phase-bar.is-day::before{background:radial-gradient(ellipse at 50% 0%,rgba(255,200,80,.3) 0%,transparent 70%);}
.ph-left{display:flex;align-items:center;gap:14px;}
.ph-icon{font-size:2.2rem;filter:drop-shadow(0 0 12px rgba(232,213,163,.4));transition:all .8s;}
.ph-info{}
.ph-name{font-family:'Cinzel Decorative',serif;font-size:1.05rem;letter-spacing:.04em;}
.ph-desc{font-size:.78rem;color:var(--smoke);font-style:italic;margin-top:2px;}
.ph-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.ph-timer{font-family:'Cinzel Decorative',serif;font-size:2rem;color:var(--ember2);text-shadow:0 0 20px rgba(200,121,65,.4);min-width:64px;text-align:right;transition:color .3s;line-height:1;}
.ph-timer.urgent{color:var(--blood2);text-shadow:0 0 20px rgba(176,32,32,.6);animation:urgPulse .5s ease-in-out infinite;}
@keyframes urgPulse{0%,100%{opacity:1}50%{opacity:.4}}
.ph-turn-badge{font-size:.68rem;color:var(--smoke);font-style:italic;text-align:right;}

.game-cols{display:grid;grid-template-columns:1fr 285px;gap:14px;}
@media(max-width:720px){.game-cols{grid-template-columns:1fr;}}
.game-main{display:flex;flex-direction:column;gap:13px;}

/* Role Card ‚Äî glowing border per camp */
.my-role-card{border-radius:16px;padding:18px 20px;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden;}
.my-role-card.loup{background:linear-gradient(135deg,rgba(80,10,10,.6),rgba(30,8,8,.8));border:1px solid rgba(180,40,40,.35);box-shadow:0 0 20px rgba(122,18,18,.15);}
.my-role-card.village{background:linear-gradient(135deg,rgba(10,50,25,.6),rgba(8,30,15,.8));border:1px solid rgba(50,140,80,.35);box-shadow:0 0 20px rgba(30,100,60,.12);}
.my-role-card.neutre{background:linear-gradient(135deg,rgba(50,20,80,.6),rgba(25,10,45,.8));border:1px solid rgba(120,60,180,.35);box-shadow:0 0 20px rgba(90,50,140,.12);}
.my-role-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;}
.my-role-card.loup::before{background:linear-gradient(90deg,transparent,rgba(200,60,60,.5),transparent);}
.my-role-card.village::before{background:linear-gradient(90deg,transparent,rgba(60,180,100,.4),transparent);}
.my-role-card.neutre::before{background:linear-gradient(90deg,transparent,rgba(150,80,220,.4),transparent);}
.role-emoji-big{font-size:3rem;filter:drop-shadow(0 0 10px rgba(232,213,163,.3));flex-shrink:0;}
.role-info{}
.role-name{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:4px;}
.role-camp{font-size:.73rem;font-style:italic;margin-bottom:6px;letter-spacing:.05em;}
.role-camp.loup{color:#e07070;}
.role-camp.village{color:#60d090;}
.role-camp.neutre{color:#b080f0;}
.role-desc-txt{font-size:.81rem;color:var(--smoke);line-height:1.55;}

/* Players Grid */
.players-section{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.08);border-radius:16px;padding:16px;}
.players-section-title{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.14em;color:var(--smoke);margin-bottom:12px;text-transform:uppercase;display:flex;align-items:center;gap:7px;}
.players-section-title span{flex:1;height:1px;background:rgba(232,213,163,.08);}
.players-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:9px;}
.p-tile{background:rgba(255,255,255,.025);border:1px solid rgba(232,213,163,.09);border-radius:12px;padding:12px 8px;text-align:center;position:relative;cursor:default;transition:all .3s;}
.p-tile:hover{border-color:rgba(232,213,163,.22);transform:translateY(-2px);background:rgba(255,255,255,.04);}
.p-tile.dead{opacity:.18;filter:grayscale(1) blur(.5px);pointer-events:none;}
.p-tile.me{border-color:rgba(232,213,163,.3);background:rgba(232,213,163,.04);}
.p-tile.mayor::after{content:'üëë';position:absolute;top:-8px;right:-4px;font-size:.9rem;filter:drop-shadow(0 0 6px rgba(200,160,0,.5));}
.p-tile.protected{border-color:rgba(80,200,120,.5);box-shadow:0 0 14px rgba(80,200,120,.12);}
.p-tile.lover::before{content:'‚ù§Ô∏è';position:absolute;top:-8px;left:-4px;font-size:.75rem;}
.p-tile.loup-known{border-color:rgba(176,32,32,.4);background:rgba(80,10,10,.2);}
.t-av{font-size:1.7rem;margin-bottom:5px;}
.t-name{font-size:.74rem;line-height:1.2;font-weight:600;}
.t-role{font-size:.64rem;color:var(--smoke);font-style:italic;margin-top:3px;}
.t-status{font-size:.62rem;margin-top:3px;}

/* Actions Panel */
.actions-panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.08);border-radius:16px;padding:16px;}
.a-title{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.14em;color:var(--smoke);margin-bottom:10px;text-transform:uppercase;display:flex;align-items:center;gap:7px;}
.a-title span{flex:1;height:1px;background:rgba(232,213,163,.08);}
.a-btns{display:flex;flex-direction:column;gap:8px;}
.a-flavor{background:rgba(255,255,255,.025);border-left:2px solid rgba(232,213,163,.2);border-radius:0 8px 8px 0;padding:10px 14px;font-size:.83rem;color:var(--moon2);font-style:italic;line-height:1.6;margin-bottom:4px;}
.a-flavor.loup{border-color:rgba(180,40,40,.5);}
.a-flavor.village{border-color:rgba(50,160,80,.5);}
.a-flavor.neutre{border-color:rgba(130,60,200,.5);}
.a-btn{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.12);color:var(--moon);font-family:'EB Garamond',serif;font-size:.9rem;padding:9px 14px;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;text-align:left;}
.a-btn:hover{background:rgba(232,213,163,.09);border-color:rgba(232,213,163,.32);transform:translateX(2px);}
.a-btn.red{border-color:rgba(140,20,20,.4);background:rgba(100,10,10,.1);}
.a-btn.red:hover{background:rgba(122,18,18,.25);border-color:var(--blood2);}
.a-btn.purple{border-color:rgba(140,80,200,.35);background:rgba(90,30,140,.08);}
.a-btn.purple:hover{background:rgba(140,80,200,.15);border-color:#a060e0;}
.a-btn.green{border-color:rgba(50,160,80,.35);background:rgba(20,100,40,.08);}
.a-btn.green:hover{background:rgba(40,160,70,.15);border-color:#50d080;}
.a-used{font-size:.78rem;color:var(--smoke);font-style:italic;opacity:.7;padding:3px 0;}

/* Side panel */
.game-side{display:flex;flex-direction:column;gap:13px;}

/* Event Card */
.event-card{background:linear-gradient(135deg,rgba(60,25,100,.5),rgba(30,10,55,.6));border:1px solid rgba(156,100,220,.35);border-radius:14px;padding:18px;text-align:center;animation:evGlow 3s ease-in-out infinite;}
@keyframes evGlow{0%,100%{box-shadow:0 0 15px rgba(156,100,220,.2);}50%{box-shadow:0 0 35px rgba(156,100,220,.45);}}
.ev-big{font-size:2.2rem;margin-bottom:8px;}
.ev-title{font-family:'Cinzel Decorative',serif;font-size:.82rem;color:#c8b0ff;margin-bottom:5px;letter-spacing:.06em;}
.ev-desc{font-size:.78rem;color:var(--smoke);font-style:italic;line-height:1.5;}

/* Chat Panel */
.chat-panel{background:rgba(8,8,18,.5);border:1px solid rgba(232,213,163,.08);border-radius:14px;display:flex;flex-direction:column;min-height:200px;max-height:320px;overflow:hidden;}
.chat-head{font-family:'Cinzel Decorative',serif;font-size:.66rem;letter-spacing:.14em;color:var(--smoke);padding:12px 14px 9px;border-bottom:1px solid rgba(232,213,163,.06);text-transform:uppercase;display:flex;align-items:center;gap:6px;}
.chat-head::before{content:'';width:6px;height:6px;background:#4a9a5a;border-radius:50%;box-shadow:0 0 8px #4a9a5a;}
.chat-msgs{flex:1;overflow-y:auto;padding:10px 13px;display:flex;flex-direction:column;gap:6px;}
.c-msg{font-size:.82rem;line-height:1.45;}
.c-msg .c-author{font-weight:600;color:var(--ember2);}
.c-msg .c-author.dead{color:var(--smoke);text-decoration:line-through;opacity:.6;}
.c-msg .c-author.me-author{color:var(--moon);}
.c-msg .c-text{color:var(--moon2);}
.c-msg.sys{font-style:italic;color:var(--smoke);font-size:.76rem;padding:3px 0;border-top:1px solid rgba(232,213,163,.04);margin-top:2px;}
.c-msg.sys.death{color:#e07070;}
.c-msg.sys.night{color:#8070b0;}
.c-msg.sys.chaos{color:#c0a0ff;}
.c-msg.sys.info{color:#70c0a0;}
.chat-row{display:flex;gap:7px;padding:8px 12px;border-top:1px solid rgba(232,213,163,.06);}
.chat-inp{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.12);border-radius:8px;color:var(--moon);font-family:'EB Garamond',serif;font-size:.88rem;padding:8px 11px;outline:none;transition:border-color .2s;}
.chat-inp:focus{border-color:rgba(232,213,163,.3);}
.chat-inp:disabled{opacity:.35;cursor:not-allowed;}
.chat-inp.silenced{opacity:.4;cursor:not-allowed;border-color:rgba(200,160,80,.3)!important;}
.silenced-badge{background:rgba(150,120,50,.2);border:1px solid rgba(200,160,80,.35);border-radius:6px;padding:4px 10px;font-size:.75rem;color:#c0a070;font-style:italic;text-align:center;}
.chat-send{background:linear-gradient(135deg,var(--blood),#500a0a);border:1px solid rgba(176,32,32,.4);color:var(--moon);border-radius:8px;padding:8px 13px;cursor:pointer;font-size:.88rem;transition:all .2s;}
.chat-send:hover{background:linear-gradient(135deg,var(--blood2),var(--blood));}

/* VOICE CHAT */
.voice-panel{background:linear-gradient(135deg,rgba(20,15,40,.6),rgba(10,8,20,.7));border:1px solid rgba(100,80,180,.25);border-radius:14px;padding:14px;margin-bottom:13px;}
.voice-head{font-family:'Cinzel Decorative',serif;font-size:.64rem;letter-spacing:.12em;color:#a090d0;margin-bottom:10px;text-transform:uppercase;display:flex;align-items:center;gap:6px;}
.voice-head::before{content:'üéôÔ∏è';font-size:.85rem;}
.voice-users{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;min-height:32px;}
.voice-user{display:flex;align-items:center;gap:5px;background:rgba(100,80,180,.12);border:1px solid rgba(120,100,200,.2);border-radius:20px;padding:4px 10px;font-size:.76rem;transition:.3s;}
.voice-user.speaking{background:rgba(80,200,120,.15);border-color:rgba(80,200,120,.5);box-shadow:0 0 12px rgba(80,200,120,.2);}
.voice-user.muted{opacity:.45;}
.voice-user .v-av{font-size:.95rem;}
.voice-user .v-name{color:var(--moon2);}
.voice-user .v-mic{font-size:.7rem;}
.voice-btns{display:flex;gap:7px;}
.v-btn{flex:1;background:rgba(100,80,180,.15);border:1px solid rgba(120,100,200,.3);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.83rem;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;}
.v-btn:hover{background:rgba(120,100,200,.25);color:var(--moon);}
.v-btn.active{background:rgba(80,200,120,.2);border-color:rgba(80,200,120,.5);color:#80e0a0;}
.v-btn.red{background:rgba(180,40,40,.2);border-color:rgba(200,60,60,.4);color:#e07070;}
.v-btn.red:hover{background:rgba(200,50,50,.3);}
.v-btn:disabled{opacity:.35;cursor:not-allowed;}
.dead-zone{padding:10px 14px;background:rgba(0,0,0,.25);border-radius:10px;margin-top:8px;border:1px solid rgba(232,213,163,.05);}
.dead-zone-lbl{font-size:.68rem;color:var(--smoke);font-style:italic;margin-bottom:6px;text-transform:uppercase;letter-spacing:.1em;}
.dead-chips{display:flex;flex-wrap:wrap;gap:5px;}
.dead-chip{font-size:.75rem;color:var(--smoke);text-decoration:line-through;padding:3px 9px;background:rgba(255,255,255,.03);border-radius:12px;border:1px solid rgba(232,213,163,.06);}

/* Wolves chat ‚Äî private section */
.wolf-chat{background:linear-gradient(135deg,rgba(80,10,10,.4),rgba(30,5,5,.5));border:1px solid rgba(180,40,40,.25);border-radius:14px;display:flex;flex-direction:column;max-height:160px;overflow:hidden;}
.wolf-chat-head{font-family:'Cinzel Decorative',serif;font-size:.64rem;letter-spacing:.12em;color:#e07070;padding:9px 12px 7px;border-bottom:1px solid rgba(180,40,40,.15);text-transform:uppercase;display:flex;align-items:center;gap:6px;}
.wolf-chat-head::before{content:'üê∫';font-size:.8rem;}
.wolf-chat-msgs{flex:1;overflow-y:auto;padding:8px 11px;display:flex;flex-direction:column;gap:4px;font-size:.79rem;}
.wolf-chat-row{display:flex;gap:6px;padding:7px 10px;border-top:1px solid rgba(180,40,40,.1);}
.wolf-chat-inp{flex:1;background:rgba(100,10,10,.2);border:1px solid rgba(180,40,40,.2);border-radius:6px;color:var(--moon);font-family:'EB Garamond',serif;font-size:.83rem;padding:6px 10px;outline:none;}
.wolf-send{background:rgba(122,18,18,.6);border:none;color:var(--moon);border-radius:6px;padding:6px 11px;cursor:pointer;font-size:.82rem;}

/* NARRATIVE */
#narr{position:fixed;inset:0;z-index:200;background:rgba(4,4,12,.93);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .6s;}
#narr.show{opacity:1;pointer-events:all;}
.narr-inner{max-width:540px;width:90%;text-align:center;padding:20px;}
.narr-fire{font-size:3.5rem;margin-bottom:14px;animation:fireFlick 1.2s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(255,107,0,.6));}
@keyframes fireFlick{0%,100%{transform:scaleY(1) rotate(-3deg);}25%{transform:scaleY(1.08) rotate(2deg);}50%{transform:scaleY(.94) rotate(-1deg);}75%{transform:scaleY(1.05) rotate(3deg);}}
.narr-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.3rem,4vw,1.9rem);margin-bottom:13px;opacity:0;animation:fadeUp .8s ease .1s forwards;}
.narr-text{font-style:italic;font-size:clamp(.95rem,2.5vw,1.15rem);color:var(--moon2);line-height:1.75;opacity:0;animation:fadeUp .8s ease .4s forwards;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.narr-btn{margin-top:26px;display:inline-block;background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.9rem;padding:10px 28px;border-radius:8px;cursor:pointer;transition:all .2s;opacity:0;animation:fadeUp .8s ease .8s forwards;}
.narr-btn:hover{background:rgba(232,213,163,.18);color:var(--moon);}

/* MODAL */
#modal-ov{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.77);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;}
#modal-ov.open{display:flex;}
.modal{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.18);border-radius:16px;padding:24px;width:90%;max-width:380px;animation:fadeUp .2s ease;}
.modal h3{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:12px;}
.m-close{float:right;background:none;border:none;color:var(--smoke);font-size:1.2rem;cursor:pointer;margin-top:-3px;}
.m-opts{display:flex;flex-direction:column;gap:7px;margin-top:10px;}
.m-opt{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);color:var(--moon);font-family:'EB Garamond',serif;font-size:.93rem;padding:10px 13px;border-radius:8px;cursor:pointer;text-align:left;transition:all .2s;display:flex;align-items:center;gap:8px;}
.m-opt:hover{background:rgba(232,213,163,.08);border-color:rgba(232,213,163,.28);}
.m-opt.red:hover{background:rgba(122,18,18,.2);border-color:var(--blood2);}

/* VICTORY */
#victory-screen{align-items:center;justify-content:center;text-align:center;padding:40px 20px;}
.v-icon{font-size:5rem;margin-bottom:14px;animation:vBounce 1s ease infinite;}
@keyframes vBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
.v-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.8rem,6vw,3rem);margin-bottom:12px;animation:glow 2s ease-in-out infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 20px currentColor}50%{text-shadow:0 0 60px currentColor,0 0 100px currentColor}}
.v-desc{font-style:italic;font-size:1.1rem;color:var(--moon2);max-width:480px;line-height:1.6;margin-bottom:24px;}
.v-surv{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);border-radius:12px;padding:18px;max-width:380px;width:100%;margin-bottom:22px;}
.surv-row{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:.93rem;}
.surv-row+.surv-row{border-top:1px solid rgba(232,213,163,.07);}


#settings-btn{position:fixed;top:14px;right:14px;z-index:100;background:rgba(20,18,30,.85);border:1px solid rgba(232,213,163,.18);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:.25s;backdrop-filter:blur(6px);}
#settings-btn:hover{transform:rotate(30deg);border-color:rgba(232,213,163,.4);}
#settings-modal{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;}
#settings-modal.open{display:flex;}
.sbox{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.2);border-radius:18px;padding:0;width:94%;max-width:520px;overflow:hidden;max-height:88vh;display:flex;flex-direction:column;}
.sbox-title{font-family:'Cinzel Decorative',serif;font-size:.9rem;text-align:center;margin-bottom:0;padding-top:4px;}

.sbox-header{padding:20px 24px 0;flex-shrink:0;}
.sbox-tabs{display:flex;gap:0;border-bottom:1px solid rgba(232,213,163,.12);margin-top:16px;}
.sbox-tab{flex:1;padding:9px 4px;background:none;border:none;color:var(--smoke);font-family:'EB Garamond',serif;font-size:.88rem;cursor:pointer;transition:.2s;border-bottom:2px solid transparent;margin-bottom:-1px;}
.sbox-tab.active{color:var(--moon);border-bottom-color:var(--blood);}
.sbox-panel{display:none;overflow-y:auto;flex:1;}
.sbox-panel.active{display:block;}
.sbox-inner{padding:16px 24px 20px;}
/* Settings panel */
.sbox-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(232,213,163,.07);}
.sbox-label{font-size:.9rem;color:var(--moon2);}
.sbox-close{display:block;width:100%;margin-top:14px;background:rgba(232,213,163,.06);border:1px solid rgba(232,213,163,.15);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.9rem;padding:9px;border-radius:8px;cursor:pointer;}
/* Guide panel */
.guide-section{margin-bottom:20px;}
.guide-section-title{font-family:'Cinzel Decorative',serif;font-size:.72rem;letter-spacing:.08em;color:var(--smoke);text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(232,213,163,.1);}
.guide-camp{font-size:.7rem;letter-spacing:.06em;font-family:'Cinzel Decorative',serif;padding:2px 8px;border-radius:10px;display:inline-block;margin-bottom:10px;}
.guide-camp.loup{background:rgba(180,40,40,.2);color:#e07070;border:1px solid rgba(180,40,40,.3);}
.guide-camp.village{background:rgba(40,140,80,.15);color:#70c090;border:1px solid rgba(40,140,80,.25);}
.guide-camp.neutre{background:rgba(120,80,180,.18);color:#b090e0;border:1px solid rgba(120,80,180,.28);}
.guide-role{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid rgba(232,213,163,.05);}
.guide-role:last-child{border-bottom:none;}
.guide-role-em{font-size:1.3rem;flex-shrink:0;width:28px;text-align:center;padding-top:1px;}
.guide-role-body{}
.guide-role-name{font-family:'Cinzel Decorative',serif;font-size:.7rem;color:var(--moon);margin-bottom:3px;}
.guide-role-desc{font-size:.8rem;color:var(--smoke);line-height:1.45;}
.guide-event{display:flex;gap:10px;padding:7px 0;border-bottom:1px solid rgba(232,213,163,.05);}
.guide-event:last-child{border-bottom:none;}
.guide-event-icon{font-size:1.1rem;flex-shrink:0;width:24px;text-align:center;}
.guide-event-body{}
.guide-event-name{font-size:.82rem;color:var(--moon2);font-weight:600;margin-bottom:2px;}
.guide-event-desc{font-size:.78rem;color:var(--smoke);line-height:1.4;}

.sbox-label{font-size:.9rem;color:var(--moon2);}
.sw{position:relative;width:44px;height:24px;display:inline-block;cursor:pointer;}
.sw input{opacity:0;width:0;height:0;position:absolute;}
.sw-track{position:absolute;inset:0;background:rgba(255,255,255,.1);border:1px solid rgba(232,213,163,.2);border-radius:12px;transition:.3s;}
.sw input:checked+.sw-track{background:var(--blood);}
.sw-knob{position:absolute;top:3px;left:3px;width:16px;height:16px;background:var(--moon);border-radius:50%;transition:.3s;pointer-events:none;}
.sw input:checked~.sw-knob{transform:translateX(20px);}
.sbox-close{display:block;width:100%;margin-top:16px;background:rgba(232,213,163,.06);border:1px solid rgba(232,213,163,.15);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.9rem;padding:9px;border-radius:8px;cursor:pointer;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(232,213,163,.18);border-radius:3px;}
.spinner{width:34px;height:34px;border:3px solid rgba(232,213,163,.12);border-top-color:var(--moon2);border-radius:50%;animation:spin .8s linear infinite;margin:18px auto;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<button id="settings-btn" onclick="window.openSettings()">‚öôÔ∏è</button>
<div id="settings-modal" onclick="if(event.target===this)window.closeSettings()">
  <div class="sbox">
    <div class="sbox-header">
      <div class="sbox-title">‚öôÔ∏è Loup-Garou</div>
      <div class="sbox-tabs">
        <button class="sbox-tab active" onclick="window.switchSettingsTab('settings')">Param√®tres</button>
        <button class="sbox-tab" onclick="window.switchSettingsTab('roles')">R√¥les</button>
        <button class="sbox-tab" onclick="window.switchSettingsTab('events')">√âv√©nements</button>
      </div>
    </div>

    <!-- ONGLET PARAM√àTRES -->
    <div class="sbox-panel active" id="stab-settings">
      <div class="sbox-inner">
        <div class="sbox-row"><span class="sbox-label">üîä Son</span>
          <label class="sw"><input type="checkbox" id="sound-toggle" checked onchange="window.toggleSound(this.checked)"><div class="sw-track"></div><div class="sw-knob"></div></label>
        </div>
        <button class="sbox-close" onclick="window.closeSettings()">Fermer</button>
      </div>
    </div>

    <!-- ONGLET R√îLES -->
    <div class="sbox-panel" id="stab-roles">
      <div class="sbox-inner">
        <div class="guide-section">
          <div class="guide-section-title">Camp des Loups</div>
          <div class="guide-role"><div class="guide-role-em">üê∫</div><div class="guide-role-body"><div class="guide-role-name">Loup-Garou</div><div class="guide-role-desc">Chaque nuit, les loups choisissent ensemble une victime. Leur objectif : √©liminer tous les villageois.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">ü§ç</div><div class="guide-role-body"><div class="guide-role-name">Loup Blanc</div><div class="guide-role-desc">Joue avec les loups‚Ä¶ mais veut finir seul en vie. Il peut trahir les siens √† tout moment.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üî•</div><div class="guide-role-body"><div class="guide-role-name">Loup Enrag√©</div><div class="guide-role-desc">Une nuit sur trois, il tue deux joueurs au lieu d'un.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">ü¶†</div><div class="guide-role-body"><div class="guide-role-name">Loup Infectieux</div><div class="guide-role-desc">Une fois par partie, transforme sa cible en Loup-Garou au lieu de la tuer.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üêú</div><div class="guide-role-body"><div class="guide-role-name">Loup aux Puces</div><div class="guide-role-desc">Infecte secr√®tement une cible. Apr√®s plusieurs tours, la victime devient Loup sans le savoir.</div></div></div>
        </div>
        <div class="guide-section">
          <div class="guide-section-title">Camp du Village</div>
          <div class="guide-role"><div class="guide-role-em">üßë</div><div class="guide-role-body"><div class="guide-role-name">Villageois</div><div class="guide-role-desc">Aucun pouvoir. Doit observer, analyser et voter intelligemment.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üîÆ</div><div class="guide-role-body"><div class="guide-role-name">Voyante</div><div class="guide-role-desc">Chaque nuit, d√©couvre le r√¥le exact d'un joueur‚Ä¶ sauf si elle est manipul√©e.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üß™</div><div class="guide-role-body"><div class="guide-role-name">Sorci√®re</div><div class="guide-role-desc">Poss√®de une potion de vie et une potion de mort, utilisables une seule fois chacune.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üèπ</div><div class="guide-role-body"><div class="guide-role-name">Chasseur</div><div class="guide-role-desc">S'il est √©limin√©, il tire imm√©diatement sur un autre joueur ‚Äî tir obligatoire.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üíò</div><div class="guide-role-body"><div class="guide-role-name">Cupidon</div><div class="guide-role-desc">Lie deux amoureux. Si l'un meurt, l'autre aussi. Les amoureux peuvent gagner seuls.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üõ°Ô∏è</div><div class="guide-role-body"><div class="guide-role-name">Garde du Corps</div><div class="guide-role-desc">Prot√®ge un joueur chaque nuit. Si son prot√©g√© devrait mourir (attaque ou vote), le garde meurt √† sa place.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üëë</div><div class="guide-role-body"><div class="guide-role-name">Maire</div><div class="guide-role-desc">√âlu par les joueurs. Sa voix compte double lors des votes.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">‚ú®</div><div class="guide-role-body"><div class="guide-role-name">Dieu du Village</div><div class="guide-role-desc">Une fois par partie, annule une √©limination (jour ou nuit).</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üíÄ</div><div class="guide-role-body"><div class="guide-role-name">N√©cromancien</div><div class="guide-role-desc">Peut communiquer chaque nuit avec un mort pour obtenir des informations.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">‚è≥</div><div class="guide-role-body"><div class="guide-role-name">Chronomancien</div><div class="guide-role-desc">Une fois par partie, rembobine un tour complet et rejoue les √©v√©nements.</div></div></div>
        </div>
        <div class="guide-section">
          <div class="guide-section-title">R√¥les Neutres &amp; Manipulateurs</div>
          <div class="guide-role"><div class="guide-role-em">ü™Ñ</div><div class="guide-role-body"><div class="guide-role-name">Illusionniste</div><div class="guide-role-desc">Modifie l'identit√© r√©v√©l√©e par la Voyante.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üåÄ</div><div class="guide-role-body"><div class="guide-role-name">Hypnotiseur</div><div class="guide-role-desc">Force un joueur √† voter pour une cible pr√©cise lors du prochain vote.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üé≠</div><div class="guide-role-body"><div class="guide-role-name">Usurpateur</div><div class="guide-role-desc">Vole d√©finitivement le r√¥le d'un autre joueur et en h√©rite le pouvoir.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">‚öñÔ∏è</div><div class="guide-role-body"><div class="guide-role-name">Avocat</div><div class="guide-role-desc">Prot√®ge un joueur contre l'√©limination par vote. Recharge toutes les 2‚Äì3 tours.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üó°Ô∏è</div><div class="guide-role-body"><div class="guide-role-name">Tra√Ætre</div><div class="guide-role-desc">Commence comme villageois, mais rejoint secr√®tement les loups plus tard dans la partie.</div></div></div>
          <div class="guide-role"><div class="guide-role-em">üßµ</div><div class="guide-role-body"><div class="guide-role-name">Marionnettiste</div><div class="guide-role-desc">Contr√¥le secr√®tement les actions d'un joueur pendant la nuit.</div></div></div>
        </div>
      </div>
    </div>

    <!-- ONGLET √âV√âNEMENTS -->
    <div class="sbox-panel" id="stab-events">
      <div class="sbox-inner">
        <div class="guide-section">
          <div class="guide-section-title">‚ö° √âv√©nements Chaos</div>
          <div class="guide-event"><div class="guide-event-icon">üå´Ô∏è</div><div class="guide-event-body"><div class="guide-event-name">Brouillard</div><div class="guide-event-desc">Personne ne peut parler pendant une minute.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">ü§´</div><div class="guide-event-body"><div class="guide-event-name">Silence</div><div class="guide-event-desc">Un joueur est r√©duit au silence pour le tour.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üó≥Ô∏è</div><div class="guide-event-body"><div class="guide-event-name">Double Vote</div><div class="guide-event-desc">Tous les votes comptent double ce tour.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üîÉ</div><div class="guide-event-body"><div class="guide-event-name">Vote Invers√©</div><div class="guide-event-desc">Le joueur avec le plus de votes est sauv√© ; le moins vot√© est √©limin√©.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üíÄ</div><div class="guide-event-body"><div class="guide-event-name">Deux Morts Cette Nuit</div><div class="guide-event-desc">Les loups √©liminent deux victimes au lieu d'une.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üõ°Ô∏è</div><div class="guide-event-body"><div class="guide-event-name">Immunit√© Al√©atoire</div><div class="guide-event-desc">Un joueur devient intouchable pour ce tour.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üëª</div><div class="guide-event-body"><div class="guide-event-name">Retour des Morts</div><div class="guide-event-desc">Un joueur √©limin√© revient pour un tour.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üëë</div><div class="guide-event-body"><div class="guide-event-name">Nouveau Maire</div><div class="guide-event-desc">Un maire temporaire est d√©sign√© al√©atoirement ce tour.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üí£</div><div class="guide-event-body"><div class="guide-event-name">Pi√®ge Explosif</div><div class="guide-event-desc">Un joueur est pi√©g√©. S'il est vot√©, il explose et tue deux autres joueurs au hasard.</div></div></div>
        </div>
        <div class="guide-section">
          <div class="guide-section-title">üß† √âv√©nements Strat√©giques</div>
          <div class="guide-event"><div class="guide-event-icon">üëÅÔ∏è</div><div class="guide-event-body"><div class="guide-event-name">Voyante Aveugl√©e</div><div class="guide-event-desc">La Voyante re√ßoit une information fausse ou inutilisable cette nuit.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üß™</div><div class="guide-event-body"><div class="guide-event-name">Potion Retrouv√©e</div><div class="guide-event-desc">La Sorci√®re r√©cup√®re une potion d√©j√† utilis√©e.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">‚öîÔ∏è</div><div class="guide-event-body"><div class="guide-event-name">Duel Obligatoire</div><div class="guide-event-desc">Deux joueurs s'affrontent ; le village vote pour en √©liminer un des deux.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">‚è±Ô∏è</div><div class="guide-event-body"><div class="guide-event-name">D√©bat Limit√©</div><div class="guide-event-desc">Seulement une minute pour discuter avant le vote.</div></div></div>
          <div class="guide-event"><div class="guide-event-icon">üö´</div><div class="guide-event-body"><div class="guide-event-name">Discussions Interdites</div><div class="guide-event-desc">Vote imm√©diat sans d√©bat possible.</div></div></div>
        </div>
      </div>
    </div>

  </div>
</div>
<div class="bg-stars"></div>
<div class="bg-fog"></div>
<div id="app">

<!-- WELCOME -->
<div id="welcome-screen" class="screen active">
  <div class="welcome-moon">üåï</div>
  <div class="welcome-title">Loup-Garou</div>
  <div class="welcome-sub">Chaque nuit, le village tremble‚Ä¶</div>
  <div class="welcome-cards">
    <div class="w-card red" onclick="showScreen('create')">
      <div class="w-card-icon">üî•</div>
      <div class="w-card-title">Cr√©er une Partie</div>
      <div class="w-card-desc">Configurez les r√¥les et invitez vos amis avec un code √† 6 chiffres.</div>
    </div>
    <div class="w-card green" onclick="showScreen('join')">
      <div class="w-card-icon">üåô</div>
      <div class="w-card-title">Rejoindre une Partie</div>
      <div class="w-card-desc">Entrez le code partag√© par l'h√¥te pour rejoindre la nuit.</div>
    </div>
  </div>
</div>

<!-- CREATE -->
<div id="create-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üî• Nouvelle Partie</div>
    <div class="field"><label>Votre nom</label><input id="c-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-create"></div></div>
    <button class="btn-primary" onclick="createGame()">üåô Cr√©er la Partie</button>
    <div id="c-err" class="err-msg"></div>
  </div>
</div>

<!-- JOIN -->
<div id="join-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üåô Rejoindre</div>
    <div class="field"><label>Code de la partie (6 chiffres)</label><input id="j-code" class="code-input" placeholder="000000" maxlength="6" autocomplete="off" inputmode="numeric"></div>
    <div class="field"><label>Votre nom</label><input id="j-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-join"></div></div>
    <button class="btn-primary" onclick="joinGame()">üêæ Rejoindre</button>
    <div id="j-err" class="err-msg"></div>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby-screen" class="screen">
  <div class="lobby-head">
    <div class="lobby-lbl">Partagez ce code avec vos amis !</div>
    <div class="lobby-code" id="lobby-code">------</div>
    <button class="copy-btn" onclick="copyCode()">üìã Copier le code</button>
    <div class="lobby-lbl" style="margin-top:8px;" id="lobby-lbl">En attente‚Ä¶</div>
  </div>
  <div id="host-setup"></div>
  <div class="lobby-players" id="lobby-players"></div>
  <div class="lobby-waiting" id="lobby-wait">‚è≥ En attente que l'h√¥te lance la partie‚Ä¶</div>
  <div id="lobby-launch" style="display:none;max-width:380px;margin:0 auto;">
    <button class="btn-primary" onclick="launchGame()">üê∫ Lancer la Partie</button>
    <div id="launch-err" class="err-msg"></div>
  </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="phase-bar is-night" id="phase-bar">
    <div class="ph-left">
      <div class="ph-icon" id="ph-icon">üåë</div>
      <div class="ph-info">
        <div class="ph-name" id="ph-name">Nuit 1</div>
        <div class="ph-desc" id="ph-desc">Les cr√©atures s'√©veillent‚Ä¶</div>
      </div>
    </div>
    <div class="ph-right">
      <div class="ph-timer" id="ph-timer">--</div>
      <div class="ph-turn-badge" id="ph-turn-badge">Tour 1</div>
    </div>
  </div>
  <div class="game-cols">
    <div class="game-main">
      <div class="my-role-card" id="my-role-card">
        <div class="role-emoji-big" id="r-em">‚ùì</div>
        <div class="role-info">
          <div class="role-name" id="r-name">R√¥le secret</div>
          <div class="role-camp" id="r-camp"></div>
          <div class="role-desc-txt" id="r-desc"></div>
        </div>
      </div>
      <div class="players-section">
        <div class="players-section-title">üë• Joueurs <span></span></div>
        <div class="players-grid" id="g-players"></div>
        <div class="dead-zone" id="dead-zone" style="display:none;">
          <div class="dead-zone-lbl">‚ö∞Ô∏è √âlimin√©s</div>
          <div class="dead-chips" id="dead-chips"></div>
        </div>
      </div>
      <div class="actions-panel">
        <div class="a-title">‚ö° Vos Actions <span></span></div>
        <div class="a-btns" id="a-btns"></div>
      </div>
    </div>
    <div class="game-side">
      <div id="voice-panel" class="voice-panel" style="display:none;">
        <div class="voice-head">Chat Vocal</div>
        <div class="voice-users" id="voice-users"></div>
        <div class="voice-btns">
          <button class="v-btn" id="v-join-btn" onclick="voiceJoin()">üéôÔ∏è Rejoindre</button>
          <button class="v-btn" id="v-mute-btn" onclick="voiceToggleMute()" style="display:none;">üé§ Muet</button>
          <button class="v-btn red" id="v-leave-btn" onclick="voiceLeave()" style="display:none;">üìµ Quitter</button>
        </div>
      </div>
      <div class="event-card" id="ev-card" style="display:none;"></div>
      <div id="wolf-chat-panel" style="display:none;">
        <div class="wolf-chat">
          <div class="wolf-chat-head">Canal des Loups</div>
          <div class="wolf-chat-msgs" id="wolf-msgs"></div>
          <div class="wolf-chat-row">
            <input class="wolf-chat-inp" id="wolf-in" placeholder="Message secret‚Ä¶" maxlength="200" autocomplete="off">
            <button class="wolf-send" onclick="sendWolfChat()">‚Üë</button>
          </div>
        </div>
      </div>
      <div id="necro-chat-panel" style="display:none;">
        <div class="wolf-chat" style="background:linear-gradient(135deg,rgba(40,10,70,.5),rgba(15,5,30,.6));border-color:rgba(150,80,220,.25);">
          <div class="wolf-chat-head" style="color:#c0a0ff;">üíÄ Canal des Esprits</div>
          <div class="wolf-chat-msgs" id="necro-msgs"></div>
          <div class="wolf-chat-row">
            <input class="wolf-chat-inp" id="necro-in" placeholder="Murmure depuis l'au-del√†‚Ä¶" maxlength="200" autocomplete="off" style="border-color:rgba(150,80,220,.25);">
            <button class="wolf-send" onclick="sendNecroChat()" style="background:rgba(90,30,140,.5);">‚Üë</button>
          </div>
        </div>
      </div>
      <div class="chat-panel">
        <div class="chat-head">üí¨ Village</div>
        <div class="chat-msgs" id="chat-msgs"></div>
        <div class="chat-row">
          <input class="chat-inp" id="chat-in" placeholder="Votre message‚Ä¶" maxlength="200" autocomplete="off">
          <button class="chat-send" onclick="sendChat()">‚Üë</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VICTORY -->
<div id="victory-screen" class="screen">
  <div class="v-icon" id="v-icon">üèÜ</div>
  <div class="v-title" id="v-title"></div>
  <div class="v-desc" id="v-desc"></div>
  <div class="v-surv" id="v-surv"></div>
  <button class="btn-primary" style="max-width:300px;" onclick="backToWelcome()">üîÑ Nouvelle Partie</button>
</div>
</div><!-- #app -->

<!-- NARRATIVE -->
<div id="narr">
  <div class="narr-inner">
    <div class="narr-fire" id="n-fire">üî•</div>
    <div class="narr-title" id="n-title"></div>
    <div class="narr-text" id="n-text"></div>
    <button class="narr-btn" onclick="closeNarr()">Continuer‚Ä¶</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal-ov">
  <div class="modal">
    <button class="m-close" onclick="closeModal()">‚úï</button>
    <h3 id="m-title">Action</h3>
    <div id="m-body"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
window._fb = { initializeApp, getDatabase, ref, set, get, onValue, update };
window.dispatchEvent(new CustomEvent('firebaseLoaded'));
</script>
<script>
// Fonctions UI d√©finies imm√©diatement (avant Firebase)
window.showScreen = function(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const scr = document.getElementById(name+'-screen');
  if(scr) scr.classList.add('active');
};
window.closeModal = function(){
  const ov = document.getElementById('modal-ov');
  if(ov && ov._hunterLock) return;
  if(ov) ov.classList.remove('open');
};
window.closeNarr = function(){
  const n = document.getElementById('narr');
  if(n) n.classList.remove('show');
};
window.openSettings = function(){ document.getElementById('settings-modal').classList.add('open'); };
window.closeSettings = function(){ document.getElementById('settings-modal').classList.remove('open'); };
window.switchSettingsTab = function(tab){
  const tabs = ['settings','roles','events'];
  document.querySelectorAll('.sbox-tab').forEach((t,i)=>t.classList.toggle('active', tabs[i]===tab));
  document.querySelectorAll('.sbox-panel').forEach(p=>p.classList.remove('active'));
  const panel = document.getElementById('stab-'+tab);
  if(panel) panel.classList.add('active');
};
window.toggleSound = function(on){
  // sera remplac√©e une fois Firebase charg√©
  window._pendingSoundToggle = on;
};

window.addEventListener('firebaseLoaded', function() {


// ================================================================
// üîä SOUND ENGINE (Web Audio API ‚Äî no external files)
// ================================================================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let ambientSource = null;
let ambientGain = null;

function getAudioCtx(){
  if(!audioCtx) audioCtx = new AudioCtx();
  // Resume on user gesture
  if(audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// Generic synth note
function playTone(freq, type, dur, vol, delay=0, ctx=null){
  ctx = ctx || getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, ctx.currentTime+delay);
  gain.gain.setValueAtTime(0, ctx.currentTime+delay);
  gain.gain.linearRampToValueAtTime(vol, ctx.currentTime+delay+0.02);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+delay+dur);
  osc.start(ctx.currentTime+delay);
  osc.stop(ctx.currentTime+delay+dur+0.05);
}

// Ambient drone for welcome/lobby screen (looping low hum)
function startAmbient(){
  stopAmbient();
  const ctx = getAudioCtx();
  ambientSource = ctx.createOscillator();
  ambientGain = ctx.createGain();
  const filter = ctx.createBiquadFilter();
  filter.type = 'lowpass'; filter.frequency.value = 300;
  ambientSource.type = 'sawtooth';
  ambientSource.frequency.setValueAtTime(55, ctx.currentTime);
  // Slow wobble
  const lfo = ctx.createOscillator();
  const lfoGain = ctx.createGain();
  lfo.frequency.value = 0.12;
  lfoGain.gain.value = 3;
  lfo.connect(lfoGain); lfoGain.connect(ambientSource.frequency);
  ambientGain.gain.value = 0.04;
  ambientSource.connect(filter); filter.connect(ambientGain); ambientGain.connect(ctx.destination);
  ambientSource.start();
  lfo.start();
  // Occasional dark bell pings
  function schedulePing(){
    const delay = 4 + Math.random()*8;
    const pingFreqs = [220, 185, 165, 246];
    const f = pingFreqs[Math.floor(Math.random()*pingFreqs.length)];
    playTone(f, 'sine', 3.5, 0.06, delay, ctx);
    playTone(f*2, 'sine', 2, 0.02, delay+0.01, ctx);
    pingTimer = setTimeout(schedulePing, delay*1000);
  }
  schedulePing();
}
let pingTimer = null;
function stopAmbient(){
  if(ambientSource){try{ambientSource.stop();}catch(e){} ambientSource=null;}
  if(pingTimer){clearTimeout(pingTimer); pingTimer=null;}
  if(ambientGain){try{ambientGain.disconnect();}catch(e){} ambientGain=null;}
}

// Red√©finir toggleSound ici (acc√®s aux vraies variables audio)
window.toggleSound = function(on){
  audioEnabled = on;
  if(on){
    getAudioCtx();
    const active = document.querySelector('.screen.active')?.id?.replace('-screen','');
    if(['welcome','lobby','create','join'].includes(active) && !ambientSource) startAmbient();
  } else {
    stopAmbient();
    try{ if(audioCtx && audioCtx.state==='running') audioCtx.suspend(); }catch(e){}
  }
};

// üåô Sound: game launches (dramatic reveal)
function playGameStart(){
  stopAmbient();
  const ctx = getAudioCtx();
  // Low rumble sweep
  const sweep = ctx.createOscillator();
  const sweepGain = ctx.createGain();
  sweep.connect(sweepGain); sweepGain.connect(ctx.destination);
  sweep.type = 'sawtooth';
  sweep.frequency.setValueAtTime(60, ctx.currentTime);
  sweep.frequency.linearRampToValueAtTime(30, ctx.currentTime+2);
  sweepGain.gain.setValueAtTime(0.08, ctx.currentTime);
  sweepGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+2.5);
  sweep.start(ctx.currentTime); sweep.stop(ctx.currentTime+2.6);
  // Choir-like chords
  const chords = [130.81, 164.81, 196, 246.94];
  chords.forEach((f,i) => playTone(f, 'sine', 2.5, 0.05, 0.3+i*0.12, ctx));
  // Wolf howl shimmer
  [800, 600, 450, 300].forEach((f,i) => playTone(f, 'triangle', 1.2, 0.04, 1.2+i*0.15, ctx));
  playTone(220, 'sine', 2, 0.07, 1.8, ctx);
}

// üåÄ Sound: event triggered (eerie, chaotic)
function playEventSound(){
  const ctx = getAudioCtx();
  // Glitchy dissonant hit
  const dissonant = [311, 370, 415, 466];
  dissonant.forEach((f,i) => playTone(f, 'square', 0.8, 0.04, i*0.04, ctx));
  // Low thud
  const noise = ctx.createOscillator();
  const noiseGain = ctx.createGain();
  noise.connect(noiseGain); noiseGain.connect(ctx.destination);
  noise.type = 'sawtooth';
  noise.frequency.setValueAtTime(80, ctx.currentTime);
  noise.frequency.exponentialRampToValueAtTime(20, ctx.currentTime+0.5);
  noiseGain.gain.setValueAtTime(0.15, ctx.currentTime);
  noiseGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.6);
  noise.start(ctx.currentTime); noise.stop(ctx.currentTime+0.7);
  // Shimmer tail
  [523, 622, 740].forEach((f,i) => playTone(f, 'sine', 1.5, 0.03, 0.2+i*0.1, ctx));
}

// üíÄ Sound: a player dies (dark toll)
function playDeathSound(){
  if(!audioEnabled) return;
  const ctx = getAudioCtx();
  // Bell toll ‚Äî low & sinister
  playTone(110, 'sine', 4, 0.12, 0, ctx);
  playTone(116.54, 'sine', 3.5, 0.05, 0.05, ctx); // slight dissonance
  // Sub thud
  const sub = ctx.createOscillator();
  const subGain = ctx.createGain();
  sub.connect(subGain); subGain.connect(ctx.destination);
  sub.type = 'sine'; sub.frequency.setValueAtTime(55, ctx.currentTime);
  sub.frequency.exponentialRampToValueAtTime(30, ctx.currentTime+1);
  subGain.gain.setValueAtTime(0.18, ctx.currentTime);
  subGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+1.2);
  sub.start(ctx.currentTime); sub.stop(ctx.currentTime+1.3);
  // Eerie overtone fade
  playTone(220, 'sine', 3, 0.03, 0.3, ctx);
  playTone(440, 'sine', 2, 0.015, 0.6, ctx);
}

// üê∫ Sound: wolves win (dark triumphant howl)
function playWolfVictorySound(){
  if(!audioEnabled) return;
  const ctx = getAudioCtx();
  // Howl sweep
  const howl = ctx.createOscillator();
  const howlGain = ctx.createGain();
  howl.connect(howlGain); howlGain.connect(ctx.destination);
  howl.type = 'sawtooth';
  howl.frequency.setValueAtTime(200, ctx.currentTime);
  howl.frequency.linearRampToValueAtTime(800, ctx.currentTime+1.2);
  howl.frequency.linearRampToValueAtTime(400, ctx.currentTime+2);
  howlGain.gain.setValueAtTime(0, ctx.currentTime);
  howlGain.gain.linearRampToValueAtTime(0.12, ctx.currentTime+0.2);
  howlGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+2.5);
  howl.start(ctx.currentTime); howl.stop(ctx.currentTime+2.6);
  // Dark low chord
  [55, 73.4, 87.3].forEach((f,i) => playTone(f, 'sine', 4, 0.06, 0.5+i*0.1, ctx));
  // Dissonant stabs
  [311, 370].forEach((f,i) => playTone(f, 'triangle', 1.5, 0.04, 1.5+i*0.2, ctx));
}

// üåæ Sound: village wins (hopeful bells)
function playVillageVictorySound(){
  if(!audioEnabled) return;
  const ctx = getAudioCtx();
  // Ascending bright arpeggio
  const melody = [261.63, 329.63, 392, 523.25, 659.25, 783.99];
  melody.forEach((f,i) => playTone(f, 'sine', 2, 0.07, i*0.18, ctx));
  // Warm pad chord
  [196, 246.94, 293.66, 392].forEach((f,i) => playTone(f, 'triangle', 4, 0.04, 0.8+i*0.05, ctx));
  // Final sustained bell
  playTone(1046.5, 'sine', 3.5, 0.06, 1.5, ctx);
  playTone(523.25, 'sine', 3.5, 0.05, 1.5, ctx);
}

// ‚ù§Ô∏è Sound: lovers win (bittersweet)
function playLoversVictorySound(){
  if(!audioEnabled) return;
  const ctx = getAudioCtx();
  // Slow romantic arpeggio
  [293.66, 370, 440, 523.25, 440, 370, 293.66].forEach((f,i) => playTone(f, 'sine', 2.5, 0.06, i*0.22, ctx));
  // Warm harmony
  [220, 277.18, 329.63].forEach((f,i) => playTone(f, 'triangle', 4, 0.04, 0.5+i*0.1, ctx));
}

// Enable audio on first interaction
let audioEnabled = true;
function enableAudio(){ getAudioCtx(); if(audioEnabled&&!ambientSource) startAmbient(); }
document.addEventListener('click', enableAudio, {once:true});
document.addEventListener('keydown', enableAudio, {once:true});

// (ambient g√©r√© dans showScreen ci-dessous)

// ================================================================
// üî• REMPLACEZ LES VALEURS CI-DESSOUS PAR VOTRE CONFIG FIREBASE
// ================================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyDkLxCZApo145b2XWwKlc-lQzBh1MtpqH4",
  authDomain:        "projet-loup-garou.firebaseapp.com",
  databaseURL:       "https://projet-loup-garou-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "projet-loup-garou",
  storageBucket:     "projet-loup-garou.firebasestorage.app",
  messagingSenderId: "811973035375",
  appId:             "1:811973035375:web:1ac25aa172960369a9149a"
};

// ================================================================
// DATA
// ================================================================
const ALL_ROLES = {
  'Loup-Garou':      {camp:'loup',   emoji:'üê∫', desc:'Chaque nuit, les loups choisissent ensemble une victime. Votre objectif : √©liminer tous les villageois.'},
  'Loup Blanc':      {camp:'loup',   emoji:'ü§ç', desc:'Vous jouez avec les loups‚Ä¶ mais votre vrai objectif est de finir SEUL en vie. Trahissez au moment opportun.'},
  'Loup Enrag√©':     {camp:'loup',   emoji:'üî•', desc:'Une nuit sur trois, vous tuez DEUX joueurs au lieu d\'un. Votre violence peut acc√©l√©rer la victoire des loups.'},
  'Loup Infectieux': {camp:'loup',   emoji:'ü¶†', desc:'Une fois par partie, au lieu de tuer, vous pouvez transformer votre cible en Loup-Garou sans qu\'elle le sache imm√©diatement.'},
  'Loup aux Puces':  {camp:'loup',   emoji:'üêú', desc:'Vous infectez secr√®tement une cible. Apr√®s quelques tours, elle deviendra Loup-Garou sans le savoir.'},
  'Villageois':      {camp:'village',emoji:'üë®‚Äçüåæ',desc:'Aucun pouvoir particulier. Votre seule arme : l\'observation, la logique et le vote. Trouvez les loups avant qu\'ils ne vous trouvent.'},
  'Voyante':         {camp:'village',emoji:'üîÆ', desc:'Chaque nuit, vous r√©v√©lez le r√¥le exact d\'un joueur de votre choix. Guidez le village sans vous exposer.'},
  'Sorci√®re':        {camp:'village',emoji:'üß™', desc:'Vous poss√©dez une potion de vie (ressuscite un mort) et une potion de mort (tue une cible). Chacune utilisable une seule fois.'},
  'Chasseur':        {camp:'village',emoji:'üèπ', desc:'Si vous √™tes √©limin√©(e), vous pouvez imm√©diatement tuer un autre joueur. Votre mort n\'est jamais gratuite.'},
  'Cupidon':         {camp:'village',emoji:'üíò', desc:'Au d√©but de la partie, vous avez li√© deux amoureux. Si l\'un meurt, l\'autre meurt aussi. Les amoureux peuvent gagner seuls.'},
  'Garde du Corps':  {camp:'village',emoji:'üõ°Ô∏è', desc:'Chaque nuit, vous prot√©gez un joueur contre une attaque. Si votre prot√©g√© devrait mourir, c\'est vous qui mourez √† sa place.'},
  'Dieu du Village': {camp:'village',emoji:'‚ú®', desc:'Une fois dans la partie, vous pouvez annuler une √©limination ‚Äî de jour comme de nuit. Utilisez ce miracle au bon moment.'},
  'N√©cromancien':    {camp:'village',emoji:'üíÄ', desc:'Chaque nuit, choisissez un mort : un canal de chat priv√© s\'ouvre entre vous et son esprit pour cette nuit uniquement.'},
  'Chronomancien':   {camp:'village', emoji:'‚è≥', desc:'Une fois par partie, vous rembobinez le compteur de tours d\'un cran. Les joueurs morts restent morts, mais la num√©rotation repart en arri√®re ‚Äî ce qui r√©initialise les pouvoirs √† recharge (Illusionniste, Hypnotiseur‚Ä¶). Un pouvoir de timing, pas de r√©surrection.'},
  'Illusionniste':   {camp:'neutre', emoji:'ü™Ñ', desc:'Vous pouvez modifier l\'information re√ßue par la Voyante. Rechargement : 2 ou 3 tours (al√©atoire). Elle verra ce que vous voulez, pas la r√©alit√©.'},
  'Hypnotiseur':     {camp:'neutre', emoji:'üåÄ', desc:'Vous forcez un joueur √† voter pour une cible pr√©cise lors du prochain vote. Rechargement : 2 ou 3 tours (al√©atoire). Manipulation pure.'},
  'Usurpateur':      {camp:'neutre', emoji:'üé≠', desc:'Vous choisissez un joueur et usurpez son r√¥le pour toute la partie. Son pouvoir devient le v√¥tre d√©finitivement.'},
  'Avocat':          {camp:'neutre', emoji:'‚öñÔ∏è', desc:'Vous prot√©gez un joueur contre l\'√©limination par vote. Votre client ne peut pas √™tre √©limin√© ce tour.'},
  'Tra√Ætre':         {camp:'neutre', emoji:'üó°Ô∏è', desc:'Vous commencez comme villageois, mais au tour 3 vous rejoignez automatiquement le camp des loups. Leur objectif devient le v√¥tre. Les loups ne vous connaissent pas encore ‚Äî c\'est votre atout.'},
  'Marionnettiste':  {camp:'neutre', emoji:'üßµ', desc:'Vous forcez un joueur √† voter pour une cible pr√©cise lors du prochain vote de jour. Votre contr√¥le passe par le m√™me syst√®me que l\'Hypnotiseur. Rechargement : 2‚Äì3 tours.'},
};

const AVATARS = ['üßë','üë©','üßî','üëµ','üßí','üëß','üßë‚Äçü¶±','üßë‚Äçü¶≥','üßë‚Äçü¶∞','üßë‚Äçü¶≤','üßï','üßõ','üßô','üßù','üßü','üßú','üßö','üé©'];

const ALL_EVENTS = [
  {name:'Brouillard',            icon:'üå´Ô∏è',desc:'Personne ne peut parler pendant une minute.'},
  {name:'Silence',               icon:'ü§´',desc:'Un joueur est r√©duit au silence pour ce tour.'},
  {name:'Double Vote',           icon:'üó≥Ô∏è',desc:'Tous les votes comptent double ce jour.'},
  {name:'Vote Invers√©',          icon:'üîÉ',desc:'Le joueur avec le plus de votes est sauv√©.'},
  {name:'Deux Morts Cette Nuit', icon:'üíÄ',desc:'La nuit devient doublement meurtri√®re.'},
  {name:'Immunit√© Al√©atoire',    icon:'üõ°Ô∏è',desc:'Un joueur devient intouchable pour un tour.'},
  {name:'Retour des Morts',      icon:'üëª',desc:'Un joueur √©limin√© revient pour un tour.'},
  {name:'Nouveau Maire',         icon:'üëë',desc:'Un joueur est d√©sign√© Maire ce tour. Il garde son r√¥le de base et vote deux fois aujourd\'hui.'},
  {name:'Pi√®ge Explosif',        icon:'üí£',desc:'Si le joueur pi√©g√© est vot√©, deux autres meurent.'},
  {name:'Voyante Aveugl√©e',      icon:'üëÅÔ∏è',desc:'La Voyante re√ßoit une information fausse.'},
  {name:'Potion Retrouv√©e',      icon:'üß™',desc:'La Sorci√®re r√©cup√®re une potion utilis√©e.'},
  {name:'Duel Obligatoire',      icon:'‚öîÔ∏è',desc:'Deux joueurs s\'affrontent ; le village vote pour l\'un.'},
  {name:'D√©bat Limit√©',          icon:'‚è±Ô∏è',desc:'Seulement une minute pour discuter.'},
  {name:'Discussions Interdites',icon:'üö´',desc:'Vote imm√©diat sans d√©bat.'},
];

// ================================================================
// STATE
// ================================================================
let db = null;
let me = {name:'', avatar:'üßë', id:''};
let roomCode = '';
let isHost = false;
let unsubRoom = null;
let timerInterval = null;
let selectedAvC = 'üßë';
let selectedAvJ = 'üßë';
let selectedRoles = new Set(['Loup-Garou','Villageois','Voyante']);
let chatRendered = 0;
let narrQueue = [];
let narrActive = false;
let lastSeenLogLen = 0;
let lastSeenNarrLen = 0;
let localRoom = null; // cached room for timer

// ================================================================
// FIREBASE INIT
// ================================================================
(async function initFirebase() {
  try {
    if(!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'REMPLACEZ_ICI') {
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
          <div>
            <div style="font-size:3rem;margin-bottom:16px;">üî•</div>
            <div style="font-family:'Cinzel Decorative',serif;font-size:1.4rem;margin-bottom:12px;">Configuration Firebase manquante</div>
            <div style="color:#8a8070;font-size:.95rem;max-width:480px;line-height:1.7;">
              Ouvrez <strong>index.html</strong> dans un √©diteur de texte.<br>
              Cherchez <code style="background:rgba(255,255,255,.08);padding:2px 8px;border-radius:4px;">REMPLACEZ_ICI</code>
              et remplacez chaque valeur par vos cl√©s Firebase.<br><br>
              Voir <strong>README.md</strong> pour les instructions compl√®tes.
            </div>
          </div>
        </div>`;
      return;
    }
    const app = window._fb.initializeApp(FIREBASE_CONFIG);
    db = window._fb.getDatabase(app);
    console.log('‚úÖ Firebase connect√©');
  } catch(e) {
    console.error('Firebase init failed:', e);
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
        <div>
          <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
          <div style="font-family:'Cinzel Decorative',serif;font-size:1.2rem;margin-bottom:12px;">Erreur de connexion Firebase</div>
          <div style="color:#8a8070;font-size:.9rem;max-width:480px;line-height:1.7;">${e.message}<br><br>V√©rifiez vos cl√©s dans index.html ‚Äî notamment <strong>databaseURL</strong>.</div>
        </div>
      </div>`;
  }
})();

// ================================================================
// UTILS
// ================================================================
function genId() { return Math.random().toString(36).substr(2,9) + Date.now().toString(36); }
function genCode() { return String(Math.floor(100000 + Math.random() * 900000)); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function dbRef(path) { return window._fb.ref(db, path); }
async function dbSet(path, val) { await window._fb.set(dbRef(path), val); }
async function dbUpdate(path, val) { await window._fb.update(dbRef(path), val); }
async function dbGet(path) { const s = await window._fb.get(dbRef(path)); return s.exists() ? s.val() : null; }
function dbListen(path, cb) { return window._fb.onValue(dbRef(path), snap => cb(snap.exists() ? snap.val() : null)); }

// ================================================================
// SCREENS
// ================================================================
window.showScreen = function(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(name+'-screen').classList.add('active');
  if(name==='welcome'||name==='lobby'||name==='create'||name==='join'){
    if(audioEnabled && !ambientSource) startAmbient();
  } else if(name==='game'){ stopAmbient(); }
};

function buildAvatarPicker(id, onSel, defVal) {
  const c = document.getElementById(id);
  if(!c) return;
  c.innerHTML = '';
  AVATARS.forEach((a,i) => {
    const b = document.createElement('button');
    b.className = 'av-btn' + (i===0?' selected':'');
    b.textContent = a;
    b.onclick = () => {
      c.querySelectorAll('.av-btn').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
      onSel(a);
    };
    c.appendChild(b);
  });
}
buildAvatarPicker('av-create', a => selectedAvC = a, 'üßë');
buildAvatarPicker('av-join',   a => selectedAvJ = a, 'üßë');

document.getElementById('j-code').addEventListener('input', function(){
  this.value = this.value.replace(/[^0-9]/g,'').substr(0,6);
});
document.getElementById('chat-in').addEventListener('keypress', e => { if(e.key==='Enter') sendChat(); });
document.getElementById('j-code').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });
document.getElementById('c-name').addEventListener('keypress', e => { if(e.key==='Enter') createGame(); });
document.getElementById('j-name').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });

window.copyCode = function() {
  navigator.clipboard.writeText(roomCode).then(() => {
    const b = document.querySelector('.copy-btn');
    if(b){const o=b.textContent;b.textContent='‚úÖ Copi√© !';setTimeout(()=>b.textContent=o,1500);}
  }).catch(()=>prompt('Code :',roomCode));
};

// ================================================================
// CREATE GAME
// ================================================================
window.createGame = async function() {
  const name = document.getElementById('c-name').value.trim();
  const err = document.getElementById('c-err');
  if(!name){err.textContent='‚ùå Entrez votre nom !';return;}
  me = {name, avatar:selectedAvC, id:genId()};
  isHost = true;
  roomCode = genCode();

  const room = {
    code: roomCode,
    status: 'lobby',
    host: me.id,
    settings: {roles:Array.from(selectedRoles), eventProb:30, nightDur:90, dayDur:180},
    game: null,
    chat: {},
    log: {},
    players: {}
  };
  room.players[me.id] = {name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false};

  await dbSet('rooms/'+roomCode, room);
  err.textContent = '';
  enterLobby();
};

// ================================================================
// JOIN GAME
// ================================================================
window.joinGame = async function() {
  const code = document.getElementById('j-code').value.trim().replace(/\D/g,'');
  const name = document.getElementById('j-name').value.trim();
  const err = document.getElementById('j-err');

  if(code.length!==6){err.style.color='#e07070';err.textContent='‚ùå Code invalide ‚Äî 6 chiffres';return;}
  if(!name){err.style.color='#e07070';err.textContent='‚ùå Entrez votre nom !';return;}

  err.style.color='var(--moon2)';err.textContent='üîç Connexion‚Ä¶';

  const room = await dbGet('rooms/'+code);
  if(!room){err.style.color='#e07070';err.textContent=`‚ùå Partie "${code}" introuvable.`;return;}
  if(room.status!=='lobby'){err.style.color='#e07070';err.textContent='‚ö†Ô∏è Partie d√©j√† en cours !';return;}

  const players = room.players ? Object.values(room.players) : [];
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase())){
    err.style.color='#e07070';err.textContent='‚ö†Ô∏è Ce nom est d√©j√† pris !';return;
  }

  me = {name, avatar:selectedAvJ, id:genId()};
  isHost = false;
  roomCode = code;

  await dbSet('rooms/'+code+'/players/'+me.id, {
    name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false
  });

  err.textContent='';
  enterLobby();
};

// ================================================================
// LOBBY
// ================================================================
function enterLobby() {
  loversNarrShown = false;
  chatRendered=0; wolfChatRendered=0; lastSeenLogLen=0; lastSeenNarrLen=0; narrQueue=[]; narrActive=false; shownDawnTurns=new Set();
  showScreen('lobby');
  document.getElementById('lobby-code').textContent = roomCode;
  if(isHost){
    document.getElementById('lobby-wait').style.display='none';
    document.getElementById('lobby-launch').style.display='block';
    buildHostSetup();
  }
  // Real-time listener
  if(unsubRoom) unsubRoom();
  unsubRoom = dbListen('rooms/'+roomCode, onRoomUpdate);
}

function buildHostSetup() {
  const div = document.getElementById('host-setup');
  div.innerHTML = `
    <div class="panel">
      <div class="p-title">üé≠ R√¥les actifs</div>
      <div class="roles-grid" id="roles-grid"></div>
    </div>
    <div class="panel">
      <div class="p-title">‚öôÔ∏è Param√®tres</div>
      <div class="dur-row">
        <div class="dur-field"><label>üåë Dur√©e Nuit (s)</label><input type="number" id="night-dur" value="90" min="20" max="300"></div>
        <div class="dur-field"><label>‚òÄÔ∏è Dur√©e Jour (s)</label><input type="number" id="day-dur" value="180" min="30" max="600"></div>
        <div class="dur-field"><label>üåÄ Prob. √âv√©nement %</label><input type="number" id="ev-prob" value="30" min="0" max="100"></div>
      </div>
    </div>`;

  const grid = document.getElementById('roles-grid');
  // Maire is a sur-r√¥le (event-only), never shown in selector
  const HIDDEN_ROLES = new Set(['Maire']);
  for(const [name,data] of Object.entries(ALL_ROLES)){
    if(HIDDEN_ROLES.has(name)) continue;
    const d = document.createElement('div');
    d.className=`role-tog ${data.camp} ${selectedRoles.has(name)?'on':''}`;
    d.innerHTML=`<span class="r-em">${data.emoji}</span>${name}`;
    d.onclick=()=>{
      if(selectedRoles.has(name)){selectedRoles.delete(name);d.classList.remove('on');}
      else{selectedRoles.add(name);d.classList.add('on');}
    };
    grid.appendChild(d);
  }
}

// ================================================================
// LAUNCH
// ================================================================
window.launchGame = async function() {
  const room = await dbGet('rooms/'+roomCode);
  if(!room) return;
  const players = room.players ? Object.values(room.players) : [];
  if(players.length < 3){
    document.getElementById('launch-err').textContent='‚ùå Il faut au moins 3 joueurs !'; return;
  }

  const nightDur = parseInt(document.getElementById('night-dur')?.value)||90;
  const dayDur   = parseInt(document.getElementById('day-dur')?.value)||180;
  const evProb   = parseInt(document.getElementById('ev-prob')?.value)||30;

  // Assign roles
  const roles = Array.from(selectedRoles);
  const shuffledRoles = [...roles].sort(()=>Math.random()-.5);
  const shuffledPlayers = [...players].sort(()=>Math.random()-.5);
  const playerUpdates = {};
  shuffledPlayers.forEach((p,i)=>{
    playerUpdates['rooms/'+roomCode+'/players/'+p.id+'/role'] = shuffledRoles[i%shuffledRoles.length];
  });
  await window._fb.update(window._fb.ref(db), playerUpdates);

  // Reload with roles
  const updatedRoom = await dbGet('rooms/'+roomCode);
  const updatedPlayers = Object.values(updatedRoom.players);

  // Cupidon ‚Äî don't auto-link; mark as pending so Cupidon player chooses
  let loversA=null, loversB=null;
  const cupidon = updatedPlayers.find(p=>p.role==='Cupidon');
  // loversA/loversB will be set by Cupidon's action at start of night 1

  // Mayor is now only a temporary "super-role" granted by events, not an assignable role

  // Election duration: 60s (chat + vote du maire)
  const mayorElectionDur = 60;
  const game = {
    phase:'mayor_election', turn:1,
    phaseEndTime: Date.now()+mayorElectionDur*1000,
    nightDur, dayDur, evProb,
    witchLifeUsed:false, witchDeathUsed:false, godUsed:false, chronoUsed:false, infectUsed:false,
    seerUsed:false, illusionUsedThisNight:false,
    fleaUsed:false, fleaTarget:null, fleaTurn:0, fleaInfected:false,
    hunterUsed:false, cupidonDone:false,
    loversA, loversB,
    currentEvent:null, victory:null,
    lastPhaseChange: Date.now(),
    mayorElected:false,
  };

  await dbUpdate('rooms/'+roomCode, {status:'playing', game,
    settings:{roles:Array.from(selectedRoles), eventProb:evProb, nightDur, dayDur}
  });

  await pushLog(`üëë La partie commence ! √âlisez votre Maire avant la premi√®re nuit.`, 'system');
  pushNarr({fire:'üëë',color:'#d4a017',title:'Avant la Premi√®re Nuit‚Ä¶',
    text:`Avant que l'obscurit√© ne s'abatte sur le village, les habitants se r√©unissent pour d√©signer un Maire. D√©battez librement, puis votez. Le Maire √©lu verra sa voix compter double lors des votes d'√©limination.`});
  if(audioEnabled) playGameStart();
};

// ================================================================
// ROOM UPDATE LISTENER
// ================================================================
function onRoomUpdate(room) {
  if(!room) return;
  localRoom = room;
  const players = room.players ? Object.values(room.players) : [];

  if(room.status==='lobby'){
    renderLobbyPlayers(players, room.host);
    document.getElementById('lobby-lbl').textContent = `${players.length} joueur${players.length>1?'s':''} connect√©${players.length>1?'s':''}`;
    return;
  }

  if(room.status==='playing'){
    if(!document.getElementById('game-screen').classList.contains('active')){
      showScreen('game'); startTimerLoop(); initVoicePanel();
    } else if(!timerInterval) { startTimerLoop(); }
    renderMyRole(room);
    updateGameView(room);
    renderChat(room);
    checkNewLogNarr(room);
    checkNewNarr(room);
    checkDawnWhisper(room);
    checkLoversNarr(room);
  }

  if(room.status==='ended' && room.game?.victory){
    clearInterval(timerInterval);
    if(unsubRoom) unsubRoom();
    showVictory(room.game.victory);
  }
}

function renderLobbyPlayers(players, hostId) {
  const grid = document.getElementById('lobby-players');
  grid.innerHTML='';
  players.forEach(p=>{
    const d=document.createElement('div');
    d.className=`lp-tile ${p.id===hostId?'host':''}`;
    d.innerHTML=`<div class="lp-av">${p.avatar}</div><div class="lp-name">${esc(p.name)}</div>${p.id===me.id?'<div class="lp-badge">üë§ Vous</div>':''}${p.id===hostId?'<div class="lp-badge" style="color:var(--ember)">üéÆ H√¥te</div>':''}`;
    grid.appendChild(d);
  });
}

// ================================================================
// GAME VIEW
// ================================================================
function updateGameView(room) {
  if(!room.game) return;
  const g = room.game;
  const players = room.players ? Object.values(room.players) : [];
  const isNight = g.phase==='night';
  const myP = players.find(p=>p.id===me.id);
  const myRole = myP?.role || '';
  const isWolf = ['Loup-Garou','Loup Blanc','Loup Enrag√©','Loup Infectieux','Loup aux Puces'].includes(myRole);

  // Phase bar
  const isMayorElection = g.phase === 'mayor_election';
  const bar = document.getElementById('phase-bar');
  if(isMayorElection){
    bar.className = 'phase-bar is-night';
    document.getElementById('ph-icon').textContent = 'üëë';
    document.getElementById('ph-name').textContent = '√âlection du Maire';
    document.getElementById('ph-desc').textContent = 'D√©battez et votez pour √©lire votre Maire avant la premi√®re nuit.';
  } else {
    bar.className = 'phase-bar ' + (isNight ? 'is-night' : 'is-day');
    document.getElementById('ph-icon').textContent = isNight ? 'üåë' : '‚òÄÔ∏è';
    document.getElementById('ph-name').textContent = isNight ? `Nuit ${g.turn}` : `Jour ${g.turn}`;
    document.getElementById('ph-desc').textContent = isNight
      ? 'Le village ferme les yeux‚Ä¶ les cr√©atures s\'√©veillent.'
      : 'L\'aube se l√®ve. Le village doit trouver le coupable.';
  }
  const turnBadge = document.getElementById('ph-turn-badge');
  if(turnBadge) turnBadge.textContent = isMayorElection ? '√âlection' : `Tour ${g.turn}`;

  // Wolf chat visibility (night only for wolves, not during election)
  const wolfPanel = document.getElementById('wolf-chat-panel');
  if(wolfPanel) wolfPanel.style.display = (isWolf && isNight && !isMayorElection) ? 'block' : 'none';

  renderPlayers(players);
  renderActions(room);
  renderEvent(g);
  renderWolfChat(room);
  renderNecroChat(room);
  updateChatInputState(g);
}

function renderMyRole(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  if(!myP) return;
  const rd = ALL_ROLES[myP.role];
  if(!rd) return;
  document.getElementById('r-em').textContent = rd.emoji;
  document.getElementById('r-name').textContent = myP.role;
  document.getElementById('r-camp').textContent = {loup:'‚öîÔ∏è Camp des Loups',village:'üåæ Camp du Village',neutre:'üé≠ R√¥le Neutre'}[rd.camp];
  document.getElementById('r-camp').className = 'role-camp '+rd.camp;
  let desc = rd.desc;
  if(myP.usurpedFrom && room.game?.usurpDone){
    document.getElementById('r-name').textContent = myP.role+' üé≠';
    desc = rd.desc+'\n\nüé≠ Vol√© √† '+myP.usurpedFrom;
  }
  if(myP.lovers && room.game){
    const g = room.game;
    const loverId = g.loversA===me.id ? g.loversB : g.loversA;
    const lover = Object.values(room.players).find(p=>p.id===loverId);
    if(lover) desc += ` ‚ù§Ô∏è Vous √™tes amoureux(se) de ${lover.name}.`;
  }
  document.getElementById('r-desc').textContent = desc;
  const card = document.getElementById('my-role-card');
  card.className = 'my-role-card ' + rd.camp;
}

function renderPlayers(players) {
  const grid = document.getElementById('g-players');
  const deadChips = document.getElementById('dead-chips');
  grid.innerHTML=''; deadChips.innerHTML='';
  let hasDead=false;

  players.forEach(p=>{
    if(!p.alive){
      hasDead=true;
      const c=document.createElement('div');
      c.className='dead-chip';
      c.textContent=`${p.avatar} ${p.name}`;
      deadChips.appendChild(c);
      return;
    }
    const d=document.createElement('div');
    const isMe=p.id===me.id;
    d.className=`p-tile ${isMe?'me':''} ${p.mayor?'mayor':''} ${p.lovers?'lover':''} ${p.protected?'protected':''}`;
    const rd=ALL_ROLES[p.role];
    const roleShow = isMe && rd ? `<div class="t-role">${rd.emoji} ${p.role}</div>` : '';
    d.innerHTML=`<div class="t-av">${p.avatar}</div><div class="t-name">${esc(p.name)}${isMe?' (vous)':''}</div>${roleShow}`;
    grid.appendChild(d);
  });
  document.getElementById('dead-zone').style.display=hasDead?'block':'none';
}

function renderActions(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  const btns = document.getElementById('a-btns');
  btns.innerHTML='';

  if(!myP){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">En attente‚Ä¶</div>';return;}
  if(!myP.alive){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">‚ò†Ô∏è Vous √™tes √©limin√©(e). Observez les vivants en silence‚Ä¶</div>';return;}

  // ‚îÄ‚îÄ Mayor Election Phase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const g = room.game;
  if(g?.phase==='mayor_election'){
    const mayorVotes = g.mayorVotes || {};
    const myMayorVote = mayorVotes[myP.id];
    const tally = {};
    Object.values(mayorVotes).forEach(tid=>{ tally[tid]=(tally[tid]||0)+1; });
    const tallyStr = Object.entries(tally).sort((a,b)=>b[1]-a[1])
      .map(([id,v])=>{ const p=players.find(x=>x.id===id); return `${p?.avatar||''} ${p?.name||'?'} <strong style="color:var(--moon)">${v} vote${v>1?'s':''}</strong>`; })
      .join(' &nbsp;¬∑&nbsp; ');
    const votedCount = Object.keys(mayorVotes).length;
    const aliveMayor=players.filter(p=>p.alive);
    const aliveCount = aliveMayor.length;
    const pct = aliveCount>0 ? Math.round(votedCount/aliveCount*100) : 0;

    btns.innerHTML = `
      <div style="font-family:'Cinzel Decorative',serif;font-size:.82rem;color:var(--moon);margin-bottom:10px;text-align:center;">
        üëë √âlection du Maire
      </div>
      <div style="font-size:.8rem;color:var(--smoke);font-style:italic;margin-bottom:10px;text-align:center;">
        D√©battez dans le chat et votez pour √©lire votre Maire.<br>
        Il gardera son r√¥le de base, mais votera deux fois lors des votes.
      </div>`;

    if(tallyStr){
      btns.innerHTML += `<div style="font-size:.78rem;color:var(--smoke);font-style:italic;margin-bottom:6px;">${tallyStr}</div>`;
    }
    btns.innerHTML += `<div style="background:rgba(255,255,255,.06);border-radius:4px;height:4px;overflow:hidden;margin-bottom:10px;">
      <div style="background:var(--moon);height:100%;width:${pct}%;transition:width .4s;"></div>
    </div>`;

    if(!myMayorVote){
      if(aliveMayor.every(p=>mayorVotes[p.id])){
        btns.innerHTML+=`<div class="a-used" style="text-align:center">üèÅ Tous ont vot√© ‚Äî r√©solution‚Ä¶</div>`;
      } else { const candidates=players.filter(p=>p.alive); candidates.forEach(p=>{
        const btn = document.createElement('button');
        btn.className = 'a-btn';
        btn.style.cssText = 'background:rgba(180,140,30,.15);border-color:rgba(200,160,50,.3);color:var(--moon);margin-bottom:4px;';
        btn.innerHTML = `${p.avatar} ${esc(p.name)}${p.id===myP.id?' (moi)':''}`;
        btn.onclick = () => voteForMayor(p.id);
        btns.appendChild(btn); }); }
    } else {
      const voted = players.find(p=>p.id===myMayorVote);
      btns.innerHTML += `<div class="a-used" style="color:var(--moon);">‚úÖ Vot√© pour ${voted?.avatar||''} ${esc(voted?.name||'?')} ‚Äî en attente des autres‚Ä¶</div>`;
    }
    if(myP.mayor){
      btns.innerHTML += `<div style="font-size:.8rem;color:var(--moon);margin-top:8px;font-style:italic;text-align:center;">üëë Vous √™tes le Maire actuel (√©lu au tour pr√©c√©dent)</div>`;
    }
    return; // stop here ‚Äî no other actions during election
  }

  const role = myP.role;

  const add = (lbl,cls,fn) => {
    const b=document.createElement('button');
    b.className='a-btn '+cls; b.innerHTML=lbl; b.onclick=fn; btns.appendChild(b);
  };

  // Role-specific flavor text
  const ROLE_NIGHT_MSG = {
    'Loup-Garou':     'üê∫ La nuit vous appartient. Coordonnez-vous avec vos fr√®res pour choisir une proie.',
    'Loup Blanc':     'ü§ç Jouez avec les loups‚Ä¶ mais gardez vos propres int√©r√™ts en t√™te. La trahison viendra en son temps.',
    'Loup Enrag√©':    'üî• Votre rage gronde. Cette nuit, d√©signez votre cible ‚Äî et parfois, frappez deux fois.',
    'Loup Infectieux':'ü¶† Vous pouvez tuer‚Ä¶ ou infecter. Transformer un villageois en loup peut changer la partie.',
    'Loup aux Puces': 'üêú Vous semez vos puces en secret. La victime ne le saura pas tout de suite‚Ä¶ mais elle deviendra l\'un des v√¥tres.',
    'Voyante':        'üîÆ Vos yeux percent les secrets. Choisissez un joueur pour r√©v√©ler sa vraie nature.',
    'Sorci√®re':       'üß™ Vos potions sont pr√©cieuses. Une seule vie, une seule mort ‚Äî utilisez-les √† bon escient.',
    'Garde du Corps': 'üõ°Ô∏è Qui prot√©ger cette nuit ? Si votre prot√©g√© est attaqu√©, vous vous sacrifierez √† sa place.',
    'Dieu du Village':'‚ú® Le destin lui-m√™me peut √™tre annul√© par votre volont√© divine.',
    'Chronomancien':  '‚è≥ Le temps ob√©it √† vos ordres. Rembobiner un tour pourrait tout changer.',
    'N√©cromancien':   'üíÄ Les morts ont des secrets que les vivants ignorent. √âcoutez leurs murmures.',
    'Chasseur':       'üèπ Cette nuit, attendez. Si l\'on vous tue, vous emporterez quelqu\'un avec vous.',
    'Cupidon':        'üíò Les amoureux ont d√©j√† √©t√© li√©s. Observez et pr√©parez votre strat√©gie.',
    'Maire':          'üëë Vous √™tes le Maire ‚Äî votre voix compte double au village. M√©ritez cette confiance.',
    'Villageois':     'üë®‚Äçüåæ Aucun pouvoir, mais vos yeux sont vos armes. Observez qui ment le jour venu.',
    'Illusionniste':  'ü™Ñ Vous pouvez semer la confusion dans l\'esprit de la Voyante‚Ä¶',
    'Hypnotiseur':    'üåÄ Pr√©parez votre prochaine suggestion. Demain, quelqu\'un votera comme vous le dictez.',
    'Usurpateur':     'üé≠ Vous pouvez copier le pouvoir d\'un autre. Choisissez bien votre cible.',
    'Avocat':         '‚öñÔ∏è Un joueur sera prot√©g√© de l\'√©limination lors du prochain vote. Qui m√©rite votre d√©fense ?',
    'Tra√Ætre':        'üó°Ô∏è Pour l\'instant, vous semblez √™tre un villageois. Votre loyaut√© changera bient√¥t‚Ä¶',
    'Marionnettiste': 'üßµ Vos fils de contr√¥le sont pr√™ts. Un joueur fera cette nuit ce que vous d√©cidez.',
  };

  const ROLE_DAY_MSG = {
    'Loup-Garou':     'üê∫ Dissimulez-vous parmi les villageois. Accusez, semez le doute, survivez.',
    'Loup Blanc':     'ü§ç Ni vraiment loup, ni vraiment villageois. Manipulez tout le monde pour rester seul en vie.',
    'Loup Enrag√©':    'üî• Le jour, vous √™tes un loup comme les autres. Mentez mieux.',
    'Loup Infectieux':'ü¶† Votre infection est sem√©e. Il ne reste qu\'√† attendre‚Ä¶ et faire bonne figure.',
    'Loup aux Puces': 'üêú La contamination progresse en secret. Restez discret.',
    'Voyante':        'üîÆ Vous savez des choses que les autres ignorent. √Ä vous de guider le village sans vous d√©voiler.',
    'Sorci√®re':       'üß™ Vous connaissez vos potions. Guidez les votes avec sagesse.',
    'Garde du Corps': 'üõ°Ô∏è Votre r√¥le est connu de vous seul. Votez intelligemment.',
    'Dieu du Village':'‚ú® Votez avec les autres. Votre pouvoir sacr√© peut encore sauver quelqu\'un si n√©cessaire.',
    'Chronomancien':  '‚è≥ Le temps est pr√©cieux. Participez aux d√©bats, votre pouvoir attend le bon moment.',
    'N√©cromancien':   'üíÄ Les murmures des morts vous ont √©clair√©(e). Utilisez cette connaissance prudemment.',
    'Chasseur':       'üèπ Participez aux d√©bats. Si vous √™tes √©limin√©, vous choisissez qui vous suit dans la mort.',
    'Cupidon':        'üíò Les amoureux que vous avez li√©s sont dans la partie. Leur destin est d√©sormais li√©.',
    'Maire':          'üëë Votre voix compte double. Guidez le vote du village vers la v√©rit√©.',
    'Villageois':     'üë®‚Äçüåæ Analysez, accusez, d√©fendez-vous. C\'est tout ce que vous avez ‚Äî et √ßa peut suffire.',
    'Illusionniste':  'ü™Ñ La confusion que vous semez prot√®ge les loups ou vous-m√™me. Observez les r√©actions.',
    'Hypnotiseur':    'üåÄ Votre suggestion est active. Observez si votre cible vote comme pr√©vu.',
    'Usurpateur':     'üé≠ Vous avez (peut-√™tre) copi√© un pouvoir. Utilisez-le √† bon moment.',
    'Avocat':         '‚öñÔ∏è Votre client est prot√©g√© ce vote. Mais pour combien de temps ?',
    'Tra√Ætre':        'üó°Ô∏è Pour l\'instant villageois. Bient√¥t, vous changerez de camp.',
    'Marionnettiste': 'üßµ Vos fils tirent dans l\'ombre. Observez les cons√©quences.',
  };

  const msg = g.phase==='night' ? (ROLE_NIGHT_MSG[role]||'Observez et attendez‚Ä¶') : (ROLE_DAY_MSG[role]||'Participez aux d√©bats.');
  const camp = ALL_ROLES[role]?.camp || 'village';
  btns.innerHTML=`<div class="a-flavor ${camp}">${msg}</div>`;

  if(g.phase==='night'){
    // Wolf roles
    if(['Loup-Garou','Loup Blanc','Loup aux Puces'].includes(role)){
      if(!g.wolfVotes?.[me.id]) add('üê∫ D√©signer la victime','red',()=>wolfVoteModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üê∫ Cible d√©sign√©e ‚Äî attendez le r√©sultat'}));
    }
    if(role==='Loup Enrag√©'){
      const isRageNight = (g.turn%3===0);
      if(isRageNight){
        if(!g.wolfVotes?.[me.id]) add('üî• Nuit enrag√©e ‚Äî tuer 2 cibles','red',()=>wolfRageModal(room));
        else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üî• Cibles enrag√©es d√©sign√©es'}));
      } else {
        if(!g.wolfVotes?.[me.id]) add('üê∫ D√©signer la victime','red',()=>wolfVoteModal(room));
        else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üê∫ Cible d√©sign√©e ‚Äî attendez le r√©sultat'}));
      }
    }
    if(role==='Loup Infectieux'){
      if(!g.wolfVotes?.[me.id]) add('üê∫ D√©signer la victime','red',()=>wolfVoteModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üê∫ Cible d√©sign√©e'}));
      if(!g.infectUsed) add('ü¶† Infecter (au lieu de tuer)','red',()=>infectModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'ü¶† Infection d√©j√† utilis√©e'}));
    }
    // Village roles ‚Äî check seerUsed (reset each night)
    if(role==='Voyante'){
      if(!g.seerUsed) add('üîÆ Voir un r√¥le','green',()=>seerModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üîÆ Vous avez d√©j√† regard√© cette nuit'}));
    }
    if(role==='Sorci√®re'){
      if(!g.witchLifeUsed) add('üß™ Potion de Vie','green',()=>witchLifeModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üß™ Potion de vie √©puis√©e'}));
      if(!g.witchDeathUsed) add('‚ò†Ô∏è Potion de Mort','red',()=>witchDeathModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚ò†Ô∏è Potion de mort √©puis√©e'}));
    }
    if(role==='Garde du Corps')                add('üõ°Ô∏è Prot√©ger un joueur','green',()=>protectModal(room));
    if(role==='Dieu du Village'){
      if(!g.godUsed) add('‚ú® Annuler une mort','purple',()=>godModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚ú® Pouvoir divin d√©j√† utilis√©'}));
    }
    if(role==='Chronomancien'){
      if(!g.chronoUsed && (g.turn||1) > 1) add('‚è≥ Rembobiner un tour','purple',()=>chronoAction());
      else if(g.chronoUsed) btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚è≥ Rembobinage d√©j√† utilis√©'}));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚è≥ Impossible de rembobiner √† la premi√®re nuit'}));
    }
    if(role==='N√©cromancien')                  add('üíÄ Consulter les morts','purple',()=>necroModal(room));
    if(role==='Cupidon'){
      if(!g.cupidonDone) add('üíò Lier deux amoureux','green',()=>cupidonModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üíò Amoureux d√©j√† li√©s'}));
    }
    // Neutral roles
    if(role==='Illusionniste'){
      const illuCooldown = g.illusionCooldownLength || 2;
      const illuLastTurn = g.illusionLastTurn || 0;
      const illuReady = !illuLastTurn || (g.turn||1) - illuLastTurn >= illuCooldown;
      if(illuReady) add('ü™Ñ Fausser la Voyante','purple',()=>illusionModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'ü™Ñ Pouvoir en recharge‚Ä¶ encore '+((illuLastTurn+illuCooldown)-(g.turn||1))+' tour(s)'}));
    }
    if(role==='Hypnotiseur')                   add('üåÄ Hypnotiser','purple',()=>hypnoModal(room));
    if(role==='Usurpateur'){
      if(!g.usurpDone) add('üé≠ Usurper un r√¥le','purple',()=>usurpModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üé≠ R√¥le d√©j√† usurp√© ‚Äî pouvoir permanent actif'}));
    }
    if(role==='Marionnettiste'){
      const pCooldown = g.puppetCooldownLength || 2;
      const pLastTurn = g.puppetUsedTurn || 0;
      const pReady = !pLastTurn || (g.turn||1) - pLastTurn >= pCooldown;
      if(pReady) add('üßµ Contr√¥ler un joueur','purple',()=>puppetModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üßµ Recharge‚Ä¶ encore '+((pLastTurn+pCooldown)-(g.turn||1))+' nuit(s)'}));
    }
    if(role==='Loup aux Puces'&&!g.fleaUsed)   add('üêú Infecter lentement','red',()=>fleaModal(room));
  } else {
    // DAY ‚Äî vote system
    const votes = g.dayVotes || {};
    const alivePlayers = players.filter(p=>p.alive);
    const votedCount = alivePlayers.filter(p=>votes[p.id]).length;
    const myVote = votes[me.id];
    
    // Show fog/silence status banners
    if(g.fogEnd && Date.now()<g.fogEnd){
      const secs=Math.ceil((g.fogEnd-Date.now())/1000);
      btns.innerHTML += `<div style="background:rgba(100,100,150,.15);border:1px solid rgba(150,150,200,.3);border-radius:8px;padding:8px 12px;font-size:.82rem;color:#a0a0d0;font-style:italic;">üå´Ô∏è Brouillard ‚Äî Chat d√©sactiv√© encore ${secs}s</div>`;
    }
    if(g.silencedPlayer===me.id && g.silencedTurn===(g.turn||1)){
      btns.innerHTML += `<div style="background:rgba(100,80,50,.15);border:1px solid rgba(180,140,80,.3);border-radius:8px;padding:8px 12px;font-size:.82rem;color:#c0a070;font-style:italic;">ü§´ Vous √™tes r√©duit(e) au silence ce tour</div>`;
    }
    if(g.noDebate){
      btns.innerHTML += `<div style="background:rgba(120,20,20,.15);border:1px solid rgba(200,40,40,.3);border-radius:8px;padding:8px 12px;font-size:.82rem;color:#e07070;font-style:italic;">üö´ Discussions interdites ‚Äî Le chat est d√©sactiv√© ce tour.</div>`;
    }
    if(g.duelActive && g.duelA && g.duelB){
      const pA=players.find(p=>p.id===g.duelA);
      const pB=players.find(p=>p.id===g.duelB);
      btns.innerHTML += `<div style="background:rgba(100,60,0,.2);border:1px solid rgba(200,140,40,.4);border-radius:8px;padding:10px 12px;font-size:.85rem;color:#e0a040;margin-bottom:6px;">‚öîÔ∏è <strong>Duel Obligatoire !</strong><br><span style="font-size:.78rem;color:var(--smoke);">Votez uniquement pour ${pA?.name||'?'} ou ${pB?.name||'?'}</span></div>`;
    }

    // Vote progress bar
    const pct = alivePlayers.length > 0 ? Math.round(votedCount/alivePlayers.length*100) : 0;
    btns.innerHTML += `<div style="margin-bottom:8px;">
      <div style="font-size:.75rem;color:var(--smoke);margin-bottom:4px;font-style:italic;">üìä ${votedCount}/${alivePlayers.length} joueurs ont vot√©</div>
      <div style="background:rgba(255,255,255,.06);border-radius:4px;height:4px;overflow:hidden;">
        <div style="background:var(--blood2);height:100%;width:${pct}%;transition:width .4s;"></div>
      </div>
    </div>`;

    // Show current tally if any votes
    if(votedCount > 0){
      const tally = {};
      Object.entries(votes).forEach(([vid,tid])=>{
        const w = players.find(p=>p.id===vid)?.mayor ? 2 : 1;
        tally[tid] = (tally[tid]||0)+w;
      });
      const tallyStr = Object.entries(tally).sort((a,b)=>b[1]-a[1])
        .map(([id,v])=>{ const p=players.find(x=>x.id===id); return `${p?.avatar||''} ${p?.name||'?'} <strong style="color:#e07070">${v}</strong>`; })
        .join(' &nbsp;¬∑&nbsp; ');
      btns.innerHTML += `<div style="font-size:.78rem;color:var(--smoke);font-style:italic;margin-bottom:6px;">${tallyStr}</div>`;
    }

    if(!myVote){
      add('‚öñÔ∏è Voter pour √©liminer','red',()=>voteModal(room));
    } else {
      const target = players.find(p=>p.id===myVote);
      btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:`‚úÖ Vot√© contre ${target?.name||'?'} ‚Äî en attente des autres‚Ä¶`}));
    }
    if(role==='Dieu du Village'&&!g.godUsed) add('‚ú® Annuler une √©lim.','purple',()=>godModal(room));
    if(role==='Avocat'){
      const aLT=g.advocateUsedTurn||0,aCD=g.advocateCooldownLength||2;
      if(!aLT||(g.turn||1)-aLT>=aCD) add('‚öñÔ∏è Prot√©ger du vote','purple',()=>advocateModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚öñÔ∏è Recharge dans '+((aLT+aCD)-(g.turn||1))+' tour(s)'}));
    }
    if(role==='Maire'||myP?.mayor) add('üëë Passer la couronne','',()=>mayorPassModal(room));
  }
}

function renderEvent(g) {
  const card = document.getElementById('ev-card');
  if(!g.currentEvent){card.style.display='none';return;}
  card.style.display='block';
  const ev=g.currentEvent;
  card.innerHTML=`<div class="ev-big">${ev.icon}</div><div class="ev-title">${esc(ev.name)}</div><div class="ev-desc">${esc(ev.desc)}</div>`;
}


// ================================================================
// TIMER
// ================================================================
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    const g = localRoom?.game;
    if(!g||!g.phaseEndTime) return;
    const rem = Math.max(0, Math.ceil((g.phaseEndTime - Date.now())/1000));
    const el = document.getElementById('ph-timer');
    if(el){el.textContent=rem+'s'; el.className='ph-timer'+(rem<=10?' urgent':'');}
    if(rem<=0) {
      clearInterval(timerInterval);
      timerInterval = null;
      const players = localRoom?.players ? Object.values(localRoom.players) : [];
      const alive = players.filter(p=>p.alive);
      const coordinator = alive.length > 0 ? alive.sort((a,b)=>a.id.localeCompare(b.id))[0] : null;
      if(coordinator && coordinator.id === me.id) {
        if(g.phase === 'mayor_election'){
          (async()=>{
            const freshG = await dbGet('rooms/'+roomCode+'/game');
            if(freshG?.phase === 'mayor_election' && !freshG?.mayorResolved){
              resolveMayorElection();
            }
          })();
        } else if(g.phase === 'day'){
          // On day timeout, auto-resolve votes with whoever has most
          (async()=>{
            const room = await dbGet('rooms/'+roomCode);
            const votes = room?.game?.dayVotes || {};
            if(Object.keys(votes).length > 0){
              await resolveVote(room);
            } else {
              await switchPhase('night');
            }
          })();
        } else {
          switchPhase('day');
        }
      } else if(!coordinator) {
        if(isHost){
          if(g.phase==='mayor_election') resolveMayorElection();
          else if(g.phase==='night') switchPhase('day');
          else switchPhase('night');
        }
      }
    }
  }, 500);
}

// ================================================================
// NIGHT KILL RESOLUTION ‚Äî called when switching night ‚Üí day
// ================================================================
async function resolveNightKill(g){
  // Re-kill ghost (Retour des Morts) if active
  if(g?.ghostPlayerId){
    const ghostRoom = await dbGet('rooms/'+roomCode);
    const ghost = ghostRoom?.players?.[g.ghostPlayerId];
    if(ghost?.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+g.ghostPlayerId,{alive:false});
      await pushLog(`üëª ${ghost.name} retourne dans l'au-del√†‚Ä¶`,'night');
    }
    await dbUpdate('rooms/'+roomCode+'/game',{ghostPlayerId:null});
  }

  // Voyante Aveugl√©e: clear flag
  if(g?.eventSeerBlinded){
    await dbUpdate('rooms/'+roomCode+'/game',{eventSeerBlinded:false});
  }
  // Clear silence
  if(g?.silencedPlayer){
    await dbUpdate('rooms/'+roomCode+'/game',{silencedPlayer:null, silencedTurn:null});
  }
  // Clear fog
  if(g?.fogEnd){
    await dbUpdate('rooms/'+roomCode+'/game',{fogEnd:null});
  }
  // Clear eventTwoDeaths (already applied this night)
  // (done after kills below)

  const wolfVotes = g?.wolfVotes || {};
  if(!Object.keys(wolfVotes).length){
    await dbUpdate('rooms/'+roomCode+'/game',{eventTwoDeaths:false});
    return;
  }

  // Tally wolf votes
  const tally = {};
  Object.values(wolfVotes).forEach(tid=>{ tally[tid]=(tally[tid]||0)+1; });
  const max = Math.max(...Object.values(tally));
  const top = Object.keys(tally).filter(id=>tally[id]===max);
  const targetId = top[Math.floor(Math.random()*top.length)];

  await killPlayer(targetId, 'nuit');

  // Deux Morts Cette Nuit: kill a second random alive non-wolf
  if(g?.eventTwoDeaths){
    const freshRoom = await dbGet('rooms/'+roomCode);
    const alive = Object.values(freshRoom?.players||{}).filter(p=>p.alive&&p.id!==targetId);
    if(alive.length>0){
      const second = alive[Math.floor(Math.random()*alive.length)];
      await pushLog(`üíÄ La nuit r√©clame une seconde victime‚Ä¶`,'night');
      await killPlayer(second.id,'nuit');
    }
    await dbUpdate('rooms/'+roomCode+'/game',{eventTwoDeaths:false});
  }
}

// ================================================================
// PHASE SWITCH
// ================================================================
// ================================================================
// MAYOR ELECTION
// ================================================================
window.voteForMayor = async function(candidateId){
  const room = await dbGet('rooms/'+roomCode);
  const g = room?.game;
  if(g?.phase !== 'mayor_election') return;
  if(g?.mayorResolved) return; // already resolving
  const players = Object.values(room.players||{});
  const myP = players.find(p=>p.id===me.id);
  if(!myP?.alive) return;
  if(g?.mayorVotes?.[myP.id]) return; // already voted

  await dbUpdate('rooms/'+roomCode+'/game',{
    [`mayorVotes/${myP.id}`]: candidateId
  });
  await pushLog(`üëë ${myP.name} a vot√©.`, 'info');

  // Check if everyone has voted ‚Üí resolve immediately
  const fresh = await dbGet('rooms/'+roomCode);
  const freshG = fresh?.game;
  if(freshG?.mayorResolved) return; // someone else already resolving
  const alive = Object.values(fresh.players||{}).filter(p=>p.alive);
  const votes = freshG?.mayorVotes || {};
  const allVoted = alive.length > 0 && alive.every(p=>votes[p.id]);
  if(allVoted){
    // Atomic claim: only the alphabetically first player among alive resolves
    const coordinator = [...alive].sort((a,b)=>a.id.localeCompare(b.id))[0];
    if(coordinator.id === me.id){
      await resolveMayorElection();
    }
  }
};

async function resolveMayorElection(){
  const room = await dbGet('rooms/'+roomCode);
  const g = room?.game;
  if(!g || g.phase !== 'mayor_election') return;
  if(g.mayorResolved) return; // already done by another client

  // --- ATOMIC LOCK: claim resolution immediately ---
  await dbUpdate('rooms/'+roomCode+'/game', {mayorResolved: true, phase: 'resolving_mayor'});

  // Re-read to confirm we got the lock (simple optimistic approach)
  const locked = await dbGet('rooms/'+roomCode+'/game');
  if(locked?.phase !== 'resolving_mayor') return; // someone else won

  const players = Object.values(room.players||{});
  const alive = players.filter(p=>p.alive);
  const votes = g.mayorVotes || {};

  // Tally
  const tally = {};
  Object.values(votes).forEach(tid=>{ tally[tid]=(tally[tid]||0)+1; });

  let electedId;
  if(!Object.keys(tally).length){
    electedId = alive[Math.floor(Math.random()*alive.length)]?.id;
  } else {
    const maxV = Math.max(...Object.values(tally));
    const top = Object.keys(tally).filter(id=>tally[id]===maxV);
    electedId = top[Math.floor(Math.random()*top.length)];
  }

  const elected = players.find(p=>p.id===electedId);
  if(!elected) return;

  // Set mayor flag ‚Äî ONLY for the elected, clear all others first
  const upd = {};
  players.forEach(p=>{ upd['rooms/'+roomCode+'/players/'+p.id+'/mayor'] = false; });
  upd['rooms/'+roomCode+'/players/'+electedId+'/mayor'] = true;
  upd['rooms/'+roomCode+'/game/mayorElected'] = true;
  upd['rooms/'+roomCode+'/game/mayorVotes'] = null;
  // Keep mayorResolved = true so the listener never re-triggers this
  await window._fb.update(window._fb.ref(db), upd);

  await pushLog(`üëë ${elected.name} est √©lu(e) Maire du village !`, 'system');
  pushNarr({fire:'üëë',color:'#d4a017',title:'Le Village a Parl√©',
    text:`Apr√®s d√©lib√©ration, le village a d√©sign√© ${elected.name} comme Maire. Sa voix comptera double lors des votes. Qu'il guide le village avec sagesse‚Ä¶ ou trahise leur confiance.`});

  // Transition directly to Night 1 (no event before night 1)
  await switchPhaseFromElection();
}

async function switchPhaseFromElection(){
  // Special: go from mayor_election straight to night 1 without resetting mayor
  const room = await dbGet('rooms/'+roomCode);
  if(!room?.game) return;
  const g = room.game;
  const nightDur = g.nightDur||90;
  const updates = {};
  updates['rooms/'+roomCode+'/game/phase'] = 'night';
  updates['rooms/'+roomCode+'/game/phaseEndTime'] = Date.now()+nightDur*1000;
  updates['rooms/'+roomCode+'/game/lastPhaseChange'] = Date.now();
  updates['rooms/'+roomCode+'/game/turn'] = 1; // First night is turn 1
  updates['rooms/'+roomCode+'/game/seerUsed'] = false;
  updates['rooms/'+roomCode+'/game/wolfVotes'] = null;
  // DO NOT reset mayor here ‚Äî we just elected one!
  const players = Object.values(room.players||{});
  players.forEach(p=>{ updates['rooms/'+roomCode+'/players/'+p.id+'/protected']=false; });
  await window._fb.update(window._fb.ref(db), updates);

  await pushLog(`üåë ‚Äî Nuit 1 ‚Äî Les loups se r√©veillent.`,'night');
  pushNarr({fire:'üåë',color:'#8070b0',title:'Nuit 1',text:`Le soleil s'est couch√©. Les volets se ferment. Dans l'obscurit√© totale, quelque chose se d√©place lentement entre les maisons. Quelqu'un pr√©pare son crime.`});
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom) {
    await maybeEvent(freshRoom.game);
    await checkFleaInfection(freshRoom);
    await maybeAmbientNarr(freshRoom);
  }
}

async function switchPhase(newPhase){
  const room = await dbGet('rooms/'+roomCode);
  if(!room||!room.game) return;
  const g = room.game;
  // Guard: don't switch if already switched (phaseEndTime already past and phase already changed)
  if(g.phase === newPhase) return;
  if(g.phase === 'mayor_election' && newPhase !== 'night') return; // election always leads to night
  const dur = newPhase==='night' ? g.nightDur||90 : g.dayDur||180;
  const updates = {};
  updates['rooms/'+roomCode+'/game/phase'] = newPhase;
  updates['rooms/'+roomCode+'/game/phaseEndTime'] = Date.now()+dur*1000;
  updates['rooms/'+roomCode+'/game/lastPhaseChange'] = Date.now();
  if(newPhase==='night'){
    updates['rooms/'+roomCode+'/game/turn'] = (g.turn||1)+1;
    // Reset per-night flags
    updates['rooms/'+roomCode+'/game/seerUsed'] = false;
    updates['rooms/'+roomCode+'/game/wolfVotes'] = null;
    // Clear night event flags (1-turn duration)
    updates['rooms/'+roomCode+'/game/eventSeerBlinded'] = false;
    updates['rooms/'+roomCode+'/game/necroTarget'] = null;
    updates['rooms/'+roomCode+'/game/necroTurn'] = null;
    // Clear necro chat from previous night
    await dbSet('rooms/'+roomCode+'/necrochat', null);
    updates['rooms/'+roomCode+'/game/eventTwoDeaths'] = false;
    updates['rooms/'+roomCode+'/game/fogEnd'] = null;
    updates['rooms/'+roomCode+'/game/silencedPlayer'] = null;
    updates['rooms/'+roomCode+'/game/silencedTurn'] = null;
    updates['rooms/'+roomCode+'/game/currentEvent'] = null;
    // Reset protection. Mayor persists unless it was a temporary event-mayor.
    const players = room.players ? Object.values(room.players) : [];
    players.forEach(p=>{ updates['rooms/'+roomCode+'/players/'+p.id+'/protected']=false; });
    // Only clear event-assigned mayor (mayorFromEvent flag), not the elected one
    if(g.mayorFromEvent){
      players.forEach(p=>{ updates['rooms/'+roomCode+'/players/'+p.id+'/mayor']=false; });
      updates['rooms/'+roomCode+'/game/mayorFromEvent'] = false;
    }
  } else {
    // Reset day votes for new day
    updates['rooms/'+roomCode+'/game/dayVotes'] = null;
    updates['rooms/'+roomCode+'/game/voteResolved'] = false;
    updates['rooms/'+roomCode+'/game/hypnoVictim'] = null;
    updates['rooms/'+roomCode+'/game/hypnoForcedTarget'] = null;
    // Clear day event flags (1-turn duration)
    updates['rooms/'+roomCode+'/game/eventDoubleVote'] = false;
    updates['rooms/'+roomCode+'/game/eventVoteInverse'] = false;
    updates['rooms/'+roomCode+'/game/duelActive'] = false;
    updates['rooms/'+roomCode+'/game/duelA'] = null;
    updates['rooms/'+roomCode+'/game/duelB'] = null;
    updates['rooms/'+roomCode+'/game/noDebate'] = false;
    updates['rooms/'+roomCode+'/game/trapPlayer'] = null;
    updates['rooms/'+roomCode+'/game/currentEvent'] = null;
  }
  await window._fb.update(window._fb.ref(db), updates);
  const turn = newPhase==='night' ? (g.turn||1)+1 : g.turn;
  if(newPhase==='night'){
    await pushLog(`üåë ‚Äî Nuit ${turn} ‚Äî Les loups se r√©veillent.`,'night');
    pushNarr({fire:'üåë',color:'#8070b0',title:`Nuit ${turn}`,text:`Le soleil s'est couch√©. Les volets se ferment. Dans l'obscurit√© totale, quelque chose se d√©place lentement entre les maisons. Quelqu'un pr√©pare son crime.`});
  } else {
    // Resolve wolf kill from last night BEFORE showing day
    await resolveNightKill(g);
    await pushLog(`‚òÄÔ∏è ‚Äî Jour ${g.turn} ‚Äî Le village s'√©veille.`,'day');
    pushNarr({fire:'‚òÄÔ∏è',color:'#c8a050',title:`Jour ${g.turn}`,text:`L'aube rougeoyante r√©veille le village, mais l'air reste lourd de mensonges. Les regards se croisent, fuyants ou accusateurs. Qui parmi nous ment ce matin ?`});
  }
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom) {
    await maybeEvent(freshRoom.game);
    await checkFleaInfection(freshRoom);
    await maybeAmbientNarr(freshRoom);
    // Dawn whispers for each player at start of day
    if(newPhase==='day') await pushDawnWhispers(freshRoom);
  }
  if(newPhase==='day') await checkVictory();
  if(newPhase==='night') await checkTraitorBetrayal(freshRoom);
}

// ================================================================
// EVENTS
// ================================================================
async function maybeEvent(g){
  const prob = g?.evProb || 30;
  if(Math.random()*100 < prob){
    const ev = ALL_EVENTS[Math.floor(Math.random()*ALL_EVENTS.length)];
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:ev});
    await pushLog(`üåÄ √âV√âNEMENT : ${ev.name} ‚Äî ${ev.desc}`,'chaos');
    if(audioEnabled) playEventSound();
    pushNarr({fire:ev.icon,color:'#c0a0ff',title:ev.name,text:ev.desc+' Un frisson parcourt le village. Personne ne sait encore quelles cons√©quences cela aura vraiment‚Ä¶'});
    await applyEvent(ev);
  } else {
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:null});
  }
}


// ================================================================
// DAWN WHISPERS ‚Äî personalized per-role message at start of each day
// ================================================================
async function pushDawnWhispers(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive);
  const allPlayers = Object.values(room.players||{});
  const dead = allPlayers.filter(p=>!p.alive);
  const lastDead = dead.length > 0 ? dead[dead.length-1] : null;
  const turn = room.game?.turn || 1;

  // ‚îÄ‚îÄ Build hint sentences pool (per player, unique per dawn) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getHintSentence(p, allAlive, lastDead) {
    const others = allAlive.filter(x=>x.id!==p.id);
    const rnd = arr => arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
    const suspect = rnd(others);
    const victim = lastDead;
    const target = rnd(others); // second random for protection hints
    const jouer = p; // self references

    const hints = [
      // Attack/death related (only if there's a last dead)
      ...(victim ? [
        `√Ä l'aube, pr√®s de la demeure de ${victim.name}, une silhouette ressemblant √† ${suspect?.name||'un inconnu'} aurait √©t√© aper√ßue, immobile, dans la brume‚Ä¶`,
        `Des traces fra√Æches serpentent devant la porte de ${victim.name}‚Ä¶ Certains jurent avoir vu ${suspect?.name||'quelqu\'un'} r√¥der non loin.`,
        `Une ombre a travers√© le jardin de ${victim.name} cette nuit. Elle portait la d√©marche troublante de ${suspect?.name||'un habitant'}‚Ä¶`,
        `Les lanternes vacillaient pr√®s de chez ${victim.name}. ${suspect?.name||'Quelqu\'un'} ne semblait pas loin lorsque le vent s'est lev√©‚Ä¶`,
        `Un murmure court dans le village : ${suspect?.name||'quelqu\'un'} aurait quitt√© les ruelles juste avant que le silence ne tombe sur ${victim.name}.`,
        `La porte de ${victim.name} porte encore les marques d'un passage brutal‚Ä¶ ${suspect?.name||'Quelqu\'un'} aurait √©t√© vu quittant les lieux √† la h√¢te.`,
        `Des voisins affirment avoir entendu un souffle haletant‚Ä¶ ${suspect?.name||'Un joueur'} n'√©tait pas √† sa fen√™tre cette nuit-l√†.`,
        `Le sol autour de la maison de ${victim.name} est labour√© comme apr√®s une lutte‚Ä¶ ${suspect?.name||'Quelqu\'un'} garde le silence depuis l'aube.`,
      ] : []),
      // Mysterious atmosphere hints
      `Une √©trange lueur a envelopp√© la maison de ${suspect?.name||p.name}. Plus tard, ${suspect?.name||'quelqu\'un'} semblait troubl√©, comme sorti d'un songe‚Ä¶`,
      `Certains parlent d'un rituel murmur√© dans la nuit‚Ä¶ ${suspect?.name||'Un habitant'} aurait √©t√© entendu chuchoter pr√®s du puits.`,
      `Une odeur d'herbes br√ªl√©es flotte encore dans le village. ${suspect?.name||'Quelqu\'un'} √©vite les regards ce matin.`,
      // Emotional hints (lover-related)
      ...(victim ? [
        `Depuis que ${victim.name} a ferm√© les yeux, ${target?.name||suspect?.name||'quelqu\'un'} semble marcher comme priv√©(e) d'une part de lui-m√™me‚Ä¶`,
        `Le regard de ${target?.name||suspect?.name||'quelqu\'un'} s'est √©teint au moment m√™me o√π ${victim.name} est tomb√©‚Ä¶ √©trange co√Øncidence.`,
      ] : []),
      // Protection hints
      ...(target ? [
        `Quelque chose ‚Äî ou quelqu'un ‚Äî veillait cette nuit sur ${target.name}. Une pr√©sence invisible a d√©tourn√© le malheur.`,
        `Les ombres ont tent√© d'atteindre ${target.name}, mais le destin semblait les repousser‚Ä¶`,
        `Une force discr√®te s'est interpos√©e devant la porte de ${target.name}.`,
      ] : []),
      // Behavior hints
      ...(suspect ? [
        `Au lever du jour, ${suspect.name} semblait d√©termin√©(e), comme guid√©(e) par une voix que lui seul entendait‚Ä¶`,
        `Les paroles de ${suspect.name} r√©sonnent √©trangement, comme souffl√©es par une volont√© cach√©e‚Ä¶`,
        `Certains disent que le regard de ${suspect.name} n'√©tait pas tout √† fait le sien cette nuit‚Ä¶`,
        `Ce que les yeux ont vu chez ${suspect.name} pourrait n'√™tre qu'un voile pos√© sur la v√©rit√©‚Ä¶`,
        `Les apparences autour de ${suspect.name} tremblent comme un reflet dans l'eau trouble‚Ä¶`,
        `La v√©rit√© concernant ${suspect.name} semble avoir chang√© de visage cette nuit‚Ä¶`,
      ] : []),
      // Necromancer/ghost hints
      `Une voix oubli√©e a travers√© le vent‚Ä¶ ${suspect?.name||p.name} affirme avoir entendu un conseil venu d'outre-tombe.`,
      `Les morts murmurent encore‚Ä¶ et ${suspect?.name||p.name} semble les √©couter.`,
      // Chrono hints
      `Un frisson parcourt le village‚Ä¶ certains ont l'impression que cette journ√©e a d√©j√† √©t√© v√©cue. ${suspect?.name||p.name} semble en savoir plus qu'il ne le dit.`,
      `Le temps a vacill√© cette nuit. ${suspect?.name||p.name} n'a pas quitt√© la place depuis‚Ä¶ ou peut-√™tre y √©tait-il d√©j√† hier ?`,
    ];
    return rnd(hints) || `Une force myst√©rieuse rode dans le village ce matin‚Ä¶`;
  }

  // ‚îÄ‚îÄ Role messages pool (varied, 4-6 per role) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const getDawnMsg = (p, lastDead, allAlive) => {
    const others = allAlive.filter(x=>x.id!==p.id);
    const rnd = arr => arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
    const suspect = rnd(others);
    const dn = lastDead?.name || null;
    const sn = suspect?.name || 'quelqu\'un';

    const pool = {
      'Loup-Garou': [
        dn ? `Le corps de ${dn} g√Æt froid sous l'aube grise. Le village va hurler, accuser, s'agiter. Laisse-les. Chaque cri mal dirig√© est une victoire pour toi, ${p.name}.` : `Une nouvelle aube, ${p.name}. Les villageois cherchent un monstre parmi eux. Ce matin, sois le plus humain de tous.`,
        `${p.name}, la meute a frapp√© cette nuit. Aujourd'hui tu dois incarner l'indignation, la tristesse, la col√®re sinc√®re. Les loups qui survivent jouent mieux que les acteurs.`,
        dn ? `${dn} est mort(e). Les regards vont chercher un coupable ‚Äî devance-les. Accuse ${sn} avec conviction. Les innocents h√©sitent. Toi, non.` : `Le village est intact cette nuit, ${p.name}. Cela ne durera pas. Observe qui s'inqui√®te trop peu et qui s'agite trop ‚Äî les deux sont suspects.`,
        `${p.name}, tu es parmi les loups. Aujourd'hui, √©coute plus que tu ne parles. Celui qui se tait observe. Celui qui observe sait. Celui qui sait survit.`,
        `La lumi√®re du jour expose les mensonges, ${p.name}. Pr√©pare les tiens avec soin ‚Äî une contradiction, et tout s'effondre.`,
      ],
      'Loup Blanc': [
        `${p.name}, tu portes deux masques. Ni vraiment loup, ni vraiment villageois. Aujourd'hui, observe les deux camps s'affaiblir mutuellement. Ta victoire est solitaire ‚Äî et c'est pour √ßa qu'elle sera totale.`,
        dn ? `${dn} n'est plus. Pour les loups, c'est une victoire. Pour toi, c'est un pas de plus vers l'isolement final. Continue.` : `Pas de mort cette nuit, ${p.name}. Les loups ont h√©sit√© ou manqu√© leur cible. Sers-t'en pour semer des doutes sur leur coordination.`,
        `${p.name}, chaque alli√© qui meurt ‚Äî qu'il soit loup ou villageois ‚Äî te rapproche de ton but. Reste le dernier debout, co√ªte que co√ªte.`,
        `Ta loyaut√© n'appartient qu'√† toi-m√™me, ${p.name}. Ce matin, fais semblant de chercher les loups avec le village. Ce soir, peut-√™tre, tu les rejoindras dans l'ombre.`,
      ],
      'Loup Enrag√©': [
        `${p.name}, ta rage gronde sous la surface. Le jour, tu es un citoyen ordinaire. Laisse ${sn} parler ‚Äî s'il dit quelque chose de stupide, enfonce-le.`,
        dn ? `${dn} est tomb√©(e) sous vos crocs. Parfait. Aujourd'hui, joue le chagrin ‚Äî mais garde tes yeux ouverts sur la prochaine cible.` : `La nuit a √©t√© calme, ${p.name}. Cela peut √©veiller des soup√ßons sur les loups. Sois particuli√®rement actif dans les d√©bats ce jour.`,
        `${p.name}, ta force est une arme nocturne. Le jour, ta seule arme est ta langue. Utilise-la pour d√©tourner les regards.`,
      ],
      'Loup Infectieux': [
        `${p.name}, ton poison se diffuse en silence dans le village. Quelqu'un se r√©veille peut-√™tre avec une soif nouvelle sans encore comprendre ce qui lui arrive.`,
        dn ? `${dn} a pay√© le prix du sang. Mais ton vrai pouvoir, c'est de cr√©er des alli√©s invisibles. Observe bien ce matin ‚Äî quelqu'un semble-t-il diff√©rent ?` : `Pas de mort visible, ${p.name}. Mais l'infection, elle, continue son chemin invisible. Patience.`,
        `${p.name}, tu peux transformer des ennemis en alli√©s sans qu'ils le sachent. C'est une forme de pouvoir que m√™me les loups ordinaires n'ont pas.`,
      ],
      'Loup aux Puces': [
        `${p.name}, tes puces ont √©t√© sem√©es. Quelqu'un dans ce village se gratte sans savoir pourquoi. La transformation arrive ‚Äî reste discret.`,
        `Tu as plant√© une graine dans la chair de ${sn}‚Ä¶ ou peut-√™tre d'un autre. Ce matin, observe les comportements inhabituels.`,
        `${p.name}, le vrai danger vient de l'int√©rieur. Et tu l'as mis l√†. Continue √† jouer le jeu innocent pendant que ton arme fait son ≈ìuvre.`,
      ],
      'Voyante': [
        `${p.name}, la nuit t'a offert une v√©rit√© que d'autres ignorent. La vraie question : comment la faire peser sur le vote d'aujourd'hui sans te br√ªler ?`,
        dn ? `${dn} est mort(e) sans que tu aies pu l'avertir. Chaque vision a un co√ªt. Aujourd'hui, utilise ce que tu sais pour orienter les soup√ßons subtilement.` : `La v√©rit√© que tu as vue cette nuit est une arme √† double tranchant, ${p.name}. Trop directe, elle te cible. Trop floue, elle ne sert √† rien.`,
        `${p.name}, les yeux voient, mais les langues trahissent. Parle par allusions, par questions, par doutes ‚Äî jamais par certitudes.`,
        `Une vision claire dans un village aveugle, ${p.name}. Tu as un avantage immense et un risque mortel. Doser l'un sans d√©clencher l'autre est tout l'art de la Voyante.`,
        `${p.name}, si tu r√©v√®les trop t√¥t ce que tu sais, les loups feront de toi leur cible prioritaire cette nuit. Choisir le bon moment est plus important que l'information elle-m√™me.`,
      ],
      'Sorci√®re': [
        `${p.name}, tes potions sont deux pouvoirs absolus ‚Äî et deux pi√®ges si tu les gaspilles. Ce matin, √©value qui m√©rite vraiment d'√™tre sauv√© ou condamn√©.`,
        dn ? `${dn} aurait peut-√™tre pu √™tre sauv√©(e) par ta potion de vie, ${p.name}. Ou non. Ce qui compte maintenant : qui prot√©ger ce soir ?` : `Personne n'est mort cette nuit, ${p.name}. Ta potion de vie n'a pas encore √©t√© utile ‚Äî et c'est bien ainsi. Elle vaut plus en r√©serve.`,
        `${p.name}, la potion de mort peut changer une partie en un instant. Mais utilis√©e sur le mauvais joueur, elle peut aussi tuer un alli√©. √âcoute attentivement les accusations d'aujourd'hui.`,
        `Ton silence est puissant, ${p.name}. Personne ne sait ce que tu poss√®des. Garde ce secret aussi pr√©cieusement que tes fioles.`,
      ],
      'Chasseur': [
        `${p.name}, tu n'as aucun pouvoir pr√©ventif ‚Äî mais ta mort sera toujours payante. Aujourd'hui, identifie ta cible pour ton dernier tir, au cas o√π.`,
        `Si quelqu'un essaie de t'√©liminer ce jour, ${p.name}, rappelle-toi : ils mourront avec toi. Cette certitude peut te rendre presque invuln√©rable ‚Äî si les autres la connaissent.`,
        dn ? `${dn} est parti(e) sans pouvoir riposter. Toi, tu peux. Cette diff√©rence est tout ce qui te s√©pare de l'ordinaire.` : `Aucune mort cette nuit, ${p.name}. Les loups se terrent. Mais ils ont une cible en t√™te ‚Äî est-ce toi ?`,
        `${p.name}, observe qui te regarde trop longtemps aujourd'hui. Celui qui veut te viser sait que ta mort lui co√ªtera cher. Seul un loup tr√®s confiant oserait te cibler.`,
      ],
      'Garde du Corps': [
        dn ? `${dn} n'√©tait pas sous ta protection, ${p.name}. Ce matin, d√©cide qui tu mettras en s√©curit√© ce soir. Certains m√©ritent plus que d'autres.` : `Le village a dormi en s√©curit√© cette nuit. Peut-√™tre gr√¢ce √† toi. Peut-√™tre par chance. Ce soir, sois l√† o√π les loups frappent.`,
        `${p.name}, tu es un bouclier vivant. Mais les boucliers n'ont qu'une vie. Prot√®ge le bon joueur ce soir ‚Äî celui dont la mort serait une catastrophe pour le village.`,
        `Personne ne sait que tu existes, ${p.name}. C'est ta force. Ne la gaspille pas en te d√©voilant trop t√¥t.`,
        `${p.name}, qui prot√©ger ce soir ? La Voyante ? Le Dieu du Village ? Ou quelqu'un d'autre dont tu pressens qu'il est en danger ? Observe bien les tensions du jour.`,
      ],
      'Dieu du Village': [
        `${p.name}, ta gr√¢ce peut annuler une √©limination ‚Äî de jour comme de nuit. Mais les miracles trop fr√©quents cessent d'en √™tre. Garde ce pouvoir pour le moment qui changera tout.`,
        dn ? `${dn} est parti(e). Tu aurais pu intervenir. Mais √©tait-ce le bon moment ? Maintenant, cette d√©cision appartient au pass√©. Concentre-toi sur qui prot√©ger ensuite.` : `Personne n'est tomb√© cette nuit, ${p.name}. Ton pouvoir reste intact, entier, en attente. Sois pr√™t √† l'utiliser au moment le moins attendu.`,
        `${p.name}, la divinit√© observatrice est plus puissante que celle qui agit √† tort et √† travers. Attends. √âcoute. Le bon moment finit toujours par se montrer.`,
      ],
      'Chronomancien': [
        `${p.name}, le temps peut encore √™tre rembobin√© ‚Äî mais une seule fois. Ce matin, demande-toi : si une erreur irr√©parable est commise aujourd'hui, m√©rite-t-elle vraiment ton intervention ?`,
        dn ? `${dn} est mort(e). Rembobiner ? Peut-√™tre. Mais si c'√©tait un loup d√©masqu√©, c'est une victoire. Si c'√©tait un alli√© cl√©‚Ä¶ le choix est entre tes mains, ${p.name}.` : `La nuit s'est pass√©e sans drame, ${p.name}. Ton pouvoir reste en r√©serve. Et en r√©serve il doit rester ‚Äî jusqu'au moment o√π une seule d√©cision peut tout changer.`,
        `${p.name}, tu contr√¥les quelque chose que personne d'autre ne poss√®de : une deuxi√®me chance. Ne la d√©pense pas sur une erreur mineure.`,
      ],
      'N√©cromancien': [
        `${p.name}, les morts parlent √† ceux qui savent √©couter. Cette nuit, tu as ouvert une connexion avec l'au-del√†. Ce que tu y as appris, personne d'autre ne le sait.`,
        `Les murmures des d√©funts sont une carte du mensonge, ${p.name}. Utilise ce que tu as entendu pour orienter les soup√ßons ‚Äî mais sans r√©v√©ler ta source.`,
        dn ? `${dn} est peut-√™tre encore pr√™t(e) √† parler, ${p.name}. Les morts gardent leurs secrets ‚Äî √† moins qu'on ne sache comment les convaincre.` : `${p.name}, m√™me sans mort r√©cente, les anciens disparus ont beaucoup √† dire. Les v√©rit√©s d'outre-tombe ne se p√©riment pas.`,
      ],
      'Cupidon': [
        `${p.name}, les amoureux que tu as li√©s partagent un destin commun. Observer leur comportement aujourd'hui peut trahir leur lien aux yeux des autres ‚Äî ou au contraire les renforcer.`,
        `Tu as cr√©√© quelque chose d'irr√©versible, ${p.name}. Deux destins soud√©s. Regarde-les ce matin : se prot√®gent-ils ? S'√©vitent-ils ? Cela en dit long.`,
        `${p.name}, Cupidon n'interf√®re plus ‚Äî son ≈ìuvre est faite. Mais observer les cons√©quences de ce lien peut te donner des informations pr√©cieuses pour tes votes.`,
      ],
      'Illusionniste': [
        `${p.name}, la confusion que tu as sem√©e dans les visions de la Voyante pourrait faire accuser quelqu'un d'innocent aujourd'hui. Ou sauver un loup. Observe attentivement les r√©actions.`,
        `Les illusions sont des outils fragiles, ${p.name}. Trop fr√©quentes, elles √©veillent les soup√ßons sur leur existence m√™me. Joue avec mod√©ration.`,
        `${p.name}, quelqu'un dans ce village voit le monde √† travers tes filtres sans le savoir. C'est un avantage immense ‚Äî et une responsabilit√©.`,
        `La v√©rit√© que la Voyante croit avoir vu cette nuit n'en est peut-√™tre pas une, ${p.name}. Observe si ses accusations du jour semblent coh√©rentes avec ton intervention.`,
      ],
      'Hypnotiseur': [
        `${p.name}, ta suggestion est plant√©e. Regarde si ta cible vote comme tu l'as dict√©. Si oui, ton pouvoir est r√©el et redoutable. Si non‚Ä¶ il faudra recommencer.`,
        `Un vote forc√© est une arme silencieuse, ${p.name}. Personne ne sait que tu tires les fils. C'est l√† toute ta puissance.`,
        `${p.name}, observe les r√©actions quand ta cible annonce son vote. Une h√©sitation, un regard fuyant ‚Äî quelqu'un pourrait soup√ßonner une influence ext√©rieure.`,
        `Tu contr√¥les une voix dans ce village, ${p.name}. Et une voix peut suffire √† faire basculer une √©limination. Ne la gaspille pas.`,
      ],
      'Usurpateur': [
        `${p.name}, tu portes un masque vol√©. Le r√¥le que tu as usurp√© est d√©sormais le tien. Mais souviens-toi : le v√©ritable propri√©taire de ce r√¥le existe toujours dans le village.`,
        `${p.name}, l'identit√© est une illusion dans ce village. Tu en es la preuve vivante. Utilise ce nouveau r√¥le avec plus de sagesse que celui qui le d√©tenait avant toi.`,
        `Ce pouvoir t'appartient maintenant, ${p.name}. Personne ne sait ce que tu caches. Ni ce que tu pourrais encore faire.`,
        `${p.name}, un r√¥le usurp√© est un avantage double : tu sais ce que tu peux faire, et les autres l'ignorent. Joue sur cet √©cart d'information.`,
      ],
      'Avocat': [
        `${p.name}, ton client est prot√©g√© du vote ce tour. Assure-toi que sa survie te profite r√©ellement ‚Äî ou que ce soit la bonne personne √† prot√©ger.`,
        `La protection que tu accordes, ${p.name}, peut sauver un innocent‚Ä¶ ou prot√©ger un loup. Choisis avec discernement.`,
        `${p.name}, ta voix ne compte pas double ‚Äî mais ta protection peut changer le r√©sultat du vote entier. Utilise-la strat√©giquement.`,
      ],
      'Tra√Ætre': [
        `${p.name}, tu joues encore le villageois. Pour combien de temps ? La meute t'attend dans l'ombre. √âcoute les signaux ‚Äî le moment de changer de camp se rapproche peut-√™tre.`,
        `Ton loyaut√© est une illusion que tu vends chaque jour, ${p.name}. Mais les loups savent la v√©rit√©. Et bient√¥t, tout le village le saura aussi.`,
        `${p.name}, chaque journ√©e que tu passes parmi les villageois est un risque. Si tu te retournes trop t√¥t, tu es suspect. Trop tard, et les loups auront d√©j√† perdu.`,
        dn ? `${dn} est mort(e) ‚Äî et ce n'est peut-√™tre pas √©tranger √† ce que tu portes, ${p.name}. Sois pr√™t(e). La transformation approche.` : `${p.name}, le village te croit innocent. Pour combien de temps encore ? Au 3√®me tour, ton masque tombera d√©finitivement.`,
      ],
      'Marionnettiste': [
        `${p.name}, tes fils ont agi cette nuit. Les cons√©quences de tes manipulations se lisent dans les comportements d'aujourd'hui ‚Äî si tu sais o√π regarder.`,
        `Quelqu'un dans ce village a vot√© diff√©remment de ce qu'il aurait voulu, ${p.name}. Et personne ne sait que c'est toi qui as tir√© les ficelles.`,
        `${p.name}, contr√¥ler sans √™tre vu est l'art du Marionnettiste. Ce matin, joue l'innocent parmi les innocents.`,
        `Tu as mis une pens√©e dans une t√™te qui n'est pas la tienne, ${p.name}. L'effet se verra peut-√™tre aujourd'hui. Peut-√™tre plus tard. Mais il se verra.`,
      ],
      'Villageois': [
        dn ? `${dn} est mort(e) cette nuit. Quelqu'un autour de toi a ordonn√© √ßa, ${p.name}. Observe les r√©actions ‚Äî la culpabilit√© laisse des traces que les mots ne peuvent pas effacer.` : `Une nuit sans mort, ${p.name}. Les loups ont h√©sit√©. Ou attendu. Profite de cette journ√©e pour observer ${sn} de plus pr√®s.`,
        `${p.name}, tu n'as pas de pouvoir ‚Äî mais tu as des yeux, une m√©moire et un vote. Parfois, c'est amplement suffisant pour trouver un loup.`,
        `${p.name}, les loups ont des habitudes. Qui parle trop ? Qui reste silencieux ? Qui vote toujours dans le m√™me sens que d'autres ? Les sch√©mas finissent par se r√©v√©ler.`,
        `La force des villageois est le nombre, ${p.name}. Mais seulement si vous votez ensemble dans la bonne direction. Construis des alliances ‚Äî et m√©fie-toi de celles qui te sont propos√©es.`,
        dn ? `Ce matin, les visages portent le deuil de ${dn}. ${p.name}, observe qui semble trop peu affect√©. Le chagrin feint a sa propre texture.` : `${p.name}, les loups sont parmi vous, mais leurs nuits sont coordonn√©es. Tente de trouver qui semble le mieux inform√© des √©v√©nements nocturnes.`,
      ],
    };

    const msgs = pool[p.role] || [`${p.name}, une nouvelle journ√©e commence. Reste vigilant face √† l'ombre.`];
    // Pick a unique message index per player to avoid repetition
    return msgs[Math.floor(Math.random()*msgs.length)];
  };

  // ‚îÄ‚îÄ Assign unique hint sentences (no two players get same hint) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Build one hint per player (shuffled from common pool, unique per player)
  const whispers = {};
  // Track used hint texts to avoid duplicates
  const usedHints = new Set();

  players.forEach(p=>{
    const main = getDawnMsg(p, lastDead, players);
    // Generate hint, retry if duplicate
    let hint = '';
    let attempts = 0;
    do {
      hint = getHintSentence(p, players, lastDead);
      attempts++;
    } while(usedHints.has(hint) && attempts < 10);
    usedHints.add(hint);

    whispers[p.id] = {
      text: main + '\n\n‚Ä¶N√©anmoins, ' + hint,
      turn, ts: Date.now()
    };
  });
  await dbSet('rooms/'+roomCode+'/dawnWhispers', whispers);
}

// Called each render cycle ‚Äî shows whisper to current player only
let shownDawnTurns = new Set();
function checkDawnWhisper(room){
  if(!room.dawnWhispers || room.game?.phase !== 'day') return;
  const w = room.dawnWhispers[me.id];
  if(!w) return;
  const key = `${roomCode}_dawn_${w.turn}`;
  if(shownDawnTurns.has(key)) return;
  shownDawnTurns.add(key);
  const myP = room.players?.[me.id];
  const rd = ALL_ROLES[myP?.role];
  // Private local narr (not pushed to Firebase)
  queueNarr({
    fire: rd?.emoji || 'üåÖ',
    color: rd?.camp==='loup' ? '#e07070' : rd?.camp==='neutre' ? '#c0a0ff' : '#c8a050',
    title: `Jour ${w.turn} ‚Äî Ce que vous ressentez`,
    text: w.text
  });
}

// Check if we need to show a private lovers narr (only for lovers and Cupidon)
let loversNarrShown = false;
function checkLoversNarr(room){
  if(loversNarrShown) return;
  const g = room.game;
  if(!g?.loversNarrPending) return;
  const myP = room.players?.[me.id];
  if(!myP) return;
  const isLovers = myP.lovers;
  const isCupidon = myP.role === 'Cupidon';
  if(!isLovers && !isCupidon) return;
  loversNarrShown = true;
  const a = room.players?.[g.loversA];
  const b = room.players?.[g.loversB];
  if(!a||!b) return;
  if(isLovers){
    const partner = me.id === g.loversA ? b : a;
    queueNarr({fire:'üíò',color:'#f48fb1',title:'Vous √™tes Amoureux(se) !',
      text:`Une force invisible vous lie √† ${partner.name}. Si l'un de vous meurt, l'autre suivra. Prot√©gez-vous mutuellement‚Ä¶ ou gagnez ensemble.`});
  }
}

async function checkFleaInfection(room){
  const g = room.game;
  if(!g?.fleaTarget || g.fleaInfected) return;
  const currentTurn = g.turn;
  const fleaTurn = g.fleaTurn || 0;
  if(currentTurn - fleaTurn >= 2){
    const target = room.players?.[g.fleaTarget];
    if(target && target.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+g.fleaTarget,{role:'Loup-Garou'});
      await dbUpdate('rooms/'+roomCode+'/game',{fleaInfected:true});
      await pushLog(`üêú Quelqu'un ressent une √©trange transformation‚Ä¶`,'night');
      pushNarr({fire:'üêú',color:'#8a6030',title:'La M√©tamorphose',text:`${target.name} se r√©veille avec une sensation √©trange. Quelque chose en lui a chang√©. Une soif nouvelle. Une loyaut√© nouvelle. La meute l'appelle maintenant.`});
    }
  }
}

// ================================================================
// TRA√éTRE ‚Äî automatic betrayal at turn 3
// ================================================================
async function checkTraitorBetrayal(room){
  const g = room.game;
  if(!g) return;
  if(g.traiteurBetrayed) return; // already done
  if((g.turn||1) < 3) return;
  const players = Object.values(room.players||{});
  const traitor = players.find(p=>p.role==='Tra√Ætre' && p.alive);
  if(!traitor) return;
  // Change traitor's camp to loup
  await dbUpdate('rooms/'+roomCode+'/players/'+traitor.id, {role:'Loup-Garou'});
  await dbUpdate('rooms/'+roomCode+'/game', {traiteurBetrayed:true});
  await pushLog(`üó°Ô∏è Une √¢me sombre change de camp dans l'ombre du village‚Ä¶`,'chaos');
  pushNarr({fire:'üó°Ô∏è',color:'#c04040',title:'La Trahison',
    text:`La loyaut√© n'√©tait qu'un masque. Dans le secret de la nuit, une √¢me a c√©d√© √† l'appel des t√©n√®bres. Le camp des loups vient de gagner un alli√© inattendu.`});
  // Private notification only for the traitor themselves (shown via dawnWhisper next day)
}

// ================================================================
// AMBIENT NARRATIVE EVENTS ‚Äî personal, immersive, role-aware
// ================================================================
async function maybeAmbientNarr(room){
  const g = room.game;
  const players = Object.values(room.players||{});
  const alive = players.filter(p=>p.alive);
  const dead = players.filter(p=>!p.alive);
  if(alive.length < 2) return;
  // ~50% chance of ambient narr each phase change
  if(Math.random() > 0.5) return;

  const phase = g.phase; // current phase after switch
  const lastDead = dead.length > 0 ? dead[dead.length-1] : null;
  const randAlive = alive[Math.floor(Math.random()*alive.length)];
  const wolves = alive.filter(p=>ALL_ROLES[p.role]?.camp==='loup');
  const villagers = alive.filter(p=>ALL_ROLES[p.role]?.camp==='village');
  const seer = alive.find(p=>p.role==='Voyante');
  const witch = alive.find(p=>p.role==='Sorci√®re');
  const hunter = alive.find(p=>p.role==='Chasseur');
  const mayor = alive.find(p=>p.mayor);
  const lovers = alive.filter(p=>p.lovers);

  // Pool of possible ambient events ‚Äî pick one that makes sense contextually
  const pool = [];

  // Universal ambient events
  pool.push({
    fire:'ü¶â',color:'#8080b0',
    title:'Un Bruit dans l\'Ombre',
    text:`Le vent souffle entre les ruelles du village. Quelqu'un a aper√ßu une silhouette cette nuit derri√®re la fen√™tre de ${randAlive.name}. Rien d'autre. Juste une ombre.`
  });
  pool.push({
    fire:'üïØÔ∏è',color:'#c8a050',
    title:'La Chandelle Vacille',
    text:`Une fen√™tre s'est allum√©e en plein milieu de la nuit dans le village. Qui ne dort pas ? Pourquoi ? ${randAlive.name} a √©t√© vu(e) debout √† une heure avanc√©e. Co√Øncidence ?`
  });
  pool.push({
    fire:'üê¶',color:'#60a080',
    title:'Le Chant de l\'Aube',
    text:`Les oiseaux se sont tus cette nuit, plus t√¥t que d'habitude. Comme s'ils sentaient quelque chose. Comme s'ils fuyaient un pr√©dateur que les humains ne peuvent pas encore voir.`
  });
  pool.push({
    fire:'üå´Ô∏è',color:'#707090',
    title:'Brumes Matinales',
    text:`Un √©pais brouillard recouvre le village ce matin. Les visages sont flous, les intentions encore plus. Dans cette grisaille, m√™me les innocents semblent suspects.`
  });

  if(lastDead){
    pool.push({
      fire:'üï≥Ô∏è',color:'#a06060',
      title:'Les Traces de la Nuit',
      text:`Pr√®s de la maison de ${lastDead.name}, quelqu'un a remarqu√© des empreintes dans la boue. Deux paires. L'une appartient √† la victime. L'autre‚Ä¶ reste un myst√®re.`
    });
    pool.push({
      fire:'üìú',color:'#c8a050',
      title:'Un Message Retrouv√©',
      text:`On a trouv√© un billet froiss√© dans la poche de ${lastDead.name}. Le papier est tach√©, l'encre √† moiti√© effac√©e. On peut juste lire un pr√©nom : "${randAlive.name}".`
    });
    pool.push({
      fire:'üß©',color:'#808060',
      title:'T√©moignage',
      text:`Un villageois confie √† voix basse : la nuit de la mort de ${lastDead.name}, il a entendu des voix √† deux maisons de distance. Deux voix. L'une grave, l'autre que personne n'a reconnue.`
    });
  }

  if(wolves.length > 0 && alive.length > 3){
    pool.push({
      fire:'üê∫',color:'#a04040',
      title:'Un Grognement Lointain',
      text:`Aux abords du village, quelqu'un a entendu un son grave cette nuit. Pas un animal. Quelque chose de plus patient. Plus intelligent. Il regardait le village depuis les t√©n√®bres.`
    });
    pool.push({
      fire:'ü©∏',color:'#900000',
      title:'Une Tache Sombre',
      text:`Une trace sombre a √©t√© remarqu√©e sur le perron ce matin. Personne ne sait depuis combien de temps elle est l√†. ${randAlive.name} ne semblait pas surpris(e) en la voyant.`
    });
  }

  if(seer){
    pool.push({
      fire:'üîÆ',color:'#9060b0',
      title:'Une Vision Trouble',
      text:`Quelqu'un dans le village se r√©veille chaque matin les yeux rouges, comme hant√©(e) par des images nocturnes. Les r√™ves ont des v√©rit√©s que les mots ne peuvent pas contenir.`
    });
  }

  if(witch){
    pool.push({
      fire:'ü´ô',color:'#5080a0',
      title:'Une Odeur √Çcre',
      text:`Une √©trange odeur s'est r√©pandue dans une ruelle cette nuit. Am√®re, chimique, presque m√©dicinale. Comme si quelqu'un avait renvers√© un flacon dans l'obscurit√©.`
    });
  }

  if(hunter){
    pool.push({
      fire:'üèπ',color:'#a08040',
      title:'Un Bruit de Pas',
      text:`On a entendu des pas rapides sur les toits cette nuit. L√©gers mais pr√©cis. Comme quelqu'un qui surveille. Qui attend. Avec une fl√®che d√©j√† encoch√©e.`
    });
  }

  if(mayor){
    pool.push({
      fire:'üëë',color:'#c0a030',
      title:'Le Maire Inquiet',
      text:`${mayor.name} n'a presque pas dormi. On l'a vu d√©ambuler dans les rues, les mains crois√©es dans le dos, le regard perdu. Les d√©cisions du village p√®sent lourd en ces temps sombres.`
    });
  }

  if(lovers.length === 2){
    pool.push({
      fire:'‚ù§Ô∏è',color:'#d060a0',
      title:'Une √âtreinte Secr√®te',
      text:`${lovers[0].name} et ${lovers[1].name} ont √©t√© aper√ßus ensemble cette nuit, loin du village. Que se disaient-ils ? Que se promettaient-ils ? Certains amours survivent m√™me aux loups.`
    });
  }

  if(phase === 'night'){
    pool.push({
      fire:'üåë',color:'#6050a0',
      title:'Le Village Retient son Souffle',
      text:`Toutes les bougies sont √©teintes. Toutes les portes verrouill√©es. Mais certains yeux restent ouverts dans le noir, √† √©couter les bruits que la nuit produit quand elle croit que tout le monde dort.`
    });
  } else {
    pool.push({
      fire:'‚òÄÔ∏è',color:'#b08030',
      title:'L\'Heure des Regards',
      text:`Le soleil s'est lev√© mais aucun sourire ne l'accompagne. Les villageois s'observent en biais, pesant chaque mot avant de l'√©noncer. La m√©fiance est devenue le seul langage parl√© ici.`
    });
    pool.push({
      fire:'üó£Ô∏è',color:'#808060',
      title:'Des Murmures',
      text:`On chuchote beaucoup ce matin. Des noms circulent. Des th√©ories naissent et meurent en quelques secondes. ${randAlive.name} a √©t√© mentionn√©(e) plusieurs fois. Pour rien. Ou peut-√™tre pas.`
    });
  }

  const chosen = pool[Math.floor(Math.random()*pool.length)];
  pushNarr(chosen);
}

async function applyEvent(ev){
  const room = await dbGet('rooms/'+roomCode);
  const players = room?.players ? Object.values(room.players) : [];
  const alive = players.filter(p=>p.alive);
  const g = room?.game;
  if(!alive.length) return;

  // ‚îÄ‚îÄ Immunit√© Al√©atoire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(ev.name==='Immunit√© Al√©atoire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    await dbUpdate('rooms/'+roomCode+'/players/'+t.id,{protected:true});
    await pushLog(`üõ°Ô∏è ${t.name} est prot√©g√©(e) par l'immunit√© al√©atoire ce tour !`,'chaos');
  }

  // ‚îÄ‚îÄ Nouveau Maire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(ev.name==='Nouveau Maire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    const upd={};
    players.forEach(p=>{upd['rooms/'+roomCode+'/players/'+p.id+'/mayor']=false;});
    upd['rooms/'+roomCode+'/players/'+t.id+'/mayor']=true;
    upd['rooms/'+roomCode+'/game/mayorFromEvent']=true; // temporary ‚Äî cleared next night
    await window._fb.update(window._fb.ref(db),upd);
    await pushLog(`üëë ${t.name} est d√©sign√©(e) Maire par le destin ‚Äî son vote compte double aujourd\'hui !`,'chaos');
    pushNarr({fire:'üëë',color:'#d4a017',title:'Un Nouveau Maire',
      text:`Le destin a pos√© sa couronne sur la t√™te de ${t.name}. Ce titre ne durera qu'un jour ‚Äî mais une voix qui compte double peut tout changer.`});
  }

  // ‚îÄ‚îÄ Retour des Morts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Mort revient pour un tour; on schedule sa re-mort au prochain changement de phase
  if(ev.name==='Retour des Morts'){
    const dead=players.filter(p=>!p.alive);
    if(dead.length){
      const r=dead[Math.floor(Math.random()*dead.length)];
      await dbUpdate('rooms/'+roomCode+'/players/'+r.id,{alive:true});
      await dbUpdate('rooms/'+roomCode+'/game',{ghostPlayerId:r.id});
      await pushLog(`üëª ${r.name} revient d'entre les morts pour un tour !`,'chaos');
    }
  }

  // ‚îÄ‚îÄ Potion Retrouv√©e ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(ev.name==='Potion Retrouv√©e'){
    if(g?.witchLifeUsed&&g?.witchDeathUsed){
      // Both used ‚Äî restore life potion
      await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:false});
      await pushLog(`üß™ La Sorci√®re retrouve sa potion de vie !`,'chaos');
    } else if(g?.witchLifeUsed){
      await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:false});
      await pushLog(`üß™ La Sorci√®re retrouve sa potion de vie !`,'chaos');
    } else if(g?.witchDeathUsed){
      await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:false});
      await pushLog(`üß™ La Sorci√®re retrouve sa potion de mort !`,'chaos');
    } else {
      await pushLog(`üß™ La Sorci√®re poss√®de d√©j√† toutes ses potions.`,'chaos');
    }
  }

  // ‚îÄ‚îÄ Double Vote ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Stored as a flag; resolveVote reads it and multiplies all votes √ó2
  if(ev.name==='Double Vote'){
    await dbUpdate('rooms/'+roomCode+'/game',{eventDoubleVote:true});
    await pushLog(`üó≥Ô∏è Ce tour, tous les votes comptent double !`,'chaos');
  }

  // ‚îÄ‚îÄ Vote Invers√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // The player with most votes is SAVED; second-most is eliminated
  if(ev.name==='Vote Invers√©'){
    await dbUpdate('rooms/'+roomCode+'/game',{eventVoteInverse:true});
    await pushLog(`üîÉ Vote Invers√© ! Le joueur avec le plus de votes sera sauv√©.`,'chaos');
  }

  // ‚îÄ‚îÄ Deux Morts Cette Nuit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Wolves will kill TWO targets; stored as flag read in resolveNightKill
  if(ev.name==='Deux Morts Cette Nuit'){
    await dbUpdate('rooms/'+roomCode+'/game',{eventTwoDeaths:true});
    await pushLog(`üíÄ Cette nuit sera doublement meurtri√®re ‚Äî deux victimes !`,'chaos');
  }

  // ‚îÄ‚îÄ Pi√®ge Explosif ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pick a random alive player; if they get voted, 2 others die
  if(ev.name==='Pi√®ge Explosif'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    await dbUpdate('rooms/'+roomCode+'/game',{trapPlayer:t.id});
    await pushLog(`üí£ Un pi√®ge explosif est pos√©‚Ä¶ (la cible ne sait pas qu'elle est pi√©g√©e)`, 'chaos');
  }

  // ‚îÄ‚îÄ Voyante Aveugl√©e ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Force seer to get wrong info; stored as flag used in _seer
  if(ev.name==='Voyante Aveugl√©e'){
    await dbUpdate('rooms/'+roomCode+'/game',{eventSeerBlinded:true});
    await pushLog(`üëÅÔ∏è La Voyante est aveugl√©e ‚Äî ses visions seront fausses cette nuit !`,'chaos');
  }

  // ‚îÄ‚îÄ Duel Obligatoire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pick 2 random alive players; host triggers vote between them
  if(ev.name==='Duel Obligatoire'){
    if(alive.length>=2){
      const shuffled=[...alive].sort(()=>Math.random()-.5);
      const [pA,pB]=shuffled;
      await dbUpdate('rooms/'+roomCode+'/game',{duelA:pA.id, duelB:pB.id, duelActive:true});
      await pushLog(`‚öîÔ∏è DUEL entre ${pA.name} et ${pB.name} ! Le village vote pour en √©liminer un.`,'chaos');
    }
  }

  // ‚îÄ‚îÄ Brouillard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Disable chat for 60s ‚Äî stored as flag with timestamp
  if(ev.name==='Brouillard'){
    const fogEnd = Date.now()+60000;
    await dbUpdate('rooms/'+roomCode+'/game',{fogEnd});
    await pushLog(`üå´Ô∏è Brouillard ! Le chat est d√©sactiv√© pendant 60 secondes.`,'chaos');
  }

  // ‚îÄ‚îÄ Silence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pick a random alive player; they cannot chat this turn
  if(ev.name==='Silence'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    await dbUpdate('rooms/'+roomCode+'/game',{silencedPlayer:t.id, silencedTurn:g?.turn||1});
    await pushLog(`ü§´ ${t.name} est r√©duit(e) au silence pour ce tour !`,'chaos');
  }

  // ‚îÄ‚îÄ D√©bat Limit√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Cut day phase duration to 60s
  if(ev.name==='D√©bat Limit√©'){
    const newEnd = Date.now()+60000;
    await dbUpdate('rooms/'+roomCode+'/game',{phaseEndTime:newEnd});
    await pushLog(`‚è±Ô∏è D√©bat Limit√© ! Vous n'avez qu'une minute pour d√©cider.`,'chaos');
  }

  // ‚îÄ‚îÄ Discussions Interdites ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Only blocks chat, NOT the vote phase duration
  if(ev.name==='Discussions Interdites'){
    await dbUpdate('rooms/'+roomCode+'/game',{noDebate:true});
    await pushLog(`üö´ Discussions Interdites ! Les joueurs ne peuvent plus communiquer dans le chat ce tour.`,'chaos');
  }
}

// ================================================================
// KILL
// ================================================================
async function killPlayer(playerId, source){
  const room = await dbGet('rooms/'+roomCode);
  const p = room?.players?.[playerId];
  if(!p||!p.alive) return;
  if(p.protected){
    const r2=await dbGet('rooms/'+roomCode);
    // Garde du Corps: sacrifice himself if HE is the one who protected this player this night
    if(r2?.game?.guardTarget===playerId){
      const guard=Object.values(r2.players||{}).find(q=>q.alive&&q.role==='Garde du Corps');
      if(guard){
        await dbUpdate('rooms/'+roomCode+'/players/'+playerId,{protected:false});
        await dbUpdate('rooms/'+roomCode+'/game',{guardTarget:null});
        await dbUpdate('rooms/'+roomCode+'/players/'+guard.id,{alive:false});
        await pushLog(`üõ°Ô∏è ${guard.name} se sacrifie pour sauver ${p.name} !`,'death');
        if(audioEnabled) playDeathSound();
        pushNarr({fire:'üõ°Ô∏è',color:'#60c090',title:'Sacrifice du Garde',text:`${guard.name} s'est interpos√© entre ${p.name} et la mort. Son sacrifice ne sera pas oubli√©.`});
        if(guard.mayor) await pushLog('üëë Le Maire est mort !','system');
        await checkVictory(); return;
      }
    }
    await pushLog(`üõ°Ô∏è ${p.name} √©tait prot√©g√© ‚Äî l'attaque a √©chou√©.`,'info'); return;
  }

  await dbUpdate('rooms/'+roomCode+'/players/'+playerId,{alive:false});
  await pushLog(`üíÄ ${p.name} a √©t√© √©limin√©(e).`,'death');
  if(audioEnabled) playDeathSound();

  const narr = source==='nuit'||source==='loups'
    ? {fire:'üåë',color:'#e07070',title:'La Nuit a Frapp√©',text:`Les ombres ont d√©chir√© le silence. Ce matin, les villageois ont retrouv√© ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî froid et immobile. Le givre recouvrait ses l√®vres comme si la mort avait scell√© ses secrets.`}
    : {fire:'‚öñÔ∏è',color:'#e0c070',title:'La Justice du Village',text:`Apr√®s de longues heures de d√©bat, la foule a lev√© la main. ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî a √©t√© conduit au centre du village. Ses yeux cherchaient encore un alli√© dans la foule. Il n'en trouva aucun.`};
  pushNarr(narr);

  // Lovers
  const g = room.game;
  if(p.lovers && g){
    const loverId = g.loversA===playerId ? g.loversB : g.loversA;
    const lover = room.players?.[loverId];
    if(lover&&lover.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+loverId,{alive:false});
      await pushLog(`‚ù§Ô∏è ${lover.name} ne peut survivre √† la mort de son amour et meurt aussi.`,'death');
      pushNarr({fire:'üíî',color:'#f48fb1',title:'Un Amour Bris√©',text:`Quand ${p.name} est tomb√©(e), quelque chose dans le c≈ìur de ${lover.name} s'est bris√©. Les amoureux li√©s par Cupidon ne peuvent survivre l'un sans l'autre. La l√©gende s'est confirm√©e.`});
    }
  }
  if(p.mayor) await pushLog(`üëë Le Maire ${p.name} est mort ! Un nouveau Maire doit √™tre √©lu.`,'system');

  // Auto-trigger new mayor election if the deceased was Mayor
  if(p.mayor && isHost){
    const freshR=await dbGet('rooms/'+roomCode);
    const aliveP=Object.values(freshR?.players||{}).filter(q=>q.alive);
    if(aliveP.length>0){
      // Pick a random new mayor from alive players
      const newMayor=aliveP[Math.floor(Math.random()*aliveP.length)];
      const mUpd={};
      aliveP.forEach(q=>{mUpd['rooms/'+roomCode+'/players/'+q.id+'/mayor']=false;});
      mUpd['rooms/'+roomCode+'/players/'+newMayor.id+'/mayor']=true;
      await window._fb.update(window._fb.ref(db),mUpd);
      await pushLog(`üëë ${newMayor.name} h√©rite automatiquement de la couronne du Maire.`,'info');
      pushNarr({fire:'üëë',color:'#d4a017',title:'Nouveau Maire',text:`La couronne ne peut rester sans t√™te. Le destin d√©signe ${newMayor.name} comme nouveau Maire du village. Sa voix comptera double aux votes.`});
    }
  }

  if(p.role==='Chasseur'&&!room.game?.hunterUsed){
    await dbUpdate('rooms/'+roomCode+'/game',{hunterUsed:true});
    pushNarr({fire:'üèπ',color:'#a08040',title:'Le Dernier Tir',text:`${p.name} doit d√©signer une cible ‚Äî tir OBLIGATOIRE.`});
    if(me.id===playerId){
      const fR=await dbGet('rooms/'+roomCode);
      const targets=Object.values(fR.players||{}).filter(q=>q.alive&&q.id!==playerId);
      if(targets.length){
        setTimeout(()=>{
          const ov=document.getElementById('modal-ov');
          document.getElementById('m-title').textContent='üèπ Dernier Tir ‚Äî Obligatoire';
          document.getElementById('m-body').innerHTML='<div class="m-opts"><p style="color:#e07070;font-size:.85rem;margin-bottom:8px">‚ö†Ô∏è Vous DEVEZ choisir une cible !</p>'+
            targets.map(t=>`<button class="m-opt red" onclick="window._hunterShoot('${t.id}')">${t.avatar} ${esc(t.name)}</button>`).join('')+'</div>';
          ov.querySelector('.m-close').style.display='none';
          ov._hunterLock=true; ov.classList.add('open');
        },1500);
      }
    }
  }

  await checkVictory();
}


window._kill=(id,src)=>killPlayer(id,src);
window._hunterShoot=async function(id){
  const ov=document.getElementById('modal-ov');
  ov.querySelector('.m-close').style.display=''; ov._hunterLock=false; ov.classList.remove('open');
  await killPlayer(id,'chasseur');
};

window._setMayor = async function(id){
  const room = await dbGet('rooms/'+roomCode);
  const upd={};
  Object.keys(room.players||{}).forEach(pid=>{upd['rooms/'+roomCode+'/players/'+pid+'/mayor']=false;});
  upd['rooms/'+roomCode+'/players/'+id+'/mayor']=true;
  await window._fb.update(window._fb.ref(db),upd);
  const p=room.players[id];
  if(p) await pushLog(`üëë ${p.name} est √©lu Maire !`,'info');
};

window._revive = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  const r=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(r) await pushLog(`‚ú® ${r.name} est de retour parmi les vivants.`,'info');
};
window._protect = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{protected:true});
  await dbUpdate('rooms/'+roomCode+'/game',{lastProtected:id});
  // No log ‚Äî secret action
};

// ================================================================
// WOLF PRIVATE CHAT
// ================================================================
let wolfChatRendered = 0;
window.sendWolfChat = async function(){
  const inp=document.getElementById('wolf-in');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/wolfchat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts
  });
};
function renderWolfChat(room){
  const msgs = room.wolfchat ? Object.values(room.wolfchat).sort((a,b)=>a.ts-b.ts) : [];
  const c=document.getElementById('wolf-msgs');
  if(!c) return;
  if(msgs.length===wolfChatRendered) return;
  wolfChatRendered=msgs.length;
  c.innerHTML='';
  msgs.forEach(m=>{
    const d=document.createElement('div');
    const isMe=m.id===me.id;
    d.style.cssText=`font-size:.78rem;color:${isMe?'var(--moon)':'#e07070'};`;
    d.innerHTML=`<strong>${m.avatar} ${esc(m.name)}:</strong> <span style="color:var(--moon2)">${esc(m.text)}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}
document.getElementById('wolf-in')?.addEventListener('keypress',e=>{if(e.key==='Enter')sendWolfChat();});

// ================================================================
// NECROMANCER SPIRIT CHAT
// ================================================================
let necroChatRendered = 0;
let lastNecroTurnSeen = 0;
window.sendNecroChat = async function(){
  const inp=document.getElementById('necro-in');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  const ts=Date.now();
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  if(!g?.necroTarget) return;
  // Only necromancer and the targeted dead can chat
  const myP=room.players?.[me.id];
  const isNecro = myP?.role==='N√©cromancien';
  const isDead = !myP?.alive && me.id===g.necroTarget;
  if(!isNecro && !isDead) return;
  await dbSet('rooms/'+roomCode+'/necrochat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts, isDead:!myP?.alive
  });
};
document.getElementById('necro-in')?.addEventListener('keypress',e=>{if(e.key==='Enter')sendNecroChat();});

function renderNecroChat(room){
  const g=room?.game;
  const necroPanel=document.getElementById('necro-chat-panel');
  if(!necroPanel) return;
  const myP=room.players?.[me.id];
  const isNecro = myP?.role==='N√©cromancien' && myP?.alive;
  const isTargetedDead = !myP?.alive && me.id===g?.necroTarget;
  const necroTurn = g?.necroTurn||0;
  const currentTurn = g?.turn||1;
  const necroActive = g?.necroTarget && (g?.phase==='night') && necroTurn===currentTurn;
  // Show panel to necromancer or the targeted dead only, during active night
  necroPanel.style.display = (isNecro||isTargetedDead) && necroActive ? 'block' : 'none';
  // Update panel header to show who's being contacted
  if(necroActive && g?.necroTarget){
    const contactedName = room.players?.[g.necroTarget]?.name || '?';
    const header = necroPanel.querySelector('.wolf-chat-head');
    if(header){
      header.textContent = isNecro
        ? `üíÄ S√©ance ‚Äî Esprit de ${contactedName}`
        : `üíÄ Un N√©cromancien vous contacte‚Ä¶`;
    }
  }
  if(!necroActive) return;
  // Reset counter if new night/turn
  if(necroTurn !== lastNecroTurnSeen){ necroChatRendered = 0; lastNecroTurnSeen = necroTurn; }
  const msgs = room.necrochat ? Object.values(room.necrochat).sort((a,b)=>a.ts-b.ts) : [];
  const c=document.getElementById('necro-msgs');
  if(!c||msgs.length===necroChatRendered) return;
  necroChatRendered=msgs.length;
  c.innerHTML='';
  msgs.forEach(m=>{
    const d=document.createElement('div');
    const isMe=m.id===me.id;
    d.style.cssText=`font-size:.78rem;color:${isMe?'var(--moon)':m.isDead?'#c0a0ff':'#a080e0'};`;
    d.innerHTML=`<strong>${m.avatar} ${esc(m.name)}${m.isDead?' üëª':''}:</strong> <span style="color:var(--moon2)">${esc(m.text)}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

// ================================================================
// WOLF RAGE MODAL (Loup Enrag√© ‚Äî nuit 3, 6, 9...)
// ================================================================
async function wolfRageModal(room){
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup');
  openModal('üî• Nuit Enrag√©e ‚Äî Tuer 2 cibles',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez votre premi√®re cible. Vous devrez ensuite choisir la seconde.</p>`+
    targets.map(p=>`<button class="m-opt red" onclick="window._rageKill('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
let rageFirstKill = null;
window._rageKill = async function(id){
  if(!rageFirstKill){
    rageFirstKill = id;
    const room=await dbGet('rooms/'+roomCode);
    const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==id);
    openModal('üî• Deuxi√®me Cible',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez votre seconde victime !</p>`+
      targets.map(p=>`<button class="m-opt red" onclick="window._rageKill('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  } else {
    const first = rageFirstKill;
    rageFirstKill = null;
    await killPlayer(first,'nuit');
    await killPlayer(id,'nuit');
  }
};

// ================================================================
// FLEA WOLF MODAL (Loup aux Puces)
// ================================================================
async function fleaModal(room){
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==me.id);
  openModal('üêú Loup aux Puces ‚Äî Infecter',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Cette personne deviendra Loup-Garou dans 2 tours, sans s'en rendre compte imm√©diatement.</p>`+
    targets.map(p=>`<button class="m-opt red" onclick="window._flea('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._flea = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  if(!p) return;
  // Store the flea target and the turn it was applied
  await dbUpdate('rooms/'+roomCode+'/game',{fleaUsed:true, fleaTarget:id, fleaTurn:room.game.turn});
  // no log ‚Äî secret
  pushNarr({fire:'üêú',color:'#8a6030',title:'La Contamination',text:`Dans l'obscurit√©, quelque chose a ramp√© sur ${p.name}. Invisible, indolore. Pour l'instant. Mais dans quelques nuits, ${p.name} entendra l'appel de la meute‚Ä¶`});
};


// ================================================================
// NEW ROLE ACTIONS
// ================================================================
async function infectModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==me.id);
  if(room.game?.infectUsed) {openModal('ü¶†','<p style="color:var(--smoke);font-style:italic;">Pouvoir d√©j√† utilis√© cette partie.</p>');return;}
  openModal('ü¶† Loup Infectieux ‚Äî Transformer',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Au lieu de tuer, vous transformez cette personne en Loup-Garou !</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._infect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._infect = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  if(!p) return;
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{role:'Loup-Garou'});
  await dbUpdate('rooms/'+roomCode+'/game',{infectUsed:true});
  // no log ‚Äî secret
  pushNarr({fire:'ü¶†',color:'#c07040',title:'L\'Infection Se R√©pand',text:`Dans le silence de la nuit, quelqu'un a re√ßu la morsure transformatrice. Demain matin, le village comptera peut-√™tre un loup de plus sans le savoir‚Ä¶`});
};

async function illusionModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('ü™Ñ Illusionniste ‚Äî Fausser',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">La Voyante recevra une information erron√©e sur ce joueur cette nuit.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._illuse('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._illuse = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  if(!g) return;
  const cooldown = Math.random()<0.5 ? 2 : 3;
  await dbUpdate('rooms/'+roomCode+'/game',{illusionTarget:id, illusionUsedThisNight:true, illusionLastTurn:g.turn||1, illusionCooldownLength:cooldown});
  // no log ‚Äî secret
};

async function hypnoModal(room){
  const g = room.game;
  // Check cooldown
  if(g?.hypnoUsedTurn){
    const cooldown = g.hypnoCooldownLength || 2;
    const turnsLeft = (g.hypnoUsedTurn + cooldown) - (g.turn||1);
    if(turnsLeft > 0){
      openModal('üåÄ Hypnotiseur','<p style="color:var(--smoke);font-style:italic;">Pouvoir en recharge‚Ä¶ encore '+ turnsLeft +' tour(s).</p>');
      return;
    }
  }
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üåÄ Hypnotiseur ‚Äî Cibler',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Demain, ce joueur sera forc√© de voter pour la cible que vous choisissez maintenant.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._hypnoTarget('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._hypnoTarget = async function(victimId){
  const room=await dbGet('rooms/'+roomCode);
  const victim=room?.players?.[victimId];
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==victimId);
  openModal(`üåÄ Qui doit voter ${victim?.name||'?'} ?`,
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez la cible forc√©e.</p>`+
    targets.map(p=>`<button class="m-opt purple" onclick="window._hypno('${victimId}','${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
};
window._hypno = async function(victimId, forcedTargetId){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[victimId];
  const g=room?.game;
  if(!p||!g) return;
  const cooldown = Math.random()<0.5 ? 2 : 3;
  await dbUpdate('rooms/'+roomCode+'/game',{
    hypnoVictim: victimId,
    hypnoForcedTarget: forcedTargetId,
    hypnoUsedTurn: g.turn||1,
    hypnoCooldownLength: cooldown
  });
  // no log ‚Äî secret
};

async function usurpModal(room){
  const g=room.game;
  if(g?.usurpDone){
    openModal('üé≠ Usurpateur','<p style="color:var(--smoke);font-style:italic;">Vous avez d√©j√† usurp√© un r√¥le pour cette partie.</p>');
    return;
  }
  // DO NOT show roles ‚Äî player sees only names/avatars
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üé≠ Usurpateur ‚Äî Choisir une cible',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez un joueur dont vous allez copier le pouvoir secret. Vous ne saurez pas ce que vous copiez avant de choisir.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._usurp('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._usurp = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  const g=room?.game;
  if(!p||!g) return;
  if(g.usurpDone){
    openModal('üé≠ Usurpateur','<p style="color:var(--smoke);font-style:italic;">Vous avez d√©j√† usurp√© un r√¥le pour cette partie.</p>');
    return;
  }
  const stolenRole = p.role;
  const rd = ALL_ROLES[stolenRole];
  // Change the Usurpateur's actual role in DB permanently
  await dbUpdate('rooms/'+roomCode+'/players/'+me.id, {role: stolenRole});
  await dbUpdate('rooms/'+roomCode+'/game', {usurpDone: true, usurpUsedTurn: g.turn||1});
  openModal('üé≠ R√¥le Usurp√© !',`<div style="text-align:center;padding:16px;">
    <div style="font-size:2.5rem;">${rd?.emoji||'?'}</div>
    <div style="font-family:'Cinzel Decorative',serif;margin-top:8px;font-size:1rem;">${stolenRole}</div>
    <div style="color:var(--smoke);font-size:.83rem;margin-top:6px;font-style:italic;">${rd?.desc||''}</div>
    <div style="color:var(--ember2);font-size:.85rem;margin-top:10px;">Ce r√¥le est d√©sormais le v√¥tre pour toute la partie.</div>
  </div>`);
  // no log ‚Äî secret
};

async function puppetModal(room){
  const g=room.game;
  // Cooldown: 2 or 3 nights (puppetCooldownLength set at use time)
  if(g?.puppetUsedTurn){
    const cooldown = g.puppetCooldownLength || 2;
    const turnsLeft = (g.puppetUsedTurn + cooldown) - (g.turn||1);
    if(turnsLeft > 0){
      openModal('üßµ Marionnettiste',`<p style="color:var(--smoke);font-style:italic;">Pouvoir en recharge‚Ä¶ encore ${turnsLeft} nuit(s).</p>`);
      return;
    }
  }
  // DO NOT show roles ‚Äî player sees only names/avatars
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  if(!players.length){
    openModal('üßµ Marionnettiste','<p style="color:var(--smoke);font-style:italic;">Aucune cible disponible.</p>');
    return;
  }
  openModal('üßµ Marionnettiste ‚Äî Contr√¥ler',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez un joueur √† contr√¥ler. Demain, il sera forc√© de voter pour la cible que vous choisissez.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._puppetChoose('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._puppetChoose = async function(victimId){
  const room=await dbGet('rooms/'+roomCode);
  const victim=room?.players?.[victimId];
  if(!victim) return;
  // Step 2: choose who the victim must vote for (hide roles)
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==victimId);
  openModal(`üßµ Qui doit voter ${esc(victim.name)} ?`,
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez la cible que vous forcez ${esc(victim.name)} √† voter demain.</p>`+
    targets.map(p=>`<button class="m-opt purple" onclick="window._puppet('${victimId}','${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
};
window._puppet = async function(victimId, forcedTargetId){
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  const victim=room?.players?.[victimId];
  if(!victim||!g) return;
  const cooldown = Math.random()<0.5 ? 2 : 3;
  await dbUpdate('rooms/'+roomCode+'/game',{
    puppetVictim:victimId,
    puppetAction:'vote_forced',
    puppetUsedTurn:g.turn||1,
    puppetCooldownLength:cooldown,
    // Reuse hypno system for forced vote
    hypnoVictim:victimId,
    hypnoForcedTarget:forcedTargetId,
    hypnoUsedTurn:g.turn||1,
    hypnoCooldownLength:1
  });
  // no public log ‚Äî secret

};

async function advocateModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚öñÔ∏è Avocat ‚Äî Prot√©ger du vote',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Ce joueur ne pourra pas √™tre √©limin√© par vote aujourd\'hui.</p>`+
    players.map(p=>`<button class="m-opt" onclick="window._protect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function hunterModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  const myP=Object.values(room.players||{}).find(p=>p.id===me.id);
  if(myP?.alive){openModal('üèπ','<p style="color:var(--smoke);font-style:italic;">Vous n\'√™tes pas encore √©limin√©(e). Ce pouvoir s\'active √† votre mort.</p>');return;}
  openModal('üèπ Chasseur ‚Äî Dernier Tir',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Vous emportez quelqu\'un avec vous !</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._kill('${p.id}','chasseur');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function mayorPassModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üëë Passer la Couronne',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">D√©signez votre successeur comme Maire.</p>`+
    players.map(p=>`<button class="m-opt" onclick="window._setMayor('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

// ================================================================
async function seerModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üîÆ Voyante ‚Äî Voir un r√¥le',
    players.map(p=>`<button class="m-opt" onclick="window._seer('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._seer = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(!p) return;
  // Mark seer as used this night
  await dbUpdate('rooms/'+roomCode+'/game',{seerUsed:true});
  // Check Voyante Aveugl√©e event: force wrong info
  let displayRole = p.role;
  let faked = false;
  const eventBlinded = room?.game?.eventSeerBlinded;
  const illusionTarget = room?.game?.illusionTarget;

  if(eventBlinded || illusionTarget === id){
    const allRoleNames = Object.keys(ALL_ROLES);
    const myRoleData = ALL_ROLES[p.role];
    const otherRoles = allRoleNames.filter(r=>r!==p.role&&ALL_ROLES[r].camp !== myRoleData?.camp);
    displayRole = otherRoles[Math.floor(Math.random()*otherRoles.length)] || p.role;
    faked = true;
    if(illusionTarget === id){
      await dbUpdate('rooms/'+roomCode+'/game',{illusionTarget:null, illusionUsedThisNight:false});
    }
  }
  const rd=ALL_ROLES[displayRole];
  openModal('üîÆ R√©v√©lation',`<div style="text-align:center;padding:18px;">
    <div style="font-size:2.5rem;margin-bottom:9px;">${rd?.emoji||'‚ùì'}</div>
    <div style="font-family:'Cinzel Decorative',serif;font-size:.95rem;">${esc(p.name)}</div>
    <div style="font-size:.82rem;color:var(--smoke);margin-top:5px;font-style:italic;">${rd?.emoji} ${displayRole}</div>
    <div style="font-size:.79rem;color:var(--smoke);margin-top:4px;">${rd?.desc||''}</div>
    ${faked?'<div style="font-size:.72rem;color:#c0a0ff;margin-top:8px;font-style:italic;">‚ö†Ô∏è Cette vision a peut-√™tre √©t√© alt√©r√©e par une force myst√©rieuse‚Ä¶</div>':''}
  </div>`);
};

// ================================================================
// VOTE SYSTEM ‚Äî tracks per-player votes, auto-resolves when all voted
// ================================================================
async function voteModal(room){
  const g = room.game;
  const myVote = g?.dayVotes?.[me.id];
  if(myVote){
    const target = Object.values(room.players||{}).find(p=>p.id===myVote);
    openModal('‚úÖ D√©j√† vot√©',`<div style="text-align:center;padding:14px;color:var(--smoke);font-style:italic;">
      Votre vote contre <strong style="color:var(--moon)">${target?.name||'?'}</strong> est enregistr√©.<br>
      Attendez que tous aient vot√©‚Ä¶
    </div>`);
    return;
  }
  let players = Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  let title = '‚öñÔ∏è Voter pour √©liminer';
  let hint = 'Vote irr√©vocable ‚Äî le joueur avec le plus de voix sera √©limin√©.';
  // Duel: restrict to duelA/duelB
  if(g?.duelActive && g?.duelA && g?.duelB){
    players = players.filter(p=>p.id===g.duelA||p.id===g.duelB);
    title = '‚öîÔ∏è Duel Obligatoire';
    hint = 'Vous devez voter pour l\'un des deux duellistes uniquement !';
  }
  openModal(title,
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">${hint}</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._vote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

window._vote = async function(targetId){
  const room = await dbGet('rooms/'+roomCode);
  if(!room?.game || room.game.phase !== 'day') return;
  if(room.game.voteResolved) return; // Already resolved
  const voter = room.players?.[me.id];
  if(!voter?.alive) return;
  if(room.game.dayVotes?.[me.id]) return; // already voted

  // Hypnotiseur: force vote if this player is the victim
  const g = room.game;
  if(g?.hypnoVictim === me.id && g?.hypnoForcedTarget){
    const forcedTarget = room.players?.[g.hypnoForcedTarget];
    if(forcedTarget?.alive && targetId !== g.hypnoForcedTarget){
      openModal('üåÄ Hypnose !',`<div style="text-align:center;padding:14px;color:var(--smoke);font-style:italic;">Une force irr√©sistible contr√¥le votre vote‚Ä¶ <strong style="color:#c0a0ff">${forcedTarget?.name||'?'}</strong> est votre seule cible possible !</div>`);
      targetId = g.hypnoForcedTarget; // force the vote
    }
  }

  const target = room.players?.[targetId];
  if(!target?.alive) return;

  const voteUpdate = {};
  voteUpdate[`rooms/${roomCode}/game/dayVotes/${me.id}`] = targetId;
  await window._fb.update(window._fb.ref(db), voteUpdate);
  await pushLog(`üó≥Ô∏è ${voter.name} vote contre ${target.name}.${voter.mayor?' (voix √ó2)':''}`, 'day');

  // Check if all alive players have now voted
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom.game?.voteResolved) return; // Another client already resolved
  const alivePlayers = Object.values(freshRoom.players||{}).filter(p=>p.alive);
  const votes = freshRoom.game?.dayVotes || {};
  const votedCount = alivePlayers.filter(p=>votes[p.id]).length;

  if(votedCount >= alivePlayers.length){
    // Claim resolution with atomic guard
    const claimUpd = {};
    claimUpd[`rooms/${roomCode}/game/voteResolved`] = true;
    await window._fb.update(window._fb.ref(db), claimUpd);
    // Re-read to confirm we're the one who set it (simple approach: just proceed)
    await resolveVote(freshRoom);
  }
};

async function resolveVote(room){
  const votes = room.game?.dayVotes || {};
  const players = room.players || {};
  const g = room.game || {};

  // Tally votes (mayor = 2, double vote event = √ó2 for everyone)
  const tally = {};
  const doubleVote = g.eventDoubleVote || false;
  Object.entries(votes).forEach(([vid, tid])=>{
    let w = players[vid]?.mayor ? 2 : 1;
    if(doubleVote) w *= 2;
    tally[tid] = (tally[tid]||0) + w;
  });

  // Duel Obligatoire: restrict votes to duelA/duelB only
  const duelActive = g.duelActive;
  const duelTally = {};
  if(duelActive && g.duelA && g.duelB){
    [g.duelA, g.duelB].forEach(id=>{ duelTally[id] = tally[id]||0; });
  }
  const activeTally = duelActive ? duelTally : tally;

  if(!Object.keys(activeTally).length) { await switchPhase('night'); return; }

  const allVals = Object.values(activeTally);
  const maxVotes = Math.max(...allVals);
  const minVotes = Math.min(...allVals);

  // Vote Invers√©: player with MOST votes is SAVED, player with LEAST is eliminated
  const voteInverse = g.eventVoteInverse || false;
  let eliminatedId;
  if(voteInverse){
    const saved = Object.keys(activeTally).filter(id=>activeTally[id]===maxVotes);
    const savedName = players[saved[0]]?.name||'?';
    await pushLog(`üîÉ Vote Invers√© : ${savedName} (le plus vot√©) est sauv√©(e) !`,'chaos');
    const losers = Object.keys(activeTally).filter(id=>activeTally[id]===minVotes);
    eliminatedId = losers[Math.floor(Math.random()*losers.length)];
  } else {
    const top = Object.keys(activeTally).filter(id=>activeTally[id]===maxVotes);
    eliminatedId = top[Math.floor(Math.random()*top.length)];
  }
  const p = players[eliminatedId];

  // Results log
  const summary = Object.entries(activeTally)
    .sort((a,b)=>b[1]-a[1])
    .map(([id,v])=>`${players[id]?.name||'?'} (${v})`)
    .join(', ');
  await pushLog(`üìä R√©sultats : ${summary}`, 'day');
  await pushLog(`‚öñÔ∏è ${p?.name} est √©limin√©(e) par le vote du village.`, 'death');

  // Clear votes + event flags
  await dbUpdate('rooms/'+roomCode+'/game', {
    dayVotes: null,
    eventDoubleVote: false,
    eventVoteInverse: false,
    duelActive: false, duelA: null, duelB: null,
    noDebate: false
  });

  // Pi√®ge Explosif: if eliminated player is the trapped one, kill 2 more random
  if(g.trapPlayer && g.trapPlayer === eliminatedId){
    await pushLog(`üí£ BOOM ! ${p?.name} √©tait pi√©g√©(e) ‚Äî l'explosion tue 2 autres joueurs !`,'chaos');
    pushNarr({fire:'üí£',color:'#ff6030',title:'L\'Explosion !',
      text:`Le pi√®ge explosif se d√©clenche ! ${p?.name} explose, emportant d'autres innocents dans la mort.`});
    // Kill 2 random others
    const others = Object.values(players).filter(q=>q.alive&&q.id!==eliminatedId);
    const shuffled=[...others].sort(()=>Math.random()-.5).slice(0,2);
    for(const victim of shuffled){
      await killPlayer(victim.id,'explosion');
    }
    await dbUpdate('rooms/'+roomCode+'/game',{trapPlayer:null});
  }

  // Kill or avocat protection
  if(p?.protected){
    await pushLog(`üõ°Ô∏è ${p.name} √©tait prot√©g√©(e) ‚Äî le vote n'a aucun effet !`, 'info');
    pushNarr({fire:'‚öñÔ∏è',color:'#c8a050',title:'Le Village a Vot√©',
      text:`La foule avait choisi. Mais au moment de la sentence, quelqu'un a brandi un acte de protection. ${p.name} reste en vie. Les visages se d√©composent.`});
  } else {
    pushNarr({fire:'‚öñÔ∏è',color:'#e0c070',title:'La Justice du Village',
      text:`Apr√®s les d√©bats et les accusations, le village a tranch√©. ${p?.name} ‚Äî les yeux cherchant encore un ami dans la foule ‚Äî est conduit vers sa derni√®re demeure. Avait-il tort de vous faire confiance ?`});
    await killPlayer(eliminatedId, 'vote');
  }

  // Transition to night
  await switchPhase('night');
}

async function wolfVoteModal(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup');
  const g = room.game;
  const myWolfVote = g?.wolfVotes?.[me.id];
  if(myWolfVote){
    const t = room.players?.[myWolfVote];
    openModal('üê∫ Cible d√©j√† d√©sign√©e',`<div style="text-align:center;padding:12px;color:var(--smoke);font-style:italic;">Vous avez d√©sign√© <strong style="color:#e07070">${t?.name||'?'}</strong> comme cible.</div>`);
    return;
  }
  openModal('üê∫ D√©signer la victime de la nuit',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">La cible avec le plus de votes sera tu√©e √† l'aube.</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._wolfVote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._wolfVote = async function(targetId){
  const room = await dbGet('rooms/'+roomCode);
  if(!room?.game || room.game.phase !== 'night') return;
  const voter = room.players?.[me.id];
  const target = room.players?.[targetId];
  if(!voter?.alive || !target?.alive) return;
  if(room.game.wolfVotes?.[me.id]) return;
  const upd = {};
  upd[`rooms/${roomCode}/game/wolfVotes/${me.id}`] = targetId;
  await window._fb.update(window._fb.ref(db), upd);
  // Also post in wolf chat so pack sees
  await dbSet('rooms/'+roomCode+'/wolfchat/'+Date.now()+'_v_'+me.id.substr(0,4),{
    id:me.id, name:me.name, avatar:me.avatar,
    text:`üó≥Ô∏è Je vote pour tuer ${target.avatar} ${target.name}.`, ts:Date.now()
  });
};

async function protectModal(room){
  const lastProtected = room.game?.lastProtected;
  const players = Object.values(room.players||{}).filter(p=>p.alive && p.id!==lastProtected);
  if(!players.length){
    openModal('üõ°Ô∏è','<p style="color:var(--smoke);font-style:italic;">Vous ne pouvez pas prot√©ger la m√™me personne deux nuits cons√©cutives.</p>');
    return;
  }
  const lastP = lastProtected ? Object.values(room.players||{}).find(p=>p.id===lastProtected) : null;
  openModal('üõ°Ô∏è Prot√©ger un joueur',
    (lastP?`<p style="font-size:.78rem;color:var(--smoke);margin-bottom:8px;font-style:italic;">‚ö†Ô∏è Vous ne pouvez pas prot√©ger ${esc(lastP.name)} deux nuits d'affil√©e.</p>`:'') +
    players.map(p=>`<button class="m-opt green" onclick="window._protect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function witchLifeModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('üß™','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† ressusciter.</p>');return;}
  openModal('üß™ Potion de Vie',
    players.map(p=>`<button class="m-opt" onclick="window._witchLife('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchLife = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`‚ú® Une main inconnue a arrach√© ${p.name} √† la mort cette nuit‚Ä¶`,'info');
};

async function witchDeathModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚ò†Ô∏è Potion de Mort',
    players.map(p=>`<button class="m-opt red" onclick="window._witchDeath('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchDeath = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:false});
  await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p){
    await pushLog(`üíÄ ${p.name} a √©t√© retrouv√©(e) sans vie cette nuit.`,'death');
    pushNarr({fire:'üß™',color:'#e07070',title:'Le Poison Frappe',text:`Dans le silence de la nuit, la Sorci√®re a lev√© son flacon de mort. ${p.name} n'a pas eu le temps de comprendre ce qui se passait. Le poison a fait son ≈ìuvre en quelques secondes.`});
    await checkVictory();
  }
};

async function godModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('‚ú®','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† sauver.</p>');return;}
  openModal('‚ú® Dieu du Village ‚Äî Annuler',
    players.map(p=>`<button class="m-opt" onclick="window._god('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._god = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{godUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`‚ú® Le Dieu du Village annule l'√©limination de ${p.name} !`,'info');
};

async function chronoAction(){
  const g=await dbGet('rooms/'+roomCode+'/game');
  await dbUpdate('rooms/'+roomCode+'/game',{turn:Math.max(1,(g?.turn||1)-1),chronoUsed:true});
  await pushLog('‚è≥ Une force myst√©rieuse semble avoir rembobin√© le temps‚Ä¶','chaos');
  pushNarr({fire:'‚è≥',color:'#a0c0ff',title:'Le Temps Rembobine',text:'Un frisson √©trange parcourt le village. Les ombres reculent. Quelques instants s\'effacent comme s\'ils n\'avaient jamais exist√©. Le Chronomancien sourit en rangeant son sablier.'});
}

async function necroModal(room){
  const dead=Object.values(room.players||{}).filter(p=>!p.alive);
  const g=room.game;
  if(!dead.length){openModal('üíÄ','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† consulter.</p>');return;}
  // If already opened a seance this night, show who it's with
  if(g?.necroTarget){
    const target=room.players?.[g.necroTarget];
    openModal('üíÄ S√©ance en cours',`<div style="text-align:center;padding:14px;color:var(--smoke);font-style:italic;">
      Vous √™tes en communication avec l'esprit de <strong style="color:var(--moon)">${esc(target?.name||'?')}</strong> cette nuit.
    </div>`);
    return;
  }
  // Choose which dead to contact
  openModal('üíÄ N√©cromancien ‚Äî Choisir un esprit',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Quel esprit souhaitez-vous contacter cette nuit ? Un canal de chat priv√© s'ouvrira entre vous deux.</p>`+
    dead.map(p=>`<button class="m-opt purple" onclick="window._necroContact('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._necroContact = async function(deadId){
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  const dead=room?.players?.[deadId];
  if(!dead||!g) return;
  // Store necroTarget for this night (cleared at dawn)
  await dbUpdate('rooms/'+roomCode+'/game',{necroTarget:deadId, necroTurn:g.turn||1});
  openModal('üíÄ Connexion √©tablie',`<div style="text-align:center;padding:16px;">
    <div style="font-size:2rem;">üíÄ</div>
    <div style="font-family:'Cinzel Decorative',serif;margin-top:8px;font-size:.9rem;">L'Esprit de ${esc(dead.name)}</div>
    <div style="color:var(--smoke);font-size:.83rem;margin-top:6px;font-style:italic;">Un canal de communication secret s'est ouvert. Cette nuit uniquement, vous pouvez √©changer des messages priv√©s dans le canal des Esprits visible en bas de votre √©cran.</div>
  </div>`);
};

// Cupidon ‚Äî 2-step: pick lover A then lover B
let cupidonFirstChoice = null;
async function cupidonModal(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  if(cupidonFirstChoice){
    const first = room.players?.[cupidonFirstChoice];
    openModal('üíò Cupidon ‚Äî 2√®me Amoureux',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Premier amoureux : <strong style="color:var(--moon)">${first?.name||'?'}</strong><br>Choisissez maintenant le second !</p>`+
      players.filter(p=>p.id!==cupidonFirstChoice)
        .map(p=>`<button class="m-opt green" onclick="window._cupidonLink('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  } else {
    openModal('üíò Cupidon ‚Äî 1er Amoureux',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez le premier amoureux. Vous choisirez ensuite le second.</p>`+
      players.map(p=>`<button class="m-opt green" onclick="window._cupidonFirst('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  }
}
window._cupidonFirst = function(id){
  cupidonFirstChoice = id;
  // Reopen modal for second choice
  dbGet('rooms/'+roomCode).then(room=>cupidonModal(room));
};
window._cupidonLink = async function(secondId){
  const firstId = cupidonFirstChoice;
  cupidonFirstChoice = null;
  const room = await dbGet('rooms/'+roomCode);
  const a = room?.players?.[firstId];
  const b = room?.players?.[secondId];
  if(!a||!b) return;
  const upd = {};
  upd['rooms/'+roomCode+'/players/'+firstId+'/lovers'] = true;
  upd['rooms/'+roomCode+'/players/'+secondId+'/lovers'] = true;
  upd['rooms/'+roomCode+'/game/loversA'] = firstId;
  upd['rooms/'+roomCode+'/game/loversB'] = secondId;
  upd['rooms/'+roomCode+'/game/cupidonDone'] = true;
  await window._fb.update(window._fb.ref(db), upd);
  // Store lover IDs so each player can see their own private narr
  await dbUpdate('rooms/'+roomCode+'/game', {loversNarrPending: true});
  // Cupidon sees who they linked
  queueNarr({fire:'üíò',color:'#f48fb1',title:'Amoureux Li√©s !',
    text:`Dans le secret de la nuit, vous avez tendu votre arc. ${a.name} et ${b.name} sont d√©sormais li√©s par un fil invisible. Si l'un meurt, l'autre suivra.`});
};

// ================================================================
// CHAT
// ================================================================
window.sendChat = async function(){
  const inp=document.getElementById('chat-in');
  const text=inp.value.trim();
  if(!text) return;
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  // Brouillard: block chat until fogEnd
  if(g?.fogEnd && Date.now()<g.fogEnd){
    const secs=Math.ceil((g.fogEnd-Date.now())/1000);
    inp.value='';
    openModal('üå´Ô∏è Brouillard',`<p style="color:var(--smoke);font-style:italic;">Vous ne pouvez pas parler ! Le brouillard l√®ve dans ${secs} seconde(s).</p>`);
    return;
  }
  // Silence: block this specific player
  if(g?.silencedPlayer===me.id && g?.silencedTurn===(g?.turn||1)){
    inp.value='';
    openModal('ü§´ Silence',`<p style="color:var(--smoke);font-style:italic;">Vous √™tes r√©duit(e) au silence ce tour ! Impossible de parler.</p>`);
    return;
  }
  // Discussions Interdites ‚Äî only blocks chat, vote still works
  if(g?.noDebate && g?.phase==='day'){
    inp.value='';
    openModal('üö´ Discussions Interdites',`<p style="color:var(--smoke);font-style:italic;">Les discussions sont interdites ce tour ! Vous pouvez voter, mais pas communiquer.</p>`);
    return;
  }
  inp.value='';
  const ts=Date.now();
  const myP=room?.players?.[me.id];
  await dbSet('rooms/'+roomCode+'/chat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts, dead:myP?!myP.alive:false
  });
};

// Update chat input visual state based on restrictions
function updateChatInputState(g){
  const inp = document.getElementById('chat-in');
  const chatRow = inp?.parentElement;
  if(!inp || !chatRow) return;
  const silenced = g?.silencedPlayer===me.id && g?.silencedTurn===(g?.turn||1);
  const fogged = g?.fogEnd && Date.now()<g?.fogEnd;
  const noDebate = g?.noDebate && g?.phase==='day';
  const blocked = silenced || fogged || noDebate;
  inp.disabled = blocked;
  inp.classList.toggle('silenced', blocked);
  let badge = chatRow.querySelector('.silenced-badge');
  if(blocked && !badge){
    badge = document.createElement('div');
    badge.className = 'silenced-badge';
    const msg = silenced ? 'ü§´ Vous √™tes r√©duit(e) au silence' : fogged ? 'üå´Ô∏è Brouillard ‚Äî chat bloqu√©' : 'üö´ Discussions interdites';
    badge.textContent = msg;
    chatRow.insertBefore(badge, inp);
  } else if(!blocked && badge){
    badge.remove();
  }
}

function renderChat(room){
  // Merge chat messages and log entries, sorted by timestamp
  const msgs = room.chat ? Object.values(room.chat).sort((a,b)=>a.ts-b.ts) : [];
  const logs = room.log ? Object.values(room.log).sort((a,b)=>a.ts-b.ts) : [];

  const total = msgs.length + logs.length;
  if(total===chatRendered) return;
  chatRendered=total;

  const c=document.getElementById('chat-msgs');
  c.innerHTML='';

  // Merge and sort all entries
  const all = [
    ...msgs.map(m=>({...m,_type:'chat'})),
    ...logs.map(l=>({...l,_type:'log'}))
  ].sort((a,b)=>a.ts-b.ts);

  all.forEach(m=>{
    const d=document.createElement('div');
    if(m._type==='log'){
      d.className=`c-msg sys ${m.type||''}`;
      d.textContent=m.text;
    } else {
      const isMe=m.id===me.id;
      d.className='c-msg';
      d.innerHTML=`<span class="c-author ${m.dead?'dead':''} ${isMe?'me-author':''}">${m.avatar} ${esc(m.name)}: </span><span class="c-text">${esc(m.text)}</span>`;
    }
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

// ================================================================
// LOG
// ================================================================
async function pushLog(text, type='system'){
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/log/'+ts+'_'+Math.random().toString(36).substr(2,4),{text,type,ts});
}

function checkNewLogNarr(room){
  const logs = room.log ? Object.values(room.log).sort((a,b)=>a.ts-b.ts) : [];
  if(logs.length<=lastSeenLogLen){return;}
  lastSeenLogLen=logs.length;
}

// ================================================================
// VICTORY
// ================================================================
async function checkVictory(){
  const room=await dbGet('rooms/'+roomCode);
  if(!room||!room.game||room.game.victory||room.status==='ended') return;
  const players=Object.values(room.players||{});
  const alive=players.filter(p=>p.alive);
  const aliveLoup=alive.filter(p=>ALL_ROLES[p.role]?.camp==='loup');
  const aliveVillage=alive.filter(p=>ALL_ROLES[p.role]?.camp==='village');
  const g=room.game;

  let victory=null;
  if(alive.length===0){
    victory={type:'chaos',title:'üíÄ Personne ne survit',desc:'Le village s\'est auto-d√©truit. Ni loups ni villageois.',survivors:[],color:'#888888'};
  } else if(alive.length===2 && g.loversA && g.loversB &&
      alive.some(p=>p.id===g.loversA) && alive.some(p=>p.id===g.loversB)){
    victory={type:'lovers',title:'‚ù§Ô∏è Les Amoureux Gagnent !',desc:`Ni le village ni les loups n'ont pu les s√©parer. Leur amour interdit a r√©√©crit la l√©gende.`,survivors:alive,color:'#f48fb1'};
    pushNarr({fire:'‚ù§Ô∏è',color:'#f48fb1',title:'L\'Amour Triomphe',text:`Ils se sont battus contre tous. ${alive[0].name} et ${alive[1].name} survivent ensemble dans un monde qui les a combattus. Leur amour a vaincu les loups et le village.`});
  } else if(alive.length===1&&alive[0].role==='Loup Blanc'){
    victory={type:'white',title:'ü§ç Le Loup Blanc Triomphe',desc:'Il a trahi tout le monde pour finir seul en vie.',survivors:alive,color:'#e0e0e0'};
    pushNarr({fire:'ü§ç',color:'#e0e0e0',title:'Seul Survivant',text:`${alive[0].name} a tout planifi√© depuis le d√©but. Loup parmi les loups, il a attendu le bon moment pour trahir tout le monde. Ce soir, il reste seul debout.`});
  } else if(aliveLoup.length===0&&aliveVillage.length>0){
    victory={type:'village',title:'üåæ Le Village est Sauv√© !',desc:'Chaque loup a √©t√© d√©masqu√©. Ce soir, les enfants dormiront sans peur.',survivors:alive,color:'#70d090'};
    pushNarr({fire:'üåæ',color:'#70d090',title:'La Lumi√®re Triomphe',text:'Contre toute attente, les villageois ont trouv√© la v√©rit√©. Chaque loup d√©masqu√©, chaque mensonge perc√© √† jour. Ce soir, pour la premi√®re fois depuis des semaines, on peut dormir en paix.'});
  } else if(aliveLoup.length>=aliveVillage.length){
    victory={type:'wolf',title:'üê∫ Les Loups Triomphent !',desc:'Nuit apr√®s nuit, ils ont √©limin√© patiemment. La nuit ne finira jamais.',survivors:alive,color:'#e07070'};
    pushNarr({fire:'üê∫',color:'#e07070',title:'La Nuit √âternelle',text:'Ils ont gagn√© m√©thodiquement, nuit apr√®s nuit. Les villageois se sont querell√©s et tromp√©s les uns les autres. √Ä l\'aube, il ne reste que des loups sous peau humaine.'});
  }

  if(victory){
    await dbUpdate('rooms/'+roomCode,{status:'ended','game/victory':victory});
    await pushLog(`üèÜ FIN : ${victory.title}`,'system');
  }
}

function showVictory(v){
  showScreen('victory');
  // Play appropriate victory sound
  if(v.type==='wolf'||v.type==='white') playWolfVictorySound();
  else if(v.type==='village'||v.type==='chaos') playVillageVictorySound();
  else if(v.type==='lovers') playLoversVictorySound();
  const icons={wolf:'üê∫',village:'üåæ',lovers:'‚ù§Ô∏è',white:'ü§ç',chaos:'üíÄ'};
  document.getElementById('v-icon').textContent=icons[v.type]||'üèÜ';
  document.getElementById('v-title').textContent=v.title;
  document.getElementById('v-title').style.color=v.color;
  document.getElementById('v-desc').textContent=v.desc;
  const s=document.getElementById('v-surv');
  const allPlayers = localRoom?.players ? Object.values(localRoom.players) : [];
  const survivors = v.survivors||[];
  let html = '';
  if(survivors.length){
    html+='<div style="font-family:\'Cinzel Decorative\',serif;font-size:.72rem;color:var(--smoke);margin-bottom:10px;text-transform:uppercase;letter-spacing:.1em;">Survivants</div>'+
      survivors.map(p=>`<div class="surv-row"><span style="font-size:1.4rem;">${p.avatar}</span><span>${esc(p.name)}</span><span style="color:var(--smoke);font-size:.8rem;font-style:italic;margin-left:auto;">${ALL_ROLES[p.role]?.emoji||''} ${p.role}</span></div>`).join('');
  } else {
    html='<div style="color:var(--smoke);font-style:italic;">Aucun survivant</div>';
  }
  // Reveal all roles
  if(allPlayers.length>0){
    const dead = allPlayers.filter(p=>!p.alive);
    if(dead.length){
      html+='<div style="font-family:\'Cinzel Decorative\',serif;font-size:.72rem;color:var(--smoke);margin:14px 0 8px;text-transform:uppercase;letter-spacing:.1em;border-top:1px solid rgba(232,213,163,.1);padding-top:10px;">‚ö∞Ô∏è √âlimin√©s ‚Äî R√©v√©lation</div>'+
        dead.map(p=>`<div class="surv-row" style="opacity:.7;"><span style="font-size:1.4rem;filter:grayscale(1)">${p.avatar}</span><span style="text-decoration:line-through;color:var(--smoke)">${esc(p.name)}</span><span style="color:var(--smoke);font-size:.8rem;font-style:italic;margin-left:auto;">${ALL_ROLES[p.role]?.emoji||''} ${p.role}</span></div>`).join('');
    }
  }
  s.innerHTML=html;
}

window.backToWelcome = function(){
  if(unsubRoom) unsubRoom();
  if(timerInterval) clearInterval(timerInterval);
  chatRendered=0; wolfChatRendered=0; lastSeenLogLen=0; lastSeenNarrLen=0; narrQueue=[]; narrActive=false; shownDawnTurns=new Set(); loversNarrShown=false;
  selectedRoles=new Set(['Loup-Garou','Villageois','Voyante']);
  showScreen('welcome');
};

// ================================================================
// NARRATIVE ‚Äî shared via Firebase
// ================================================================
function queueNarr(n){narrQueue.push(n);if(!narrActive)showNextNarr();}
async function pushNarr(n){
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/narr/'+ts+'_'+Math.random().toString(36).substr(2,4), {...n, ts});
}
function checkNewNarr(room){
  const narrs = room.narr ? Object.values(room.narr).sort((a,b)=>a.ts-b.ts) : [];
  if(narrs.length<=lastSeenNarrLen){return;}
  for(let i=lastSeenNarrLen;i<narrs.length;i++) queueNarr(narrs[i]);
  lastSeenNarrLen=narrs.length;
}
function showNextNarr(){
  if(!narrQueue.length){narrActive=false;return;}
  narrActive=true;
  const n=narrQueue.shift();
  const ov=document.getElementById('narr');
  document.getElementById('n-fire').textContent=n.fire||'üî•';
  document.getElementById('n-title').textContent=n.title;
  document.getElementById('n-title').style.color=n.color||'var(--moon)';
  document.getElementById('n-text').textContent=n.text;
  ['n-title','n-text'].forEach(id=>{const el=document.getElementById(id);el.style.animation='none';void el.offsetWidth;el.style.animation='';});
  const btn=ov.querySelector('.narr-btn');
  btn.style.animation='none';void btn.offsetWidth;btn.style.animation='';
  ov.classList.add('show');
}
window.closeNarr = function(){document.getElementById('narr').classList.remove('show');setTimeout(showNextNarr,400);};

// ================================================================
// MODAL
// ================================================================
window.openModal = function(title,body){
  document.getElementById('m-title').textContent=title;
  document.getElementById('m-body').innerHTML=`<div class="m-opts">${body}</div>`;
  document.getElementById('modal-ov').classList.add('open');
};
window.closeModal=function(){if(document.getElementById('modal-ov')._hunterLock)return;document.getElementById('modal-ov').classList.remove('open');};
document.getElementById('modal-ov').addEventListener('click',e=>{if(e.target===document.getElementById('modal-ov')&&!document.getElementById('modal-ov')._hunterLock)closeModal();});

// ================================================================
// üéôÔ∏è VOICE CHAT ENGINE ‚Äî WebRTC mesh via Firebase signaling
// ================================================================
let voiceActive = false;
let localStream = null;
let voiceMuted = false;
let voicePeers = {}; // peerId -> { pc, audioEl, iceBuf }
let voiceParticipants = {}; // peerId -> {name, avatar, speaking, muted}
let voiceUnsubSignal = null;
let voiceUnsubParticipants = null;
let voiceSpeakingTimer = null;
let voiceAudioCtx = null; // Dedicated AudioContext for voice (separate from game audio)

const VOICE_ICE = {iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:stun2.l.google.com:19302'}
]};

function getVoiceAudioCtx(){
  if(!voiceAudioCtx || voiceAudioCtx.state==='closed'){
    voiceAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(voiceAudioCtx.state==='suspended') voiceAudioCtx.resume();
  return voiceAudioCtx;
}

async function voiceJoin(){
  if(voiceActive) return;
  try{
    localStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true, noiseSuppression:true, sampleRate:48000}, video:false});
  } catch(e){
    openModal('üéôÔ∏è Microphone',`<p style="color:#e07070;font-style:italic;">Impossible d'acc√©der au microphone.<br><small>${e.message}</small></p>`);
    return;
  }
  voiceActive = true;
  voiceMuted = false;

  // Ensure audio context is running (user gesture just happened)
  getVoiceAudioCtx();

  // Register self
  await dbSet('rooms/'+roomCode+'/voice/'+me.id, {
    name:me.name, avatar:me.avatar, id:me.id, muted:false, speaking:false, ts:Date.now()
  });

  // Listen to participants list
  voiceUnsubParticipants = dbListen('rooms/'+roomCode+'/voice', async (data)=>{
    voiceParticipants = data ? {...data} : {};
    renderVoicePanel();
    if(!voiceActive) return;
    if(data){
      for(const [peerId] of Object.entries(data)){
        if(peerId !== me.id && !voicePeers[peerId]){
          // Deterministic: the peer with the lexicographically GREATER id sends the offer
          if(me.id > peerId){
            await voiceCreateOffer(peerId);
          }
          // The peer with SMALLER id waits for an offer (handled in signal listener)
        }
      }
      // Clean up gone peers
      for(const peerId of Object.keys(voicePeers)){
        if(!data[peerId]) voiceClosePeer(peerId);
      }
    } else {
      Object.keys(voicePeers).forEach(pid=>voiceClosePeer(pid));
    }
  });

  // Listen to signaling messages addressed to us
  voiceUnsubSignal = dbListen('rooms/'+roomCode+'/voicesig/'+me.id, async (signals)=>{
    if(!signals||!voiceActive) return;
    // Process signals sorted by timestamp to avoid order issues
    const sorted = Object.entries(signals).sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
    for(const [sigId, sig] of sorted){
      if(!sig?.type) continue;
      await voiceHandleSignal(sig.from, sig);
      await dbSet('rooms/'+roomCode+'/voicesig/'+me.id+'/'+sigId, null);
    }
  });

  voiceStartSpeakingDetection();

  document.getElementById('v-join-btn').style.display='none';
  document.getElementById('v-mute-btn').style.display='flex';
  document.getElementById('v-leave-btn').style.display='flex';
  renderVoicePanel();
}

async function voiceCreateOffer(peerId){
  if(voicePeers[peerId]) return; // already exists
  const pc = voiceCreatePeerConnection(peerId);
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
  try{
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await voiceSendSignal(peerId, {type:'offer', sdp:offer.sdp, from:me.id});
  }catch(e){ console.warn('voiceCreateOffer error',e); }
}

function voiceCreatePeerConnection(peerId){
  // Close existing if any
  if(voicePeers[peerId]?.pc) try{voicePeers[peerId].pc.close();}catch(e){}

  const pc = new RTCPeerConnection(VOICE_ICE);
  voicePeers[peerId] = {pc, audioEl:null, iceBuf:[]};

  pc.onicecandidate = async (e)=>{
    if(e.candidate){
      await voiceSendSignal(peerId, {type:'candidate', candidate:JSON.parse(JSON.stringify(e.candidate)), from:me.id});
    }
  };

  pc.ontrack = (e)=>{
    // Use a real <audio> element attached to the document for autoplay policy
    let audioEl = voicePeers[peerId]?.audioEl;
    if(!audioEl){
      audioEl = document.createElement('audio');
      audioEl.autoplay = true;
      audioEl.style.display='none';
      document.body.appendChild(audioEl);
      if(voicePeers[peerId]) voicePeers[peerId].audioEl = audioEl;
    }
    audioEl.srcObject = e.streams[0];
    audioEl.play().catch(err=>console.warn('audio play blocked:',err));
  };

  pc.onconnectionstatechange = ()=>{
    if(['failed','disconnected','closed'].includes(pc.connectionState)){
      voiceClosePeer(peerId);
      renderVoicePanel();
    }
  };

  pc.onsignalingstatechange = ()=>{
    // Flush buffered ICE candidates once remote description is set
    if(pc.signalingState === 'stable' || pc.signalingState === 'have-remote-offer'){
      const buf = voicePeers[peerId]?.iceBuf || [];
      voicePeers[peerId].iceBuf = [];
      buf.forEach(c=>{ try{pc.addIceCandidate(new RTCIceCandidate(c));}catch(e){} });
    }
  };

  return pc;
}

async function voiceHandleSignal(fromId, sig){
  if(!voiceActive||!fromId) return;

  if(sig.type==='offer'){
    // We received an offer ‚Äî we must be the smaller-id peer
    if(voicePeers[fromId]?.pc) try{voicePeers[fromId].pc.close();}catch(e){}
    const pc = voiceCreatePeerConnection(fromId);
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    try{
      await pc.setRemoteDescription(new RTCSessionDescription({type:'offer', sdp:sig.sdp}));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await voiceSendSignal(fromId, {type:'answer', sdp:answer.sdp, from:me.id});
    }catch(e){ console.warn('voiceHandleSignal offer error',e); }

  } else if(sig.type==='answer'){
    const peer = voicePeers[fromId];
    if(peer?.pc && peer.pc.signalingState==='have-local-offer'){
      try{
        await peer.pc.setRemoteDescription(new RTCSessionDescription({type:'answer', sdp:sig.sdp}));
      }catch(e){ console.warn('voiceHandleSignal answer error',e); }
    }

  } else if(sig.type==='candidate'){
    const peer = voicePeers[fromId];
    if(!peer?.pc) return;
    const cand = new RTCIceCandidate(sig.candidate);
    if(peer.pc.remoteDescription){
      try{ await peer.pc.addIceCandidate(cand); }catch(e){}
    } else {
      // Buffer until remote description is set
      peer.iceBuf = peer.iceBuf||[];
      peer.iceBuf.push(sig.candidate);
    }
  }
}

async function voiceSendSignal(toId, signal){
  const sigId = Date.now()+'_'+Math.random().toString(36).substr(2,6);
  await dbSet('rooms/'+roomCode+'/voicesig/'+toId+'/'+sigId, signal);
}

function voiceClosePeer(peerId){
  const peer = voicePeers[peerId];
  if(!peer) return;
  try{peer.pc.close();}catch(e){}
  if(peer.audioEl){
    try{peer.audioEl.pause();peer.audioEl.srcObject=null;peer.audioEl.remove();}catch(e){}
  }
  delete voicePeers[peerId];
}

async function voiceLeave(){
  if(!voiceActive) return;
  voiceActive = false;
  if(voiceUnsubSignal){voiceUnsubSignal();voiceUnsubSignal=null;}
  if(voiceUnsubParticipants){voiceUnsubParticipants();voiceUnsubParticipants=null;}
  Object.keys(voicePeers).forEach(pid=>voiceClosePeer(pid));
  voicePeers={};
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  if(voiceSpeakingTimer){clearInterval(voiceSpeakingTimer);voiceSpeakingTimer=null;}
  if(voiceAudioCtx){try{voiceAudioCtx.close();}catch(e){} voiceAudioCtx=null;}
  // Remove self from Firebase
  await dbSet('rooms/'+roomCode+'/voice/'+me.id, null);
  // Clean up our signal queue
  await dbSet('rooms/'+roomCode+'/voicesig/'+me.id, null);
  const btn = document.getElementById('v-join-btn');
  if(btn) btn.style.display='flex';
  const muteBtn = document.getElementById('v-mute-btn');
  if(muteBtn){muteBtn.style.display='none';muteBtn.textContent='üé§ Muet';muteBtn.classList.remove('red');}
  const leaveBtn = document.getElementById('v-leave-btn');
  if(leaveBtn) leaveBtn.style.display='none';
  renderVoicePanel();
}

async function voiceToggleMute(){
  if(!localStream) return;
  voiceMuted = !voiceMuted;
  localStream.getAudioTracks().forEach(t=>{ t.enabled = !voiceMuted; });
  const btn = document.getElementById('v-mute-btn');
  if(btn){
    if(voiceMuted){ btn.innerHTML='üîá Reprendre'; btn.classList.add('red'); }
    else { btn.innerHTML='üé§ Muet'; btn.classList.remove('red'); }
  }
  await dbUpdate('rooms/'+roomCode+'/voice/'+me.id, {muted:voiceMuted, speaking:false});
  renderVoicePanel();
}

function voiceStartSpeakingDetection(){
  if(!localStream) return;
  try{
    const ctx = getVoiceAudioCtx();
    const src = ctx.createMediaStreamSource(localStream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.4;
    src.connect(analyser);
    const buf = new Uint8Array(analyser.frequencyBinCount);
    let lastSpeaking = false;

    voiceSpeakingTimer = setInterval(async ()=>{
      if(!voiceActive||voiceMuted||!analyser) return;
      analyser.getByteFrequencyData(buf);
      // Focus on speech frequencies (300hz-3400hz)
      const speechBins = Math.floor(buf.length * 0.15);
      let sum = 0;
      for(let i=speechBins;i<speechBins*3;i++) sum+=buf[i];
      const avg = sum / (speechBins*2);
      const speaking = avg > 10;
      if(speaking !== lastSpeaking){
        lastSpeaking = speaking;
        if(voiceActive){
          try{ await dbUpdate('rooms/'+roomCode+'/voice/'+me.id, {speaking}); }catch(e){}
        }
      }
    }, 150);
  }catch(e){ console.warn('Speaking detection error:',e); }
}

function renderVoicePanel(){
  const panel = document.getElementById('voice-panel');
  const container = document.getElementById('voice-users');
  if(!panel || !container) return;
  const pts = Object.values(voiceParticipants||{});
  if(!pts.length){
    container.innerHTML='<div style="color:var(--smoke);font-size:.76rem;font-style:italic;">Personne en vocal pour l\'instant‚Ä¶</div>';
    return;
  }
  container.innerHTML = pts.map(p=>{
    const isMe = p.id===me.id;
    const speaking = p.speaking && !p.muted;
    const cls = `voice-user${speaking?' speaking':''}${p.muted?' muted':''}`;
    const mic = p.muted ? 'üîá' : (speaking ? 'üîä' : 'üéôÔ∏è');
    return `<div class="${cls}" title="${esc(p.name)}">
      <span class="v-av">${p.avatar||'üßë'}</span>
      <span class="v-name">${esc(p.name)}${isMe?' (vous)':''}</span>
      <span class="v-mic">${mic}</span>
    </div>`;
  }).join('');
}

function initVoicePanel(){
  const panel = document.getElementById('voice-panel');
  if(panel) panel.style.display='block';
  renderVoicePanel();
  // Also watch for Firebase voice changes even before joining
  dbListen('rooms/'+roomCode+'/voice', (data)=>{
    voiceParticipants = data ? {...data} : {};
    renderVoicePanel();
  });
}

// Cleanup voice when leaving game
const _origBackToWelcome = window.backToWelcome;
window.backToWelcome = async function(){
  await voiceLeave();
  _origBackToWelcome();
};

window.voiceJoin = voiceJoin;
window.voiceLeave = voiceLeave;
window.voiceToggleMute = voiceToggleMute;

// ================================================================
// END VOICE CHAT ENGINE
// ================================================================

});
</script>
</body>
</html>
