<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üê∫ Loup-Garou</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">



<style>
:root {
  --blood: #7a1212;
  --blood2: #b02020;
  --ember: #c87941;
  --ember2: #e8a060;
  --moon: #e8d5a3;
  --moon2: #c4aa70;
  --smoke: #8a8070;
  --dark: #080810;
  --dark2: #100f18;
  --dark3: #181828;
  --dark4: #201f32;
  --wolf-clr: #c04040;
  --village-clr: #3a8a5a;
  --neutral-clr: #7a50b0;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--dark);color:var(--moon);font-family:'EB Garamond',Georgia,serif;font-size:16px;overflow-x:hidden;min-height:100vh;}

/* Stars */
.bg-stars{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(1px 1px at 8% 12%,rgba(232,213,163,.7) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 22% 5%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 38% 18%,rgba(232,213,163,.8) 0%,transparent 100%),
  radial-gradient(1px 1px at 55% 8%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 72% 15%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 88% 4%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 15% 35%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 45% 42%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 65% 30%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 92% 28%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 30% 60%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 78% 55%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 5% 75%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 50% 72%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 95% 68%,rgba(232,213,163,.4) 0%,transparent 100%);}
.bg-fog{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(ellipse at 15% 90%,rgba(200,121,65,.06) 0%,transparent 50%),
  radial-gradient(ellipse at 85% 85%,rgba(122,18,18,.08) 0%,transparent 50%),
  radial-gradient(ellipse at 50% 100%,rgba(30,25,15,.4) 0%,transparent 40%);}

/* SCREENS */
#app{position:relative;z-index:1;}
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* WELCOME */
#welcome-screen{align-items:center;justify-content:center;padding:40px 20px;text-align:center;}
.welcome-moon{font-size:5rem;margin-bottom:16px;animation:moonFloat 4s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(232,213,163,.4));}
@keyframes moonFloat{0%,100%{transform:translateY(0) rotate(-5deg);}50%{transform:translateY(-12px) rotate(5deg);}}
.welcome-title{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,8vw,4rem);text-shadow:0 0 40px rgba(232,213,163,.3),0 0 80px rgba(122,18,18,.4);letter-spacing:.05em;margin-bottom:8px;}
.welcome-sub{font-style:italic;color:var(--moon2);font-size:1.1rem;margin-bottom:40px;opacity:.8;}
.welcome-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:680px;}
.w-card{flex:1;min-width:250px;background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:16px;padding:28px 22px;cursor:pointer;transition:all .3s;}
.w-card:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.4);}
.w-card.red:hover{border-color:var(--blood2);box-shadow:0 16px 40px rgba(122,18,18,.25);}
.w-card.green:hover{border-color:#3a8a5a;box-shadow:0 16px 40px rgba(45,122,74,.2);}
.w-card-icon{font-size:2.5rem;margin-bottom:12px;}
.w-card-title{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:8px;}
.w-card-desc{font-size:.88rem;color:var(--smoke);font-style:italic;line-height:1.5;}

/* FORMS */
.form-screen{align-items:center;justify-content:center;padding:40px 20px;}
.form-box{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.15);border-radius:20px;padding:32px 28px;width:100%;max-width:420px;position:relative;}
.form-title{font-family:'Cinzel Decorative',serif;font-size:1.2rem;text-align:center;margin-bottom:22px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:.88rem;color:var(--moon2);margin-bottom:5px;}
.field input{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:8px;color:var(--moon);font-family:'EB Garamond',serif;font-size:1.05rem;padding:10px 14px;outline:none;transition:border-color .2s;}
.field input:focus{border-color:rgba(232,213,163,.45);}
.code-input{text-align:center!important;letter-spacing:.2em!important;font-size:1.5rem!important;font-family:'Cinzel Decorative',serif!important;}
.back-btn{position:absolute;top:14px;left:14px;background:none;border:none;color:var(--smoke);cursor:pointer;font-size:1.1rem;transition:color .2s;}
.back-btn:hover{color:var(--moon);}
.btn-primary{display:block;width:100%;background:linear-gradient(135deg,var(--blood),#500a0a);border:1px solid rgba(176,32,32,.5);color:var(--moon);font-family:'Cinzel Decorative',serif;font-size:.95rem;letter-spacing:.06em;padding:13px;border-radius:10px;cursor:pointer;transition:all .3s;margin-top:8px;box-shadow:0 4px 20px rgba(122,18,18,.3);}
.btn-primary:hover{background:linear-gradient(135deg,var(--blood2),var(--blood));box-shadow:0 6px 30px rgba(122,18,18,.5);transform:translateY(-1px);}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-sec{display:block;width:100%;background:transparent;border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:1rem;padding:10px;border-radius:8px;cursor:pointer;transition:all .2s;margin-top:8px;}
.btn-sec:hover{border-color:rgba(232,213,163,.4);color:var(--moon);}
.err-msg{color:#e07070;font-size:.85rem;text-align:center;padding:6px 0;min-height:24px;}
.ok-msg{color:#70d090;font-size:.85rem;text-align:center;padding:6px 0;}

/* AVATAR PICKER */
.avatar-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:4px;}
.av-btn{background:none;border:2px solid rgba(232,213,163,.1);border-radius:8px;padding:4px 6px;font-size:1.3rem;cursor:pointer;transition:all .2s;}
.av-btn.selected{border-color:rgba(232,213,163,.55);background:rgba(232,213,163,.08);}

/* LOBBY */
#lobby-screen{padding:20px;max-width:700px;margin:0 auto;width:100%;}
.lobby-head{text-align:center;padding:20px 0 24px;}
.lobby-code{font-family:'Cinzel Decorative',serif;font-size:2.4rem;letter-spacing:.18em;color:var(--ember2);text-shadow:0 0 30px rgba(200,121,65,.4);margin-bottom:8px;}
.lobby-lbl{font-size:.84rem;color:var(--smoke);font-style:italic;}
.copy-btn{background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.18);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.84rem;padding:5px 14px;border-radius:20px;cursor:pointer;transition:all .2s;margin-top:8px;}
.copy-btn:hover{background:rgba(232,213,163,.16);color:var(--moon);}
.lobby-players{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin:16px 0;}
.lp-tile{background:var(--dark3);border:1px solid rgba(232,213,163,.1);border-radius:10px;padding:14px 10px;text-align:center;animation:tileIn .4s ease;}
@keyframes tileIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
.lp-tile.host{border-color:rgba(200,121,65,.4);}
.lp-av{font-size:2rem;margin-bottom:5px;}
.lp-name{font-size:.84rem;}
.lp-badge{font-size:.7rem;color:var(--ember);font-style:italic;margin-top:2px;}
.lobby-waiting{font-style:italic;color:var(--smoke);text-align:center;padding:20px;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.5}50%{opacity:1}}
.panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:14px;padding:18px;position:relative;overflow:hidden;margin-bottom:14px;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(232,213,163,.2),transparent);}
.p-title{font-family:'Cinzel Decorative',serif;font-size:.72rem;letter-spacing:.14em;color:var(--moon2);margin-bottom:12px;text-transform:uppercase;}
.roles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:7px;max-height:260px;overflow-y:auto;}
.role-tog{background:rgba(255,255,255,.03);border:1px solid rgba(232,213,163,.1);border-radius:8px;padding:7px 5px;cursor:pointer;transition:all .2s;text-align:center;font-size:.77rem;}
.role-tog:hover{border-color:rgba(232,213,163,.3);}
.role-tog.on{border-color:rgba(232,213,163,.45);background:rgba(232,213,163,.07);}
.role-tog.on.loup{border-color:var(--blood2);background:rgba(122,18,18,.15);}
.role-tog.on.village{border-color:#4a9a5a;background:rgba(45,122,74,.12);}
.role-tog.on.neutre{border-color:#8a60c0;background:rgba(106,64,160,.15);}
.r-em{font-size:1.25rem;display:block;margin-bottom:3px;}
.dur-row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;}
.dur-field{display:flex;flex-direction:column;gap:4px;}
.dur-field label{font-size:.78rem;color:var(--smoke);}
.dur-field input{width:80px;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:6px;color:var(--moon);font-family:inherit;font-size:.95rem;padding:7px 10px;outline:none;}

/* GAME */
#game-screen{padding:14px;max-width:980px;margin:0 auto;width:100%;}

/* Phase Bar ‚Äî dynamic night/day atmosphere */
.phase-bar{display:flex;align-items:center;justify-content:space-between;border-radius:16px;padding:16px 22px;margin-bottom:14px;position:relative;overflow:hidden;transition:all .8s ease;}
.phase-bar.is-night{background:linear-gradient(135deg,#0d0b1a,#12102a);border:1px solid rgba(120,100,200,.25);box-shadow:0 4px 30px rgba(80,60,160,.2);}
.phase-bar.is-day{background:linear-gradient(135deg,#1a1208,#221a0a);border:1px solid rgba(220,160,60,.25);box-shadow:0 4px 30px rgba(200,140,40,.15);}
.phase-bar::before{content:'';position:absolute;inset:0;opacity:.04;pointer-events:none;transition:opacity .8s;}
.phase-bar.is-night::before{background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ccircle cx='5' cy='5' r='1' fill='white'/%3E%3Ccircle cx='25' cy='12' r='.7' fill='white'/%3E%3Ccircle cx='45' cy='3' r='1.2' fill='white'/%3E%3Ccircle cx='15' cy='35' r='.8' fill='white'/%3E%3Ccircle cx='55' cy='28' r='.6' fill='white'/%3E%3Ccircle cx='38' cy='50' r='1' fill='white'/%3E%3C/svg%3E");}
.phase-bar.is-day::before{background:radial-gradient(ellipse at 50% 0%,rgba(255,200,80,.3) 0%,transparent 70%);}
.ph-left{display:flex;align-items:center;gap:14px;}
.ph-icon{font-size:2.2rem;filter:drop-shadow(0 0 12px rgba(232,213,163,.4));transition:all .8s;}
.ph-info{}
.ph-name{font-family:'Cinzel Decorative',serif;font-size:1.05rem;letter-spacing:.04em;}
.ph-desc{font-size:.78rem;color:var(--smoke);font-style:italic;margin-top:2px;}
.ph-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.ph-timer{font-family:'Cinzel Decorative',serif;font-size:2rem;color:var(--ember2);text-shadow:0 0 20px rgba(200,121,65,.4);min-width:64px;text-align:right;transition:color .3s;line-height:1;}
.ph-timer.urgent{color:var(--blood2);text-shadow:0 0 20px rgba(176,32,32,.6);animation:urgPulse .5s ease-in-out infinite;}
@keyframes urgPulse{0%,100%{opacity:1}50%{opacity:.4}}
.ph-turn-badge{font-size:.68rem;color:var(--smoke);font-style:italic;text-align:right;}

.game-cols{display:grid;grid-template-columns:1fr 285px;gap:14px;}
@media(max-width:720px){.game-cols{grid-template-columns:1fr;}}
.game-main{display:flex;flex-direction:column;gap:13px;}

/* Role Card ‚Äî glowing border per camp */
.my-role-card{border-radius:16px;padding:18px 20px;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden;}
.my-role-card.loup{background:linear-gradient(135deg,rgba(80,10,10,.6),rgba(30,8,8,.8));border:1px solid rgba(180,40,40,.35);box-shadow:0 0 20px rgba(122,18,18,.15);}
.my-role-card.village{background:linear-gradient(135deg,rgba(10,50,25,.6),rgba(8,30,15,.8));border:1px solid rgba(50,140,80,.35);box-shadow:0 0 20px rgba(30,100,60,.12);}
.my-role-card.neutre{background:linear-gradient(135deg,rgba(50,20,80,.6),rgba(25,10,45,.8));border:1px solid rgba(120,60,180,.35);box-shadow:0 0 20px rgba(90,50,140,.12);}
.my-role-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;}
.my-role-card.loup::before{background:linear-gradient(90deg,transparent,rgba(200,60,60,.5),transparent);}
.my-role-card.village::before{background:linear-gradient(90deg,transparent,rgba(60,180,100,.4),transparent);}
.my-role-card.neutre::before{background:linear-gradient(90deg,transparent,rgba(150,80,220,.4),transparent);}
.role-emoji-big{font-size:3rem;filter:drop-shadow(0 0 10px rgba(232,213,163,.3));flex-shrink:0;}
.role-info{}
.role-name{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:4px;}
.role-camp{font-size:.73rem;font-style:italic;margin-bottom:6px;letter-spacing:.05em;}
.role-camp.loup{color:#e07070;}
.role-camp.village{color:#60d090;}
.role-camp.neutre{color:#b080f0;}
.role-desc-txt{font-size:.81rem;color:var(--smoke);line-height:1.55;}

/* Players Grid */
.players-section{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.08);border-radius:16px;padding:16px;}
.players-section-title{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.14em;color:var(--smoke);margin-bottom:12px;text-transform:uppercase;display:flex;align-items:center;gap:7px;}
.players-section-title span{flex:1;height:1px;background:rgba(232,213,163,.08);}
.players-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:9px;}
.p-tile{background:rgba(255,255,255,.025);border:1px solid rgba(232,213,163,.09);border-radius:12px;padding:12px 8px;text-align:center;position:relative;cursor:default;transition:all .3s;}
.p-tile:hover{border-color:rgba(232,213,163,.22);transform:translateY(-2px);background:rgba(255,255,255,.04);}
.p-tile.dead{opacity:.18;filter:grayscale(1) blur(.5px);pointer-events:none;}
.p-tile.me{border-color:rgba(232,213,163,.3);background:rgba(232,213,163,.04);}
.p-tile.mayor::after{content:'üëë';position:absolute;top:-8px;right:-4px;font-size:.9rem;filter:drop-shadow(0 0 6px rgba(200,160,0,.5));}
.p-tile.protected{border-color:rgba(80,200,120,.5);box-shadow:0 0 14px rgba(80,200,120,.12);}
.p-tile.lover::before{content:'‚ù§Ô∏è';position:absolute;top:-8px;left:-4px;font-size:.75rem;}
.p-tile.loup-known{border-color:rgba(176,32,32,.4);background:rgba(80,10,10,.2);}
.t-av{font-size:1.7rem;margin-bottom:5px;}
.t-name{font-size:.74rem;line-height:1.2;font-weight:600;}
.t-role{font-size:.64rem;color:var(--smoke);font-style:italic;margin-top:3px;}
.t-status{font-size:.62rem;margin-top:3px;}

/* Actions Panel */
.actions-panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.08);border-radius:16px;padding:16px;}
.a-title{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.14em;color:var(--smoke);margin-bottom:10px;text-transform:uppercase;display:flex;align-items:center;gap:7px;}
.a-title span{flex:1;height:1px;background:rgba(232,213,163,.08);}
.a-btns{display:flex;flex-direction:column;gap:8px;}
.a-flavor{background:rgba(255,255,255,.025);border-left:2px solid rgba(232,213,163,.2);border-radius:0 8px 8px 0;padding:10px 14px;font-size:.83rem;color:var(--moon2);font-style:italic;line-height:1.6;margin-bottom:4px;}
.a-flavor.loup{border-color:rgba(180,40,40,.5);}
.a-flavor.village{border-color:rgba(50,160,80,.5);}
.a-flavor.neutre{border-color:rgba(130,60,200,.5);}
.a-btn{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.12);color:var(--moon);font-family:'EB Garamond',serif;font-size:.9rem;padding:9px 14px;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;text-align:left;}
.a-btn:hover{background:rgba(232,213,163,.09);border-color:rgba(232,213,163,.32);transform:translateX(2px);}
.a-btn.red{border-color:rgba(140,20,20,.4);background:rgba(100,10,10,.1);}
.a-btn.red:hover{background:rgba(122,18,18,.25);border-color:var(--blood2);}
.a-btn.purple{border-color:rgba(140,80,200,.35);background:rgba(90,30,140,.08);}
.a-btn.purple:hover{background:rgba(140,80,200,.15);border-color:#a060e0;}
.a-btn.green{border-color:rgba(50,160,80,.35);background:rgba(20,100,40,.08);}
.a-btn.green:hover{background:rgba(40,160,70,.15);border-color:#50d080;}
.a-used{font-size:.78rem;color:var(--smoke);font-style:italic;opacity:.7;padding:3px 0;}

/* Side panel */
.game-side{display:flex;flex-direction:column;gap:13px;}

/* Event Card */
.event-card{background:linear-gradient(135deg,rgba(60,25,100,.5),rgba(30,10,55,.6));border:1px solid rgba(156,100,220,.35);border-radius:14px;padding:18px;text-align:center;animation:evGlow 3s ease-in-out infinite;}
@keyframes evGlow{0%,100%{box-shadow:0 0 15px rgba(156,100,220,.2);}50%{box-shadow:0 0 35px rgba(156,100,220,.45);}}
.ev-big{font-size:2.2rem;margin-bottom:8px;}
.ev-title{font-family:'Cinzel Decorative',serif;font-size:.82rem;color:#c8b0ff;margin-bottom:5px;letter-spacing:.06em;}
.ev-desc{font-size:.78rem;color:var(--smoke);font-style:italic;line-height:1.5;}

/* Chat Panel */
.chat-panel{background:rgba(8,8,18,.5);border:1px solid rgba(232,213,163,.08);border-radius:14px;display:flex;flex-direction:column;min-height:200px;max-height:320px;overflow:hidden;}
.chat-head{font-family:'Cinzel Decorative',serif;font-size:.66rem;letter-spacing:.14em;color:var(--smoke);padding:12px 14px 9px;border-bottom:1px solid rgba(232,213,163,.06);text-transform:uppercase;display:flex;align-items:center;gap:6px;}
.chat-head::before{content:'';width:6px;height:6px;background:#4a9a5a;border-radius:50%;box-shadow:0 0 8px #4a9a5a;}
.chat-msgs{flex:1;overflow-y:auto;padding:10px 13px;display:flex;flex-direction:column;gap:6px;}
.c-msg{font-size:.82rem;line-height:1.45;}
.c-msg .c-author{font-weight:600;color:var(--ember2);}
.c-msg .c-author.dead{color:var(--smoke);text-decoration:line-through;opacity:.6;}
.c-msg .c-author.me-author{color:var(--moon);}
.c-msg .c-text{color:var(--moon2);}
.c-msg.sys{font-style:italic;color:var(--smoke);font-size:.76rem;padding:3px 0;border-top:1px solid rgba(232,213,163,.04);margin-top:2px;}
.c-msg.sys.death{color:#e07070;}
.c-msg.sys.night{color:#8070b0;}
.c-msg.sys.chaos{color:#c0a0ff;}
.c-msg.sys.info{color:#70c0a0;}
.chat-row{display:flex;gap:7px;padding:8px 12px;border-top:1px solid rgba(232,213,163,.06);}
.chat-inp{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.12);border-radius:8px;color:var(--moon);font-family:'EB Garamond',serif;font-size:.88rem;padding:8px 11px;outline:none;transition:border-color .2s;}
.chat-inp:focus{border-color:rgba(232,213,163,.3);}
.chat-inp:disabled{opacity:.35;cursor:not-allowed;}
.chat-send{background:linear-gradient(135deg,var(--blood),#500a0a);border:1px solid rgba(176,32,32,.4);color:var(--moon);border-radius:8px;padding:8px 13px;cursor:pointer;font-size:.88rem;transition:all .2s;}
.chat-send:hover{background:linear-gradient(135deg,var(--blood2),var(--blood));}

/* Dead zone */
.dead-zone{padding:10px 14px;background:rgba(0,0,0,.25);border-radius:10px;margin-top:8px;border:1px solid rgba(232,213,163,.05);}
.dead-zone-lbl{font-size:.68rem;color:var(--smoke);font-style:italic;margin-bottom:6px;text-transform:uppercase;letter-spacing:.1em;}
.dead-chips{display:flex;flex-wrap:wrap;gap:5px;}
.dead-chip{font-size:.75rem;color:var(--smoke);text-decoration:line-through;padding:3px 9px;background:rgba(255,255,255,.03);border-radius:12px;border:1px solid rgba(232,213,163,.06);}

/* Wolves chat ‚Äî private section */
.wolf-chat{background:linear-gradient(135deg,rgba(80,10,10,.4),rgba(30,5,5,.5));border:1px solid rgba(180,40,40,.25);border-radius:14px;display:flex;flex-direction:column;max-height:160px;overflow:hidden;}
.wolf-chat-head{font-family:'Cinzel Decorative',serif;font-size:.64rem;letter-spacing:.12em;color:#e07070;padding:9px 12px 7px;border-bottom:1px solid rgba(180,40,40,.15);text-transform:uppercase;display:flex;align-items:center;gap:6px;}
.wolf-chat-head::before{content:'üê∫';font-size:.8rem;}
.wolf-chat-msgs{flex:1;overflow-y:auto;padding:8px 11px;display:flex;flex-direction:column;gap:4px;font-size:.79rem;}
.wolf-chat-row{display:flex;gap:6px;padding:7px 10px;border-top:1px solid rgba(180,40,40,.1);}
.wolf-chat-inp{flex:1;background:rgba(100,10,10,.2);border:1px solid rgba(180,40,40,.2);border-radius:6px;color:var(--moon);font-family:'EB Garamond',serif;font-size:.83rem;padding:6px 10px;outline:none;}
.wolf-send{background:rgba(122,18,18,.6);border:none;color:var(--moon);border-radius:6px;padding:6px 11px;cursor:pointer;font-size:.82rem;}

/* NARRATIVE */
#narr{position:fixed;inset:0;z-index:200;background:rgba(4,4,12,.93);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .6s;}
#narr.show{opacity:1;pointer-events:all;}
.narr-inner{max-width:540px;width:90%;text-align:center;padding:20px;}
.narr-fire{font-size:3.5rem;margin-bottom:14px;animation:fireFlick 1.2s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(255,107,0,.6));}
@keyframes fireFlick{0%,100%{transform:scaleY(1) rotate(-3deg);}25%{transform:scaleY(1.08) rotate(2deg);}50%{transform:scaleY(.94) rotate(-1deg);}75%{transform:scaleY(1.05) rotate(3deg);}}
.narr-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.3rem,4vw,1.9rem);margin-bottom:13px;opacity:0;animation:fadeUp .8s ease .1s forwards;}
.narr-text{font-style:italic;font-size:clamp(.95rem,2.5vw,1.15rem);color:var(--moon2);line-height:1.75;opacity:0;animation:fadeUp .8s ease .4s forwards;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.narr-btn{margin-top:26px;display:inline-block;background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.9rem;padding:10px 28px;border-radius:8px;cursor:pointer;transition:all .2s;opacity:0;animation:fadeUp .8s ease .8s forwards;}
.narr-btn:hover{background:rgba(232,213,163,.18);color:var(--moon);}

/* MODAL */
#modal-ov{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.77);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;}
#modal-ov.open{display:flex;}
.modal{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.18);border-radius:16px;padding:24px;width:90%;max-width:380px;animation:fadeUp .2s ease;}
.modal h3{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:12px;}
.m-close{float:right;background:none;border:none;color:var(--smoke);font-size:1.2rem;cursor:pointer;margin-top:-3px;}
.m-opts{display:flex;flex-direction:column;gap:7px;margin-top:10px;}
.m-opt{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);color:var(--moon);font-family:'EB Garamond',serif;font-size:.93rem;padding:10px 13px;border-radius:8px;cursor:pointer;text-align:left;transition:all .2s;display:flex;align-items:center;gap:8px;}
.m-opt:hover{background:rgba(232,213,163,.08);border-color:rgba(232,213,163,.28);}
.m-opt.red:hover{background:rgba(122,18,18,.2);border-color:var(--blood2);}

/* VICTORY */
#victory-screen{align-items:center;justify-content:center;text-align:center;padding:40px 20px;}
.v-icon{font-size:5rem;margin-bottom:14px;animation:vBounce 1s ease infinite;}
@keyframes vBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
.v-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.8rem,6vw,3rem);margin-bottom:12px;animation:glow 2s ease-in-out infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 20px currentColor}50%{text-shadow:0 0 60px currentColor,0 0 100px currentColor}}
.v-desc{font-style:italic;font-size:1.1rem;color:var(--moon2);max-width:480px;line-height:1.6;margin-bottom:24px;}
.v-surv{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);border-radius:12px;padding:18px;max-width:380px;width:100%;margin-bottom:22px;}
.surv-row{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:.93rem;}
.surv-row+.surv-row{border-top:1px solid rgba(232,213,163,.07);}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(232,213,163,.18);border-radius:3px;}
.spinner{width:34px;height:34px;border:3px solid rgba(232,213,163,.12);border-top-color:var(--moon2);border-radius:50%;animation:spin .8s linear infinite;margin:18px auto;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="bg-stars"></div>
<div class="bg-fog"></div>
<div id="app">

<!-- WELCOME -->
<div id="welcome-screen" class="screen active">
  <div class="welcome-moon">üåï</div>
  <div class="welcome-title">Loup-Garou</div>
  <div class="welcome-sub">Chaque nuit, le village tremble‚Ä¶</div>
  <div class="welcome-cards">
    <div class="w-card red" onclick="showScreen('create')">
      <div class="w-card-icon">üî•</div>
      <div class="w-card-title">Cr√©er une Partie</div>
      <div class="w-card-desc">Configurez les r√¥les et invitez vos amis avec un code √† 6 chiffres.</div>
    </div>
    <div class="w-card green" onclick="showScreen('join')">
      <div class="w-card-icon">üåô</div>
      <div class="w-card-title">Rejoindre une Partie</div>
      <div class="w-card-desc">Entrez le code partag√© par l'h√¥te pour rejoindre la nuit.</div>
    </div>
  </div>
</div>

<!-- CREATE -->
<div id="create-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üî• Nouvelle Partie</div>
    <div class="field"><label>Votre nom</label><input id="c-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-create"></div></div>
    <button class="btn-primary" onclick="createGame()">üåô Cr√©er la Partie</button>
    <div id="c-err" class="err-msg"></div>
  </div>
</div>

<!-- JOIN -->
<div id="join-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üåô Rejoindre</div>
    <div class="field"><label>Code de la partie (6 chiffres)</label><input id="j-code" class="code-input" placeholder="000000" maxlength="6" autocomplete="off" inputmode="numeric"></div>
    <div class="field"><label>Votre nom</label><input id="j-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-join"></div></div>
    <button class="btn-primary" onclick="joinGame()">üêæ Rejoindre</button>
    <div id="j-err" class="err-msg"></div>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby-screen" class="screen">
  <div class="lobby-head">
    <div class="lobby-lbl">Partagez ce code avec vos amis !</div>
    <div class="lobby-code" id="lobby-code">------</div>
    <button class="copy-btn" onclick="copyCode()">üìã Copier le code</button>
    <div class="lobby-lbl" style="margin-top:8px;" id="lobby-lbl">En attente‚Ä¶</div>
  </div>
  <div id="host-setup"></div>
  <div class="lobby-players" id="lobby-players"></div>
  <div class="lobby-waiting" id="lobby-wait">‚è≥ En attente que l'h√¥te lance la partie‚Ä¶</div>
  <div id="lobby-launch" style="display:none;max-width:380px;margin:0 auto;">
    <button class="btn-primary" onclick="launchGame()">üê∫ Lancer la Partie</button>
    <div id="launch-err" class="err-msg"></div>
  </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="phase-bar is-night" id="phase-bar">
    <div class="ph-left">
      <div class="ph-icon" id="ph-icon">üåë</div>
      <div class="ph-info">
        <div class="ph-name" id="ph-name">Nuit 1</div>
        <div class="ph-desc" id="ph-desc">Les cr√©atures s'√©veillent‚Ä¶</div>
      </div>
    </div>
    <div class="ph-right">
      <div class="ph-timer" id="ph-timer">--</div>
      <div class="ph-turn-badge" id="ph-turn-badge">Tour 1</div>
    </div>
  </div>
  <div class="game-cols">
    <div class="game-main">
      <div class="my-role-card" id="my-role-card">
        <div class="role-emoji-big" id="r-em">‚ùì</div>
        <div class="role-info">
          <div class="role-name" id="r-name">R√¥le secret</div>
          <div class="role-camp" id="r-camp"></div>
          <div class="role-desc-txt" id="r-desc"></div>
        </div>
      </div>
      <div class="players-section">
        <div class="players-section-title">üë• Joueurs <span></span></div>
        <div class="players-grid" id="g-players"></div>
        <div class="dead-zone" id="dead-zone" style="display:none;">
          <div class="dead-zone-lbl">‚ö∞Ô∏è √âlimin√©s</div>
          <div class="dead-chips" id="dead-chips"></div>
        </div>
      </div>
      <div class="actions-panel">
        <div class="a-title">‚ö° Vos Actions <span></span></div>
        <div class="a-btns" id="a-btns"></div>
      </div>
    </div>
    <div class="game-side">
      <div class="event-card" id="ev-card" style="display:none;"></div>
      <div id="wolf-chat-panel" style="display:none;">
        <div class="wolf-chat">
          <div class="wolf-chat-head">Canal des Loups</div>
          <div class="wolf-chat-msgs" id="wolf-msgs"></div>
          <div class="wolf-chat-row">
            <input class="wolf-chat-inp" id="wolf-in" placeholder="Message secret‚Ä¶" maxlength="200" autocomplete="off">
            <button class="wolf-send" onclick="sendWolfChat()">‚Üë</button>
          </div>
        </div>
      </div>
      <div class="chat-panel">
        <div class="chat-head">üí¨ Village</div>
        <div class="chat-msgs" id="chat-msgs"></div>
        <div class="chat-row">
          <input class="chat-inp" id="chat-in" placeholder="Votre message‚Ä¶" maxlength="200" autocomplete="off">
          <button class="chat-send" onclick="sendChat()">‚Üë</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VICTORY -->
<div id="victory-screen" class="screen">
  <div class="v-icon" id="v-icon">üèÜ</div>
  <div class="v-title" id="v-title"></div>
  <div class="v-desc" id="v-desc"></div>
  <div class="v-surv" id="v-surv"></div>
  <button class="btn-primary" style="max-width:300px;" onclick="backToWelcome()">üîÑ Nouvelle Partie</button>
</div>
</div><!-- #app -->

<!-- NARRATIVE -->
<div id="narr">
  <div class="narr-inner">
    <div class="narr-fire" id="n-fire">üî•</div>
    <div class="narr-title" id="n-title"></div>
    <div class="narr-text" id="n-text"></div>
    <button class="narr-btn" onclick="closeNarr()">Continuer‚Ä¶</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal-ov">
  <div class="modal">
    <button class="m-close" onclick="closeModal()">‚úï</button>
    <h3 id="m-title">Action</h3>
    <div id="m-body"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ================================================================
// üî• REMPLACEZ LES VALEURS CI-DESSOUS PAR VOTRE CONFIG FIREBASE
// ================================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyDkLxCZApo145b2XWwKlc-lQzBh1MtpqH4",
  authDomain:        "projet-loup-garou.firebaseapp.com",
  databaseURL:       "https://projet-loup-garou-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "projet-loup-garou",
  storageBucket:     "projet-loup-garou.firebasestorage.app",
  messagingSenderId: "811973035375",
  appId:             "1:811973035375:web:1ac25aa172960369a9149a"
};

// ================================================================
// DATA
// ================================================================
const ALL_ROLES = {
  'Loup-Garou':      {camp:'loup',   emoji:'üê∫', desc:'Chaque nuit, les loups choisissent ensemble une victime. Votre objectif : √©liminer tous les villageois.'},
  'Loup Blanc':      {camp:'loup',   emoji:'ü§ç', desc:'Vous jouez avec les loups‚Ä¶ mais votre vrai objectif est de finir SEUL en vie. Trahissez au moment opportun.'},
  'Loup Enrag√©':     {camp:'loup',   emoji:'üî•', desc:'Une nuit sur trois, vous tuez DEUX joueurs au lieu d\'un. Votre violence peut acc√©l√©rer la victoire des loups.'},
  'Loup Infectieux': {camp:'loup',   emoji:'ü¶†', desc:'Une fois par partie, au lieu de tuer, vous pouvez transformer votre cible en Loup-Garou sans qu\'elle le sache imm√©diatement.'},
  'Loup aux Puces':  {camp:'loup',   emoji:'üêú', desc:'Vous infectez secr√®tement une cible. Apr√®s quelques tours, elle deviendra Loup-Garou sans le savoir.'},
  'Villageois':      {camp:'village',emoji:'üë®‚Äçüåæ',desc:'Aucun pouvoir particulier. Votre seule arme : l\'observation, la logique et le vote. Trouvez les loups avant qu\'ils ne vous trouvent.'},
  'Voyante':         {camp:'village',emoji:'üîÆ', desc:'Chaque nuit, vous r√©v√©lez le r√¥le exact d\'un joueur de votre choix. Guidez le village sans vous exposer.'},
  'Sorci√®re':        {camp:'village',emoji:'üß™', desc:'Vous poss√©dez une potion de vie (ressuscite un mort) et une potion de mort (tue une cible). Chacune utilisable une seule fois.'},
  'Chasseur':        {camp:'village',emoji:'üèπ', desc:'Si vous √™tes √©limin√©(e), vous pouvez imm√©diatement tuer un autre joueur. Votre mort n\'est jamais gratuite.'},
  'Cupidon':         {camp:'village',emoji:'üíò', desc:'Au d√©but de la partie, vous avez li√© deux amoureux. Si l\'un meurt, l\'autre meurt aussi. Les amoureux peuvent gagner seuls.'},
  'Garde du Corps':  {camp:'village',emoji:'üõ°Ô∏è', desc:'Chaque nuit, vous prot√©gez un joueur contre une attaque. Si votre prot√©g√© devrait mourir, c\'est vous qui mourez √† sa place.'},
  'Maire':           {camp:'village',emoji:'üëë', desc:'√âlu(e) par le village (ou d√©sign√© par le r√¥le). Votre voix compte double lors des votes d\'√©limination.'},
  'Dieu du Village': {camp:'village',emoji:'‚ú®', desc:'Une fois dans la partie, vous pouvez annuler une √©limination ‚Äî de jour comme de nuit. Utilisez ce miracle au bon moment.'},
  'N√©cromancien':    {camp:'village',emoji:'üíÄ', desc:'Vous pouvez communiquer avec les esprits des morts et obtenir des informations sur leur camp.'},
  'Chronomancien':   {camp:'village',emoji:'‚è≥', desc:'Une fois par partie, vous pouvez rembobiner un tour complet et rejouer les √©v√©nements. Un pouvoir immense.'},
  'Illusionniste':   {camp:'neutre', emoji:'ü™Ñ', desc:'Vous pouvez modifier l\'information re√ßue par la Voyante. Rechargement : 2 ou 3 tours (al√©atoire). Elle verra ce que vous voulez, pas la r√©alit√©.'},
  'Hypnotiseur':     {camp:'neutre', emoji:'üåÄ', desc:'Vous forcez un joueur √† voter pour une cible pr√©cise lors du prochain vote. Rechargement : 2 ou 3 tours (al√©atoire). Manipulation pure.'},
  'Usurpateur':      {camp:'neutre', emoji:'üé≠', desc:'Vous pouvez copier temporairement le pouvoir d\'un autre joueur. Le pouvoir copi√© dure un tour.'},
  'Avocat':          {camp:'neutre', emoji:'‚öñÔ∏è', desc:'Vous prot√©gez un joueur contre l\'√©limination par vote. Votre client ne peut pas √™tre √©limin√© ce tour.'},
  'Tra√Ætre':         {camp:'neutre', emoji:'üó°Ô∏è', desc:'Vous commencez comme villageois, mais rejoindrez secr√®tement les loups plus tard dans la partie.'},
  'Marionnettiste':  {camp:'neutre', emoji:'üßµ', desc:'Vous contr√¥lez secr√®tement les actions d\'un joueur pendant la nuit. Il agira selon votre volont√©.'},
};

const AVATARS = ['üßë','üë©','üßî','üëµ','üßí','üëß','üßë‚Äçü¶±','üßë‚Äçü¶≥','üßë‚Äçü¶∞','üßë‚Äçü¶≤','üßï','üßõ','üßô','üßù','üßü','üßú','üßö','üé©'];

const ALL_EVENTS = [
  {name:'Brouillard',            icon:'üå´Ô∏è',desc:'Personne ne peut parler pendant une minute.'},
  {name:'Silence',               icon:'ü§´',desc:'Un joueur est r√©duit au silence pour ce tour.'},
  {name:'Double Vote',           icon:'üó≥Ô∏è',desc:'Tous les votes comptent double ce jour.'},
  {name:'Vote Invers√©',          icon:'üîÉ',desc:'Le joueur avec le plus de votes est sauv√©.'},
  {name:'Deux Morts Cette Nuit', icon:'üíÄ',desc:'La nuit devient doublement meurtri√®re.'},
  {name:'Immunit√© Al√©atoire',    icon:'üõ°Ô∏è',desc:'Un joueur devient intouchable pour un tour.'},
  {name:'Retour des Morts',      icon:'üëª',desc:'Un joueur √©limin√© revient pour un tour.'},
  {name:'Nuit √âternelle',        icon:'üåë',desc:'Deux phases de nuit cons√©cutives.'},
  {name:'Nouveau Maire',         icon:'üëë',desc:'Un maire est d√©sign√© al√©atoirement.'},
  {name:'Pi√®ge Explosif',        icon:'üí£',desc:'Si le joueur pi√©g√© est vot√©, deux autres meurent.'},
  {name:'Voyante Aveugl√©e',      icon:'üëÅÔ∏è',desc:'La Voyante re√ßoit une information fausse.'},
  {name:'Potion Retrouv√©e',      icon:'üß™',desc:'La Sorci√®re r√©cup√®re une potion utilis√©e.'},
  {name:'Duel Obligatoire',      icon:'‚öîÔ∏è',desc:'Deux joueurs s\'affrontent ; le village vote pour l\'un.'},
  {name:'D√©bat Limit√©',          icon:'‚è±Ô∏è',desc:'Seulement une minute pour discuter.'},
  {name:'Discussions Interdites',icon:'üö´',desc:'Vote imm√©diat sans d√©bat.'},
];

// ================================================================
// STATE
// ================================================================
let db = null;
let me = {name:'', avatar:'üßë', id:''};
let roomCode = '';
let isHost = false;
let unsubRoom = null;
let timerInterval = null;
let selectedAvC = 'üßë';
let selectedAvJ = 'üßë';
let selectedRoles = new Set(['Loup-Garou','Villageois','Voyante']);
let chatRendered = 0;
let narrQueue = [];
let narrActive = false;
let lastSeenLogLen = 0;
let lastSeenNarrLen = 0;
let localRoom = null; // cached room for timer

// ================================================================
// FIREBASE INIT
// ================================================================
(async function initFirebase() {
  try {
    if(!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'REMPLACEZ_ICI') {
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
          <div>
            <div style="font-size:3rem;margin-bottom:16px;">üî•</div>
            <div style="font-family:'Cinzel Decorative',serif;font-size:1.4rem;margin-bottom:12px;">Configuration Firebase manquante</div>
            <div style="color:#8a8070;font-size:.95rem;max-width:480px;line-height:1.7;">
              Ouvrez <strong>index.html</strong> dans un √©diteur de texte.<br>
              Cherchez <code style="background:rgba(255,255,255,.08);padding:2px 8px;border-radius:4px;">REMPLACEZ_ICI</code>
              et remplacez chaque valeur par vos cl√©s Firebase.<br><br>
              Voir <strong>README.md</strong> pour les instructions compl√®tes.
            </div>
          </div>
        </div>`;
      return;
    }
    const app = initializeApp(FIREBASE_CONFIG);
    db = getDatabase(app);
    console.log('‚úÖ Firebase connect√©');
  } catch(e) {
    console.error('Firebase init failed:', e);
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
        <div>
          <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
          <div style="font-family:'Cinzel Decorative',serif;font-size:1.2rem;margin-bottom:12px;">Erreur de connexion Firebase</div>
          <div style="color:#8a8070;font-size:.9rem;max-width:480px;line-height:1.7;">${e.message}<br><br>V√©rifiez vos cl√©s dans index.html ‚Äî notamment <strong>databaseURL</strong>.</div>
        </div>
      </div>`;
  }
})();

// ================================================================
// UTILS
// ================================================================
function genId() { return Math.random().toString(36).substr(2,9) + Date.now().toString(36); }
function genCode() { return String(Math.floor(100000 + Math.random() * 900000)); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function dbRef(path) { return ref(db, path); }
async function dbSet(path, val) { await set(dbRef(path), val); }
async function dbUpdate(path, val) { await update(dbRef(path), val); }
async function dbGet(path) { const s = await get(dbRef(path)); return s.exists() ? s.val() : null; }
function dbListen(path, cb) { return onValue(dbRef(path), snap => cb(snap.exists() ? snap.val() : null)); }

// ================================================================
// SCREENS
// ================================================================
window.showScreen = function(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(name+'-screen').classList.add('active');
};

function buildAvatarPicker(id, onSel, defVal) {
  const c = document.getElementById(id);
  if(!c) return;
  c.innerHTML = '';
  AVATARS.forEach((a,i) => {
    const b = document.createElement('button');
    b.className = 'av-btn' + (i===0?' selected':'');
    b.textContent = a;
    b.onclick = () => {
      c.querySelectorAll('.av-btn').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
      onSel(a);
    };
    c.appendChild(b);
  });
}
buildAvatarPicker('av-create', a => selectedAvC = a, 'üßë');
buildAvatarPicker('av-join',   a => selectedAvJ = a, 'üßë');

document.getElementById('j-code').addEventListener('input', function(){
  this.value = this.value.replace(/[^0-9]/g,'').substr(0,6);
});
document.getElementById('chat-in').addEventListener('keypress', e => { if(e.key==='Enter') sendChat(); });
document.getElementById('j-code').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });
document.getElementById('c-name').addEventListener('keypress', e => { if(e.key==='Enter') createGame(); });
document.getElementById('j-name').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });

window.copyCode = function() {
  navigator.clipboard.writeText(roomCode).then(() => {
    const b = document.querySelector('.copy-btn');
    if(b){const o=b.textContent;b.textContent='‚úÖ Copi√© !';setTimeout(()=>b.textContent=o,1500);}
  }).catch(()=>prompt('Code :',roomCode));
};

// ================================================================
// CREATE GAME
// ================================================================
window.createGame = async function() {
  const name = document.getElementById('c-name').value.trim();
  const err = document.getElementById('c-err');
  if(!name){err.textContent='‚ùå Entrez votre nom !';return;}
  me = {name, avatar:selectedAvC, id:genId()};
  isHost = true;
  roomCode = genCode();

  const room = {
    code: roomCode,
    status: 'lobby',
    host: me.id,
    settings: {roles:Array.from(selectedRoles), eventProb:30, nightDur:90, dayDur:180},
    game: null,
    chat: {},
    log: {},
    players: {}
  };
  room.players[me.id] = {name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false};

  await dbSet('rooms/'+roomCode, room);
  err.textContent = '';
  enterLobby();
};

// ================================================================
// JOIN GAME
// ================================================================
window.joinGame = async function() {
  const code = document.getElementById('j-code').value.trim().replace(/\D/g,'');
  const name = document.getElementById('j-name').value.trim();
  const err = document.getElementById('j-err');

  if(code.length!==6){err.style.color='#e07070';err.textContent='‚ùå Code invalide ‚Äî 6 chiffres';return;}
  if(!name){err.style.color='#e07070';err.textContent='‚ùå Entrez votre nom !';return;}

  err.style.color='var(--moon2)';err.textContent='üîç Connexion‚Ä¶';

  const room = await dbGet('rooms/'+code);
  if(!room){err.style.color='#e07070';err.textContent=`‚ùå Partie "${code}" introuvable.`;return;}
  if(room.status!=='lobby'){err.style.color='#e07070';err.textContent='‚ö†Ô∏è Partie d√©j√† en cours !';return;}

  const players = room.players ? Object.values(room.players) : [];
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase())){
    err.style.color='#e07070';err.textContent='‚ö†Ô∏è Ce nom est d√©j√† pris !';return;
  }

  me = {name, avatar:selectedAvJ, id:genId()};
  isHost = false;
  roomCode = code;

  await dbSet('rooms/'+code+'/players/'+me.id, {
    name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false
  });

  err.textContent='';
  enterLobby();
};

// ================================================================
// LOBBY
// ================================================================
function enterLobby() {
  showScreen('lobby');
  document.getElementById('lobby-code').textContent = roomCode;
  if(isHost){
    document.getElementById('lobby-wait').style.display='none';
    document.getElementById('lobby-launch').style.display='block';
    buildHostSetup();
  }
  // Real-time listener
  if(unsubRoom) unsubRoom();
  unsubRoom = dbListen('rooms/'+roomCode, onRoomUpdate);
}

function buildHostSetup() {
  const div = document.getElementById('host-setup');
  div.innerHTML = `
    <div class="panel">
      <div class="p-title">üé≠ R√¥les actifs</div>
      <div class="roles-grid" id="roles-grid"></div>
    </div>
    <div class="panel">
      <div class="p-title">‚öôÔ∏è Param√®tres</div>
      <div class="dur-row">
        <div class="dur-field"><label>üåë Dur√©e Nuit (s)</label><input type="number" id="night-dur" value="90" min="20" max="300"></div>
        <div class="dur-field"><label>‚òÄÔ∏è Dur√©e Jour (s)</label><input type="number" id="day-dur" value="180" min="30" max="600"></div>
        <div class="dur-field"><label>üåÄ Prob. √âv√©nement %</label><input type="number" id="ev-prob" value="30" min="0" max="100"></div>
      </div>
    </div>`;

  const grid = document.getElementById('roles-grid');
  for(const [name,data] of Object.entries(ALL_ROLES)){
    const d = document.createElement('div');
    d.className=`role-tog ${data.camp} ${selectedRoles.has(name)?'on':''}`;
    d.innerHTML=`<span class="r-em">${data.emoji}</span>${name}`;
    d.onclick=()=>{
      if(selectedRoles.has(name)){selectedRoles.delete(name);d.classList.remove('on');}
      else{selectedRoles.add(name);d.classList.add('on');}
    };
    grid.appendChild(d);
  }
}

// ================================================================
// LAUNCH
// ================================================================
window.launchGame = async function() {
  const room = await dbGet('rooms/'+roomCode);
  if(!room) return;
  const players = room.players ? Object.values(room.players) : [];
  if(players.length < 3){
    document.getElementById('launch-err').textContent='‚ùå Il faut au moins 3 joueurs !'; return;
  }

  const nightDur = parseInt(document.getElementById('night-dur')?.value)||90;
  const dayDur   = parseInt(document.getElementById('day-dur')?.value)||180;
  const evProb   = parseInt(document.getElementById('ev-prob')?.value)||30;

  // Assign roles
  const roles = Array.from(selectedRoles);
  const shuffledRoles = [...roles].sort(()=>Math.random()-.5);
  const shuffledPlayers = [...players].sort(()=>Math.random()-.5);
  const playerUpdates = {};
  shuffledPlayers.forEach((p,i)=>{
    playerUpdates['rooms/'+roomCode+'/players/'+p.id+'/role'] = shuffledRoles[i%shuffledRoles.length];
  });
  await update(ref(db), playerUpdates);

  // Reload with roles
  const updatedRoom = await dbGet('rooms/'+roomCode);
  const updatedPlayers = Object.values(updatedRoom.players);

  // Cupidon ‚Äî don't auto-link; mark as pending so Cupidon player chooses
  let loversA=null, loversB=null;
  const cupidon = updatedPlayers.find(p=>p.role==='Cupidon');
  // loversA/loversB will be set by Cupidon's action at start of night 1

  // Mayor
  const mayorP = updatedPlayers.find(p=>p.role==='Maire');
  if(mayorP) await dbUpdate('rooms/'+roomCode+'/players/'+mayorP.id, {mayor:true});

  const game = {
    phase:'night', turn:1,
    phaseEndTime: Date.now()+nightDur*1000,
    nightDur, dayDur, evProb,
    witchLifeUsed:false, witchDeathUsed:false, godUsed:false, chronoUsed:false, infectUsed:false,
    seerUsed:false, illusionUsedThisNight:false,
    fleaUsed:false, fleaTarget:null, fleaTurn:0, fleaInfected:false,
    hunterUsed:false, cupidonDone:false,
    loversA, loversB,
    currentEvent:null, victory:null,
    lastPhaseChange: Date.now(),
  };

  await dbUpdate('rooms/'+roomCode, {status:'playing', game,
    settings:{roles:Array.from(selectedRoles), eventProb:evProb, nightDur, dayDur}
  });

  await pushLog(`üåô La partie commence avec ${updatedPlayers.length} joueurs !`, 'system');
  await maybeEvent(game);
};

// ================================================================
// ROOM UPDATE LISTENER
// ================================================================
function onRoomUpdate(room) {
  if(!room) return;
  localRoom = room;
  const players = room.players ? Object.values(room.players) : [];

  if(room.status==='lobby'){
    renderLobbyPlayers(players, room.host);
    document.getElementById('lobby-lbl').textContent = `${players.length} joueur${players.length>1?'s':''} connect√©${players.length>1?'s':''}`;
    return;
  }

  if(room.status==='playing'){
    if(!document.getElementById('game-screen').classList.contains('active')){
      showScreen('game');
      renderMyRole(room);
      startTimerLoop();
    } else if(!timerInterval) {
      // Restart timer after phase switch cleared it
      startTimerLoop();
    }
    updateGameView(room);
    renderChat(room);
    checkNewLogNarr(room);
    checkNewNarr(room);
    checkDawnWhisper(room);
  }

  if(room.status==='ended' && room.game?.victory){
    clearInterval(timerInterval);
    if(unsubRoom) unsubRoom();
    showVictory(room.game.victory);
  }
}

function renderLobbyPlayers(players, hostId) {
  const grid = document.getElementById('lobby-players');
  grid.innerHTML='';
  players.forEach(p=>{
    const d=document.createElement('div');
    d.className=`lp-tile ${p.id===hostId?'host':''}`;
    d.innerHTML=`<div class="lp-av">${p.avatar}</div><div class="lp-name">${esc(p.name)}</div>${p.id===me.id?'<div class="lp-badge">üë§ Vous</div>':''}${p.id===hostId?'<div class="lp-badge" style="color:var(--ember)">üéÆ H√¥te</div>':''}`;
    grid.appendChild(d);
  });
}

// ================================================================
// GAME VIEW
// ================================================================
function updateGameView(room) {
  if(!room.game) return;
  const g = room.game;
  const players = room.players ? Object.values(room.players) : [];
  const isNight = g.phase==='night';
  const myP = players.find(p=>p.id===me.id);
  const myRole = myP?.role || '';
  const isWolf = ['Loup-Garou','Loup Blanc','Loup Enrag√©','Loup Infectieux','Loup aux Puces'].includes(myRole);

  // Phase bar
  const bar = document.getElementById('phase-bar');
  bar.className = 'phase-bar ' + (isNight ? 'is-night' : 'is-day');
  document.getElementById('ph-icon').textContent = isNight ? 'üåë' : '‚òÄÔ∏è';
  document.getElementById('ph-name').textContent = isNight ? `Nuit ${g.turn}` : `Jour ${g.turn}`;
  document.getElementById('ph-desc').textContent = isNight
    ? 'Le village ferme les yeux‚Ä¶ les cr√©atures s\'√©veillent.'
    : 'L\'aube se l√®ve. Le village doit trouver le coupable.';
  const turnBadge = document.getElementById('ph-turn-badge');
  if(turnBadge) turnBadge.textContent = `Tour ${g.turn}`;

  // Wolf chat visibility (night only for wolves)
  const wolfPanel = document.getElementById('wolf-chat-panel');
  if(wolfPanel) wolfPanel.style.display = (isWolf && isNight) ? 'block' : 'none';

  renderPlayers(players);
  renderActions(room);
  renderEvent(g);
  renderWolfChat(room);
}

function renderMyRole(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  if(!myP) return;
  const rd = ALL_ROLES[myP.role];
  if(!rd) return;
  document.getElementById('r-em').textContent = rd.emoji;
  document.getElementById('r-name').textContent = myP.role;
  document.getElementById('r-camp').textContent = {loup:'‚öîÔ∏è Camp des Loups',village:'üåæ Camp du Village',neutre:'üé≠ R√¥le Neutre'}[rd.camp];
  document.getElementById('r-camp').className = 'role-camp '+rd.camp;
  let desc = rd.desc;
  if(myP.lovers && room.game){
    const g = room.game;
    const loverId = g.loversA===me.id ? g.loversB : g.loversA;
    const lover = Object.values(room.players).find(p=>p.id===loverId);
    if(lover) desc += ` ‚ù§Ô∏è Vous √™tes amoureux(se) de ${lover.name}.`;
  }
  document.getElementById('r-desc').textContent = desc;
  const card = document.getElementById('my-role-card');
  card.className = 'my-role-card ' + rd.camp;
}

function renderPlayers(players) {
  const grid = document.getElementById('g-players');
  const deadChips = document.getElementById('dead-chips');
  grid.innerHTML=''; deadChips.innerHTML='';
  let hasDead=false;

  players.forEach(p=>{
    if(!p.alive){
      hasDead=true;
      const c=document.createElement('div');
      c.className='dead-chip';
      c.textContent=`${p.avatar} ${p.name}`;
      deadChips.appendChild(c);
      return;
    }
    const d=document.createElement('div');
    const isMe=p.id===me.id;
    d.className=`p-tile ${isMe?'me':''} ${p.mayor?'mayor':''} ${p.lovers?'lover':''} ${p.protected?'protected':''}`;
    const rd=ALL_ROLES[p.role];
    const roleShow = isMe && rd ? `<div class="t-role">${rd.emoji} ${p.role}</div>` : '';
    d.innerHTML=`<div class="t-av">${p.avatar}</div><div class="t-name">${esc(p.name)}${isMe?' (vous)':''}</div>${roleShow}`;
    grid.appendChild(d);
  });
  document.getElementById('dead-zone').style.display=hasDead?'block':'none';
}

function renderActions(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  const btns = document.getElementById('a-btns');
  btns.innerHTML='';

  if(!myP){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">En attente‚Ä¶</div>';return;}
  if(!myP.alive){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">‚ò†Ô∏è Vous √™tes √©limin√©(e). Observez les vivants en silence‚Ä¶</div>';return;}

  const g = room.game;
  const role = myP.role;

  const add = (lbl,cls,fn) => {
    const b=document.createElement('button');
    b.className='a-btn '+cls; b.innerHTML=lbl; b.onclick=fn; btns.appendChild(b);
  };

  // Role-specific flavor text
  const ROLE_NIGHT_MSG = {
    'Loup-Garou':     'üê∫ La nuit vous appartient. Coordonnez-vous avec vos fr√®res pour choisir une proie.',
    'Loup Blanc':     'ü§ç Jouez avec les loups‚Ä¶ mais gardez vos propres int√©r√™ts en t√™te. La trahison viendra en son temps.',
    'Loup Enrag√©':    'üî• Votre rage gronde. Cette nuit, d√©signez votre cible ‚Äî et parfois, frappez deux fois.',
    'Loup Infectieux':'ü¶† Vous pouvez tuer‚Ä¶ ou infecter. Transformer un villageois en loup peut changer la partie.',
    'Loup aux Puces': 'üêú Vous semez vos puces en secret. La victime ne le saura pas tout de suite‚Ä¶ mais elle deviendra l\'un des v√¥tres.',
    'Voyante':        'üîÆ Vos yeux percent les secrets. Choisissez un joueur pour r√©v√©ler sa vraie nature.',
    'Sorci√®re':       'üß™ Vos potions sont pr√©cieuses. Une seule vie, une seule mort ‚Äî utilisez-les √† bon escient.',
    'Garde du Corps': 'üõ°Ô∏è Qui prot√©ger cette nuit ? Si votre prot√©g√© est attaqu√©, vous vous sacrifierez √† sa place.',
    'Dieu du Village':'‚ú® Le destin lui-m√™me peut √™tre annul√© par votre volont√© divine.',
    'Chronomancien':  '‚è≥ Le temps ob√©it √† vos ordres. Rembobiner un tour pourrait tout changer.',
    'N√©cromancien':   'üíÄ Les morts ont des secrets que les vivants ignorent. √âcoutez leurs murmures.',
    'Chasseur':       'üèπ Cette nuit, attendez. Si l\'on vous tue, vous emporterez quelqu\'un avec vous.',
    'Cupidon':        'üíò Les amoureux ont d√©j√† √©t√© li√©s. Observez et pr√©parez votre strat√©gie.',
    'Maire':          'üëë Vous √™tes le Maire ‚Äî votre voix compte double au village. M√©ritez cette confiance.',
    'Villageois':     'üë®‚Äçüåæ Aucun pouvoir, mais vos yeux sont vos armes. Observez qui ment le jour venu.',
    'Illusionniste':  'ü™Ñ Vous pouvez semer la confusion dans l\'esprit de la Voyante‚Ä¶',
    'Hypnotiseur':    'üåÄ Pr√©parez votre prochaine suggestion. Demain, quelqu\'un votera comme vous le dictez.',
    'Usurpateur':     'üé≠ Vous pouvez copier le pouvoir d\'un autre. Choisissez bien votre cible.',
    'Avocat':         '‚öñÔ∏è Un joueur sera prot√©g√© de l\'√©limination lors du prochain vote. Qui m√©rite votre d√©fense ?',
    'Tra√Ætre':        'üó°Ô∏è Pour l\'instant, vous semblez √™tre un villageois. Votre loyaut√© changera bient√¥t‚Ä¶',
    'Marionnettiste': 'üßµ Vos fils de contr√¥le sont pr√™ts. Un joueur fera cette nuit ce que vous d√©cidez.',
  };

  const ROLE_DAY_MSG = {
    'Loup-Garou':     'üê∫ Dissimulez-vous parmi les villageois. Accusez, semez le doute, survivez.',
    'Loup Blanc':     'ü§ç Ni vraiment loup, ni vraiment villageois. Manipulez tout le monde pour rester seul en vie.',
    'Loup Enrag√©':    'üî• Le jour, vous √™tes un loup comme les autres. Mentez mieux.',
    'Loup Infectieux':'ü¶† Votre infection est sem√©e. Il ne reste qu\'√† attendre‚Ä¶ et faire bonne figure.',
    'Loup aux Puces': 'üêú La contamination progresse en secret. Restez discret.',
    'Voyante':        'üîÆ Vous savez des choses que les autres ignorent. √Ä vous de guider le village sans vous d√©voiler.',
    'Sorci√®re':       'üß™ Vous connaissez vos potions. Guidez les votes avec sagesse.',
    'Garde du Corps': 'üõ°Ô∏è Votre r√¥le est connu de vous seul. Votez intelligemment.',
    'Dieu du Village':'‚ú® Votez avec les autres. Votre pouvoir sacr√© peut encore sauver quelqu\'un si n√©cessaire.',
    'Chronomancien':  '‚è≥ Le temps est pr√©cieux. Participez aux d√©bats, votre pouvoir attend le bon moment.',
    'N√©cromancien':   'üíÄ Les murmures des morts vous ont √©clair√©(e). Utilisez cette connaissance prudemment.',
    'Chasseur':       'üèπ Participez aux d√©bats. Si vous √™tes √©limin√©, vous choisissez qui vous suit dans la mort.',
    'Cupidon':        'üíò Les amoureux que vous avez li√©s sont dans la partie. Leur destin est d√©sormais li√©.',
    'Maire':          'üëë Votre voix compte double. Guidez le vote du village vers la v√©rit√©.',
    'Villageois':     'üë®‚Äçüåæ Analysez, accusez, d√©fendez-vous. C\'est tout ce que vous avez ‚Äî et √ßa peut suffire.',
    'Illusionniste':  'ü™Ñ La confusion que vous semez prot√®ge les loups ou vous-m√™me. Observez les r√©actions.',
    'Hypnotiseur':    'üåÄ Votre suggestion est active. Observez si votre cible vote comme pr√©vu.',
    'Usurpateur':     'üé≠ Vous avez (peut-√™tre) copi√© un pouvoir. Utilisez-le √† bon moment.',
    'Avocat':         '‚öñÔ∏è Votre client est prot√©g√© ce vote. Mais pour combien de temps ?',
    'Tra√Ætre':        'üó°Ô∏è Pour l\'instant villageois. Bient√¥t, vous changerez de camp.',
    'Marionnettiste': 'üßµ Vos fils tirent dans l\'ombre. Observez les cons√©quences.',
  };

  const msg = g.phase==='night' ? (ROLE_NIGHT_MSG[role]||'Observez et attendez‚Ä¶') : (ROLE_DAY_MSG[role]||'Participez aux d√©bats.');
  const camp = ALL_ROLES[role]?.camp || 'village';
  btns.innerHTML=`<div class="a-flavor ${camp}">${msg}</div>`;

  if(g.phase==='night'){
    // Wolf roles
    if(['Loup-Garou','Loup Blanc','Loup Enrag√©','Loup aux Puces'].includes(role)){
      if(!g.wolfVotes?.[me.id]) add('üê∫ D√©signer la victime','red',()=>wolfVoteModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üê∫ Cible d√©sign√©e ‚Äî attendez le r√©sultat'}));
    }
    if(role==='Loup Enrag√©' && (g.turn % 3 === 0))
      add('üî• Nuit enrag√©e ‚Äî tuer 2 cibles','red',()=>wolfRageModal(room));
    if(role==='Loup Infectieux'){
      if(!g.wolfVotes?.[me.id]) add('üê∫ D√©signer la victime','red',()=>wolfVoteModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üê∫ Cible d√©sign√©e'}));
      if(!g.infectUsed) add('ü¶† Infecter (au lieu de tuer)','red',()=>infectModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'ü¶† Infection d√©j√† utilis√©e'}));
    }
    // Village roles ‚Äî check seerUsed (reset each night)
    if(role==='Voyante'){
      if(!g.seerUsed) add('üîÆ Voir un r√¥le','green',()=>seerModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üîÆ Vous avez d√©j√† regard√© cette nuit'}));
    }
    if(role==='Sorci√®re'){
      if(!g.witchLifeUsed) add('üß™ Potion de Vie','green',()=>witchLifeModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üß™ Potion de vie √©puis√©e'}));
      if(!g.witchDeathUsed) add('‚ò†Ô∏è Potion de Mort','red',()=>witchDeathModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚ò†Ô∏è Potion de mort √©puis√©e'}));
    }
    if(role==='Garde du Corps')                add('üõ°Ô∏è Prot√©ger un joueur','green',()=>protectModal(room));
    if(role==='Dieu du Village'){
      if(!g.godUsed) add('‚ú® Annuler une mort','purple',()=>godModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚ú® Pouvoir divin d√©j√† utilis√©'}));
    }
    if(role==='Chronomancien'){
      if(!g.chronoUsed && (g.turn||1) > 1) add('‚è≥ Rembobiner un tour','purple',()=>chronoAction());
      else if(g.chronoUsed) btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚è≥ Rembobinage d√©j√† utilis√©'}));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'‚è≥ Impossible de rembobiner √† la premi√®re nuit'}));
    }
    if(role==='N√©cromancien')                  add('üíÄ Consulter les morts','purple',()=>necroModal(room));
    if(role==='Cupidon'){
      if(!g.cupidonDone) add('üíò Lier deux amoureux','green',()=>cupidonModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'üíò Amoureux d√©j√† li√©s'}));
    }
    // Neutral roles
    if(role==='Illusionniste'){
      const illuCooldown = g.illusionCooldownLength || 2;
      const illuLastTurn = g.illusionLastTurn || 0;
      const illuReady = !illuLastTurn || (g.turn||1) - illuLastTurn >= illuCooldown;
      if(illuReady) add('ü™Ñ Fausser la Voyante','purple',()=>illusionModal(room));
      else btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:'ü™Ñ Pouvoir en recharge‚Ä¶ encore '+((illuLastTurn+illuCooldown)-(g.turn||1))+' tour(s)'}));
    }
    if(role==='Hypnotiseur')                   add('üåÄ Hypnotiser','purple',()=>hypnoModal(room));
    if(role==='Usurpateur')                    add('üé≠ Copier un pouvoir','purple',()=>usurpModal(room));
    if(role==='Marionnettiste')                add('üßµ Contr√¥ler un joueur','purple',()=>puppetModal(room));
    if(role==='Avocat')                        add('‚öñÔ∏è Prot√©ger du vote','',()=>advocateModal(room));
    if(role==='Loup aux Puces'&&!g.fleaUsed)   add('üêú Infecter lentement','red',()=>fleaModal(room));
  } else {
    // DAY ‚Äî vote system
    const votes = g.dayVotes || {};
    const alivePlayers = players.filter(p=>p.alive);
    const votedCount = alivePlayers.filter(p=>votes[p.id]).length;
    const myVote = votes[me.id];

    // Vote progress bar
    const pct = alivePlayers.length > 0 ? Math.round(votedCount/alivePlayers.length*100) : 0;
    btns.innerHTML += `<div style="margin-bottom:8px;">
      <div style="font-size:.75rem;color:var(--smoke);margin-bottom:4px;font-style:italic;">üìä ${votedCount}/${alivePlayers.length} joueurs ont vot√©</div>
      <div style="background:rgba(255,255,255,.06);border-radius:4px;height:4px;overflow:hidden;">
        <div style="background:var(--blood2);height:100%;width:${pct}%;transition:width .4s;"></div>
      </div>
    </div>`;

    // Show current tally if any votes
    if(votedCount > 0){
      const tally = {};
      Object.entries(votes).forEach(([vid,tid])=>{
        const w = players.find(p=>p.id===vid)?.mayor ? 2 : 1;
        tally[tid] = (tally[tid]||0)+w;
      });
      const tallyStr = Object.entries(tally).sort((a,b)=>b[1]-a[1])
        .map(([id,v])=>{ const p=players.find(x=>x.id===id); return `${p?.avatar||''} ${p?.name||'?'} <strong style="color:#e07070">${v}</strong>`; })
        .join(' &nbsp;¬∑&nbsp; ');
      btns.innerHTML += `<div style="font-size:.78rem;color:var(--smoke);font-style:italic;margin-bottom:6px;">${tallyStr}</div>`;
    }

    if(!myVote){
      add('‚öñÔ∏è Voter pour √©liminer','red',()=>voteModal(room));
    } else {
      const target = players.find(p=>p.id===myVote);
      btns.appendChild(Object.assign(document.createElement('div'),{className:'a-used',textContent:`‚úÖ Vot√© contre ${target?.name||'?'} ‚Äî en attente des autres‚Ä¶`}));
    }
    if(role==='Dieu du Village'&&!g.godUsed) add('‚ú® Annuler une √©lim.','purple',()=>godModal(room));
    if(role==='Maire') add('üëë Passer la couronne','',()=>mayorPassModal(room));
  }
}

function renderEvent(g) {
  const card = document.getElementById('ev-card');
  if(!g.currentEvent){card.style.display='none';return;}
  card.style.display='block';
  const ev=g.currentEvent;
  card.innerHTML=`<div class="ev-big">${ev.icon}</div><div class="ev-title">${esc(ev.name)}</div><div class="ev-desc">${esc(ev.desc)}</div>`;
}


// ================================================================
// TIMER
// ================================================================
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    const g = localRoom?.game;
    if(!g||!g.phaseEndTime) return;
    const rem = Math.max(0, Math.ceil((g.phaseEndTime - Date.now())/1000));
    const el = document.getElementById('ph-timer');
    if(el){el.textContent=rem+'s'; el.className='ph-timer'+(rem<=10?' urgent':'');}
    if(rem<=0) {
      clearInterval(timerInterval);
      timerInterval = null;
      const players = localRoom?.players ? Object.values(localRoom.players) : [];
      const alive = players.filter(p=>p.alive);
      const coordinator = alive.length > 0 ? alive.sort((a,b)=>a.id.localeCompare(b.id))[0] : null;
      if(coordinator && coordinator.id === me.id) {
        // Only switch if day hasn't already ended via votes
        if(g.phase === 'day'){
          // On day timeout, auto-resolve votes with whoever has most
          (async()=>{
            const room = await dbGet('rooms/'+roomCode);
            const votes = room?.game?.dayVotes || {};
            if(Object.keys(votes).length > 0){
              await resolveVote(room);
            } else {
              await switchPhase('night');
            }
          })();
        } else {
          switchPhase('day');
        }
      } else if(!coordinator) {
        if(isHost){
          if(g.phase==='night') switchPhase('day');
          else switchPhase('night');
        }
      }
    }
  }, 500);
}

// ================================================================
// NIGHT KILL RESOLUTION ‚Äî called when switching night ‚Üí day
// ================================================================
async function resolveNightKill(g){
  const wolfVotes = g?.wolfVotes || {};
  if(!Object.keys(wolfVotes).length) return; // No wolves voted

  // Tally wolf votes
  const tally = {};
  Object.values(wolfVotes).forEach(tid=>{ tally[tid]=(tally[tid]||0)+1; });
  const max = Math.max(...Object.values(tally));
  const top = Object.keys(tally).filter(id=>tally[id]===max);
  const targetId = top[Math.floor(Math.random()*top.length)];

  await killPlayer(targetId, 'nuit');
}

// ================================================================
// PHASE SWITCH
// ================================================================
async function switchPhase(newPhase){
  const room = await dbGet('rooms/'+roomCode);
  if(!room||!room.game) return;
  const g = room.game;
  // Guard: don't switch if already switched (phaseEndTime already past and phase already changed)
  if(g.phase === newPhase) return;
  const dur = newPhase==='night' ? g.nightDur||90 : g.dayDur||180;
  const updates = {};
  updates['rooms/'+roomCode+'/game/phase'] = newPhase;
  updates['rooms/'+roomCode+'/game/phaseEndTime'] = Date.now()+dur*1000;
  updates['rooms/'+roomCode+'/game/lastPhaseChange'] = Date.now();
  if(newPhase==='night'){
    updates['rooms/'+roomCode+'/game/turn'] = (g.turn||1)+1;
    // Reset per-night flags
    updates['rooms/'+roomCode+'/game/seerUsed'] = false;
    // illusionUsedThisNight removed ‚Äî using turn-based cooldown instead
    updates['rooms/'+roomCode+'/game/wolfVotes'] = null;
    // Reset protection
    const players = room.players ? Object.values(room.players) : [];
    players.forEach(p=>{ updates['rooms/'+roomCode+'/players/'+p.id+'/protected']=false; });
  } else {
    // Reset day votes for new day
    updates['rooms/'+roomCode+'/game/dayVotes'] = null;
    updates['rooms/'+roomCode+'/game/voteResolved'] = false;
    updates['rooms/'+roomCode+'/game/hypnoVictim'] = null;
    updates['rooms/'+roomCode+'/game/hypnoForcedTarget'] = null;
  }
  await update(ref(db), updates);
  const turn = newPhase==='night' ? (g.turn||1)+1 : g.turn;
  if(newPhase==='night'){
    await pushLog(`üåë ‚Äî Nuit ${turn} ‚Äî Les loups se r√©veillent.`,'night');
    pushNarr({fire:'üåë',color:'#8070b0',title:`Nuit ${turn}`,text:`Le soleil s'est couch√©. Les volets se ferment. Dans l'obscurit√© totale, quelque chose se d√©place lentement entre les maisons. Quelqu'un pr√©pare son crime.`});
  } else {
    // Resolve wolf kill from last night BEFORE showing day
    await resolveNightKill(g);
    await pushLog(`‚òÄÔ∏è ‚Äî Jour ${g.turn} ‚Äî Le village s'√©veille.`,'day');
    pushNarr({fire:'‚òÄÔ∏è',color:'#c8a050',title:`Jour ${g.turn}`,text:`L'aube rougeoyante r√©veille le village, mais l'air reste lourd de mensonges. Les regards se croisent, fuyants ou accusateurs. Qui parmi nous ment ce matin ?`});
  }
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom) {
    await maybeEvent(freshRoom.game);
    await checkFleaInfection(freshRoom);
    await maybeAmbientNarr(freshRoom);
    // Dawn whispers for each player at start of day
    if(newPhase==='day') await pushDawnWhispers(freshRoom);
  }
  if(newPhase==='day') await checkVictory();
}

// ================================================================
// EVENTS
// ================================================================
async function maybeEvent(g){
  const prob = g?.evProb || 30;
  if(Math.random()*100 < prob){
    const ev = ALL_EVENTS[Math.floor(Math.random()*ALL_EVENTS.length)];
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:ev});
    await pushLog(`üåÄ √âV√âNEMENT : ${ev.name} ‚Äî ${ev.desc}`,'chaos');
    pushNarr({fire:ev.icon,color:'#c0a0ff',title:ev.name,text:ev.desc+' Un frisson parcourt le village. Personne ne sait encore quelles cons√©quences cela aura vraiment‚Ä¶'});
    await applyEvent(ev);
  } else {
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:null});
  }
}


// ================================================================
// DAWN WHISPERS ‚Äî personalized per-role message at start of each day
// ================================================================
async function pushDawnWhispers(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive);
  const dead = Object.values(room.players||{}).filter(p=>!p.alive);
  const lastDead = dead.length > 0 ? dead[dead.length-1] : null;
  const turn = room.game?.turn || 1;

  const getDawnMsg = (p, lastDead, allAlive) => {
    const others = allAlive.filter(x=>x.id!==p.id);
    const suspect = others.length ? others[Math.floor(Math.random()*others.length)] : null;
    const deadName = lastDead?.name || null;

    const pool = {
      'Loup-Garou': [
        deadName ? `Le corps de ${deadName} a √©t√© retrouv√© au lever du soleil. Le village est en deuil. C'est exactement ce que tu voulais, ${p.name}. Garde ton calme et laisse les autres s'accuser.` : `Une nouvelle journ√©e commence, ${p.name}. Le village cherche un coupable ‚Äî assure-toi que ce ne soit jamais toi.`,
        `${p.name}, les loups ont frapp√© dans l'ombre. Aujourd'hui, prends les devants : accuse ${suspect?.name||'quelqu\'un'} avant qu'on t'accuse. Les innocents h√©sitent. Pas toi.`,
      ],
      'Loup Blanc': [
        `${p.name}, tu joues des deux c√¥t√©s de l'√©chiquier. Les loups te croient des leurs, le village pense pareil. Pour l'instant, laisse les autres s'√©liminer. Ta victoire est solitaire.`,
        deadName ? `${deadName} est mort(e), et le village gronde. ${p.name}, reste discret. Ta vraie menace, ce sont les loups eux-m√™mes. Le moment de les trahir approche.` : `${p.name}, ni loup ni villageois ‚Äî tu es seul contre tous. Et c'est exactement l√† o√π tu dois √™tre.`,
      ],
      'Loup Infectieux': [
        `${p.name}, ton infection agit en silence. Observe les comportements autour de toi ‚Äî quelqu'un a peut-√™tre d√©j√† chang√© de camp sans s'en rendre compte encore.`,
      ],
      'Loup Enrag√©': [
        `${p.name}, ta rage sommeille jusqu'√† la prochaine nuit. Aujourd'hui, joue l'innocent. Accuse, crie, pleure si n√©cessaire. Les meilleurs menteurs ressemblent aux meilleures victimes.`,
      ],
      'Loup aux Puces': [
        `${p.name}, tes puces font leur travail invisible. Reste calme. Ce que tu as sem√© cette nuit portera ses fruits bient√¥t.`,
      ],
      'Voyante': [
        `${p.name}, tu sais des choses que les autres ignorent. Mais comment les r√©v√©ler sans para√Ætre suspect ? Chaque accusation directe pourrait te co√ªter la vie. Sois subtil.`,
        deadName ? `${deadName} a √©t√© frapp√©(e) cette nuit, ${p.name}. Tes visions t'ont-elles pr√©venu(e) ? Utilise ce que tu sais ‚Äî mais avec prudence.` : `${p.name}, tes yeux ont vu la v√©rit√© cette nuit. √Ä toi maintenant de guider le village sans te d√©voiler.`,
      ],
      'Sorci√®re': [
        `${p.name}, tes potions valent plus que de l'or. Une vie, une mort ‚Äî chaque flacon est une d√©cision irr√©vocable. Ne les gaspille pas sur une erreur.`,
        deadName ? `${deadName} a quitt√© le monde cette nuit, ${p.name}. L'aurais-tu sauv√©(e) si tu l'avais su √† temps ? Garde ta potion de vie pour quelqu'un qui change vraiment la partie.` : `${p.name}, une nouvelle journ√©e de d√©bats commence. √âcoute, observe ‚Äî ta potion agira quand la situation sera vraiment critique.`,
      ],
      'Chasseur': [
        `${p.name}, ta fl√®che n'a qu'une seule cible, mais elle est garantie. Aujourd'hui, observe qui se comporte √©trangement. Peut-√™tre que cette personne m√©rite d'√™tre ton dernier tir.`,
        `${p.name}, si quelqu'un essaie de t'√©liminer aujourd'hui, rappelle-toi : tu ne mourras pas seul. Cette certitude devrait te donner confiance.`,
      ],
      'Garde du Corps': [
        deadName ? `${deadName} n'√©tait pas sous ta protection cette nuit, ${p.name}. Qui prot√©ger maintenant ? Choisis wis√©ment ce soir.` : `${p.name}, personne n'est mort cette nuit. Peut-√™tre que ta pr√©sence a suffi √† faire h√©siter les loups. Ou peut-√™tre que ce n'est que partie remise.`,
        `${p.name}, tu veilles dans l'ombre. Le village ne sait pas que tu existes, et c'est ta force.`,
      ],
      'Dieu du Village': [
        `${p.name}, ta gr√¢ce divine peut encore sauver une √¢me. Mais les dieux qui interviennent trop t√¥t perdent leur myst√®re. Garde ton pouvoir pour le moment d√©cisif.`,
      ],
      'Chronomancien': [
        `${p.name}, le temps peut encore √™tre remodel√©. Mais une seule fois. Observe ce qui se d√©roule aujourd'hui ‚Äî certaines erreurs m√©ritent vraiment d'√™tre effac√©es.`,
      ],
      'N√©cromancien': [
        `${p.name}, les morts t'ont murmur√© leurs secrets cette nuit. Une information que personne d'autre ne poss√®de. Mais les morts savent aussi se taire quand on les interroge de la mauvaise fa√ßon.`,
      ],
      'Cupidon': [
        `${p.name}, les amoureux que tu as li√©s portent leur destin√©e commune. Regarde-les aujourd'hui ‚Äî se prot√®gent-ils ? Se trahissent-ils ? Leur lien peut sauver ou d√©truire le village.`,
      ],
      'Maire': [
        `${p.name}, le village attend ta guidance. Ta voix compte double ‚Äî c'est une lame √† double tranchant. Si tu d√©signes le mauvais aujourd'hui, le sang sera sur tes mains.`,
        deadName ? `${deadName} n'est plus l√†, ${p.name}. En tant que Maire, le village te regarde pour trouver le responsable. Mesure chaque mot.` : `${p.name}, Maire du village, ta l√©gitimit√© d√©pend de tes d√©cisions. Prends les devants.`,
      ],
      'Illusionniste': [
        `${p.name}, la confusion que tu as sem√©e dans l'esprit de la Voyante pourrait changer les accusations d'aujourd'hui. Observe si quelqu'un accuse dans la mauvaise direction.`,
      ],
      'Hypnotiseur': [
        `${p.name}, ta suggestion est active. Regarde si ta cible vote comme tu l'as ordonn√©. Si oui, tu contr√¥les plus que les autres ne le soup√ßonnent.`,
      ],
      'Usurpateur': [
        `${p.name}, tu portes en toi un pouvoir vol√©. Personne ne sait ce dont tu es vraiment capable. C'est ton arme la plus pr√©cieuse.`,
      ],
      'Avocat': [
        `${p.name}, ton client est prot√©g√© ce vote. Assure-toi que sa survie te profite‚Ä¶ ou qu'il le m√©rite vraiment.`,
      ],
      'Tra√Ætre': [
        `${p.name}, tu joues encore le villageois. Pour combien de temps encore ? √âcoute la meute dans l'ombre ‚Äî le moment de changer de camp approche peut-√™tre.`,
      ],
      'Marionnettiste': [
        `${p.name}, tes fils ont agi cette nuit. Observe les cons√©quences de tes manipulations dans les comportements d'aujourd'hui.`,
      ],
      'Villageois': [
        deadName ? `${deadName} a √©t√© tu√©(e) cette nuit. Quelqu'un parmi vous le savait. Quelqu'un a peut-√™tre m√™me ordonn√© √ßa. ${p.name}, observe les r√©actions ‚Äî la culpabilit√© laisse des traces.` : `${p.name}, une nouvelle nuit s'est pass√©e sans mort. Les loups ont h√©sit√©. Ou attendu. Profite de cette journ√©e pour observer ${suspect?.name||'les autres'} de plus pr√®s.`,
        `${p.name}, tu n'as aucun pouvoir surnaturel. Mais tu as des yeux, une m√©moire, et un vote. ${suspect ? `Ce matin, quelque chose dans le regard de ${suspect.name} te semble diff√©rent. Peut-√™tre rien. Peut-√™tre tout.` : 'Analyse. √âcoute. D√©duis.'}`,
      ],
    };

    const msgs = pool[p.role] || [`${p.name}, une nouvelle journ√©e commence. Reste vigilant.`];
    return msgs[Math.floor(Math.random()*msgs.length)];
  };

  const whispers = {};
  players.forEach(p=>{
    whispers[p.id] = {
      text: getDawnMsg(p, lastDead, players),
      turn, ts: Date.now()
    };
  });
  await dbSet('rooms/'+roomCode+'/dawnWhispers', whispers);
}

// Called each render cycle ‚Äî shows whisper to current player only
let shownDawnTurns = new Set();
function checkDawnWhisper(room){
  if(!room.dawnWhispers || room.game?.phase !== 'day') return;
  const w = room.dawnWhispers[me.id];
  if(!w) return;
  const key = `${roomCode}_dawn_${w.turn}`;
  if(shownDawnTurns.has(key)) return;
  shownDawnTurns.add(key);
  const myP = room.players?.[me.id];
  const rd = ALL_ROLES[myP?.role];
  // Private local narr (not pushed to Firebase)
  queueNarr({
    fire: rd?.emoji || 'üåÖ',
    color: rd?.camp==='loup' ? '#e07070' : rd?.camp==='neutre' ? '#c0a0ff' : '#c8a050',
    title: `Jour ${w.turn} ‚Äî Ce que vous ressentez`,
    text: w.text
  });
}

async function checkFleaInfection(room){
  const g = room.game;
  if(!g?.fleaTarget || g.fleaInfected) return;
  const currentTurn = g.turn;
  const fleaTurn = g.fleaTurn || 0;
  if(currentTurn - fleaTurn >= 2){
    const target = room.players?.[g.fleaTarget];
    if(target && target.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+g.fleaTarget,{role:'Loup-Garou'});
      await dbUpdate('rooms/'+roomCode+'/game',{fleaInfected:true});
      await pushLog(`üêú Quelqu'un ressent une √©trange transformation‚Ä¶`,'night');
      pushNarr({fire:'üêú',color:'#8a6030',title:'La M√©tamorphose',text:`${target.name} se r√©veille avec une sensation √©trange. Quelque chose en lui a chang√©. Une soif nouvelle. Une loyaut√© nouvelle. La meute l'appelle maintenant.`});
    }
  }
}

// ================================================================
// AMBIENT NARRATIVE EVENTS ‚Äî personal, immersive, role-aware
// ================================================================
async function maybeAmbientNarr(room){
  const g = room.game;
  const players = Object.values(room.players||{});
  const alive = players.filter(p=>p.alive);
  const dead = players.filter(p=>!p.alive);
  if(alive.length < 2) return;
  // ~50% chance of ambient narr each phase change
  if(Math.random() > 0.5) return;

  const phase = g.phase; // current phase after switch
  const lastDead = dead.length > 0 ? dead[dead.length-1] : null;
  const randAlive = alive[Math.floor(Math.random()*alive.length)];
  const wolves = alive.filter(p=>ALL_ROLES[p.role]?.camp==='loup');
  const villagers = alive.filter(p=>ALL_ROLES[p.role]?.camp==='village');
  const seer = alive.find(p=>p.role==='Voyante');
  const witch = alive.find(p=>p.role==='Sorci√®re');
  const hunter = alive.find(p=>p.role==='Chasseur');
  const mayor = alive.find(p=>p.mayor);
  const lovers = alive.filter(p=>p.lovers);

  // Pool of possible ambient events ‚Äî pick one that makes sense contextually
  const pool = [];

  // Universal ambient events
  pool.push({
    fire:'ü¶â',color:'#8080b0',
    title:'Un Bruit dans l\'Ombre',
    text:`Le vent souffle entre les ruelles du village. Quelqu'un a aper√ßu une silhouette cette nuit derri√®re la fen√™tre de ${randAlive.name}. Rien d'autre. Juste une ombre.`
  });
  pool.push({
    fire:'üïØÔ∏è',color:'#c8a050',
    title:'La Chandelle Vacille',
    text:`Une fen√™tre s'est allum√©e en plein milieu de la nuit dans le village. Qui ne dort pas ? Pourquoi ? ${randAlive.name} a √©t√© vu(e) debout √† une heure avanc√©e. Co√Øncidence ?`
  });
  pool.push({
    fire:'üê¶',color:'#60a080',
    title:'Le Chant de l\'Aube',
    text:`Les oiseaux se sont tus cette nuit, plus t√¥t que d'habitude. Comme s'ils sentaient quelque chose. Comme s'ils fuyaient un pr√©dateur que les humains ne peuvent pas encore voir.`
  });
  pool.push({
    fire:'üå´Ô∏è',color:'#707090',
    title:'Brumes Matinales',
    text:`Un √©pais brouillard recouvre le village ce matin. Les visages sont flous, les intentions encore plus. Dans cette grisaille, m√™me les innocents semblent suspects.`
  });

  if(lastDead){
    pool.push({
      fire:'üï≥Ô∏è',color:'#a06060',
      title:'Les Traces de la Nuit',
      text:`Pr√®s de la maison de ${lastDead.name}, quelqu'un a remarqu√© des empreintes dans la boue. Deux paires. L'une appartient √† la victime. L'autre‚Ä¶ reste un myst√®re.`
    });
    pool.push({
      fire:'üìú',color:'#c8a050',
      title:'Un Message Retrouv√©',
      text:`On a trouv√© un billet froiss√© dans la poche de ${lastDead.name}. Le papier est tach√©, l'encre √† moiti√© effac√©e. On peut juste lire un pr√©nom : "${randAlive.name}".`
    });
    pool.push({
      fire:'üß©',color:'#808060',
      title:'T√©moignage',
      text:`Un villageois confie √† voix basse : la nuit de la mort de ${lastDead.name}, il a entendu des voix √† deux maisons de distance. Deux voix. L'une grave, l'autre que personne n'a reconnue.`
    });
  }

  if(wolves.length > 0 && alive.length > 3){
    pool.push({
      fire:'üê∫',color:'#a04040',
      title:'Un Grognement Lointain',
      text:`Aux abords du village, quelqu'un a entendu un son grave cette nuit. Pas un animal. Quelque chose de plus patient. Plus intelligent. Il regardait le village depuis les t√©n√®bres.`
    });
    pool.push({
      fire:'ü©∏',color:'#900000',
      title:'Une Tache Sombre',
      text:`Une trace sombre a √©t√© remarqu√©e sur le perron ce matin. Personne ne sait depuis combien de temps elle est l√†. ${randAlive.name} ne semblait pas surpris(e) en la voyant.`
    });
  }

  if(seer){
    pool.push({
      fire:'üîÆ',color:'#9060b0',
      title:'Une Vision Trouble',
      text:`Quelqu'un dans le village se r√©veille chaque matin les yeux rouges, comme hant√©(e) par des images nocturnes. Les r√™ves ont des v√©rit√©s que les mots ne peuvent pas contenir.`
    });
  }

  if(witch){
    pool.push({
      fire:'ü´ô',color:'#5080a0',
      title:'Une Odeur √Çcre',
      text:`Une √©trange odeur s'est r√©pandue dans une ruelle cette nuit. Am√®re, chimique, presque m√©dicinale. Comme si quelqu'un avait renvers√© un flacon dans l'obscurit√©.`
    });
  }

  if(hunter){
    pool.push({
      fire:'üèπ',color:'#a08040',
      title:'Un Bruit de Pas',
      text:`On a entendu des pas rapides sur les toits cette nuit. L√©gers mais pr√©cis. Comme quelqu'un qui surveille. Qui attend. Avec une fl√®che d√©j√† encoch√©e.`
    });
  }

  if(mayor){
    pool.push({
      fire:'üëë',color:'#c0a030',
      title:'Le Maire Inquiet',
      text:`${mayor.name} n'a presque pas dormi. On l'a vu d√©ambuler dans les rues, les mains crois√©es dans le dos, le regard perdu. Les d√©cisions du village p√®sent lourd en ces temps sombres.`
    });
  }

  if(lovers.length === 2){
    pool.push({
      fire:'‚ù§Ô∏è',color:'#d060a0',
      title:'Une √âtreinte Secr√®te',
      text:`${lovers[0].name} et ${lovers[1].name} ont √©t√© aper√ßus ensemble cette nuit, loin du village. Que se disaient-ils ? Que se promettaient-ils ? Certains amours survivent m√™me aux loups.`
    });
  }

  if(phase === 'night'){
    pool.push({
      fire:'üåë',color:'#6050a0',
      title:'Le Village Retient son Souffle',
      text:`Toutes les bougies sont √©teintes. Toutes les portes verrouill√©es. Mais certains yeux restent ouverts dans le noir, √† √©couter les bruits que la nuit produit quand elle croit que tout le monde dort.`
    });
  } else {
    pool.push({
      fire:'‚òÄÔ∏è',color:'#b08030',
      title:'L\'Heure des Regards',
      text:`Le soleil s'est lev√© mais aucun sourire ne l'accompagne. Les villageois s'observent en biais, pesant chaque mot avant de l'√©noncer. La m√©fiance est devenue le seul langage parl√© ici.`
    });
    pool.push({
      fire:'üó£Ô∏è',color:'#808060',
      title:'Des Murmures',
      text:`On chuchote beaucoup ce matin. Des noms circulent. Des th√©ories naissent et meurent en quelques secondes. ${randAlive.name} a √©t√© mentionn√©(e) plusieurs fois. Pour rien. Ou peut-√™tre pas.`
    });
  }

  const chosen = pool[Math.floor(Math.random()*pool.length)];
  pushNarr(chosen);
}

async function applyEvent(ev){
  const room = await dbGet('rooms/'+roomCode);
  const players = room?.players ? Object.values(room.players) : [];
  const alive = players.filter(p=>p.alive);
  if(!alive.length) return;

  if(ev.name==='Immunit√© Al√©atoire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    await dbUpdate('rooms/'+roomCode+'/players/'+t.id,{protected:true});
    await pushLog(`üõ°Ô∏è ${t.name} est immunis√© pour ce tour.`,'chaos');
  }
  if(ev.name==='Nouveau Maire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    const upd={};
    players.forEach(p=>{upd['rooms/'+roomCode+'/players/'+p.id+'/mayor']=false;});
    upd['rooms/'+roomCode+'/players/'+t.id+'/mayor']=true;
    await update(ref(db),upd);
    await pushLog(`üëë ${t.name} devient le nouveau Maire !`,'chaos');
  }
  if(ev.name==='Retour des Morts'){
    const dead=players.filter(p=>!p.alive);
    if(dead.length){
      const r=dead[Math.floor(Math.random()*dead.length)];
      await dbUpdate('rooms/'+roomCode+'/players/'+r.id,{alive:true});
      await pushLog(`üëª ${r.name} revient d'entre les morts pour un tour !`,'chaos');
    }
  }
  if(ev.name==='Potion Retrouv√©e'){
    const g=room.game;
    if(g?.witchLifeUsed){await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:false});}
    else if(g?.witchDeathUsed){await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:false});}
  }
}

// ================================================================
// KILL
// ================================================================
async function killPlayer(playerId, source){
  const room = await dbGet('rooms/'+roomCode);
  const p = room?.players?.[playerId];
  if(!p||!p.alive) return;
  if(p.protected){await pushLog(`üõ°Ô∏è ${p.name} √©tait prot√©g√© ‚Äî l'attaque a √©chou√©.`,'info');return;}

  await dbUpdate('rooms/'+roomCode+'/players/'+playerId,{alive:false});
  await pushLog(`üíÄ ${p.name} a √©t√© √©limin√©(e).`,'death');

  const narr = source==='nuit'||source==='loups'
    ? {fire:'üåë',color:'#e07070',title:'La Nuit a Frapp√©',text:`Les ombres ont d√©chir√© le silence. Ce matin, les villageois ont retrouv√© ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî froid et immobile. Le givre recouvrait ses l√®vres comme si la mort avait scell√© ses secrets.`}
    : {fire:'‚öñÔ∏è',color:'#e0c070',title:'La Justice du Village',text:`Apr√®s de longues heures de d√©bat, la foule a lev√© la main. ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî a √©t√© conduit au centre du village. Ses yeux cherchaient encore un alli√© dans la foule. Il n'en trouva aucun.`};
  pushNarr(narr);

  // Lovers
  const g = room.game;
  if(p.lovers && g){
    const loverId = g.loversA===playerId ? g.loversB : g.loversA;
    const lover = room.players?.[loverId];
    if(lover&&lover.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+loverId,{alive:false});
      await pushLog(`‚ù§Ô∏è ${lover.name} ne peut survivre √† la mort de son amour et meurt aussi.`,'death');
      pushNarr({fire:'üíî',color:'#f48fb1',title:'Un Amour Bris√©',text:`Quand ${p.name} est tomb√©(e), quelque chose dans le c≈ìur de ${lover.name} s'est bris√©. Les amoureux li√©s par Cupidon ne peuvent survivre l'un sans l'autre. La l√©gende s'est confirm√©e.`});
    }
  }
  if(p.mayor) await pushLog(`üëë Le Maire est mort ! D√©signez un nouveau maire.`,'system');

  // Chasseur: trigger shot on elimination
  if(p.role === 'Chasseur' && !room.game?.hunterUsed){
    await dbUpdate('rooms/'+roomCode+'/game',{hunterUsed:true});
    pushNarr({fire:'üèπ',color:'#a08040',title:'Le Dernier Tir du Chasseur',text:`${p.name} tombe‚Ä¶ mais pas sans riposter. Le Chasseur peut encore choisir qui l'accompagne dans la mort. Son regard cherche une derni√®re cible dans la foule.`});
    // Show modal for the hunter's player to pick a target
    if(me.id === playerId){
      const freshRoom = await dbGet('rooms/'+roomCode);
      const targets = Object.values(freshRoom.players||{}).filter(q=>q.alive&&q.id!==playerId);
      if(targets.length > 0){
        setTimeout(()=>{
          openModal('üèπ Dernier Tir ‚Äî Choisissez votre cible',
            `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Vous √™tes √©limin√©(e) mais votre fl√®che peut encore frapper !</p>`+
            targets.map(t=>`<button class="m-opt red" onclick="window._kill('${t.id}','chasseur');closeModal()">${t.avatar} ${esc(t.name)}</button>`).join('')
          );
        }, 2000);
      }
    }
  }

  await checkVictory();
}


window._kill = (id,src)=>killPlayer(id,src);

window._setMayor = async function(id){
  const room = await dbGet('rooms/'+roomCode);
  const upd={};
  Object.keys(room.players||{}).forEach(pid=>{upd['rooms/'+roomCode+'/players/'+pid+'/mayor']=false;});
  upd['rooms/'+roomCode+'/players/'+id+'/mayor']=true;
  await update(ref(db),upd);
  const p=room.players[id];
  if(p) await pushLog(`üëë ${p.name} est √©lu Maire !`,'info');
};

window._revive = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  const r=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(r) await pushLog(`‚ú® ${r.name} est de retour parmi les vivants.`,'info');
};
window._protect = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{protected:true});
  await dbUpdate('rooms/'+roomCode+'/game',{lastProtected:id});
  // No log ‚Äî secret action
};

// ================================================================
// WOLF PRIVATE CHAT
// ================================================================
let wolfChatRendered = 0;
window.sendWolfChat = async function(){
  const inp=document.getElementById('wolf-in');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/wolfchat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts
  });
};
function renderWolfChat(room){
  const msgs = room.wolfchat ? Object.values(room.wolfchat).sort((a,b)=>a.ts-b.ts) : [];
  const c=document.getElementById('wolf-msgs');
  if(!c) return;
  if(msgs.length===wolfChatRendered) return;
  wolfChatRendered=msgs.length;
  c.innerHTML='';
  msgs.forEach(m=>{
    const d=document.createElement('div');
    const isMe=m.id===me.id;
    d.style.cssText=`font-size:.78rem;color:${isMe?'var(--moon)':'#e07070'};`;
    d.innerHTML=`<strong>${m.avatar} ${esc(m.name)}:</strong> <span style="color:var(--moon2)">${esc(m.text)}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}
document.getElementById('wolf-in')?.addEventListener('keypress',e=>{if(e.key==='Enter')sendWolfChat();});

// ================================================================
// WOLF RAGE MODAL (Loup Enrag√© ‚Äî nuit 3, 6, 9...)
// ================================================================
async function wolfRageModal(room){
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup');
  openModal('üî• Nuit Enrag√©e ‚Äî Tuer 2 cibles',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez votre premi√®re cible. Vous devrez ensuite choisir la seconde.</p>`+
    targets.map(p=>`<button class="m-opt red" onclick="window._rageKill('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
let rageFirstKill = null;
window._rageKill = async function(id){
  if(!rageFirstKill){
    rageFirstKill = id;
    const room=await dbGet('rooms/'+roomCode);
    const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==id);
    openModal('üî• Deuxi√®me Cible',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez votre seconde victime !</p>`+
      targets.map(p=>`<button class="m-opt red" onclick="window._rageKill('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  } else {
    const first = rageFirstKill;
    rageFirstKill = null;
    await killPlayer(first,'nuit');
    await killPlayer(id,'nuit');
  }
};

// ================================================================
// FLEA WOLF MODAL (Loup aux Puces)
// ================================================================
async function fleaModal(room){
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==me.id);
  openModal('üêú Loup aux Puces ‚Äî Infecter',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Cette personne deviendra Loup-Garou dans 2 tours, sans s'en rendre compte imm√©diatement.</p>`+
    targets.map(p=>`<button class="m-opt red" onclick="window._flea('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._flea = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  if(!p) return;
  // Store the flea target and the turn it was applied
  await dbUpdate('rooms/'+roomCode+'/game',{fleaUsed:true, fleaTarget:id, fleaTurn:room.game.turn});
  // no log ‚Äî secret
  pushNarr({fire:'üêú',color:'#8a6030',title:'La Contamination',text:`Dans l'obscurit√©, quelque chose a ramp√© sur ${p.name}. Invisible, indolore. Pour l'instant. Mais dans quelques nuits, ${p.name} entendra l'appel de la meute‚Ä¶`});
};


// ================================================================
// NEW ROLE ACTIONS
// ================================================================
async function infectModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup'&&p.id!==me.id);
  if(room.game?.infectUsed) {openModal('ü¶†','<p style="color:var(--smoke);font-style:italic;">Pouvoir d√©j√† utilis√© cette partie.</p>');return;}
  openModal('ü¶† Loup Infectieux ‚Äî Transformer',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Au lieu de tuer, vous transformez cette personne en Loup-Garou !</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._infect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._infect = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  if(!p) return;
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{role:'Loup-Garou'});
  await dbUpdate('rooms/'+roomCode+'/game',{infectUsed:true});
  // no log ‚Äî secret
  pushNarr({fire:'ü¶†',color:'#c07040',title:'L\'Infection Se R√©pand',text:`Dans le silence de la nuit, quelqu'un a re√ßu la morsure transformatrice. Demain matin, le village comptera peut-√™tre un loup de plus sans le savoir‚Ä¶`});
};

async function illusionModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('ü™Ñ Illusionniste ‚Äî Fausser',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">La Voyante recevra une information erron√©e sur ce joueur cette nuit.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._illuse('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._illuse = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const g=room?.game;
  if(!g) return;
  const cooldown = Math.random()<0.5 ? 2 : 3;
  await dbUpdate('rooms/'+roomCode+'/game',{illusionTarget:id, illusionUsedThisNight:true, illusionLastTurn:g.turn||1, illusionCooldownLength:cooldown});
  // no log ‚Äî secret
};

async function hypnoModal(room){
  const g = room.game;
  // Check cooldown
  if(g?.hypnoUsedTurn){
    const cooldown = g.hypnoCooldownLength || 2;
    const turnsLeft = (g.hypnoUsedTurn + cooldown) - (g.turn||1);
    if(turnsLeft > 0){
      openModal('üåÄ Hypnotiseur','<p style="color:var(--smoke);font-style:italic;">Pouvoir en recharge‚Ä¶ encore '+ turnsLeft +' tour(s).</p>');
      return;
    }
  }
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üåÄ Hypnotiseur ‚Äî Cibler',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Demain, ce joueur sera forc√© de voter pour la cible que vous choisissez maintenant.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._hypnoTarget('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._hypnoTarget = async function(victimId){
  const room=await dbGet('rooms/'+roomCode);
  const victim=room?.players?.[victimId];
  const targets=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==victimId);
  openModal(`üåÄ Qui doit voter ${victim?.name||'?'} ?`,
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez la cible forc√©e.</p>`+
    targets.map(p=>`<button class="m-opt purple" onclick="window._hypno('${victimId}','${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
};
window._hypno = async function(victimId, forcedTargetId){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[victimId];
  const g=room?.game;
  if(!p||!g) return;
  const cooldown = Math.random()<0.5 ? 2 : 3;
  await dbUpdate('rooms/'+roomCode+'/game',{
    hypnoVictim: victimId,
    hypnoForcedTarget: forcedTargetId,
    hypnoUsedTurn: g.turn||1,
    hypnoCooldownLength: cooldown
  });
  // no log ‚Äî secret
};

async function usurpModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üé≠ Usurpateur ‚Äî Copier',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Vous copiez temporairement le pouvoir de ce joueur.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._usurp('${p.id}');closeModal()">${p.avatar} ${esc(p.name)} <span style="font-size:.76rem;color:var(--smoke)">${ALL_ROLES[p.role]?.emoji} ${p.role}</span></button>`).join('')
  );
}
window._usurp = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  if(p){
    const rd=ALL_ROLES[p.role];
    openModal('üé≠ Pouvoir Copi√©',`<div style="text-align:center;padding:16px;">
      <div style="font-size:2rem;">${rd?.emoji||'?'}</div>
      <div style="font-family:'Cinzel Decorative',serif;margin-top:8px;">${p.role}</div>
      <div style="color:var(--smoke);font-size:.83rem;margin-top:6px;font-style:italic;">${rd?.desc||''}</div>
      <div style="color:var(--ember2);font-size:.8rem;margin-top:10px;">Pouvoir actif pour ce tour uniquement.</div>
    </div>`);
    // no log ‚Äî secret
  }
};

async function puppetModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üßµ Marionnettiste ‚Äî Contr√¥ler',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Ce joueur effectuera une action que vous choisissez √† sa place.</p>`+
    players.map(p=>`<button class="m-opt purple" onclick="window._puppet('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._puppet = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=room?.players?.[id];
  // no log ‚Äî secret
};

async function advocateModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚öñÔ∏è Avocat ‚Äî Prot√©ger du vote',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Ce joueur ne pourra pas √™tre √©limin√© par vote aujourd\'hui.</p>`+
    players.map(p=>`<button class="m-opt" onclick="window._protect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function hunterModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  const myP=Object.values(room.players||{}).find(p=>p.id===me.id);
  if(myP?.alive){openModal('üèπ','<p style="color:var(--smoke);font-style:italic;">Vous n\'√™tes pas encore √©limin√©(e). Ce pouvoir s\'active √† votre mort.</p>');return;}
  openModal('üèπ Chasseur ‚Äî Dernier Tir',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Vous emportez quelqu\'un avec vous !</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._kill('${p.id}','chasseur');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function mayorPassModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üëë Passer la Couronne',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">D√©signez votre successeur comme Maire.</p>`+
    players.map(p=>`<button class="m-opt" onclick="window._setMayor('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

// ================================================================
async function seerModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üîÆ Voyante ‚Äî Voir un r√¥le',
    players.map(p=>`<button class="m-opt" onclick="window._seer('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._seer = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(!p) return;
  // Mark seer as used this night
  await dbUpdate('rooms/'+roomCode+'/game',{seerUsed:true});
  // Check if illusionist has faked this player
  const illusionTarget = room?.game?.illusionTarget;
  let displayRole = p.role;
  let faked = false;
  if(illusionTarget === id){
    const allRoleNames = Object.keys(ALL_ROLES);
    const myRoleData = ALL_ROLES[p.role];
    const otherRoles = allRoleNames.filter(r=>ALL_ROLES[r].camp !== myRoleData?.camp);
    displayRole = otherRoles[Math.floor(Math.random()*otherRoles.length)] || p.role;
    faked = true;
    await dbUpdate('rooms/'+roomCode+'/game',{illusionTarget:null, illusionUsedThisNight:false});
  }
  const rd=ALL_ROLES[displayRole];
  openModal('üîÆ R√©v√©lation',`<div style="text-align:center;padding:18px;">
    <div style="font-size:2.5rem;margin-bottom:9px;">${rd?.emoji||'‚ùì'}</div>
    <div style="font-family:'Cinzel Decorative',serif;font-size:.95rem;">${esc(p.name)}</div>
    <div style="font-size:.82rem;color:var(--smoke);margin-top:5px;font-style:italic;">${rd?.emoji} ${displayRole}</div>
    <div style="font-size:.79rem;color:var(--smoke);margin-top:4px;">${rd?.desc||''}</div>
    ${faked?'<div style="font-size:.72rem;color:#c0a0ff;margin-top:8px;font-style:italic;">‚ö†Ô∏è Cette vision a peut-√™tre √©t√© alt√©r√©e par une force myst√©rieuse‚Ä¶</div>':''}
  </div>`);
};

// ================================================================
// VOTE SYSTEM ‚Äî tracks per-player votes, auto-resolves when all voted
// ================================================================
async function voteModal(room){
  const g = room.game;
  const myVote = g?.dayVotes?.[me.id];
  if(myVote){
    const target = Object.values(room.players||{}).find(p=>p.id===myVote);
    openModal('‚úÖ D√©j√† vot√©',`<div style="text-align:center;padding:14px;color:var(--smoke);font-style:italic;">
      Votre vote contre <strong style="color:var(--moon)">${target?.name||'?'}</strong> est enregistr√©.<br>
      Attendez que tous aient vot√©‚Ä¶
    </div>`);
    return;
  }
  const players = Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚öñÔ∏è Voter pour √©liminer',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Vote irr√©vocable ‚Äî le joueur avec le plus de voix sera √©limin√©.</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._vote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

window._vote = async function(targetId){
  const room = await dbGet('rooms/'+roomCode);
  if(!room?.game || room.game.phase !== 'day') return;
  if(room.game.voteResolved) return; // Already resolved
  const voter = room.players?.[me.id];
  if(!voter?.alive) return;
  if(room.game.dayVotes?.[me.id]) return; // already voted

  // Hypnotiseur: force vote if this player is the victim
  const g = room.game;
  if(g?.hypnoVictim === me.id && g?.hypnoForcedTarget){
    const forcedTarget = room.players?.[g.hypnoForcedTarget];
    if(forcedTarget?.alive && targetId !== g.hypnoForcedTarget){
      openModal('üåÄ Hypnose !',`<div style="text-align:center;padding:14px;color:var(--smoke);font-style:italic;">Une force irr√©sistible contr√¥le votre vote‚Ä¶ <strong style="color:#c0a0ff">${forcedTarget?.name||'?'}</strong> est votre seule cible possible !</div>`);
      targetId = g.hypnoForcedTarget; // force the vote
    }
  }

  const target = room.players?.[targetId];
  if(!target?.alive) return;

  const voteUpdate = {};
  voteUpdate[`rooms/${roomCode}/game/dayVotes/${me.id}`] = targetId;
  await update(ref(db), voteUpdate);
  await pushLog(`üó≥Ô∏è ${voter.name} vote contre ${target.name}.${voter.mayor?' (voix √ó2)':''}`, 'day');

  // Check if all alive players have now voted
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom.game?.voteResolved) return; // Another client already resolved
  const alivePlayers = Object.values(freshRoom.players||{}).filter(p=>p.alive);
  const votes = freshRoom.game?.dayVotes || {};
  const votedCount = alivePlayers.filter(p=>votes[p.id]).length;

  if(votedCount >= alivePlayers.length){
    // Claim resolution with atomic guard
    const claimUpd = {};
    claimUpd[`rooms/${roomCode}/game/voteResolved`] = true;
    await update(ref(db), claimUpd);
    // Re-read to confirm we're the one who set it (simple approach: just proceed)
    await resolveVote(freshRoom);
  }
};

async function resolveVote(room){
  const votes = room.game?.dayVotes || {};
  const players = room.players || {};

  // Tally votes (mayor = 2)
  const tally = {};
  Object.entries(votes).forEach(([vid, tid])=>{
    const w = players[vid]?.mayor ? 2 : 1;
    tally[tid] = (tally[tid]||0) + w;
  });

  if(!Object.keys(tally).length) { await switchPhase('night'); return; }

  const maxVotes = Math.max(...Object.values(tally));
  const top = Object.keys(tally).filter(id=>tally[id]===maxVotes);
  // Tiebreak: random
  const eliminated = top[Math.floor(Math.random()*top.length)];
  const p = players[eliminated];

  // Results log
  const summary = Object.entries(tally)
    .sort((a,b)=>b[1]-a[1])
    .map(([id,v])=>`${players[id]?.name||'?'} (${v})`)
    .join(', ');
  await pushLog(`üìä R√©sultats : ${summary}`, 'day');
  await pushLog(`‚öñÔ∏è ${p?.name} est √©limin√©(e) par le vote du village.`, 'death');

  // Clear votes
  await dbUpdate('rooms/'+roomCode+'/game', {dayVotes: null});

  // Kill or avocat protection
  if(p?.protected){
    await pushLog(`üõ°Ô∏è ${p.name} √©tait prot√©g√©(e) ‚Äî le vote n'a aucun effet !`, 'info');
    pushNarr({fire:'‚öñÔ∏è',color:'#c8a050',title:'Le Village a Vot√©',
      text:`La foule avait choisi. Mais au moment de la sentence, quelqu'un a brandi un acte de protection. ${p.name} reste en vie. Les visages se d√©composent.`});
  } else {
    pushNarr({fire:'‚öñÔ∏è',color:'#e0c070',title:'La Justice du Village',
      text:`Apr√®s les d√©bats et les accusations, le village a tranch√©. ${p?.name} ‚Äî les yeux cherchant encore un ami dans la foule ‚Äî est conduit vers sa derni√®re demeure. Avait-il tort de vous faire confiance ?`});
    await killPlayer(eliminated, 'vote');
  }

  // Transition to night
  await switchPhase('night');
}

async function wolfVoteModal(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup');
  const g = room.game;
  const myWolfVote = g?.wolfVotes?.[me.id];
  if(myWolfVote){
    const t = room.players?.[myWolfVote];
    openModal('üê∫ Cible d√©j√† d√©sign√©e',`<div style="text-align:center;padding:12px;color:var(--smoke);font-style:italic;">Vous avez d√©sign√© <strong style="color:#e07070">${t?.name||'?'}</strong> comme cible.</div>`);
    return;
  }
  openModal('üê∫ D√©signer la victime de la nuit',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">La cible avec le plus de votes sera tu√©e √† l'aube.</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._wolfVote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._wolfVote = async function(targetId){
  const room = await dbGet('rooms/'+roomCode);
  if(!room?.game || room.game.phase !== 'night') return;
  const voter = room.players?.[me.id];
  const target = room.players?.[targetId];
  if(!voter?.alive || !target?.alive) return;
  if(room.game.wolfVotes?.[me.id]) return;
  const upd = {};
  upd[`rooms/${roomCode}/game/wolfVotes/${me.id}`] = targetId;
  await update(ref(db), upd);
  // Also post in wolf chat so pack sees
  await dbSet('rooms/'+roomCode+'/wolfchat/'+Date.now()+'_v_'+me.id.substr(0,4),{
    id:me.id, name:me.name, avatar:me.avatar,
    text:`üó≥Ô∏è Je vote pour tuer ${target.avatar} ${target.name}.`, ts:Date.now()
  });
};

async function protectModal(room){
  const lastProtected = room.game?.lastProtected;
  const players = Object.values(room.players||{}).filter(p=>p.alive && p.id!==lastProtected);
  if(!players.length){
    openModal('üõ°Ô∏è','<p style="color:var(--smoke);font-style:italic;">Vous ne pouvez pas prot√©ger la m√™me personne deux nuits cons√©cutives.</p>');
    return;
  }
  const lastP = lastProtected ? Object.values(room.players||{}).find(p=>p.id===lastProtected) : null;
  openModal('üõ°Ô∏è Prot√©ger un joueur',
    (lastP?`<p style="font-size:.78rem;color:var(--smoke);margin-bottom:8px;font-style:italic;">‚ö†Ô∏è Vous ne pouvez pas prot√©ger ${esc(lastP.name)} deux nuits d'affil√©e.</p>`:'') +
    players.map(p=>`<button class="m-opt green" onclick="window._protect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function witchLifeModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('üß™','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† ressusciter.</p>');return;}
  openModal('üß™ Potion de Vie',
    players.map(p=>`<button class="m-opt" onclick="window._witchLife('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchLife = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`‚ú® Une main inconnue a arrach√© ${p.name} √† la mort cette nuit‚Ä¶`,'info');
};

async function witchDeathModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚ò†Ô∏è Potion de Mort',
    players.map(p=>`<button class="m-opt red" onclick="window._witchDeath('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchDeath = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:false});
  await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p){
    await pushLog(`üíÄ ${p.name} a √©t√© retrouv√©(e) sans vie cette nuit.`,'death');
    pushNarr({fire:'üß™',color:'#e07070',title:'Le Poison Frappe',text:`Dans le silence de la nuit, la Sorci√®re a lev√© son flacon de mort. ${p.name} n'a pas eu le temps de comprendre ce qui se passait. Le poison a fait son ≈ìuvre en quelques secondes.`});
    await checkVictory();
  }
};

async function godModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('‚ú®','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† sauver.</p>');return;}
  openModal('‚ú® Dieu du Village ‚Äî Annuler',
    players.map(p=>`<button class="m-opt" onclick="window._god('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._god = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{godUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`‚ú® Le Dieu du Village annule l'√©limination de ${p.name} !`,'info');
};

async function chronoAction(){
  const g=await dbGet('rooms/'+roomCode+'/game');
  await dbUpdate('rooms/'+roomCode+'/game',{turn:Math.max(1,(g?.turn||1)-1),chronoUsed:true});
  await pushLog('‚è≥ Une force myst√©rieuse semble avoir rembobin√© le temps‚Ä¶','chaos');
  pushNarr({fire:'‚è≥',color:'#a0c0ff',title:'Le Temps Rembobine',text:'Un frisson √©trange parcourt le village. Les ombres reculent. Quelques instants s\'effacent comme s\'ils n\'avaient jamais exist√©. Le Chronomancien sourit en rangeant son sablier.'});
}

async function necroModal(room){
  const dead=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!dead.length){openModal('üíÄ','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† consulter.</p>');return;}
  const rand=dead[Math.floor(Math.random()*dead.length)];
  const rd=ALL_ROLES[rand.role];
  openModal('üíÄ Vision du N√©cromancien',`<div style="text-align:center;padding:16px;">
    <div style="font-size:2rem;margin-bottom:8px;">üíÄ</div>
    <div style="font-style:italic;color:var(--smoke);font-size:.88rem;line-height:1.6;">
      L'esprit de ${esc(rand.name)} murmure‚Ä¶<br>
      <em>"Je faisais partie du camp : ${rd?.camp==='loup'?'‚öîÔ∏è Loups':rd?.camp==='village'?'üåæ Village':'üé≠ Neutre'}"</em>
    </div>
  </div>`);
}

// Cupidon ‚Äî 2-step: pick lover A then lover B
let cupidonFirstChoice = null;
async function cupidonModal(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  if(cupidonFirstChoice){
    const first = room.players?.[cupidonFirstChoice];
    openModal('üíò Cupidon ‚Äî 2√®me Amoureux',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Premier amoureux : <strong style="color:var(--moon)">${first?.name||'?'}</strong><br>Choisissez maintenant le second !</p>`+
      players.filter(p=>p.id!==cupidonFirstChoice)
        .map(p=>`<button class="m-opt green" onclick="window._cupidonLink('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  } else {
    openModal('üíò Cupidon ‚Äî 1er Amoureux',
      `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Choisissez le premier amoureux. Vous choisirez ensuite le second.</p>`+
      players.map(p=>`<button class="m-opt green" onclick="window._cupidonFirst('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
    );
  }
}
window._cupidonFirst = function(id){
  cupidonFirstChoice = id;
  // Reopen modal for second choice
  dbGet('rooms/'+roomCode).then(room=>cupidonModal(room));
};
window._cupidonLink = async function(secondId){
  const firstId = cupidonFirstChoice;
  cupidonFirstChoice = null;
  const room = await dbGet('rooms/'+roomCode);
  const a = room?.players?.[firstId];
  const b = room?.players?.[secondId];
  if(!a||!b) return;
  const upd = {};
  upd['rooms/'+roomCode+'/players/'+firstId+'/lovers'] = true;
  upd['rooms/'+roomCode+'/players/'+secondId+'/lovers'] = true;
  upd['rooms/'+roomCode+'/game/loversA'] = firstId;
  upd['rooms/'+roomCode+'/game/loversB'] = secondId;
  upd['rooms/'+roomCode+'/game/cupidonDone'] = true;
  await update(ref(db), upd);
  pushNarr({fire:'üíò',color:'#f48fb1',title:'Les Amoureux sont Li√©s',
    text:`Dans le secret de la nuit, Cupidon a tendu son arc. ${a.name} et ${b.name} sont d√©sormais li√©s par un fil invisible. Si l'un meurt, l'autre suivra. Pour le meilleur et pour le pire.`});
};

// ================================================================
// CHAT
// ================================================================
window.sendChat = async function(){
  const inp=document.getElementById('chat-in');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  const ts=Date.now();
  const room=await dbGet('rooms/'+roomCode);
  const myP=room?.players?.[me.id];
  await dbSet('rooms/'+roomCode+'/chat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts, dead:myP?!myP.alive:false
  });
};

function renderChat(room){
  // Merge chat messages and log entries, sorted by timestamp
  const msgs = room.chat ? Object.values(room.chat).sort((a,b)=>a.ts-b.ts) : [];
  const logs = room.log ? Object.values(room.log).sort((a,b)=>a.ts-b.ts) : [];

  const total = msgs.length + logs.length;
  if(total===chatRendered) return;
  chatRendered=total;

  const c=document.getElementById('chat-msgs');
  c.innerHTML='';

  // Merge and sort all entries
  const all = [
    ...msgs.map(m=>({...m,_type:'chat'})),
    ...logs.map(l=>({...l,_type:'log'}))
  ].sort((a,b)=>a.ts-b.ts);

  all.forEach(m=>{
    const d=document.createElement('div');
    if(m._type==='log'){
      d.className=`c-msg sys ${m.type||''}`;
      d.textContent=m.text;
    } else {
      const isMe=m.id===me.id;
      d.className='c-msg';
      d.innerHTML=`<span class="c-author ${m.dead?'dead':''} ${isMe?'me-author':''}">${m.avatar} ${esc(m.name)}: </span><span class="c-text">${esc(m.text)}</span>`;
    }
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

// ================================================================
// LOG
// ================================================================
async function pushLog(text, type='system'){
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/log/'+ts+'_'+Math.random().toString(36).substr(2,4),{text,type,ts});
}

function checkNewLogNarr(room){
  const logs = room.log ? Object.values(room.log).sort((a,b)=>a.ts-b.ts) : [];
  if(logs.length<=lastSeenLogLen){return;}
  lastSeenLogLen=logs.length;
}

// ================================================================
// VICTORY
// ================================================================
async function checkVictory(){
  const room=await dbGet('rooms/'+roomCode);
  if(!room||!room.game||room.game.victory||room.status==='ended') return;
  const players=Object.values(room.players||{});
  const alive=players.filter(p=>p.alive);
  const aliveLoup=alive.filter(p=>ALL_ROLES[p.role]?.camp==='loup');
  const aliveVillage=alive.filter(p=>ALL_ROLES[p.role]?.camp==='village');
  const g=room.game;

  let victory=null;
  if(alive.length===0){
    victory={type:'chaos',title:'üíÄ Personne ne survit',desc:'Le village s\'est auto-d√©truit. Ni loups ni villageois.',survivors:[],color:'#888888'};
  } else if(alive.length===2&&alive[0].lovers&&alive[1].lovers){
    victory={type:'lovers',title:'‚ù§Ô∏è Les Amoureux Gagnent !',desc:`Ni le village ni les loups n'ont pu les s√©parer. Leur amour interdit a r√©√©crit la l√©gende.`,survivors:alive,color:'#f48fb1'};
    pushNarr({fire:'‚ù§Ô∏è',color:'#f48fb1',title:'L\'Amour Triomphe',text:`Ils se sont battus contre tous. ${alive[0].name} et ${alive[1].name} survivent ensemble dans un monde qui les a combattus. Leur amour a vaincu les loups et le village.`});
  } else if(alive.length===1&&alive[0].role==='Loup Blanc'){
    victory={type:'white',title:'ü§ç Le Loup Blanc Triomphe',desc:'Il a trahi tout le monde pour finir seul en vie.',survivors:alive,color:'#e0e0e0'};
    pushNarr({fire:'ü§ç',color:'#e0e0e0',title:'Seul Survivant',text:`${alive[0].name} a tout planifi√© depuis le d√©but. Loup parmi les loups, il a attendu le bon moment pour trahir tout le monde. Ce soir, il reste seul debout.`});
  } else if(aliveLoup.length===0&&aliveVillage.length>0){
    victory={type:'village',title:'üåæ Le Village est Sauv√© !',desc:'Chaque loup a √©t√© d√©masqu√©. Ce soir, les enfants dormiront sans peur.',survivors:alive,color:'#70d090'};
    pushNarr({fire:'üåæ',color:'#70d090',title:'La Lumi√®re Triomphe',text:'Contre toute attente, les villageois ont trouv√© la v√©rit√©. Chaque loup d√©masqu√©, chaque mensonge perc√© √† jour. Ce soir, pour la premi√®re fois depuis des semaines, on peut dormir en paix.'});
  } else if(aliveLoup.length>=aliveVillage.length){
    victory={type:'wolf',title:'üê∫ Les Loups Triomphent !',desc:'Nuit apr√®s nuit, ils ont √©limin√© patiemment. La nuit ne finira jamais.',survivors:alive,color:'#e07070'};
    pushNarr({fire:'üê∫',color:'#e07070',title:'La Nuit √âternelle',text:'Ils ont gagn√© m√©thodiquement, nuit apr√®s nuit. Les villageois se sont querell√©s et tromp√©s les uns les autres. √Ä l\'aube, il ne reste que des loups sous peau humaine.'});
  }

  if(victory){
    await dbUpdate('rooms/'+roomCode,{status:'ended','game/victory':victory});
    await pushLog(`üèÜ FIN : ${victory.title}`,'system');
  }
}

function showVictory(v){
  showScreen('victory');
  const icons={wolf:'üê∫',village:'üåæ',lovers:'‚ù§Ô∏è',white:'ü§ç',chaos:'üíÄ'};
  document.getElementById('v-icon').textContent=icons[v.type]||'üèÜ';
  document.getElementById('v-title').textContent=v.title;
  document.getElementById('v-title').style.color=v.color;
  document.getElementById('v-desc').textContent=v.desc;
  const s=document.getElementById('v-surv');
  if(v.survivors?.length){
    s.innerHTML='<div style="font-family:\'Cinzel Decorative\',serif;font-size:.72rem;color:var(--smoke);margin-bottom:10px;text-transform:uppercase;letter-spacing:.1em;">Survivants</div>'+
      v.survivors.map(p=>`<div class="surv-row"><span style="font-size:1.4rem;">${p.avatar}</span><span>${esc(p.name)}</span><span style="color:var(--smoke);font-size:.8rem;font-style:italic;margin-left:auto;">${ALL_ROLES[p.role]?.emoji||''} ${p.role}</span></div>`).join('');
  } else {
    s.innerHTML='<div style="color:var(--smoke);font-style:italic;">Aucun survivant</div>';
  }
}

window.backToWelcome = function(){
  if(unsubRoom) unsubRoom();
  if(timerInterval) clearInterval(timerInterval);
  chatRendered=0; wolfChatRendered=0; lastSeenLogLen=0; lastSeenNarrLen=0; narrQueue=[]; narrActive=false; shownDawnTurns=new Set();
  selectedRoles=new Set(['Loup-Garou','Villageois','Voyante']);
  showScreen('welcome');
};

// ================================================================
// NARRATIVE ‚Äî shared via Firebase
// ================================================================
function queueNarr(n){narrQueue.push(n);if(!narrActive)showNextNarr();}
async function pushNarr(n){
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/narr/'+ts+'_'+Math.random().toString(36).substr(2,4), {...n, ts});
}
function checkNewNarr(room){
  const narrs = room.narr ? Object.values(room.narr).sort((a,b)=>a.ts-b.ts) : [];
  if(narrs.length<=lastSeenNarrLen){return;}
  // Show all new narrations
  for(let i=lastSeenNarrLen;i<narrs.length;i++) queueNarr(narrs[i]);
  lastSeenNarrLen=narrs.length;
}
function showNextNarr(){
  if(!narrQueue.length){narrActive=false;return;}
  narrActive=true;
  const n=narrQueue.shift();
  const ov=document.getElementById('narr');
  document.getElementById('n-fire').textContent=n.fire||'üî•';
  document.getElementById('n-title').textContent=n.title;
  document.getElementById('n-title').style.color=n.color||'var(--moon)';
  document.getElementById('n-text').textContent=n.text;
  // Reset animations
  ['n-title','n-text'].forEach(id=>{const el=document.getElementById(id);el.style.animation='none';void el.offsetWidth;el.style.animation='';});
  const btn=ov.querySelector('.narr-btn');
  btn.style.animation='none';void btn.offsetWidth;btn.style.animation='';
  ov.classList.add('show');
}
window.closeNarr = function(){document.getElementById('narr').classList.remove('show');setTimeout(showNextNarr,400);};

// ================================================================
// MODAL
// ================================================================
window.openModal = function(title,body){
  document.getElementById('m-title').textContent=title;
  document.getElementById('m-body').innerHTML=`<div class="m-opts">${body}</div>`;
  document.getElementById('modal-ov').classList.add('open');
};
window.closeModal = function(){document.getElementById('modal-ov').classList.remove('open');};
document.getElementById('modal-ov').addEventListener('click',e=>{if(e.target===document.getElementById('modal-ov'))closeModal();});

</script>
</body>
</html>
