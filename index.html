<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üê∫ Loup-Garou</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">



<style>
:root {
  --blood: #7a1212;
  --blood2: #b02020;
  --ember: #c87941;
  --ember2: #e8a060;
  --moon: #e8d5a3;
  --moon2: #c4aa70;
  --smoke: #8a8070;
  --dark: #080810;
  --dark2: #100f18;
  --dark3: #181828;
  --dark4: #201f32;
  --wolf-clr: #c04040;
  --village-clr: #3a8a5a;
  --neutral-clr: #7a50b0;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--dark);color:var(--moon);font-family:'EB Garamond',Georgia,serif;font-size:16px;overflow-x:hidden;min-height:100vh;}

/* Stars */
.bg-stars{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(1px 1px at 8% 12%,rgba(232,213,163,.7) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 22% 5%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 38% 18%,rgba(232,213,163,.8) 0%,transparent 100%),
  radial-gradient(1px 1px at 55% 8%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 72% 15%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 88% 4%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 15% 35%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 45% 42%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1.5px 1.5px at 65% 30%,rgba(232,213,163,.6) 0%,transparent 100%),
  radial-gradient(1px 1px at 92% 28%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 30% 60%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 78% 55%,rgba(232,213,163,.4) 0%,transparent 100%),
  radial-gradient(1px 1px at 5% 75%,rgba(232,213,163,.5) 0%,transparent 100%),
  radial-gradient(1px 1px at 50% 72%,rgba(232,213,163,.3) 0%,transparent 100%),
  radial-gradient(1px 1px at 95% 68%,rgba(232,213,163,.4) 0%,transparent 100%);}
.bg-fog{position:fixed;inset:0;z-index:0;pointer-events:none;background:
  radial-gradient(ellipse at 15% 90%,rgba(200,121,65,.06) 0%,transparent 50%),
  radial-gradient(ellipse at 85% 85%,rgba(122,18,18,.08) 0%,transparent 50%),
  radial-gradient(ellipse at 50% 100%,rgba(30,25,15,.4) 0%,transparent 40%);}

/* SCREENS */
#app{position:relative;z-index:1;}
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* WELCOME */
#welcome-screen{align-items:center;justify-content:center;padding:40px 20px;text-align:center;}
.welcome-moon{font-size:5rem;margin-bottom:16px;animation:moonFloat 4s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(232,213,163,.4));}
@keyframes moonFloat{0%,100%{transform:translateY(0) rotate(-5deg);}50%{transform:translateY(-12px) rotate(5deg);}}
.welcome-title{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,8vw,4rem);text-shadow:0 0 40px rgba(232,213,163,.3),0 0 80px rgba(122,18,18,.4);letter-spacing:.05em;margin-bottom:8px;}
.welcome-sub{font-style:italic;color:var(--moon2);font-size:1.1rem;margin-bottom:40px;opacity:.8;}
.welcome-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:680px;}
.w-card{flex:1;min-width:250px;background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:16px;padding:28px 22px;cursor:pointer;transition:all .3s;}
.w-card:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.4);}
.w-card.red:hover{border-color:var(--blood2);box-shadow:0 16px 40px rgba(122,18,18,.25);}
.w-card.green:hover{border-color:#3a8a5a;box-shadow:0 16px 40px rgba(45,122,74,.2);}
.w-card-icon{font-size:2.5rem;margin-bottom:12px;}
.w-card-title{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:8px;}
.w-card-desc{font-size:.88rem;color:var(--smoke);font-style:italic;line-height:1.5;}

/* FORMS */
.form-screen{align-items:center;justify-content:center;padding:40px 20px;}
.form-box{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.15);border-radius:20px;padding:32px 28px;width:100%;max-width:420px;position:relative;}
.form-title{font-family:'Cinzel Decorative',serif;font-size:1.2rem;text-align:center;margin-bottom:22px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:.88rem;color:var(--moon2);margin-bottom:5px;}
.field input{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:8px;color:var(--moon);font-family:'EB Garamond',serif;font-size:1.05rem;padding:10px 14px;outline:none;transition:border-color .2s;}
.field input:focus{border-color:rgba(232,213,163,.45);}
.code-input{text-align:center!important;letter-spacing:.2em!important;font-size:1.5rem!important;font-family:'Cinzel Decorative',serif!important;}
.back-btn{position:absolute;top:14px;left:14px;background:none;border:none;color:var(--smoke);cursor:pointer;font-size:1.1rem;transition:color .2s;}
.back-btn:hover{color:var(--moon);}
.btn-primary{display:block;width:100%;background:linear-gradient(135deg,var(--blood),#500a0a);border:1px solid rgba(176,32,32,.5);color:var(--moon);font-family:'Cinzel Decorative',serif;font-size:.95rem;letter-spacing:.06em;padding:13px;border-radius:10px;cursor:pointer;transition:all .3s;margin-top:8px;box-shadow:0 4px 20px rgba(122,18,18,.3);}
.btn-primary:hover{background:linear-gradient(135deg,var(--blood2),var(--blood));box-shadow:0 6px 30px rgba(122,18,18,.5);transform:translateY(-1px);}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-sec{display:block;width:100%;background:transparent;border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:1rem;padding:10px;border-radius:8px;cursor:pointer;transition:all .2s;margin-top:8px;}
.btn-sec:hover{border-color:rgba(232,213,163,.4);color:var(--moon);}
.err-msg{color:#e07070;font-size:.85rem;text-align:center;padding:6px 0;min-height:24px;}
.ok-msg{color:#70d090;font-size:.85rem;text-align:center;padding:6px 0;}

/* AVATAR PICKER */
.avatar-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:4px;}
.av-btn{background:none;border:2px solid rgba(232,213,163,.1);border-radius:8px;padding:4px 6px;font-size:1.3rem;cursor:pointer;transition:all .2s;}
.av-btn.selected{border-color:rgba(232,213,163,.55);background:rgba(232,213,163,.08);}

/* LOBBY */
#lobby-screen{padding:20px;max-width:700px;margin:0 auto;width:100%;}
.lobby-head{text-align:center;padding:20px 0 24px;}
.lobby-code{font-family:'Cinzel Decorative',serif;font-size:2.4rem;letter-spacing:.18em;color:var(--ember2);text-shadow:0 0 30px rgba(200,121,65,.4);margin-bottom:8px;}
.lobby-lbl{font-size:.84rem;color:var(--smoke);font-style:italic;}
.copy-btn{background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.18);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.84rem;padding:5px 14px;border-radius:20px;cursor:pointer;transition:all .2s;margin-top:8px;}
.copy-btn:hover{background:rgba(232,213,163,.16);color:var(--moon);}
.lobby-players{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin:16px 0;}
.lp-tile{background:var(--dark3);border:1px solid rgba(232,213,163,.1);border-radius:10px;padding:14px 10px;text-align:center;animation:tileIn .4s ease;}
@keyframes tileIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
.lp-tile.host{border-color:rgba(200,121,65,.4);}
.lp-av{font-size:2rem;margin-bottom:5px;}
.lp-name{font-size:.84rem;}
.lp-badge{font-size:.7rem;color:var(--ember);font-style:italic;margin-top:2px;}
.lobby-waiting{font-style:italic;color:var(--smoke);text-align:center;padding:20px;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.5}50%{opacity:1}}
.panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.1);border-radius:14px;padding:18px;position:relative;overflow:hidden;margin-bottom:14px;}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(232,213,163,.2),transparent);}
.p-title{font-family:'Cinzel Decorative',serif;font-size:.72rem;letter-spacing:.14em;color:var(--moon2);margin-bottom:12px;text-transform:uppercase;}
.roles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:7px;max-height:260px;overflow-y:auto;}
.role-tog{background:rgba(255,255,255,.03);border:1px solid rgba(232,213,163,.1);border-radius:8px;padding:7px 5px;cursor:pointer;transition:all .2s;text-align:center;font-size:.77rem;}
.role-tog:hover{border-color:rgba(232,213,163,.3);}
.role-tog.on{border-color:rgba(232,213,163,.45);background:rgba(232,213,163,.07);}
.role-tog.on.loup{border-color:var(--blood2);background:rgba(122,18,18,.15);}
.role-tog.on.village{border-color:#4a9a5a;background:rgba(45,122,74,.12);}
.role-tog.on.neutre{border-color:#8a60c0;background:rgba(106,64,160,.15);}
.r-em{font-size:1.25rem;display:block;margin-bottom:3px;}
.dur-row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;}
.dur-field{display:flex;flex-direction:column;gap:4px;}
.dur-field label{font-size:.78rem;color:var(--smoke);}
.dur-field input{width:80px;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.18);border-radius:6px;color:var(--moon);font-family:inherit;font-size:.95rem;padding:7px 10px;outline:none;}

/* GAME */
#game-screen{padding:14px;max-width:960px;margin:0 auto;width:100%;}
.phase-bar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,var(--dark3),var(--dark4));border:1px solid rgba(232,213,163,.1);border-radius:14px;padding:13px 18px;margin-bottom:13px;}
.ph-left{display:flex;align-items:center;gap:12px;}
.ph-icon{font-size:1.9rem;filter:drop-shadow(0 0 8px rgba(232,213,163,.3));}
.ph-name{font-family:'Cinzel Decorative',serif;font-size:.95rem;}
.ph-desc{font-size:.8rem;color:var(--smoke);font-style:italic;}
.ph-timer{font-family:'Cinzel Decorative',serif;font-size:1.8rem;color:var(--ember2);text-shadow:0 0 20px rgba(200,121,65,.4);min-width:58px;text-align:right;transition:color .3s;}
.ph-timer.urgent{color:var(--blood2);text-shadow:0 0 20px rgba(176,32,32,.6);animation:urgPulse .5s ease-in-out infinite;}
@keyframes urgPulse{0%,100%{opacity:1}50%{opacity:.55}}
.game-cols{display:grid;grid-template-columns:1fr 270px;gap:13px;}
@media(max-width:700px){.game-cols{grid-template-columns:1fr;}}
.game-main{display:flex;flex-direction:column;gap:12px;}
.my-role-card{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.15);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;}
.role-emoji-big{font-size:2.6rem;}
.role-name{font-family:'Cinzel Decorative',serif;font-size:.9rem;margin-bottom:3px;}
.role-camp{font-size:.76rem;font-style:italic;margin-bottom:3px;}
.role-camp.loup{color:var(--wolf-clr);}
.role-camp.village{color:var(--village-clr);}
.role-camp.neutre{color:var(--neutral-clr);}
.role-desc-txt{font-size:.8rem;color:var(--smoke);line-height:1.4;}
.players-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:9px;}
.p-tile{background:var(--dark3);border:1px solid rgba(232,213,163,.1);border-radius:10px;padding:10px 8px;text-align:center;position:relative;cursor:pointer;transition:all .25s;}
.p-tile:hover{border-color:rgba(232,213,163,.3);transform:translateY(-2px);}
.p-tile.dead{opacity:.22;filter:grayscale(1);pointer-events:none;}
.p-tile.me{border-color:rgba(232,213,163,.35);background:rgba(232,213,163,.05);}
.p-tile.mayor::after{content:'üëë';position:absolute;top:-6px;right:-4px;font-size:.85rem;}
.p-tile.protected{border-color:rgba(100,200,100,.45);box-shadow:0 0 10px rgba(100,200,100,.15);}
.p-tile.lover::before{content:'‚ù§Ô∏è';position:absolute;top:-6px;left:-4px;font-size:.72rem;}
.t-av{font-size:1.55rem;margin-bottom:3px;}
.t-name{font-size:.77rem;line-height:1.2;}
.t-role{font-size:.67rem;color:var(--smoke);font-style:italic;margin-top:2px;}
.actions-panel{background:var(--dark3);border:1px solid rgba(232,213,163,.1);border-radius:12px;padding:13px;}
.a-title{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.12em;color:var(--smoke);margin-bottom:9px;text-transform:uppercase;}
.a-btns{display:flex;flex-wrap:wrap;gap:7px;}
.a-btn{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.12);color:var(--moon);font-family:'EB Garamond',serif;font-size:.86rem;padding:7px 12px;border-radius:7px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;}
.a-btn:hover{background:rgba(232,213,163,.08);border-color:rgba(232,213,163,.3);}
.a-btn.red{border-color:rgba(122,18,18,.35);}
.a-btn.red:hover{background:rgba(122,18,18,.2);border-color:var(--blood2);}
.a-btn.purple{border-color:rgba(140,80,200,.3);}
.a-btn.purple:hover{background:rgba(140,80,200,.1);}
.game-side{display:flex;flex-direction:column;gap:12px;}
.event-card{background:linear-gradient(135deg,rgba(70,35,110,.35),rgba(35,15,55,.45));border:1px solid rgba(156,100,220,.3);border-radius:12px;padding:15px;text-align:center;animation:evGlow 2s ease-in-out infinite;}
@keyframes evGlow{0%,100%{box-shadow:0 0 12px rgba(156,100,220,.2);}50%{box-shadow:0 0 28px rgba(156,100,220,.4);}}
.ev-big{font-size:1.9rem;margin-bottom:6px;}
.ev-title{font-family:'Cinzel Decorative',serif;font-size:.8rem;color:#c0a0ff;margin-bottom:4px;}
.ev-desc{font-size:.77rem;color:var(--smoke);font-style:italic;line-height:1.4;}
.master-panel{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(200,121,65,.2);border-radius:12px;padding:13px;}
.m-title{font-family:'Cinzel Decorative',serif;font-size:.7rem;letter-spacing:.12em;color:var(--ember);margin-bottom:9px;text-transform:uppercase;}
.m-btns{display:flex;flex-direction:column;gap:6px;}
.m-btn{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.1);color:var(--moon);font-family:'EB Garamond',serif;font-size:.86rem;padding:7px 12px;border-radius:8px;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;gap:7px;}
.m-btn:hover{background:rgba(232,213,163,.07);border-color:rgba(232,213,163,.28);}
.m-btn.kill{border-color:rgba(122,18,18,.3);}
.m-btn.kill:hover{background:rgba(122,18,18,.2);border-color:var(--blood2);}
.chat-panel{background:var(--dark2);border:1px solid rgba(232,213,163,.09);border-radius:12px;display:flex;flex-direction:column;min-height:180px;max-height:300px;}
.chat-head{font-family:'Cinzel Decorative',serif;font-size:.68rem;letter-spacing:.12em;color:var(--smoke);padding:11px 13px 8px;border-bottom:1px solid rgba(232,213,163,.07);text-transform:uppercase;}
.chat-msgs{flex:1;overflow-y:auto;padding:9px 12px;display:flex;flex-direction:column;gap:5px;}
.c-msg{font-size:.83rem;line-height:1.4;}
.c-msg .c-author{font-weight:600;color:var(--ember2);}
.c-msg .c-author.dead{color:var(--smoke);text-decoration:line-through;}
.c-msg .c-author.me-author{color:var(--moon);}
.c-msg .c-text{color:var(--moon2);}
.c-msg.sys{font-style:italic;color:var(--smoke);font-size:.78rem;}
.chat-row{display:flex;gap:7px;padding:9px 12px;border-top:1px solid rgba(232,213,163,.07);}
.chat-inp{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(232,213,163,.14);border-radius:6px;color:var(--moon);font-family:'EB Garamond',serif;font-size:.88rem;padding:7px 10px;outline:none;transition:border-color .2s;}
.chat-inp:focus{border-color:rgba(232,213,163,.34);}
.chat-send{background:rgba(122,18,18,.4);border:1px solid rgba(176,32,32,.4);color:var(--moon);border-radius:6px;padding:7px 12px;cursor:pointer;font-size:.84rem;transition:all .2s;}
.chat-send:hover{background:rgba(122,18,18,.7);}
.dead-zone{padding:8px 12px;background:rgba(0,0,0,.2);border-radius:8px;margin-top:6px;}
.dead-zone-lbl{font-size:.71rem;color:var(--smoke);font-style:italic;margin-bottom:5px;}
.dead-chips{display:flex;flex-wrap:wrap;gap:5px;}
.dead-chip{font-size:.77rem;color:var(--smoke);text-decoration:line-through;padding:2px 8px;background:rgba(255,255,255,.03);border-radius:10px;}

/* NARRATIVE */
#narr{position:fixed;inset:0;z-index:200;background:rgba(4,4,12,.93);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .6s;}
#narr.show{opacity:1;pointer-events:all;}
.narr-inner{max-width:540px;width:90%;text-align:center;padding:20px;}
.narr-fire{font-size:3.5rem;margin-bottom:14px;animation:fireFlick 1.2s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(255,107,0,.6));}
@keyframes fireFlick{0%,100%{transform:scaleY(1) rotate(-3deg);}25%{transform:scaleY(1.08) rotate(2deg);}50%{transform:scaleY(.94) rotate(-1deg);}75%{transform:scaleY(1.05) rotate(3deg);}}
.narr-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.3rem,4vw,1.9rem);margin-bottom:13px;opacity:0;animation:fadeUp .8s ease .1s forwards;}
.narr-text{font-style:italic;font-size:clamp(.95rem,2.5vw,1.15rem);color:var(--moon2);line-height:1.75;opacity:0;animation:fadeUp .8s ease .4s forwards;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.narr-btn{margin-top:26px;display:inline-block;background:rgba(232,213,163,.08);border:1px solid rgba(232,213,163,.2);color:var(--moon2);font-family:'EB Garamond',serif;font-size:.9rem;padding:10px 28px;border-radius:8px;cursor:pointer;transition:all .2s;opacity:0;animation:fadeUp .8s ease .8s forwards;}
.narr-btn:hover{background:rgba(232,213,163,.18);color:var(--moon);}

/* MODAL */
#modal-ov{position:fixed;inset:0;z-index:150;background:rgba(0,0,0,.77);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;}
#modal-ov.open{display:flex;}
.modal{background:linear-gradient(135deg,var(--dark3),var(--dark2));border:1px solid rgba(232,213,163,.18);border-radius:16px;padding:24px;width:90%;max-width:380px;animation:fadeUp .2s ease;}
.modal h3{font-family:'Cinzel Decorative',serif;font-size:.95rem;margin-bottom:12px;}
.m-close{float:right;background:none;border:none;color:var(--smoke);font-size:1.2rem;cursor:pointer;margin-top:-3px;}
.m-opts{display:flex;flex-direction:column;gap:7px;margin-top:10px;}
.m-opt{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);color:var(--moon);font-family:'EB Garamond',serif;font-size:.93rem;padding:10px 13px;border-radius:8px;cursor:pointer;text-align:left;transition:all .2s;display:flex;align-items:center;gap:8px;}
.m-opt:hover{background:rgba(232,213,163,.08);border-color:rgba(232,213,163,.28);}
.m-opt.red:hover{background:rgba(122,18,18,.2);border-color:var(--blood2);}

/* VICTORY */
#victory-screen{align-items:center;justify-content:center;text-align:center;padding:40px 20px;}
.v-icon{font-size:5rem;margin-bottom:14px;animation:vBounce 1s ease infinite;}
@keyframes vBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
.v-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.8rem,6vw,3rem);margin-bottom:12px;animation:glow 2s ease-in-out infinite;}
@keyframes glow{0%,100%{text-shadow:0 0 20px currentColor}50%{text-shadow:0 0 60px currentColor,0 0 100px currentColor}}
.v-desc{font-style:italic;font-size:1.1rem;color:var(--moon2);max-width:480px;line-height:1.6;margin-bottom:24px;}
.v-surv{background:rgba(255,255,255,.04);border:1px solid rgba(232,213,163,.11);border-radius:12px;padding:18px;max-width:380px;width:100%;margin-bottom:22px;}
.surv-row{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:.93rem;}
.surv-row+.surv-row{border-top:1px solid rgba(232,213,163,.07);}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(232,213,163,.18);border-radius:3px;}
.spinner{width:34px;height:34px;border:3px solid rgba(232,213,163,.12);border-top-color:var(--moon2);border-radius:50%;animation:spin .8s linear infinite;margin:18px auto;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="bg-stars"></div>
<div class="bg-fog"></div>
<div id="app">

<!-- WELCOME -->
<div id="welcome-screen" class="screen active">
  <div class="welcome-moon">üåï</div>
  <div class="welcome-title">Loup-Garou</div>
  <div class="welcome-sub">Chaque nuit, le village tremble‚Ä¶</div>
  <div class="welcome-cards">
    <div class="w-card red" onclick="showScreen('create')">
      <div class="w-card-icon">üî•</div>
      <div class="w-card-title">Cr√©er une Partie</div>
      <div class="w-card-desc">Configurez les r√¥les et invitez vos amis avec un code √† 6 chiffres.</div>
    </div>
    <div class="w-card green" onclick="showScreen('join')">
      <div class="w-card-icon">üåô</div>
      <div class="w-card-title">Rejoindre une Partie</div>
      <div class="w-card-desc">Entrez le code partag√© par l'h√¥te pour rejoindre la nuit.</div>
    </div>
  </div>
</div>

<!-- CREATE -->
<div id="create-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üî• Nouvelle Partie</div>
    <div class="field"><label>Votre nom</label><input id="c-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-create"></div></div>
    <button class="btn-primary" onclick="createGame()">üåô Cr√©er la Partie</button>
    <div id="c-err" class="err-msg"></div>
  </div>
</div>

<!-- JOIN -->
<div id="join-screen" class="screen form-screen">
  <div class="form-box">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê</button>
    <div class="form-title">üåô Rejoindre</div>
    <div class="field"><label>Code de la partie (6 chiffres)</label><input id="j-code" class="code-input" placeholder="000000" maxlength="6" autocomplete="off" inputmode="numeric"></div>
    <div class="field"><label>Votre nom</label><input id="j-name" placeholder="Votre pr√©nom..." maxlength="18" autocomplete="off"></div>
    <div class="field"><label>Avatar</label><div class="avatar-grid" id="av-join"></div></div>
    <button class="btn-primary" onclick="joinGame()">üêæ Rejoindre</button>
    <div id="j-err" class="err-msg"></div>
  </div>
</div>

<!-- LOBBY -->
<div id="lobby-screen" class="screen">
  <div class="lobby-head">
    <div class="lobby-lbl">Partagez ce code avec vos amis !</div>
    <div class="lobby-code" id="lobby-code">------</div>
    <button class="copy-btn" onclick="copyCode()">üìã Copier le code</button>
    <div class="lobby-lbl" style="margin-top:8px;" id="lobby-lbl">En attente‚Ä¶</div>
  </div>
  <div id="host-setup"></div>
  <div class="lobby-players" id="lobby-players"></div>
  <div class="lobby-waiting" id="lobby-wait">‚è≥ En attente que l'h√¥te lance la partie‚Ä¶</div>
  <div id="lobby-launch" style="display:none;max-width:380px;margin:0 auto;">
    <button class="btn-primary" onclick="launchGame()">üê∫ Lancer la Partie</button>
    <div id="launch-err" class="err-msg"></div>
  </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="phase-bar">
    <div class="ph-left">
      <div class="ph-icon" id="ph-icon">üåë</div>
      <div>
        <div class="ph-name" id="ph-name">Nuit 1</div>
        <div class="ph-desc" id="ph-desc">Les cr√©atures s'√©veillent‚Ä¶</div>
      </div>
    </div>
    <div class="ph-timer" id="ph-timer">--</div>
  </div>
  <div class="game-cols">
    <div class="game-main">
      <div class="my-role-card" id="my-role-card">
        <div class="role-emoji-big" id="r-em">‚ùì</div>
        <div>
          <div class="role-name" id="r-name">R√¥le secret</div>
          <div class="role-camp" id="r-camp"></div>
          <div class="role-desc-txt" id="r-desc"></div>
        </div>
      </div>
      <div class="panel">
        <div class="p-title">üë• Joueurs</div>
        <div class="players-grid" id="g-players"></div>
        <div class="dead-zone" id="dead-zone" style="display:none;">
          <div class="dead-zone-lbl">‚ö∞Ô∏è √âlimin√©s</div>
          <div class="dead-chips" id="dead-chips"></div>
        </div>
      </div>
      <div class="actions-panel">
        <div class="a-title">‚ö° Vos Actions</div>
        <div class="a-btns" id="a-btns"></div>
      </div>
    </div>
    <div class="game-side">
      <div class="event-card" id="ev-card" style="display:none;"></div>
      <div class="master-panel" id="master-panel" style="display:none;">
        <div class="m-title">üéÆ Ma√Ætre du Jeu</div>
        <div class="m-btns" id="m-btns"></div>
      </div>
      <div class="chat-panel">
        <div class="chat-head">üí¨ Discussion</div>
        <div class="chat-msgs" id="chat-msgs"></div>
        <div class="chat-row">
          <input class="chat-inp" id="chat-in" placeholder="Votre message‚Ä¶" maxlength="200" autocomplete="off">
          <button class="chat-send" onclick="sendChat()">‚Üë</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VICTORY -->
<div id="victory-screen" class="screen">
  <div class="v-icon" id="v-icon">üèÜ</div>
  <div class="v-title" id="v-title"></div>
  <div class="v-desc" id="v-desc"></div>
  <div class="v-surv" id="v-surv"></div>
  <button class="btn-primary" style="max-width:300px;" onclick="backToWelcome()">üîÑ Nouvelle Partie</button>
</div>
</div><!-- #app -->

<!-- NARRATIVE -->
<div id="narr">
  <div class="narr-inner">
    <div class="narr-fire" id="n-fire">üî•</div>
    <div class="narr-title" id="n-title"></div>
    <div class="narr-text" id="n-text"></div>
    <button class="narr-btn" onclick="closeNarr()">Continuer‚Ä¶</button>
  </div>
</div>

<!-- MODAL -->
<div id="modal-ov">
  <div class="modal">
    <button class="m-close" onclick="closeModal()">‚úï</button>
    <h3 id="m-title">Action</h3>
    <div id="m-body"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ================================================================
// üî• REMPLACEZ LES VALEURS CI-DESSOUS PAR VOTRE CONFIG FIREBASE
// ================================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyDkLxCZApo145b2XWwKlc-lQzBh1MtpqH4",
  authDomain:        "projet-loup-garou.firebaseapp.com",
  databaseURL:       "https://projet-loup-garou-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:         "projet-loup-garou",
  storageBucket:     "projet-loup-garou.firebasestorage.app",
  messagingSenderId: "811973035375",
  appId:             "1:811973035375:web:1ac25aa172960369a9149a"
};

// ================================================================
// DATA
// ================================================================
const ALL_ROLES = {
  'Loup-Garou':      {camp:'loup',   emoji:'üê∫', desc:'√âlimine une victime chaque nuit avec les autres loups.'},
  'Loup Blanc':      {camp:'loup',   emoji:'ü§ç', desc:'Joue avec les loups mais veut finir seul en vie.'},
  'Loup Enrag√©':     {camp:'loup',   emoji:'üî•', desc:'Une nuit sur 3, tue deux joueurs.'},
  'Loup Infectieux': {camp:'loup',   emoji:'ü¶†', desc:'Peut transformer sa cible en Loup-Garou (1x).'},
  'Loup aux Puces':  {camp:'loup',   emoji:'üêú', desc:'Infecte une cible ; elle devient loup apr√®s 3 tours.'},
  'Villageois':      {camp:'village',emoji:'üë®‚Äçüåæ',desc:'Observe, d√©duit et vote intelligemment.'},
  'Voyante':         {camp:'village',emoji:'üîÆ', desc:'R√©v√®le chaque nuit le r√¥le d\'un joueur.'},
  'Sorci√®re':        {camp:'village',emoji:'üß™', desc:'Une potion de vie et une de mort (1x chacune).'},
  'Chasseur':        {camp:'village',emoji:'üèπ', desc:'√Ä sa mort, emporte un joueur avec lui.'},
  'Cupidon':         {camp:'village',emoji:'üíò', desc:'Lie deux amoureux. Si l\'un meurt, l\'autre aussi.'},
  'Garde du Corps':  {camp:'village',emoji:'üõ°Ô∏è', desc:'Prot√®ge un joueur la nuit (se sacrifie si besoin).'},
  'Maire':           {camp:'village',emoji:'üëë', desc:'Voix double lors des votes.'},
  'Dieu du Village': {camp:'village',emoji:'‚ú®', desc:'Annule une √©limination une fois dans la partie.'},
  'N√©cromancien':    {camp:'village',emoji:'üíÄ', desc:'Obtient des infos aupr√®s des morts.'},
  'Chronomancien':   {camp:'village',emoji:'‚è≥', desc:'Rembobine un tour complet une fois.'},
  'Illusionniste':   {camp:'neutre', emoji:'ü™Ñ', desc:'Modifie ce que la Voyante per√ßoit.'},
  'Hypnotiseur':     {camp:'neutre', emoji:'üåÄ', desc:'Force un joueur √† voter pour une cible.'},
  'Usurpateur':      {camp:'neutre', emoji:'üé≠', desc:'Copie temporairement le pouvoir d\'un autre joueur.'},
  'Avocat':          {camp:'neutre', emoji:'‚öñÔ∏è', desc:'Prot√®ge un joueur contre l\'√©limination par vote.'},
  'Tra√Ætre':         {camp:'neutre', emoji:'üó°Ô∏è', desc:'Commence villageois, rejoint les loups plus tard.'},
  'Marionnettiste':  {camp:'neutre', emoji:'üßµ', desc:'Contr√¥le les actions d\'un joueur pendant la nuit.'},
};

const AVATARS = ['üßë','üë©','üßî','üëµ','üßí','üëß','üßë‚Äçü¶±','üßë‚Äçü¶≥','üßë‚Äçü¶∞','üßë‚Äçü¶≤','üßï','üßõ','üßô','üßù','üßü','üßú','üßö','üé©'];

const ALL_EVENTS = [
  {name:'Brouillard',            icon:'üå´Ô∏è',desc:'Personne ne peut parler pendant une minute.'},
  {name:'Silence',               icon:'ü§´',desc:'Un joueur est r√©duit au silence pour ce tour.'},
  {name:'Double Vote',           icon:'üó≥Ô∏è',desc:'Tous les votes comptent double ce jour.'},
  {name:'Vote Invers√©',          icon:'üîÉ',desc:'Le joueur avec le plus de votes est sauv√©.'},
  {name:'Deux Morts Cette Nuit', icon:'üíÄ',desc:'La nuit devient doublement meurtri√®re.'},
  {name:'Immunit√© Al√©atoire',    icon:'üõ°Ô∏è',desc:'Un joueur devient intouchable pour un tour.'},
  {name:'Retour des Morts',      icon:'üëª',desc:'Un joueur √©limin√© revient pour un tour.'},
  {name:'Nuit √âternelle',        icon:'üåë',desc:'Deux phases de nuit cons√©cutives.'},
  {name:'Nouveau Maire',         icon:'üëë',desc:'Un maire est d√©sign√© al√©atoirement.'},
  {name:'Pi√®ge Explosif',        icon:'üí£',desc:'Si le joueur pi√©g√© est vot√©, deux autres meurent.'},
  {name:'Voyante Aveugl√©e',      icon:'üëÅÔ∏è',desc:'La Voyante re√ßoit une information fausse.'},
  {name:'Potion Retrouv√©e',      icon:'üß™',desc:'La Sorci√®re r√©cup√®re une potion utilis√©e.'},
  {name:'Duel Obligatoire',      icon:'‚öîÔ∏è',desc:'Deux joueurs s\'affrontent ; le village vote pour l\'un.'},
  {name:'D√©bat Limit√©',          icon:'‚è±Ô∏è',desc:'Seulement une minute pour discuter.'},
  {name:'Discussions Interdites',icon:'üö´',desc:'Vote imm√©diat sans d√©bat.'},
];

// ================================================================
// STATE
// ================================================================
let db = null;
let me = {name:'', avatar:'üßë', id:''};
let roomCode = '';
let isHost = false;
let unsubRoom = null;
let timerInterval = null;
let selectedAvC = 'üßë';
let selectedAvJ = 'üßë';
let selectedRoles = new Set(['Loup-Garou','Villageois','Voyante']);
let chatRendered = 0;
let narrQueue = [];
let narrActive = false;
let lastSeenLogLen = 0;
let localRoom = null; // cached room for timer

// ================================================================
// FIREBASE INIT
// ================================================================
(async function initFirebase() {
  try {
    if(!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'REMPLACEZ_ICI') {
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
          <div>
            <div style="font-size:3rem;margin-bottom:16px;">üî•</div>
            <div style="font-family:'Cinzel Decorative',serif;font-size:1.4rem;margin-bottom:12px;">Configuration Firebase manquante</div>
            <div style="color:#8a8070;font-size:.95rem;max-width:480px;line-height:1.7;">
              Ouvrez <strong>index.html</strong> dans un √©diteur de texte.<br>
              Cherchez <code style="background:rgba(255,255,255,.08);padding:2px 8px;border-radius:4px;">REMPLACEZ_ICI</code>
              et remplacez chaque valeur par vos cl√©s Firebase.<br><br>
              Voir <strong>README.md</strong> pour les instructions compl√®tes.
            </div>
          </div>
        </div>`;
      return;
    }
    const app = initializeApp(FIREBASE_CONFIG);
    db = getDatabase(app);
    console.log('‚úÖ Firebase connect√©');
  } catch(e) {
    console.error('Firebase init failed:', e);
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:'EB Garamond',serif;color:#e8d5a3;text-align:center;padding:40px;background:#080810;">
        <div>
          <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
          <div style="font-family:'Cinzel Decorative',serif;font-size:1.2rem;margin-bottom:12px;">Erreur de connexion Firebase</div>
          <div style="color:#8a8070;font-size:.9rem;max-width:480px;line-height:1.7;">${e.message}<br><br>V√©rifiez vos cl√©s dans index.html ‚Äî notamment <strong>databaseURL</strong>.</div>
        </div>
      </div>`;
  }
})();

// ================================================================
// UTILS
// ================================================================
function genId() { return Math.random().toString(36).substr(2,9) + Date.now().toString(36); }
function genCode() { return String(Math.floor(100000 + Math.random() * 900000)); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function dbRef(path) { return ref(db, path); }
async function dbSet(path, val) { await set(dbRef(path), val); }
async function dbUpdate(path, val) { await update(dbRef(path), val); }
async function dbGet(path) { const s = await get(dbRef(path)); return s.exists() ? s.val() : null; }
function dbListen(path, cb) { return onValue(dbRef(path), snap => cb(snap.exists() ? snap.val() : null)); }

// ================================================================
// SCREENS
// ================================================================
window.showScreen = function(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(name+'-screen').classList.add('active');
};

function buildAvatarPicker(id, onSel, defVal) {
  const c = document.getElementById(id);
  if(!c) return;
  c.innerHTML = '';
  AVATARS.forEach((a,i) => {
    const b = document.createElement('button');
    b.className = 'av-btn' + (i===0?' selected':'');
    b.textContent = a;
    b.onclick = () => {
      c.querySelectorAll('.av-btn').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected');
      onSel(a);
    };
    c.appendChild(b);
  });
}
buildAvatarPicker('av-create', a => selectedAvC = a, 'üßë');
buildAvatarPicker('av-join',   a => selectedAvJ = a, 'üßë');

document.getElementById('j-code').addEventListener('input', function(){
  this.value = this.value.replace(/[^0-9]/g,'').substr(0,6);
});
document.getElementById('chat-in').addEventListener('keypress', e => { if(e.key==='Enter') sendChat(); });
document.getElementById('j-code').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });
document.getElementById('c-name').addEventListener('keypress', e => { if(e.key==='Enter') createGame(); });
document.getElementById('j-name').addEventListener('keypress', e => { if(e.key==='Enter') joinGame(); });

window.copyCode = function() {
  navigator.clipboard.writeText(roomCode).then(() => {
    const b = document.querySelector('.copy-btn');
    if(b){const o=b.textContent;b.textContent='‚úÖ Copi√© !';setTimeout(()=>b.textContent=o,1500);}
  }).catch(()=>prompt('Code :',roomCode));
};

// ================================================================
// CREATE GAME
// ================================================================
window.createGame = async function() {
  const name = document.getElementById('c-name').value.trim();
  const err = document.getElementById('c-err');
  if(!name){err.textContent='‚ùå Entrez votre nom !';return;}
  me = {name, avatar:selectedAvC, id:genId()};
  isHost = true;
  roomCode = genCode();

  const room = {
    code: roomCode,
    status: 'lobby',
    host: me.id,
    settings: {roles:Array.from(selectedRoles), eventProb:30, nightDur:90, dayDur:180},
    game: null,
    chat: {},
    log: {},
    players: {}
  };
  room.players[me.id] = {name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false};

  await dbSet('rooms/'+roomCode, room);
  err.textContent = '';
  enterLobby();
};

// ================================================================
// JOIN GAME
// ================================================================
window.joinGame = async function() {
  const code = document.getElementById('j-code').value.trim().replace(/\D/g,'');
  const name = document.getElementById('j-name').value.trim();
  const err = document.getElementById('j-err');

  if(code.length!==6){err.style.color='#e07070';err.textContent='‚ùå Code invalide ‚Äî 6 chiffres';return;}
  if(!name){err.style.color='#e07070';err.textContent='‚ùå Entrez votre nom !';return;}

  err.style.color='var(--moon2)';err.textContent='üîç Connexion‚Ä¶';

  const room = await dbGet('rooms/'+code);
  if(!room){err.style.color='#e07070';err.textContent=`‚ùå Partie "${code}" introuvable.`;return;}
  if(room.status!=='lobby'){err.style.color='#e07070';err.textContent='‚ö†Ô∏è Partie d√©j√† en cours !';return;}

  const players = room.players ? Object.values(room.players) : [];
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase())){
    err.style.color='#e07070';err.textContent='‚ö†Ô∏è Ce nom est d√©j√† pris !';return;
  }

  me = {name, avatar:selectedAvJ, id:genId()};
  isHost = false;
  roomCode = code;

  await dbSet('rooms/'+code+'/players/'+me.id, {
    name:me.name, avatar:me.avatar, id:me.id, role:null, alive:true, mayor:false, lovers:false, protected:false
  });

  err.textContent='';
  enterLobby();
};

// ================================================================
// LOBBY
// ================================================================
function enterLobby() {
  showScreen('lobby');
  document.getElementById('lobby-code').textContent = roomCode;
  if(isHost){
    document.getElementById('lobby-wait').style.display='none';
    document.getElementById('lobby-launch').style.display='block';
    buildHostSetup();
  }
  // Real-time listener
  if(unsubRoom) unsubRoom();
  unsubRoom = dbListen('rooms/'+roomCode, onRoomUpdate);
}

function buildHostSetup() {
  const div = document.getElementById('host-setup');
  div.innerHTML = `
    <div class="panel">
      <div class="p-title">üé≠ R√¥les actifs</div>
      <div class="roles-grid" id="roles-grid"></div>
    </div>
    <div class="panel">
      <div class="p-title">‚öôÔ∏è Param√®tres</div>
      <div class="dur-row">
        <div class="dur-field"><label>üåë Dur√©e Nuit (s)</label><input type="number" id="night-dur" value="90" min="20" max="300"></div>
        <div class="dur-field"><label>‚òÄÔ∏è Dur√©e Jour (s)</label><input type="number" id="day-dur" value="180" min="30" max="600"></div>
        <div class="dur-field"><label>üåÄ Prob. √âv√©nement %</label><input type="number" id="ev-prob" value="30" min="0" max="100"></div>
      </div>
    </div>`;

  const grid = document.getElementById('roles-grid');
  for(const [name,data] of Object.entries(ALL_ROLES)){
    const d = document.createElement('div');
    d.className=`role-tog ${data.camp} ${selectedRoles.has(name)?'on':''}`;
    d.innerHTML=`<span class="r-em">${data.emoji}</span>${name}`;
    d.onclick=()=>{
      if(selectedRoles.has(name)){selectedRoles.delete(name);d.classList.remove('on');}
      else{selectedRoles.add(name);d.classList.add('on');}
    };
    grid.appendChild(d);
  }
}

// ================================================================
// LAUNCH
// ================================================================
window.launchGame = async function() {
  const room = await dbGet('rooms/'+roomCode);
  if(!room) return;
  const players = room.players ? Object.values(room.players) : [];
  if(players.length < 3){
    document.getElementById('launch-err').textContent='‚ùå Il faut au moins 3 joueurs !'; return;
  }

  const nightDur = parseInt(document.getElementById('night-dur')?.value)||90;
  const dayDur   = parseInt(document.getElementById('day-dur')?.value)||180;
  const evProb   = parseInt(document.getElementById('ev-prob')?.value)||30;

  // Assign roles
  const roles = Array.from(selectedRoles);
  const shuffledRoles = [...roles].sort(()=>Math.random()-.5);
  const shuffledPlayers = [...players].sort(()=>Math.random()-.5);
  const playerUpdates = {};
  shuffledPlayers.forEach((p,i)=>{
    playerUpdates['rooms/'+roomCode+'/players/'+p.id+'/role'] = shuffledRoles[i%shuffledRoles.length];
  });
  await update(ref(db), playerUpdates);

  // Reload with roles
  const updatedRoom = await dbGet('rooms/'+roomCode);
  const updatedPlayers = Object.values(updatedRoom.players);

  // Cupidon
  let loversA=null, loversB=null;
  const cupidon = updatedPlayers.find(p=>p.role==='Cupidon');
  if(cupidon && updatedPlayers.length>=3){
    const others = updatedPlayers.filter(p=>p.id!==cupidon.id).sort(()=>Math.random()-.5);
    loversA = others[0].id; loversB = others[1].id;
    const loveUpdates = {};
    loveUpdates['rooms/'+roomCode+'/players/'+loversA+'/lovers'] = true;
    loveUpdates['rooms/'+roomCode+'/players/'+loversB+'/lovers'] = true;
    await update(ref(db), loveUpdates);
  }

  // Mayor
  const mayorP = updatedPlayers.find(p=>p.role==='Maire');
  if(mayorP) await dbUpdate('rooms/'+roomCode+'/players/'+mayorP.id, {mayor:true});

  const game = {
    phase:'night', turn:1,
    phaseEndTime: Date.now()+nightDur*1000,
    nightDur, dayDur, evProb,
    witchLifeUsed:false, witchDeathUsed:false, godUsed:false, chronoUsed:false,
    loversA, loversB,
    currentEvent:null, victory:null,
    lastPhaseChange: Date.now(),
  };

  await dbUpdate('rooms/'+roomCode, {status:'playing', game,
    settings:{roles:Array.from(selectedRoles), eventProb:evProb, nightDur, dayDur}
  });

  await pushLog(`üåô La partie commence avec ${updatedPlayers.length} joueurs !`, 'system');
  if(loversA && loversB){
    const a=updatedPlayers.find(p=>p.id===loversA), b=updatedPlayers.find(p=>p.id===loversB);
    if(a&&b) await pushLog(`üíò Cupidon a li√© ${a.name} et ${b.name} en amoureux.`, 'info');
  }
  await maybeEvent(game);
};

// ================================================================
// ROOM UPDATE LISTENER
// ================================================================
function onRoomUpdate(room) {
  if(!room) return;
  localRoom = room;
  const players = room.players ? Object.values(room.players) : [];

  if(room.status==='lobby'){
    renderLobbyPlayers(players, room.host);
    document.getElementById('lobby-lbl').textContent = `${players.length} joueur${players.length>1?'s':''} connect√©${players.length>1?'s':''}`;
    return;
  }

  if(room.status==='playing'){
    if(!document.getElementById('game-screen').classList.contains('active')){
      showScreen('game');
      renderMyRole(room);
      startTimerLoop();
    }
    updateGameView(room);
    renderChat(room);
    checkNewLogNarr(room);
  }

  if(room.status==='ended' && room.game?.victory){
    clearInterval(timerInterval);
    if(unsubRoom) unsubRoom();
    showVictory(room.game.victory);
  }
}

function renderLobbyPlayers(players, hostId) {
  const grid = document.getElementById('lobby-players');
  grid.innerHTML='';
  players.forEach(p=>{
    const d=document.createElement('div');
    d.className=`lp-tile ${p.id===hostId?'host':''}`;
    d.innerHTML=`<div class="lp-av">${p.avatar}</div><div class="lp-name">${esc(p.name)}</div>${p.id===me.id?'<div class="lp-badge">üë§ Vous</div>':''}${p.id===hostId?'<div class="lp-badge" style="color:var(--ember)">üéÆ H√¥te</div>':''}`;
    grid.appendChild(d);
  });
}

// ================================================================
// GAME VIEW
// ================================================================
function updateGameView(room) {
  if(!room.game) return;
  const g = room.game;
  const players = room.players ? Object.values(room.players) : [];
  const isNight = g.phase==='night';

  document.getElementById('ph-icon').textContent = isNight?'üåë':'‚òÄÔ∏è';
  document.getElementById('ph-name').textContent = isNight?`Nuit ${g.turn}`:`Jour ${g.turn}`;
  document.getElementById('ph-desc').textContent = isNight?'Les cr√©atures de la nuit s\'√©veillent‚Ä¶':'Le village d√©bat et accuse‚Ä¶';

  renderPlayers(players);
  renderActions(room);
  renderEvent(g);
  if(isHost) renderMaster(room);
}

function renderMyRole(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  if(!myP) return;
  const rd = ALL_ROLES[myP.role];
  if(!rd) return;
  document.getElementById('r-em').textContent = rd.emoji;
  document.getElementById('r-name').textContent = myP.role;
  document.getElementById('r-camp').textContent = {loup:'‚öîÔ∏è Camp des Loups',village:'üåæ Camp du Village',neutre:'üé≠ R√¥le Neutre'}[rd.camp];
  document.getElementById('r-camp').className = 'role-camp '+rd.camp;
  let desc = rd.desc;
  if(myP.lovers && room.game){
    const g = room.game;
    const loverId = g.loversA===me.id ? g.loversB : g.loversA;
    const lover = Object.values(room.players).find(p=>p.id===loverId);
    if(lover) desc += ` ‚ù§Ô∏è Vous √™tes amoureux(se) de ${lover.name}.`;
  }
  document.getElementById('r-desc').textContent = desc;
  const card = document.getElementById('my-role-card');
  if(rd.camp==='loup') card.style.borderColor='rgba(176,32,32,.4)';
  else if(rd.camp==='village') card.style.borderColor='rgba(45,122,74,.4)';
  else card.style.borderColor='rgba(106,64,160,.4)';
}

function renderPlayers(players) {
  const grid = document.getElementById('g-players');
  const deadChips = document.getElementById('dead-chips');
  grid.innerHTML=''; deadChips.innerHTML='';
  let hasDead=false;

  players.forEach(p=>{
    if(!p.alive){
      hasDead=true;
      const c=document.createElement('div');
      c.className='dead-chip';
      c.textContent=`${p.avatar} ${p.name}`;
      deadChips.appendChild(c);
      return;
    }
    const d=document.createElement('div');
    const isMe=p.id===me.id;
    d.className=`p-tile ${isMe?'me':''} ${p.mayor?'mayor':''} ${p.lovers?'lover':''} ${p.protected?'protected':''}`;
    const rd=ALL_ROLES[p.role];
    const roleShow = (isMe||isHost) && rd ? `<div class="t-role">${rd.emoji} ${p.role}</div>` : '';
    d.innerHTML=`<div class="t-av">${p.avatar}</div><div class="t-name">${esc(p.name)}${isMe?' (vous)':''}</div>${roleShow}`;
    if(isHost) d.onclick=()=>hostPlayerModal(p);
    grid.appendChild(d);
  });
  document.getElementById('dead-zone').style.display=hasDead?'block':'none';
}

function renderActions(room) {
  const players = room.players ? Object.values(room.players) : [];
  const myP = players.find(p=>p.id===me.id);
  const btns = document.getElementById('a-btns');
  btns.innerHTML='';

  if(!myP){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">En attente‚Ä¶</div>';return;}
  if(!myP.alive){btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">Vous √™tes √©limin√©. Observez en silence‚Ä¶</div>';return;}

  const g = room.game;
  const role = myP.role;

  const add = (lbl,cls,fn) => {
    const b=document.createElement('button');
    b.className='a-btn '+cls; b.innerHTML=lbl; b.onclick=fn; btns.appendChild(b);
  };

  if(g.phase==='night'){
    if(role==='Voyante')                       add('üîÆ Voir un r√¥le','',()=>seerModal(room));
    if(role==='Sorci√®re'&&!g.witchLifeUsed)    add('üß™ Potion de Vie','',()=>witchLifeModal(room));
    if(role==='Sorci√®re'&&!g.witchDeathUsed)   add('‚ò†Ô∏è Potion de Mort','red',()=>witchDeathModal(room));
    if(role==='Garde du Corps')                add('üõ°Ô∏è Prot√©ger','',()=>protectModal(room));
    if(role==='Dieu du Village'&&!g.godUsed)   add('‚ú® Annuler mort','purple',()=>godModal(room));
    if(role==='Chronomancien'&&!g.chronoUsed)  add('‚è≥ Rembobiner','purple',()=>chronoAction());
    if(role==='N√©cromancien')                  add('üíÄ Consulter morts','',()=>necroModal(room));
    if(['Loup-Garou','Loup Blanc','Loup Enrag√©','Loup Infectieux','Loup aux Puces'].includes(role))
      add('üê∫ Voter une cible','red',()=>wolfVoteModal(room));
  } else {
    add('‚öñÔ∏è Voter pour √©liminer','red',()=>voteModal(room));
    if(role==='Dieu du Village'&&!g.godUsed)   add('‚ú® Annuler √©lim.','purple',()=>godModal(room));
  }

  if(btns.children.length===0)
    btns.innerHTML='<div style="color:var(--smoke);font-style:italic;font-size:.88rem;">Pas d\'action sp√©ciale ‚Äî observez, discutez, survivez.</div>';
}

function renderEvent(g) {
  const card = document.getElementById('ev-card');
  if(!g.currentEvent){card.style.display='none';return;}
  card.style.display='block';
  const ev=g.currentEvent;
  card.innerHTML=`<div class="ev-big">${ev.icon}</div><div class="ev-title">${esc(ev.name)}</div><div class="ev-desc">${esc(ev.desc)}</div>`;
}

function renderMaster(room) {
  const panel = document.getElementById('master-panel');
  const btns = document.getElementById('m-btns');
  panel.style.display='block'; btns.innerHTML='';

  const add = (lbl,cls,fn) => {
    const b=document.createElement('button');
    b.className='m-btn '+cls; b.innerHTML=lbl; b.onclick=fn; btns.appendChild(b);
  };

  if(room.game.phase==='night'){
    add('‚òÄÔ∏è Passer au Jour','',()=>switchPhase('day'));
    add('üíÄ Mort cette nuit','kill',()=>masterKillModal(room,'nuit'));
  } else {
    add('üåô Passer √† la Nuit','',()=>switchPhase('night'));
    add('‚öñÔ∏è √âliminer (vote)','kill',()=>masterKillModal(room,'vote'));
  }
  add('üëë Nommer Maire','',()=>masterMayorModal(room));
  add('üåÄ D√©clencher √âv√©nement','',()=>masterTriggerEvent());
}

// ================================================================
// TIMER
// ================================================================
function startTimerLoop(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    const g = localRoom?.game;
    if(!g||!g.phaseEndTime) return;
    const rem = Math.max(0, Math.ceil((g.phaseEndTime - Date.now())/1000));
    const el = document.getElementById('ph-timer');
    if(el){el.textContent=rem+'s'; el.className='ph-timer'+(rem<=10?' urgent':'');}
    if(rem<=0 && isHost) { clearInterval(timerInterval); switchPhase(g.phase==='night'?'day':'night'); }
  }, 500);
}

// ================================================================
// PHASE SWITCH
// ================================================================
async function switchPhase(newPhase){
  const room = await dbGet('rooms/'+roomCode);
  if(!room||!room.game) return;
  const g = room.game;
  const dur = newPhase==='night' ? g.nightDur||90 : g.dayDur||180;
  const updates = {};
  updates['rooms/'+roomCode+'/game/phase'] = newPhase;
  updates['rooms/'+roomCode+'/game/phaseEndTime'] = Date.now()+dur*1000;
  updates['rooms/'+roomCode+'/game/lastPhaseChange'] = Date.now();
  if(newPhase==='night'){
    updates['rooms/'+roomCode+'/game/turn'] = (g.turn||1)+1;
    // Reset protection
    const players = room.players ? Object.values(room.players) : [];
    players.forEach(p=>{ updates['rooms/'+roomCode+'/players/'+p.id+'/protected']=false; });
  }
  await update(ref(db), updates);
  const turn = newPhase==='night' ? (g.turn||1)+1 : g.turn;
  if(newPhase==='night'){
    await pushLog(`üåë ‚Äî Nuit ${turn} ‚Äî Les loups se r√©veillent.`,'night');
    queueNarr({fire:'üåë',color:'#8070b0',title:`Nuit ${turn}`,text:`Le soleil s'est couch√©. Les volets se ferment. Dans l'obscurit√© totale, quelque chose se d√©place lentement entre les maisons. Quelqu'un pr√©pare son crime.`});
  } else {
    await pushLog(`‚òÄÔ∏è ‚Äî Jour ${g.turn} ‚Äî Le village s'√©veille.`,'day');
    queueNarr({fire:'‚òÄÔ∏è',color:'#c8a050',title:`Jour ${g.turn}`,text:`L'aube rougeoyante r√©veille le village, mais l'air reste lourd de mensonges. Les regards se croisent, fuyants ou accusateurs. Qui parmi nous ment ce matin ?`});
  }
  const freshRoom = await dbGet('rooms/'+roomCode);
  if(freshRoom) await maybeEvent(freshRoom.game);
  if(newPhase==='day') await checkVictory();
}

// ================================================================
// EVENTS
// ================================================================
async function maybeEvent(g){
  const prob = g?.evProb || 30;
  if(Math.random()*100 < prob){
    const ev = ALL_EVENTS[Math.floor(Math.random()*ALL_EVENTS.length)];
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:ev});
    await pushLog(`üåÄ √âV√âNEMENT : ${ev.name} ‚Äî ${ev.desc}`,'chaos');
    queueNarr({fire:ev.icon,color:'#c0a0ff',title:ev.name,text:ev.desc+' Un frisson parcourt le village. Personne ne sait encore quelles cons√©quences cela aura vraiment‚Ä¶'});
    await applyEvent(ev);
  } else {
    await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:null});
  }
}

async function masterTriggerEvent(){
  const ev = ALL_EVENTS[Math.floor(Math.random()*ALL_EVENTS.length)];
  await dbUpdate('rooms/'+roomCode+'/game',{currentEvent:ev});
  await pushLog(`üåÄ √âV√âNEMENT : ${ev.name} ‚Äî ${ev.desc}`,'chaos');
  queueNarr({fire:ev.icon,color:'#c0a0ff',title:ev.name,text:ev.desc+' Le destin du village vient de basculer‚Ä¶'});
  await applyEvent(ev);
}

async function applyEvent(ev){
  const room = await dbGet('rooms/'+roomCode);
  const players = room?.players ? Object.values(room.players) : [];
  const alive = players.filter(p=>p.alive);
  if(!alive.length) return;

  if(ev.name==='Immunit√© Al√©atoire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    await dbUpdate('rooms/'+roomCode+'/players/'+t.id,{protected:true});
    await pushLog(`üõ°Ô∏è ${t.name} est immunis√© pour ce tour.`,'chaos');
  }
  if(ev.name==='Nouveau Maire'){
    const t=alive[Math.floor(Math.random()*alive.length)];
    const upd={};
    players.forEach(p=>{upd['rooms/'+roomCode+'/players/'+p.id+'/mayor']=false;});
    upd['rooms/'+roomCode+'/players/'+t.id+'/mayor']=true;
    await update(ref(db),upd);
    await pushLog(`üëë ${t.name} devient le nouveau Maire !`,'chaos');
  }
  if(ev.name==='Retour des Morts'){
    const dead=players.filter(p=>!p.alive);
    if(dead.length){
      const r=dead[Math.floor(Math.random()*dead.length)];
      await dbUpdate('rooms/'+roomCode+'/players/'+r.id,{alive:true});
      await pushLog(`üëª ${r.name} revient d'entre les morts pour un tour !`,'chaos');
    }
  }
  if(ev.name==='Potion Retrouv√©e'){
    const g=room.game;
    if(g?.witchLifeUsed){await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:false});await pushLog('üß™ La Sorci√®re r√©cup√®re sa potion de vie !','info');}
    else if(g?.witchDeathUsed){await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:false});await pushLog('üß™ La Sorci√®re r√©cup√®re sa potion de mort !','info');}
  }
}

// ================================================================
// KILL
// ================================================================
async function killPlayer(playerId, source){
  const room = await dbGet('rooms/'+roomCode);
  const p = room?.players?.[playerId];
  if(!p||!p.alive) return;
  if(p.protected){await pushLog(`üõ°Ô∏è ${p.name} √©tait prot√©g√© ‚Äî l'attaque √©choue !`,'info');return;}

  await dbUpdate('rooms/'+roomCode+'/players/'+playerId,{alive:false});
  await pushLog(`üíÄ ${p.name} (${p.role}) a √©t√© √©limin√© ‚Äî ${source}.`,'death');

  const narr = source==='nuit'||source==='loups'
    ? {fire:'üåë',color:'#e07070',title:'La Nuit a Frapp√©',text:`Les ombres ont d√©chir√© le silence. Ce matin, les villageois ont retrouv√© ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî froid et immobile. Le givre recouvrait ses l√®vres comme si la mort avait scell√© ses secrets.`}
    : {fire:'‚öñÔ∏è',color:'#e0c070',title:'La Justice du Village',text:`Apr√®s de longues heures de d√©bat, la foule a lev√© la main. ${p.name} ‚Äî ${ALL_ROLES[p.role]?.emoji||''} ${p.role} ‚Äî a √©t√© conduit au centre du village. Ses yeux cherchaient encore un alli√© dans la foule. Il n'en trouva aucun.`};
  queueNarr(narr);

  // Lovers
  const g = room.game;
  if(p.lovers && g){
    const loverId = g.loversA===playerId ? g.loversB : g.loversA;
    const lover = room.players?.[loverId];
    if(lover&&lover.alive){
      await dbUpdate('rooms/'+roomCode+'/players/'+loverId,{alive:false});
      await pushLog(`‚ù§Ô∏è ${lover.name} ne peut survivre √† la mort de son amour et meurt aussi.`,'death');
      queueNarr({fire:'üíî',color:'#f48fb1',title:'Un Amour Bris√©',text:`Quand ${p.name} est tomb√©(e), quelque chose dans le c≈ìur de ${lover.name} s'est bris√©. Les amoureux li√©s par Cupidon ne peuvent survivre l'un sans l'autre. La l√©gende s'est confirm√©e.`});
    }
  }
  if(p.mayor) await pushLog(`üëë Le Maire est mort ! D√©signez un nouveau maire.`,'system');

  await checkVictory();
}

// ================================================================
// MASTER ACTIONS
// ================================================================
async function masterKillModal(room, source){
  const players = Object.values(room.players||{}).filter(p=>p.alive&&!p.protected);
  openModal(`‚ò†Ô∏è √âliminer ‚Äî ${source}`,
    players.map(p=>`<button class="m-opt red" onclick="window._kill('${p.id}','${source}');closeModal()">
      ${p.avatar} ${esc(p.name)} <span style="font-size:.76rem;color:var(--smoke)">${p.role||''}</span>
    </button>`).join('')
  );
}
window._kill = (id,src)=>killPlayer(id,src);

async function masterMayorModal(room){
  const players = Object.values(room.players||{}).filter(p=>p.alive);
  openModal('üëë Nommer le Maire',
    players.map(p=>`<button class="m-opt" onclick="window._setMayor('${p.id}');closeModal()">
      ${p.avatar} ${esc(p.name)}
    </button>`).join('')
  );
}
window._setMayor = async function(id){
  const room = await dbGet('rooms/'+roomCode);
  const upd={};
  Object.keys(room.players||{}).forEach(pid=>{upd['rooms/'+roomCode+'/players/'+pid+'/mayor']=false;});
  upd['rooms/'+roomCode+'/players/'+id+'/mayor']=true;
  await update(ref(db),upd);
  const p=room.players[id];
  if(p) await pushLog(`üëë ${p.name} est √©lu Maire !`,'info');
};

function hostPlayerModal(p){
  openModal(`${p.avatar} ${esc(p.name)}`,
    `<p style="margin-bottom:10px;font-style:italic;color:var(--smoke);font-size:.86rem;">${ALL_ROLES[p.role]?.emoji} ${p.role} ‚Äî ${ALL_ROLES[p.role]?.desc||''}</p>
    <div class="m-opts">
      ${p.alive?`<button class="m-opt red" onclick="window._kill('${p.id}','manuel');closeModal()">‚ò†Ô∏è √âliminer</button>`
                :`<button class="m-opt" onclick="window._revive('${p.id}');closeModal()">‚ú® Ressusciter</button>`}
      <button class="m-opt" onclick="window._setMayor('${p.id}');closeModal()">üëë Nommer Maire</button>
      <button class="m-opt" onclick="window._protect('${p.id}');closeModal()">üõ°Ô∏è Prot√©ger ce tour</button>
    </div>`
  );
}
window._revive = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  const r=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(r) await pushLog(`‚ú® ${r.name} est ressuscit√©(e) !`,'info');
};
window._protect = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{protected:true});
  const r=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(r) await pushLog(`üõ°Ô∏è ${r.name} est prot√©g√©(e) ce tour.`,'info');
};

// ================================================================
// PLAYER ACTIONS
// ================================================================
async function seerModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('üîÆ Voyante ‚Äî Voir un r√¥le',
    players.map(p=>`<button class="m-opt" onclick="window._seer('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._seer = async function(id){
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(!p) return;
  const rd=ALL_ROLES[p.role];
  openModal('üîÆ R√©v√©lation',`<div style="text-align:center;padding:18px;">
    <div style="font-size:2.5rem;margin-bottom:9px;">${rd?.emoji||'‚ùì'}</div>
    <div style="font-family:'Cinzel Decorative',serif;font-size:.95rem;">${esc(p.name)}</div>
    <div style="font-size:.82rem;color:var(--smoke);margin-top:5px;font-style:italic;">${rd?.emoji} ${p.role}</div>
    <div style="font-size:.79rem;color:var(--smoke);margin-top:4px;">${rd?.desc||''}</div>
  </div>`);
};

async function voteModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚öñÔ∏è Voter pour √©liminer',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">L'h√¥te finalise l'√©limination.</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._vote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._vote = async function(id){
  const room=await dbGet('rooms/'+roomCode);
  const voter=room?.players?.[me.id];
  const target=room?.players?.[id];
  if(voter&&target) await pushLog(`üó≥Ô∏è ${voter.name} vote contre ${target.name}.`,'day');
};

async function wolfVoteModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&ALL_ROLES[p.role]?.camp!=='loup');
  openModal('üê∫ Choisir une cible (loups)',
    `<p style="font-size:.83rem;color:var(--smoke);margin-bottom:9px;font-style:italic;">Coordonnez-vous dans le chat !</p>`+
    players.map(p=>`<button class="m-opt red" onclick="window._vote('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function protectModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive);
  openModal('üõ°Ô∏è Prot√©ger un joueur',
    players.map(p=>`<button class="m-opt" onclick="window._protect('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}

async function witchLifeModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('üß™','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† ressusciter.</p>');return;}
  openModal('üß™ Potion de Vie',
    players.map(p=>`<button class="m-opt" onclick="window._witchLife('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchLife = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{witchLifeUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`üß™ La Sorci√®re a ressuscit√© ${p.name} !`,'info');
};

async function witchDeathModal(room){
  const players=Object.values(room.players||{}).filter(p=>p.alive&&p.id!==me.id);
  openModal('‚ò†Ô∏è Potion de Mort',
    players.map(p=>`<button class="m-opt red" onclick="window._witchDeath('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._witchDeath = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:false});
  await dbUpdate('rooms/'+roomCode+'/game',{witchDeathUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p){
    await pushLog(`‚ò†Ô∏è La Sorci√®re a tu√© ${p.name} !`,'death');
    queueNarr({fire:'üß™',color:'#e07070',title:'Le Poison Frappe',text:`Dans le silence de la nuit, la Sorci√®re a lev√© son flacon de mort. ${p.name} n'a pas eu le temps de comprendre ce qui se passait. Le poison a fait son ≈ìuvre en quelques secondes.`});
    await checkVictory();
  }
};

async function godModal(room){
  const players=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!players.length){openModal('‚ú®','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† sauver.</p>');return;}
  openModal('‚ú® Dieu du Village ‚Äî Annuler',
    players.map(p=>`<button class="m-opt" onclick="window._god('${p.id}');closeModal()">${p.avatar} ${esc(p.name)}</button>`).join('')
  );
}
window._god = async function(id){
  await dbUpdate('rooms/'+roomCode+'/players/'+id,{alive:true});
  await dbUpdate('rooms/'+roomCode+'/game',{godUsed:true});
  const p=await dbGet('rooms/'+roomCode+'/players/'+id);
  if(p) await pushLog(`‚ú® Le Dieu du Village annule l'√©limination de ${p.name} !`,'info');
};

async function chronoAction(){
  const g=await dbGet('rooms/'+roomCode+'/game');
  await dbUpdate('rooms/'+roomCode+'/game',{turn:Math.max(1,(g?.turn||1)-1),chronoUsed:true});
  await pushLog('‚è≥ Le Chronomancien rembobine le temps ! Le tour est rejou√©.','chaos');
  queueNarr({fire:'‚è≥',color:'#a0c0ff',title:'Le Temps Rembobine',text:'Un frisson √©trange parcourt le village. Les ombres reculent. Quelques instants s\'effacent comme s\'ils n\'avaient jamais exist√©. Le Chronomancien sourit en rangeant son sablier.'});
}

async function necroModal(room){
  const dead=Object.values(room.players||{}).filter(p=>!p.alive);
  if(!dead.length){openModal('üíÄ','<p style="color:var(--smoke);font-style:italic;">Aucun mort √† consulter.</p>');return;}
  const rand=dead[Math.floor(Math.random()*dead.length)];
  const rd=ALL_ROLES[rand.role];
  openModal('üíÄ Vision du N√©cromancien',`<div style="text-align:center;padding:16px;">
    <div style="font-size:2rem;margin-bottom:8px;">üíÄ</div>
    <div style="font-style:italic;color:var(--smoke);font-size:.88rem;line-height:1.6;">
      L'esprit de ${esc(rand.name)} murmure‚Ä¶<br>
      <em>"Je faisais partie du camp : ${rd?.camp==='loup'?'‚öîÔ∏è Loups':rd?.camp==='village'?'üåæ Village':'üé≠ Neutre'}"</em>
    </div>
  </div>`);
}

// ================================================================
// CHAT
// ================================================================
window.sendChat = async function(){
  const inp=document.getElementById('chat-in');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  const ts=Date.now();
  const room=await dbGet('rooms/'+roomCode);
  const myP=room?.players?.[me.id];
  await dbSet('rooms/'+roomCode+'/chat/'+ts+'_'+me.id.substr(0,5),{
    id:me.id, name:me.name, avatar:me.avatar, text, ts, dead:myP?!myP.alive:false
  });
};

function renderChat(room){
  const msgs = room.chat ? Object.values(room.chat).sort((a,b)=>a.ts-b.ts) : [];
  if(msgs.length===chatRendered) return;
  chatRendered=msgs.length;
  const c=document.getElementById('chat-msgs');
  c.innerHTML='';
  msgs.forEach(m=>{
    const d=document.createElement('div');
    const isMe=m.id===me.id;
    d.className='c-msg';
    d.innerHTML=`<span class="c-author ${m.dead?'dead':''} ${isMe?'me-author':''}">${m.avatar} ${esc(m.name)}: </span><span class="c-text">${esc(m.text)}</span>`;
    c.appendChild(d);
  });
  c.scrollTop=c.scrollHeight;
}

// ================================================================
// LOG
// ================================================================
async function pushLog(text, type='system'){
  const ts=Date.now();
  await dbSet('rooms/'+roomCode+'/log/'+ts+'_'+Math.random().toString(36).substr(2,4),{text,type,ts});
}

function checkNewLogNarr(room){
  const logs = room.log ? Object.values(room.log).sort((a,b)=>a.ts-b.ts) : [];
  if(logs.length<=lastSeenLogLen){return;}
  lastSeenLogLen=logs.length;
}

// ================================================================
// VICTORY
// ================================================================
async function checkVictory(){
  const room=await dbGet('rooms/'+roomCode);
  if(!room||!room.game||room.game.victory||room.status==='ended') return;
  const players=Object.values(room.players||{});
  const alive=players.filter(p=>p.alive);
  const aliveLoup=alive.filter(p=>ALL_ROLES[p.role]?.camp==='loup');
  const aliveVillage=alive.filter(p=>ALL_ROLES[p.role]?.camp==='village');
  const g=room.game;

  let victory=null;
  if(alive.length===0){
    victory={type:'chaos',title:'üíÄ Personne ne survit',desc:'Le village s\'est auto-d√©truit. Ni loups ni villageois.',survivors:[],color:'#888888'};
  } else if(alive.length===2&&alive[0].lovers&&alive[1].lovers){
    victory={type:'lovers',title:'‚ù§Ô∏è Les Amoureux Gagnent !',desc:`Ni le village ni les loups n'ont pu les s√©parer. Leur amour interdit a r√©√©crit la l√©gende.`,survivors:alive,color:'#f48fb1'};
    queueNarr({fire:'‚ù§Ô∏è',color:'#f48fb1',title:'L\'Amour Triomphe',text:`Ils se sont battus contre tous. ${alive[0].name} et ${alive[1].name} survivent ensemble dans un monde qui les a combattus. Leur amour a vaincu les loups et le village.`});
  } else if(alive.length===1&&alive[0].role==='Loup Blanc'){
    victory={type:'white',title:'ü§ç Le Loup Blanc Triomphe',desc:'Il a trahi tout le monde pour finir seul en vie.',survivors:alive,color:'#e0e0e0'};
    queueNarr({fire:'ü§ç',color:'#e0e0e0',title:'Seul Survivant',text:`${alive[0].name} a tout planifi√© depuis le d√©but. Loup parmi les loups, il a attendu le bon moment pour trahir tout le monde. Ce soir, il reste seul debout.`});
  } else if(aliveLoup.length===0&&aliveVillage.length>0){
    victory={type:'village',title:'üåæ Le Village est Sauv√© !',desc:'Chaque loup a √©t√© d√©masqu√©. Ce soir, les enfants dormiront sans peur.',survivors:alive,color:'#70d090'};
    queueNarr({fire:'üåæ',color:'#70d090',title:'La Lumi√®re Triomphe',text:'Contre toute attente, les villageois ont trouv√© la v√©rit√©. Chaque loup d√©masqu√©, chaque mensonge perc√© √† jour. Ce soir, pour la premi√®re fois depuis des semaines, on peut dormir en paix.'});
  } else if(aliveLoup.length>=aliveVillage.length){
    victory={type:'wolf',title:'üê∫ Les Loups Triomphent !',desc:'Nuit apr√®s nuit, ils ont √©limin√© patiemment. La nuit ne finira jamais.',survivors:alive,color:'#e07070'};
    queueNarr({fire:'üê∫',color:'#e07070',title:'La Nuit √âternelle',text:'Ils ont gagn√© m√©thodiquement, nuit apr√®s nuit. Les villageois se sont querell√©s et tromp√©s les uns les autres. √Ä l\'aube, il ne reste que des loups sous peau humaine.'});
  }

  if(victory){
    await dbUpdate('rooms/'+roomCode,{status:'ended','game/victory':victory});
    await pushLog(`üèÜ FIN : ${victory.title}`,'system');
  }
}

function showVictory(v){
  showScreen('victory');
  const icons={wolf:'üê∫',village:'üåæ',lovers:'‚ù§Ô∏è',white:'ü§ç',chaos:'üíÄ'};
  document.getElementById('v-icon').textContent=icons[v.type]||'üèÜ';
  document.getElementById('v-title').textContent=v.title;
  document.getElementById('v-title').style.color=v.color;
  document.getElementById('v-desc').textContent=v.desc;
  const s=document.getElementById('v-surv');
  if(v.survivors?.length){
    s.innerHTML='<div style="font-family:\'Cinzel Decorative\',serif;font-size:.72rem;color:var(--smoke);margin-bottom:10px;text-transform:uppercase;letter-spacing:.1em;">Survivants</div>'+
      v.survivors.map(p=>`<div class="surv-row"><span style="font-size:1.4rem;">${p.avatar}</span><span>${esc(p.name)}</span><span style="color:var(--smoke);font-size:.8rem;font-style:italic;margin-left:auto;">${ALL_ROLES[p.role]?.emoji||''} ${p.role}</span></div>`).join('');
  } else {
    s.innerHTML='<div style="color:var(--smoke);font-style:italic;">Aucun survivant</div>';
  }
}

window.backToWelcome = function(){
  if(unsubRoom) unsubRoom();
  if(timerInterval) clearInterval(timerInterval);
  chatRendered=0; lastSeenLogLen=0; narrQueue=[]; narrActive=false;
  selectedRoles=new Set(['Loup-Garou','Villageois','Voyante']);
  showScreen('welcome');
};

// ================================================================
// NARRATIVE
// ================================================================
function queueNarr(n){narrQueue.push(n);if(!narrActive)showNextNarr();}
function showNextNarr(){
  if(!narrQueue.length){narrActive=false;return;}
  narrActive=true;
  const n=narrQueue.shift();
  const ov=document.getElementById('narr');
  document.getElementById('n-fire').textContent=n.fire||'üî•';
  document.getElementById('n-title').textContent=n.title;
  document.getElementById('n-title').style.color=n.color||'var(--moon)';
  document.getElementById('n-text').textContent=n.text;
  // Reset animations
  ['n-title','n-text'].forEach(id=>{const el=document.getElementById(id);el.style.animation='none';void el.offsetWidth;el.style.animation='';});
  const btn=ov.querySelector('.narr-btn');
  btn.style.animation='none';void btn.offsetWidth;btn.style.animation='';
  ov.classList.add('show');
  setTimeout(()=>{if(ov.classList.contains('show'))closeNarr();},9000);
}
window.closeNarr = function(){document.getElementById('narr').classList.remove('show');setTimeout(showNextNarr,400);};

// ================================================================
// MODAL
// ================================================================
window.openModal = function(title,body){
  document.getElementById('m-title').textContent=title;
  document.getElementById('m-body').innerHTML=`<div class="m-opts">${body}</div>`;
  document.getElementById('modal-ov').classList.add('open');
};
window.closeModal = function(){document.getElementById('modal-ov').classList.remove('open');};
document.getElementById('modal-ov').addEventListener('click',e=>{if(e.target===document.getElementById('modal-ov'))closeModal();});

</script>
</body>
</html>
